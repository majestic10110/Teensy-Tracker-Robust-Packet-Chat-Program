# --- Guard imports so PyInstaller bundles dynamically-used modules ---
import hmac
import hashlib
import json
import time
import os
import sys
import re
import math
import random
import string
import base64
import binascii
import zlib
import datetime
import traceback
import pathlib
import collections
import serial
import cryptography
from PyQt5 import QtCore, QtGui, QtWidgets
# -------------------------------------------------------------------------
# --- PyInstaller hidden-import guards (stdlib used inside embedded base) ---
import hmac  # ensure bundled
import hashlib
import secrets
import ssl
import base64 as _b64_guard
import binascii as _bina_guard
import struct as _struct_guard
import logging as _logging_guard
# -------------------------------------------------------------------------

import sys, os, types, time, re, math

from PyQt5.QtWidgets import QApplication, QLabel, QHBoxLayout, QComboBox, QPushButton, QGroupBox
from PyQt5.QtCore import QTimer

EMBEDDED_BASE_B64 = '''aW1wb3J0IG9zCkFQUF9WRVJTSU9OID0gIjEuNS5OIgppbXBvcnQgcmUKaW1wb3J0IHN5cywgbWF0aCwganNvbiwgZGF0ZXRpbWUsIHRpbWUsIHRyYWNlYmFjaywgcmFuZG9tCmltcG9ydCBvcywgc3lzCmZyb20gUHlRdDUuUXRXaWRnZXRzIGltcG9ydCAoUVNjcm9sbEFyZWEsIFFGcmFtZSwgCiAgICBRQXBwbGljYXRpb24sIFFNYWluV2luZG93LCBRV2lkZ2V0LCBRVkJveExheW91dCwgUUhCb3hMYXlvdXQsCiAgICBRTGFiZWwsIFFMaW5lRWRpdCwgUVB1c2hCdXR0b24sIFFDb21ib0JveCwgUVRleHRFZGl0LCBRR3JvdXBCb3gsCiAgICBRTWVzc2FnZUJveCwgUVN0YXR1c0JhciwgUUxpc3RXaWRnZXQsIFFMaXN0V2lkZ2V0SXRlbSwgUUlucHV0RGlhbG9nLAogICAgUVNob3J0Y3V0LCBRRmlsZURpYWxvZywgUVNpemVQb2xpY3ksIFFUYWJXaWRnZXQsIFFUb29sQmFyLCBRR3JhcGhpY3NWaWV3LAogICAgUUdyYXBoaWNzU2NlbmUsIFFDaGVja0JveCwgUURvY2tXaWRnZXQKLCBRU2Nyb2xsQXJlYSwgUUZyYW1lKQoKIyAtLS0gVFgtZWNobyBzdXBwcmVzc2lvbiBoZWxwZXJzIChGMjZhKSAtLS0KaW1wb3J0IHJlIGFzIF9yY19yZQoKX1JDX01PTl9GUkFNRV9SRSA9IF9yY19yZS5jb21waWxlKAogICAgcideXHMqZm1ccytbQS1aMC05LytcLV0rKD86LVxkKyk/XHMrdG9ccytbQS1aMC05LytcLV0rKD86LVxkKyk/XHMrY3RsXHMrVUlcXj8oPzpccytwaWRccytcdyspP1xzKiQnLAogICAgX3JjX3JlLklHTk9SRUNBU0UKKQoKZGVmIF9yY19pc19zZWxmX2NhbGxfaW5fbGluZShzZWxmLCBzOiBzdHIpIC0+IGJvb2w6CiAgICB0cnk6CiAgICAgICAgbWMgPSBnZXRhdHRyKHNlbGYsICJteWNhbGwiLCBOb25lKSBvciBnZXRhdHRyKHNlbGYsICJNWUNBTEwiLCBOb25lKQogICAgICAgIGlmIG5vdCBtYzoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgcmV0dXJuIF9yY19yZS5zZWFyY2gocmYnXGJ7X3JjX3JlLmVzY2FwZShzdHIobWMpKX1cYicsIHN0cihzKSwgX3JjX3JlLklHTk9SRUNBU0UpIGlzIG5vdCBOb25lCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiBGYWxzZQoKZGVmIF9yY19kcm9wX2NvbnNvbGVfZWNobyhzZWxmLCBsaW5lOiBzdHIpIC0+IGJvb2w6CiAgICAnJydSZXR1cm4gVHJ1ZSBpZiB0aGUgbGluZSBsb29rcyBsaWtlIG91ciBvd24gVFggbW9uaXRvciBlY2hvLicnJwogICAgdHJ5OgogICAgICAgIGlmIF9SQ19NT05fRlJBTUVfUkUubWF0Y2goc3RyKGxpbmUpKSBhbmQgX3JjX2lzX3NlbGZfY2FsbF9pbl9saW5lKHNlbGYsIGxpbmUpOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCiAgICByZXR1cm4gRmFsc2UKCgpkZWYgX3RvX2Jhc2UzNihuOiBpbnQsIHdpZHRoOiBpbnQgPSA0KSAtPiBzdHI6CiAgICBkaWdpdHMgPSAnMDEyMzQ1Njc4OUFCQ0RFRkdISUpLTE1OT1BRUlNUVVZXWFlaJwogICAgaWYgbiA8PSAwOgogICAgICAgIHJldHVybiAnMCcucmp1c3Qod2lkdGgsICcwJykKICAgIHMgPSAnJwogICAgd2hpbGUgbjoKICAgICAgICBuLCByID0gZGl2bW9kKG4sIDM2KQogICAgICAgIHMgPSBkaWdpdHNbcl0gKyBzCiAgICByZXR1cm4gcy5yanVzdCh3aWR0aCwgJzAnKQpmcm9tIFB5UXQ1LlF0Q29yZSBpbXBvcnQgUXQsIFFUaHJlYWQsIHB5cXRTaWduYWwsIFFUaW1lciwgUVJlY3RGLCBRUmVndWxhckV4cHJlc3Npb24sIFFTaXplLCBRUG9pbnRGCmZyb20gUHlRdDUuUXRHdWkgaW1wb3J0IFFLZXlTZXF1ZW5jZSwgUUZvbnQsIFFGb250TWV0cmljcywgUVBlbiwgUUJydXNoLCBRUmVndWxhckV4cHJlc3Npb25WYWxpZGF0b3IsIFFDb2xvciwgUVBvbHlnb25GCnRyeToKICAgIGltcG9ydCBzZXJpYWwKICAgIFNFUklBTF9BVkFJTEFCTEUgPSBUcnVlCmV4Y2VwdCBFeGNlcHRpb246CiAgICBzZXJpYWwgPSBOb25lCiAgICBTRVJJQUxfQVZBSUxBQkxFID0gRmFsc2UKCiMgLS0tLS0tLS0tIEhlbHBlcnMgLS0tLS0tLS0tCgojIC0tLS0gR2VvIGhlbHBlcnM6IGRpc3RhbmNlL2JlYXJpbmcvY2FyZGluYWwgKFN0ZXAgRCkgLS0tLQpkZWYgX2dlb19oYXZlcnNpbmVfa20obGF0MSwgbG9uMSwgbGF0MiwgbG9uMik6CiAgICBpbXBvcnQgbWF0aAogICAgUiA9IDYzNzEuMCAgIyBrbQogICAgcGhpMSA9IG1hdGgucmFkaWFucyhmbG9hdChsYXQxKSk7IHBoaTIgPSBtYXRoLnJhZGlhbnMoZmxvYXQobGF0MikpCiAgICBkcGhpID0gbWF0aC5yYWRpYW5zKGZsb2F0KGxhdDIpIC0gZmxvYXQobGF0MSkpCiAgICBkbG1iID0gbWF0aC5yYWRpYW5zKGZsb2F0KGxvbjIpIC0gZmxvYXQobG9uMSkpCiAgICBhID0gbWF0aC5zaW4oZHBoaS8yKSoqMiArIG1hdGguY29zKHBoaTEpKm1hdGguY29zKHBoaTIpKm1hdGguc2luKGRsbWIvMikqKjIKICAgIGMgPSAyKm1hdGguYXRhbjIoYSoqMC41LCAoMS1hKSoqMC41KQogICAgcmV0dXJuIFIqYwoKZGVmIF9nZW9faW5pdGlhbF9iZWFyaW5nX2RlZyhsYXQxLCBsb24xLCBsYXQyLCBsb24yKToKICAgIGltcG9ydCBtYXRoCiAgICBwaGkxID0gbWF0aC5yYWRpYW5zKGZsb2F0KGxhdDEpKTsgcGhpMiA9IG1hdGgucmFkaWFucyhmbG9hdChsYXQyKSkKICAgIGRsbWIgPSBtYXRoLnJhZGlhbnMoZmxvYXQobG9uMikgLSBmbG9hdChsb24xKSkKICAgIHggPSBtYXRoLnNpbihkbG1iKSptYXRoLmNvcyhwaGkyKQogICAgeSA9IG1hdGguY29zKHBoaTEpKm1hdGguc2luKHBoaTIpIC0gbWF0aC5zaW4ocGhpMSkqbWF0aC5jb3MocGhpMikqbWF0aC5jb3MoZGxtYikKICAgIHJldHVybiAobWF0aC5kZWdyZWVzKG1hdGguYXRhbjIoeCwgeSkpICsgMzYwLjApICUgMzYwLjAKCl9DQVJEMTYgPSBbIk4iLCJOTkUiLCJORSIsIkVORSIsIkUiLCJFU0UiLCJTRSIsIlNTRSIsIlMiLCJTU1ciLCJTVyIsIldTVyIsIlciLCJXTlciLCJOVyIsIk5OVyJdCmRlZiBfZ2VvX2NhcmRpbmFsMTYoZGVnKToKICAgIHRyeToKICAgICAgICBpZHggPSBpbnQoKChmbG9hdChkZWcpICsgMTEuMjUpICUgMzYwKSAvLyAyMi41KQogICAgICAgIHJldHVybiBfQ0FSRDE2W2lkeF0KICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuICJOIgoKZGVmIGRpYWdfbG9nKG1zZzogc3RyKToKICAgIHRyeToKICAgICAgICBiYXNlID0gYXBwX2Jhc2VfZGlyKCkKICAgICAgICAjIFJvb3QgbG9nCiAgICAgICAgd2l0aCBvcGVuKG9zLnBhdGguam9pbihiYXNlLCAnc3RhcnR1cF9sb2cudHh0JyksICdhJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgZi53cml0ZShtc2cgKyAnXG4nKQogICAgICAgICMgU3RvcmUgbG9nCiAgICAgICAgc3RvcmUgPSBvcy5wYXRoLmpvaW4oYmFzZSwgJ3N0b3JlJykKICAgICAgICBvcy5tYWtlZGlycyhzdG9yZSwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKHN0b3JlLCAnZGlhZ25vc3RpYy5sb2cnKSwgJ2EnLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmMjoKICAgICAgICAgICAgZjIud3JpdGUobXNnICsgJ1xuJykKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKZGVmIGFwcF9iYXNlX2RpcigpOgogICAgaWYgZ2V0YXR0cihzeXMsICdmcm96ZW4nLCBGYWxzZSk6CiAgICAgICAgcmV0dXJuIG9zLnBhdGguZGlybmFtZShzeXMuZXhlY3V0YWJsZSkKICAgIHJldHVybiBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKCmZyb20gUHlRdDUuUXRHdWkgaW1wb3J0IFFGb250RGF0YWJhc2UsIFFGb250CgpkZWYgX2luc3RhbGxfdnQzMjNfZm9udCgpOgogICAgJycnTG9hZCBidW5kbGVkIFZUMzIzIGlmIGF2YWlsYWJsZSBzbyB0aGVtZSBjaGFuZ2VzIG5ldmVyIGFsdGVyIHRoZSBmYWNlL21ldHJpY3MuJycnCiAgICB0cnk6CiAgICAgICAgYmFzZSA9IGFwcF9iYXNlX2RpcigpCiAgICAgICAgY2FuZGlkYXRlcyA9IFsKICAgICAgICAgICAgb3MucGF0aC5qb2luKGJhc2UsICJmb250cyIsICJWVDMyMy1SZWd1bGFyLnR0ZiIpLAogICAgICAgICAgICBvcy5wYXRoLmpvaW4oYmFzZSwgIlZUMzIzLVJlZ3VsYXIudHRmIiksCiAgICAgICAgXQogICAgICAgIGZvciBwIGluIGNhbmRpZGF0ZXM6CiAgICAgICAgICAgIGlmIG9zLnBhdGguaXNmaWxlKHApOgogICAgICAgICAgICAgICAgUUZvbnREYXRhYmFzZS5hZGRBcHBsaWNhdGlvbkZvbnQocCkKICAgICAgICAgICAgICAgIGJyZWFrCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHBhc3MKCmZyb20gUHlRdDUuUXRHdWkgaW1wb3J0IFFGb250SW5mbwoKZGVmIF9sb2dfZm9udF9zbmFwc2hvdCh0YWcsIHdpZGdldCk6CiAgICB0cnk6CiAgICAgICAgYmFzZSA9IGFwcF9iYXNlX2RpcigpCiAgICAgICAgc3RvcmUgPSBvcy5wYXRoLmpvaW4oYmFzZSwgInN0b3JlIik7IG9zLm1ha2VkaXJzKHN0b3JlLCBleGlzdF9vaz1UcnVlKQogICAgICAgIG91dCA9IG9zLnBhdGguam9pbihzdG9yZSwgImRpYWdub3N0aWNfZm9udC50eHQiKQogICAgICAgIGZpID0gUUZvbnRJbmZvKHdpZGdldC5mb250KCkpCiAgICAgICAgd2l0aCBvcGVuKG91dCwgImEiLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICBmLndyaXRlKGYie3RhZ306IGZhbWlseT17ZmkuZmFtaWx5KCl9IHBvaW50U2l6ZT17ZmkucG9pbnRTaXplKCl9IHBpeGVsU2l6ZT17ZmkucGl4ZWxTaXplKCl9IGV4YWN0TWF0Y2g9e2ZpLmV4YWN0TWF0Y2goKX1cbiIpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHBhc3MKCmRlZiBzdG9yZV9wYXRoKGZpbGVuYW1lOiBzdHIpOgogICAgYmFzZSA9IGFwcF9iYXNlX2RpcigpCiAgICBzdG9yZSA9IG9zLnBhdGguam9pbihiYXNlLCAic3RvcmUiKQogICAgb3MubWFrZWRpcnMoc3RvcmUsIGV4aXN0X29rPVRydWUpCiAgICByZXR1cm4gb3MucGF0aC5qb2luKHN0b3JlLCBmaWxlbmFtZSkKCmRlZiBsb2FkX2pzb24oZmlsZW5hbWU6IHN0cik6CiAgICBwYXRoID0gc3RvcmVfcGF0aChmaWxlbmFtZSkKICAgIHRyeToKICAgICAgICBpZiBvcy5wYXRoLmV4aXN0cyhwYXRoKToKICAgICAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJyIiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAgICAgIGRhdGEgPSBqc29uLmxvYWQoZikKICAgICAgICAgICAgICAgIGRpYWdfbG9nKGYibG9hZF9qc29uIE9LOiB7ZmlsZW5hbWV9IC0+IHR5cGU9e3R5cGUoZGF0YSkuX19uYW1lX199IikKICAgICAgICAgICAgICAgIHJldHVybiBkYXRhCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZGlhZ19sb2coZiJsb2FkX2pzb24gTUlTUzoge2ZpbGVuYW1lfSAobm8gZmlsZSkiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGRpYWdfbG9nKGYibG9hZF9qc29uIEVSUk9SOiB7ZmlsZW5hbWV9OiB7ZX0iKQogICAgcmV0dXJuIHt9CgpkZWYgc2F2ZV9qc29uKGZpbGVuYW1lOiBzdHIsIGRhdGEpOgogICAgcGF0aCA9IHN0b3JlX3BhdGgoZmlsZW5hbWUpCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAganNvbi5kdW1wKGRhdGEsIGYsIGVuc3VyZV9hc2NpaT1GYWxzZSwgaW5kZW50PTIpCiAgICAgICAgZGlhZ19sb2coZiJzYXZlX2pzb24gT0s6IHtmaWxlbmFtZX0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIGRpYWdfbG9nKGYic2F2ZV9qc29uIEVSUk9SOiB7ZmlsZW5hbWV9OiB7ZX0iKQoKZGVmIGxvYWRfanNvbl9yb290KGZpbGVuYW1lOiBzdHIpOgogICAgcGF0aCA9IG9zLnBhdGguam9pbihhcHBfYmFzZV9kaXIoKSwgZmlsZW5hbWUpCiAgICB0cnk6CiAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocGF0aCk6CiAgICAgICAgICAgIHdpdGggb3BlbihwYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICBkYXRhID0ganNvbi5sb2FkKGYpCiAgICAgICAgICAgICAgICBkaWFnX2xvZyhmImxvYWRfanNvbl9yb290IE9LOiB7ZmlsZW5hbWV9IC0+IHR5cGU9e3R5cGUoZGF0YSkuX19uYW1lX199IikKICAgICAgICAgICAgICAgIHJldHVybiBkYXRhCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZGlhZ19sb2coZiJsb2FkX2pzb25fcm9vdCBNSVNTOiB7ZmlsZW5hbWV9IChubyBmaWxlKSIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZGlhZ19sb2coZiJsb2FkX2pzb25fcm9vdCBFUlJPUjoge2ZpbGVuYW1lfToge2V9IikKICAgIHJldHVybiB7fQoKZGVmIHNhdmVfanNvbl9yb290KGZpbGVuYW1lOiBzdHIsIGRhdGEpOgogICAgcGF0aCA9IG9zLnBhdGguam9pbihhcHBfYmFzZV9kaXIoKSwgZmlsZW5hbWUpCiAgICB0cnk6CiAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJ3IiwgZW5jb2Rpbmc9InV0Zi04IikgYXMgZjoKICAgICAgICAgICAganNvbi5kdW1wKGRhdGEsIGYsIGVuc3VyZV9hc2NpaT1GYWxzZSwgaW5kZW50PTIpCiAgICAgICAgZGlhZ19sb2coZiJzYXZlX2pzb25fcm9vdCBPSzoge2ZpbGVuYW1lfSIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgZGlhZ19sb2coZiJzYXZlX2pzb25fcm9vdCBFUlJPUjoge2ZpbGVuYW1lfToge2V9IikKCmRlZiBiYXNlX2NhbGxzaWduKGNzOiBzdHIpIC0+IHN0cjoKICAgIGNzID0gKGNzIG9yICIiKS5zdHJpcCgpLnVwcGVyKCkKICAgIG0gPSByZS5tYXRjaChyJ14oW0EtWjAtOS9dKz8pKD86LShbMC05XXsxLDJ9fFwqKSk/JCcsIGNzKQogICAgcmV0dXJuIG0uZ3JvdXAoMSkgaWYgbSBlbHNlIGNzCgpkZWYgcGFyc2VfY2FsbHNpZ25fc3NpZChjczogc3RyKToKICAgICcnJ1JldHVybiAoYmFzZSwgc3NpZF9zdHIgb3IgTm9uZSkuIEFjY2VwdHMgJyonIGFzIHdpbGRjYXJkIFNTSUQuJycnCiAgICBjcyA9IChjcyBvciAnJykuc3RyaXAoKS51cHBlcigpCiAgICBtID0gcmUubWF0Y2gocideKFtBLVowLTkvXSs/KSg/Oi0oWzAtOV17MSwyfXxcKikpPyQnLCBjcykKICAgIGlmIG5vdCBtOgogICAgICAgIHJldHVybiBjcywgTm9uZQogICAgYmFzZSwgc3MgPSBtLmdyb3VwKDEpLCBtLmdyb3VwKDIpCiAgICByZXR1cm4gYmFzZSwgc3MKCiMgLS0tLS0tLS0tIEZsZWV0IChmaWxlLWJhY2tlZCkgLS0tLS0tLS0tCmNsYXNzIEZsZWV0TWFuYWdlcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBwYXRoKToKICAgICAgICBzZWxmLnBhdGggPSBwYXRoCiAgICAgICAgc2VsZi5lbmFibGVkID0gRmFsc2UKICAgICAgICBzZWxmLmFjdGl2ZV9mbGVldHMgPSBbIkRlZmF1bHQiXQogICAgICAgIHNlbGYuZmxlZXRzID0gW3sibmFtZSI6IkRlZmF1bHQiLCJydWxlcyI6eyJkZWZhdWx0X2FjdGlvbiI6InNob3ciLCJhdXRvcGVybWl0IjpGYWxzZX0sIm1lbWJlcnMiOltdfV0gICMgZmFsbGJhY2sKICAgICAgICBzZWxmLmxvYWQoKQogICAgICAgICMgRW5zdXJlIEtJU1MgTW9kZSBkZWZhdWx0LWNoZWNrZWQgaWYgcHJlc2VudAogICAgICAgIHRyeToKICAgICAgICAgICAgZm9yIGNhbmQgaW4gZGlyKHNlbGYpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHcgPSBnZXRhdHRyKHNlbGYsIGNhbmQpCiAgICAgICAgICAgICAgICAgICAgaWYgZ2V0YXR0cih3LCAndGV4dCcsIE5vbmUpIGFuZCBjYWxsYWJsZSh3LnRleHQpOgogICAgICAgICAgICAgICAgICAgICAgICB0ID0gdy50ZXh0KCkuc3RyaXAoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiB0LnN0YXJ0c3dpdGgoJ0tJU1MgTW9kZScpIGFuZCBoYXNhdHRyKHcsICdzZXRDaGVja2VkJyk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICB3LnNldENoZWNrZWQoVHJ1ZSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCgogICAgZGVmIGxvYWQoc2VsZik6CiAgICAgICAgZGF0YSA9IGxvYWRfanNvbl9yb290KG9zLnBhdGguYmFzZW5hbWUoc2VsZi5wYXRoKSkgb3Ige30KICAgICAgICB0cnk6CiAgICAgICAgICAgICMgSWYgZmlsZSBpcyBqdXN0IGEgbGlzdCBvZiBjYWxsc2lnbnMsIG1pZ3JhdGUgdG8gRGVmYXVsdCBncm91cAogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGRhdGEsIGxpc3QpOgogICAgICAgICAgICAgICAgZGF0YSA9IHsiYWN0aXZlX2ZsZWV0cyI6IFsiRGVmYXVsdCJdLAogICAgICAgICAgICAgICAgICAgICAgICAiZmxlZXRzIjogW3sibmFtZSI6IkRlZmF1bHQiLCJydWxlcyI6eyJkZWZhdWx0X2FjdGlvbiI6InNob3ciLCJhdXRvcGVybWl0IjpGYWxzZX0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIm1lbWJlcnMiOltiYXNlX2NhbGxzaWduKHgpIGZvciB4IGluIGRhdGEgaWYgaXNpbnN0YW5jZSh4LChzdHIsKSldfV19CiAgICAgICAgICAgIGFmID0gZGF0YS5nZXQoImFjdGl2ZV9mbGVldHMiKSBvciBbIkRlZmF1bHQiXQogICAgICAgICAgICBmbCA9IGRhdGEuZ2V0KCJmbGVldHMiKSBvciBzZWxmLmZsZWV0cwogICAgICAgICAgICAjIENvZXJjZSBmbGVldHMgdG8gZXhwZWN0ZWQgc3RydWN0dXJlCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZmwsIGRpY3QpIGFuZCAibWVtYmVycyIgaW4gZmw6CiAgICAgICAgICAgICAgICBmbCA9IFtmbF0KICAgICAgICAgICAgbm9ybV9mbGVldHMgPSBbXQogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGZsLCBsaXN0KToKICAgICAgICAgICAgICAgIGZvciBmIGluIGZsOgogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZiwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSBzdHIoZi5nZXQoIm5hbWUiLCJEZWZhdWx0Iikgb3IgIkRlZmF1bHQiKQogICAgICAgICAgICAgICAgICAgICAgICBtZW1iZXJzID0gZi5nZXQoIm1lbWJlcnMiLCBbXSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShtZW1iZXJzLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lbWJlcnMgPSBsaXN0KG1lbWJlcnMua2V5cygpKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKG1lbWJlcnMsIGxpc3QpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVtYmVycyA9IFtzdHIobSkudXBwZXIoKSBmb3IgbSBpbiBtZW1iZXJzIGlmIGlzaW5zdGFuY2UobSwoc3RyLCkpXQogICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbWVtYmVycyA9IFtdCiAgICAgICAgICAgICAgICAgICAgICAgIHJ1bGVzID0gZi5nZXQoInJ1bGVzIikgaWYgaXNpbnN0YW5jZShmLmdldCgicnVsZXMiKSwgZGljdCkgZWxzZSB7ImRlZmF1bHRfYWN0aW9uIjoic2hvdyIsImF1dG9wZXJtaXQiOkZhbHNlfQogICAgICAgICAgICAgICAgICAgICAgICBub3JtX2ZsZWV0cy5hcHBlbmQoeyJuYW1lIjogbmFtZSwgInJ1bGVzIjogcnVsZXMsICJtZW1iZXJzIjogbWVtYmVyc30pCiAgICAgICAgICAgIGlmIG5vcm1fZmxlZXRzOgogICAgICAgICAgICAgICAgc2VsZi5mbGVldHMgPSBub3JtX2ZsZWV0cwogICAgICAgICAgICBpZiBpc2luc3RhbmNlKGFmLCBsaXN0KSBhbmQgYWY6CiAgICAgICAgICAgICAgICBzZWxmLmFjdGl2ZV9mbGVldHMgPSBbc3RyKGFmWzBdKV0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgIyBlbnN1cmUgZGVmYXVsdCBleGlzdHMKICAgICAgICBpZiBub3QgYW55KGYuZ2V0KCJuYW1lIik9PSJEZWZhdWx0IiBmb3IgZiBpbiBzZWxmLmZsZWV0cyk6CiAgICAgICAgICAgIHNlbGYuZmxlZXRzLmFwcGVuZCh7Im5hbWUiOiJEZWZhdWx0IiwicnVsZXMiOnsiZGVmYXVsdF9hY3Rpb24iOiJzaG93IiwiYXV0b3Blcm1pdCI6RmFsc2V9LCJtZW1iZXJzIjpbXX0pCgogICAgZGVmIHNhdmUoc2VsZik6CiAgICAgICAgZGF0YSA9IHsiYWN0aXZlX2ZsZWV0cyI6IHNlbGYuYWN0aXZlX2ZsZWV0cywgImZsZWV0cyI6IHNlbGYuZmxlZXRzfQogICAgICAgIHNhdmVfanNvbl9yb290KG9zLnBhdGguYmFzZW5hbWUoc2VsZi5wYXRoKSwgZGF0YSkKCiAgICBkZWYgbGlzdF9mbGVldF9uYW1lcyhzZWxmKToKICAgICAgICByZXR1cm4gW2YuZ2V0KCJuYW1lIiwiPyIpIGZvciBmIGluIHNlbGYuZmxlZXRzXQoKICAgIGRlZiBzZXRfYWN0aXZlKHNlbGYsIG5hbWU6IHN0cik6CiAgICAgICAgc2VsZi5hY3RpdmVfZmxlZXRzID0gW25hbWUgb3IgIkRlZmF1bHQiXQogICAgICAgIHNlbGYuc2F2ZSgpCgogICAgZGVmIGxpc3RfbWVtYmVycyhzZWxmLCBuYW1lOiBzdHIpOgogICAgICAgIGZvciBmIGluIHNlbGYuZmxlZXRzOgogICAgICAgICAgICBpZiBmLmdldCgibmFtZSIpID09IG5hbWU6CiAgICAgICAgICAgICAgICByZXR1cm4gbGlzdChmLmdldCgibWVtYmVycyIpIG9yIFtdKQogICAgICAgIHJldHVybiBbXQoKICAgIGRlZiBhZGRfZ3JvdXAoc2VsZiwgbmFtZTogc3RyKToKICAgICAgICBuYW1lID0gKG5hbWUgb3IgIiIpLnN0cmlwKCkKICAgICAgICBpZiBub3QgbmFtZTogcmV0dXJuIEZhbHNlCiAgICAgICAgaWYgYW55KGYuZ2V0KCJuYW1lIik9PW5hbWUgZm9yIGYgaW4gc2VsZi5mbGVldHMpOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBzZWxmLmZsZWV0cy5hcHBlbmQoeyJuYW1lIjpuYW1lLCJydWxlcyI6eyJkZWZhdWx0X2FjdGlvbiI6InNob3ciLCJhdXRvcGVybWl0IjpGYWxzZX0sIm1lbWJlcnMiOltdfSkKICAgICAgICBzZWxmLnNhdmUoKQogICAgICAgIHJldHVybiBUcnVlCgogICAgZGVmIGFkZF9tZW1iZXIoc2VsZiwgZ3JvdXA6IHN0ciwgY2FsbHNpZ246IHN0cik6CiAgICAgICAgZ3JvdXAgPSAoZ3JvdXAgb3IgIiIpLnN0cmlwKCkKICAgICAgICBiYXNlLCBzcyA9IHBhcnNlX2NhbGxzaWduX3NzaWQoY2FsbHNpZ24pCiAgICAgICAgaWYgbm90IGdyb3VwIG9yIG5vdCBiYXNlOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBub3JtID0gYmFzZQogICAgICAgIGlmIHNzID09ICcqJzoKICAgICAgICAgICAgbm9ybSA9IGYie2Jhc2V9LSoiCiAgICAgICAgZWxzZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgc3MgaXMgbm90IE5vbmUgYW5kIDEgPD0gaW50KHNzKSA8PSA5OToKICAgICAgICAgICAgICAgICAgICBub3JtID0gZiJ7YmFzZX0tKiIKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBmb3IgZiBpbiBzZWxmLmZsZWV0czoKICAgICAgICAgICAgaWYgZi5nZXQoIm5hbWUiKSA9PSBncm91cDoKICAgICAgICAgICAgICAgIGlmIG5vcm0gbm90IGluIGYuZ2V0KCJtZW1iZXJzIiwgW10pOgogICAgICAgICAgICAgICAgICAgIGYuc2V0ZGVmYXVsdCgibWVtYmVycyIsIFtdKS5hcHBlbmQobm9ybSkKICAgICAgICAgICAgICAgICAgICBzZWxmLnNhdmUoKQogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgbWF0Y2hlc19tZW1iZXIoc2VsZiwgc3RvcmVkOiBzdHIsIGNhbGxzaWduOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgJycnUmV0dXJuIFRydWUgaWYgc3RvcmVkIGVudHJ5IG1hdGNoZXMgY2FsbHNpZ24gcGVyIHdpbGRjYXJkIHJ1bGVzLgogICAgICAgIC0gc3RvcmVkICdCQVNFLSonIG1hdGNoZXMgQkFTRSBvciBhbnkgQkFTRS1TU0lECiAgICAgICAgLSBzdG9yZWQgJ0JBU0UnIG1hdGNoZXMgb25seSBCQVNFIChubyBTU0lEKQogICAgICAgICcnJwogICAgICAgIGIsIHNzID0gcGFyc2VfY2FsbHNpZ25fc3NpZChjYWxsc2lnbikKICAgICAgICBpZiBzdG9yZWQuZW5kc3dpdGgoJy0qJyk6CiAgICAgICAgICAgIHJldHVybiBzdG9yZWRbOi0yXSA9PSBiCiAgICAgICAgcmV0dXJuIHN0b3JlZCA9PSBiCgogICAgZGVmIHJlbW92ZV9tZW1iZXIoc2VsZiwgZ3JvdXA6IHN0ciwgY2FsbHNpZ246IHN0cik6CiAgICAgICAgZ3JvdXAgPSAoZ3JvdXAgb3IgIiIpLnN0cmlwKCkKICAgICAgICBjcyA9IGJhc2VfY2FsbHNpZ24oY2FsbHNpZ24pCiAgICAgICAgZm9yIGYgaW4gc2VsZi5mbGVldHM6CiAgICAgICAgICAgIGlmIGYuZ2V0KCJuYW1lIik9PWdyb3VwIGFuZCBjcyBpbiBmLmdldCgibWVtYmVycyIsW10pOgogICAgICAgICAgICAgICAgZlsibWVtYmVycyJdLnJlbW92ZShjcykKICAgICAgICAgICAgICAgIHNlbGYuc2F2ZSgpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIHJldHVybiBGYWxzZQoKIyAtLS0tLS0tLS0gU2VyaWFsIHRocmVhZCAoc3R1YikgLS0tLS0tLS0tCmNsYXNzIFNlcmlhbFJlYWRlclRocmVhZChRVGhyZWFkKToKICAgIGxpbmVfcmVjZWl2ZWQgPSBweXF0U2lnbmFsKHN0cikKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBvd25lcik6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygpCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgCiAgICAgICAgIyBQb3NpdGlvbnMgc3RvcmUKCiAgICAgICAgdHJ5OgoKICAgICAgICAgICAgc2VsZi5fcG9zaXRpb25zID0gc2VsZi5fbG9hZF9wb3NpdGlvbnMoKQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgoKICAgICAgICAgICAgc2VsZi5fcG9zaXRpb25zID0ge30KCiMgT25lLXNob3QgY29vcmRpbmF0ZSBiZWFjb24gZmxhZwogICAgICAgIHNlbGYuX2JlYWNvbl9jb29yZHNfZm9yY2Vfb25jZSA9IEZhbHNlCiMgTG9hZCBiZWFjb24gY29vcmRpbmF0ZSBzdGF0ZQogICAgICAgIHRyeToKICAgICAgICAgICAgX2MgPSBzZWxmLl9sb2FkX2JlYWNvbl9jb29yZHNfZnJvbV9zZXR0aW5ncygpCiAgICAgICAgICAgIHNlbGYuX2JlYWNvbl9jb29yZHNfZW5hYmxlZCA9IGJvb2woX2MuZ2V0KCdlbmFibGVkJykpCiAgICAgICAgICAgIHNlbGYuX2JlYWNvbl9jb29yZHNfbGF0ID0gX2MuZ2V0KCdsYXQnKQogICAgICAgICAgICBzZWxmLl9iZWFjb25fY29vcmRzX2xvbiA9IF9jLmdldCgnbG9uJykKICAgICAgICAgICAgc2VsZi5fYmVhY29uX2Nvb3Jkc19sYXN0X3RzID0gX2MuZ2V0KCdsYXN0X3RzJykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBzZWxmLl9iZWFjb25fY29vcmRzX2VuYWJsZWQgPSBGYWxzZQogICAgICAgICAgICBzZWxmLl9iZWFjb25fY29vcmRzX2xhdCA9IE5vbmUKICAgICAgICAgICAgc2VsZi5fYmVhY29uX2Nvb3Jkc19sb24gPSBOb25lCiAgICAgICAgICAgIHNlbGYuX2JlYWNvbl9jb29yZHNfbGFzdF90cyA9IE5vbmUKIyBFbnN1cmUgYSBzdGF0dXMgYmFyIGV4aXN0cwogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgInN0YXR1c19iYXIiKSBvciBzZWxmLnN0YXR1c19iYXIgaXMgTm9uZToKICAgICAgICAgICAgICAgIGZyb20gUHlRdDUuUXRXaWRnZXRzIGltcG9ydCBRU3RhdHVzQmFyCiAgICAgICAgICAgICAgICBzZWxmLnN0YXR1c19iYXIgPSBRU3RhdHVzQmFyKCkKICAgICAgICAgICAgICAgIHNlbGYuc2V0U3RhdHVzQmFyKHNlbGYuc3RhdHVzX2JhcikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgc2VsZi5fc3RvcCA9IEZhbHNlCiAgICAgICAgc2VsZi5vd25lciA9IG93bmVyICAjIENoYXRBcHAgaW5zdGFuY2UgKGhhcyAuc2VyKQoKICAgIAogICAgZGVmIHN0b3Aoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLl9zdG9wID0gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHNlbGYuX3N0b3AgPSBUcnVlCiAgICBkZWYgcnVuKHNlbGYpOgogICAgICAgIGJ1ZiA9IGJ5dGVhcnJheSgpCiAgICAgICAgd2hpbGUgbm90IHNlbGYuX3N0b3A6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlciA9IGdldGF0dHIoc2VsZi5vd25lciwgJ3NlcicsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBzZXIgYW5kIHNlci5pc19vcGVuOgogICAgICAgICAgICAgICAgICAgIGRhdGEgPSBzZXIucmVhZCgyNTYpCiAgICAgICAgICAgICAgICAgICAgaWYgZGF0YToKICAgICAgICAgICAgICAgICAgICAgICAgYnVmLmV4dGVuZChkYXRhKQogICAgICAgICAgICAgICAgICAgICAgICB3aGlsZSBUcnVlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY3V0ID0gTm9uZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIGksIGIgaW4gZW51bWVyYXRlKGJ1Zik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgYiBpbiAoMTAsIDEzKTogICMgQ1IvTEYKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY3V0ID0gaTsgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGN1dCBpcyBOb25lOiBicmVhawogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGluZSA9IGJ5dGVzKGJ1Zls6Y3V0XSkuZGVjb2RlKCd1dGYtOCcsIGVycm9ycz0naWdub3JlJykKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmcm9tIF9fbWFpbl9fIGltcG9ydCBkaWFnX2xvZwogICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZGlhZ19sb2coZiJbUlhdIHtsaW5lfSIpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGogPSBjdXQKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdoaWxlIGogPCBsZW4oYnVmKSBhbmQgYnVmW2pdIGluICgxMCwxMyk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaiArPSAxCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidWYgPSBidWZbajpdCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsaW5lID0gbGluZS5zdHJpcCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBsaW5lOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubGluZV9yZWNlaXZlZC5lbWl0KGxpbmUpCiAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5tc2xlZXAoMTUpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYubXNsZWVwKDUwKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgIyBCbGFuayBvciBpbnZhbGlkIGZpZWxkczogRElTQUJMRSBjb29yZGluYXRlIGJlYWNvbnMKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9iZWFjb25fY29vcmRzX2VuYWJsZWQgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2JlYWNvbl9jb29yZHNfbGF0ID0gTm9uZQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2JlYWNvbl9jb29yZHNfbG9uID0gTm9uZQogICAgICAgICAgICAgICAgICAgIHNlbGYuX2JlYWNvbl9jb29yZHNfbGFzdF90cyA9IE5vbmUKICAgICAgICAgICAgICAgICAgICBzZWxmLl9iZWFjb25fY29vcmRzX2ZvcmNlX29uY2UgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgICMgUGVyc2lzdCBkaXNhYmxlZCBzdGF0ZQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2F2ZV9iZWFjb25fY29vcmRzX3RvX3NldHRpbmdzKEZhbHNlLCBOb25lLCBOb25lLCBOb25lKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICAjIE9wdGlvbmFsOiBmZWVkYmFjawogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3RhdHVzKCdGaXhlZCBwb3NpdGlvbiBjbGVhcmVkOyBjb29yZGluYXRlIGJlYWNvbnMgZGlzYWJsZWQnLCAzMDAwKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgIHNlbGYuX2Fja19wYXVzZV9kZWZhdWx0ID0gMTIuMAogICAgICAgIHNlbGYuX2Fja19zZW50ID0ge30KICAgICAgICBzZWxmLl9hY2tfc2VudF90dGwgPSA2MDAuMAogICAgICAgIHNlbGYuZ2V0X215Y2FsbCA9IGdldF9teWNhbGwKICAgICAgICBzZWxmLmdldF9saXZlID0gZ2V0X2xpdmUKICAgICAgICBzZWxmLmdldF90aGVtZSA9IGdldF90aGVtZQogICAgICAgIHYgPSBRVkJveExheW91dChzZWxmKQogICAgICAgIGN0cmwgPSBRSEJveExheW91dCgpCiAgICAgICAgc2VsZi56b29tX2luID0gUVB1c2hCdXR0b24oIisiKQogICAgICAgIHNlbGYuem9vbV9vdXQgPSBRUHVzaEJ1dHRvbigiLSIpCiAgICAgICAgc2VsZi5yZXNldF9idG4gPSBRUHVzaEJ1dHRvbigiUkVTRVQiKQogICAgICAgIGZvciBiIGluIChzZWxmLnpvb21faW4sIHNlbGYuem9vbV9vdXQsIHNlbGYucmVzZXRfYnRuKToKICAgICAgICAgICAgYi5zZXRTaXplUG9saWN5KFFTaXplUG9saWN5Lk1pbmltdW0sIFFTaXplUG9saWN5Lk1pbmltdW0pCiAgICAgICAgY3RybC5hZGRXaWRnZXQoc2VsZi56b29tX2luKTsgY3RybC5hZGRXaWRnZXQoc2VsZi56b29tX291dCk7IGN0cmwuYWRkV2lkZ2V0KHNlbGYucmVzZXRfYnRuKTsgY3RybC5hZGRTdHJldGNoKDEpCiAgICAgICAgdi5hZGRMYXlvdXQoY3RybCkKICAgICAgICBzZWxmLnNjZW5lID0gUUdyYXBoaWNzU2NlbmUoKQogICAgICAgIHNlbGYudmlldyA9IFFHcmFwaGljc1ZpZXcoc2VsZi5zY2VuZSkKICAgICAgICB2LmFkZFdpZGdldChzZWxmLnZpZXcsIDEpCiAgICAgICAgc2VsZi56b29tX2luLmNsaWNrZWQuY29ubmVjdChsYW1iZGE6IHNlbGYudmlldy5zY2FsZSgxLjE1LCAxLjE1KSkKICAgICAgICBzZWxmLnpvb21fb3V0LmNsaWNrZWQuY29ubmVjdChsYW1iZGE6IHNlbGYudmlldy5zY2FsZSgxLzEuMTUsIDEvMS4xNSkpCiAgICAgICAgc2VsZi5yZXNldF9idG4uY2xpY2tlZC5jb25uZWN0KHNlbGYucmVzZXRfdmlldykKICAgICAgICBzZWxmLmRyYXdfZ3JhcGgoKQoKICAgIGRlZiByZXNldF92aWV3KHNlbGYpOgogICAgICAgIHNlbGYudmlldy5yZXNldFRyYW5zZm9ybSgpCiAgICAgICAgciA9IHNlbGYuc2NlbmUuaXRlbXNCb3VuZGluZ1JlY3QoKQogICAgICAgIGlmIHIuaXNWYWxpZCgpOgogICAgICAgICAgICBzZWxmLnZpZXcuZml0SW5WaWV3KHIuYWRqdXN0ZWQoLTQwLCAtNDAsIDQwLCA0MCksIFF0LktlZXBBc3BlY3RSYXRpbykKCiAgICBkZWYgX3RyaWFuZ2xlKHNlbGYsIGN4LCBjeSwgc2l6ZSk6CiAgICAgICAgaCA9IHNpemUKICAgICAgICByID0gaCAvICgzKiowLjUpICAjIHJhZGl1cyByZWxhdGlvbiBmb3IgZXF1aWxhdGVyYWwKICAgICAgICBwdHMgPSBbXQogICAgICAgIGZvciBrIGluIHJhbmdlKDMpOgogICAgICAgICAgICBhbmcgPSAtbWF0aC5waS8yICsgayAqIDIqbWF0aC5waS8zICAjIHBvaW50IHVwCiAgICAgICAgICAgIHB0cy5hcHBlbmQoUVBvaW50RihjeCArIHIqbWF0aC5jb3MoYW5nKSwgY3kgKyByKm1hdGguc2luKGFuZykpKQogICAgICAgIHJldHVybiBRUG9seWdvbkYocHRzKQoKICAgIGRlZiBkcmF3X2dyYXBoKHNlbGYpOgogICAgICAgIHNlbGYuc2NlbmUuY2xlYXIoKQoKICAgICAgICAjIC0tLS0gTWV0cmljcyBsYWJlbCBoZWxwZXIgKFN0ZXAgRCkgLS0tLQogICAgICAgIGRlZiBfYWRkX21ldHJpY3NfbGFiZWwoY2FsbHNpZ246IHN0ciwgY3g6IGZsb2F0LCBiYXNlbGluZV95OiBmbG9hdCwgZmlyc3RfbGluZV9oZWlnaHQ6IGZsb2F0KToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgY3N1ID0gKGNhbGxzaWduIG9yICIiKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICAgICAgICAgIG15dSA9IChzZWxmLmdldF9teWNhbGwoKSBvciAiTVlDQUxMIikuc3RyaXAoKS51cHBlcigpCiAgICAgICAgICAgICAgICBpZiBjc3UgPT0gbXl1OgogICAgICAgICAgICAgICAgICAgIHJldHVybiAgIyBza2lwIE1ZQ0FMTAogICAgICAgICAgICAgICAgbSA9IE5vbmUKICAgICAgICAgICAgICAgIGdtID0gZ2V0YXR0cihzZWxmLCAnZ2V0X21ldHJpYycsIE5vbmUpCiAgICAgICAgICAgICAgICBpZiBjYWxsYWJsZShnbSk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBtID0gZ20oY2FsbHNpZ24pCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgbSA9IE5vbmUKICAgICAgICAgICAgICAgIGlmIG06CiAgICAgICAgICAgICAgICAgICAgbGluZTIgPSBmInttWydrbV9zdHInXX0ga20gLyB7bVsnbWlfc3RyJ119IG1pIgogICAgICAgICAgICAgICAgICAgIGxpbmUzID0gZiJ7bVsnZGVnX3N0ciddfcKwIHttWydjYXJkJ119IgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICBsaW5lMiA9ICJObyBQb3NpdGlvbiIKICAgICAgICAgICAgICAgICAgICBsaW5lMyA9ICIiCiAgICAgICAgICAgICAgICBmcm9tIFB5UXQ1LlF0R3VpIGltcG9ydCBRRm9udAogICAgICAgICAgICAgICAgZiA9IFFGb250KHNlbGYuZm9udCgpKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGYuc2V0UG9pbnRTaXplKG1heCg4LCBmLnBvaW50U2l6ZSgpLTIpKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICB0MiA9IHNlbGYuc2NlbmUuYWRkVGV4dChsaW5lMik7IHQyLnNldERlZmF1bHRUZXh0Q29sb3IodF90ZXh0KTsgdDIuc2V0Rm9udChmKTsgdDIuc2V0WlZhbHVlKDgpCiAgICAgICAgICAgICAgICBiYjIgPSB0Mi5ib3VuZGluZ1JlY3QoKQogICAgICAgICAgICAgICAgdDIuc2V0UG9zKGN4IC0gYmIyLndpZHRoKCkvMiwgYmFzZWxpbmVfeSArIGZpcnN0X2xpbmVfaGVpZ2h0ICsgMikKICAgICAgICAgICAgICAgIGlmIGxpbmUzOgogICAgICAgICAgICAgICAgICAgIHQzID0gc2VsZi5zY2VuZS5hZGRUZXh0KGxpbmUzKTsgdDMuc2V0RGVmYXVsdFRleHRDb2xvcih0X3RleHQpOyB0My5zZXRGb250KGYpOyB0My5zZXRaVmFsdWUoOCkKICAgICAgICAgICAgICAgICAgICBiYjMgPSB0My5ib3VuZGluZ1JlY3QoKQogICAgICAgICAgICAgICAgICAgIHQzLnNldFBvcyhjeCAtIGJiMy53aWR0aCgpLzIsIGJhc2VsaW5lX3kgKyBmaXJzdF9saW5lX2hlaWdodCArIDIgKyBiYjIuaGVpZ2h0KCkgKyAyKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICMgdGhlbWUgY29sb3JzCiAgICAgICAgdCA9IHNlbGYuZ2V0X3RoZW1lKCkgaWYgaGFzYXR0cihzZWxmLCAnZ2V0X3RoZW1lJykgZWxzZSB7fQogICAgICAgIHRfZWRnZSA9IFFDb2xvcih0LmdldCgnbWFwX2VkZ2UnLCAnIzUwNTA1MCcpKQogICAgICAgIHRfdGV4dCA9IFFDb2xvcih0LmdldCgndGV4dCcsICcjMDAwMDAwJykpCiAgICAgICAgc2VsZi52aWV3LnNldEJhY2tncm91bmRCcnVzaChRQnJ1c2goUUNvbG9yKHQuZ2V0KCdwYW5lbF9iZycsICcjZjVmNWY1JykpKSkKCiAgICAgICAgIyBoZWxwZXI6IGNsaXBwZWQgbGluZSB0byBhdm9pZCBpY29ucy9sYWJlbHMgYXQgZW5kcG9pbnRzCiAgICAgICAgZGVmIGRyYXdfZWRnZShheCwgYXksIGJ4LCBieSwgckEsIHJCLCBsYWJlbF9oX3NyYz0wLjApOgogICAgICAgICAgICBkeCwgZHkgPSAoYngtYXgpLCAoYnktYXkpCiAgICAgICAgICAgIEwgPSAoZHgqZHggKyBkeSpkeSkgKiogMC41CiAgICAgICAgICAgIGlmIEwgPCAxZS02OgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHV4LCB1eSA9IGR4IC8gTCwgZHkgLyBMCiAgICAgICAgICAgIGV4dHJhX3NyYyA9IChsYWJlbF9oX3NyYyArIDYuMCkgaWYgdXkgPiAwIGVsc2UgMC4wICAjIGlmIGdvaW5nIGRvd253YXJkIGZyb20gc291cmNlLCBza2lwIGxhYmVsIGJlbG93CiAgICAgICAgICAgIHN4LCBzeSA9IGF4ICsgdXggKiAockEgKyAyLjAgKyBleHRyYV9zcmMpLCBheSArIHV5ICogKHJBICsgMi4wICsgZXh0cmFfc3JjKQogICAgICAgICAgICBleCwgZXkgPSBieCAtIHV4ICogKHJCICsgMi4wKSwgYnkgLSB1eSAqIChyQiArIDIuMCkKICAgICAgICAgICAgc2VsZi5zY2VuZS5hZGRMaW5lKHN4LCBzeSwgZXgsIGV5LCBwZW5fZWRnZSkKCiAgICAgICAgbXkgPSBiYXNlX2NhbGxzaWduKHNlbGYuZ2V0X215Y2FsbCgpIG9yICJNWUNBTEwiKQogICAgICAgIHBhcmVudHMsIGNoaWxkcmVuLCBlZGdlcyA9IHNlbGYuZ2V0X2xpdmUoKQoKICAgICAgICAjIGxheW91dCBjb25zdGFudHMgKGhhbGYtc2l6ZSwgdGhpY2tlciBib3JkZXJzKQogICAgICAgIFIxLCBSMiA9IDIyMC4wLCAxMjAuMAogICAgICAgIHNpemVfY2VudHJlID0gMTcuMAogICAgICAgIHNpemVfcGFyZW50ID0gMTQuMAogICAgICAgIHNpemVfY2hpbGQgID0gMTEuMAogICAgICAgIGZtID0gUUZvbnRNZXRyaWNzKHNlbGYuZm9udCgpKQogICAgICAgIGxhYmVsX2ggPSBmbS5oZWlnaHQoKQoKICAgICAgICBwZW5fbXkgPSBRUGVuKFFDb2xvcigiY3lhbiIpKTsgcGVuX215LnNldFdpZHRoRig0LjApCiAgICAgICAgcGVuX3BhcmVudCA9IFFQZW4oUUNvbG9yKDAsMjU1LDApKTsgcGVuX3BhcmVudC5zZXRXaWR0aEYoNC4wKSAgICMgbGltZQogICAgICAgIHBlbl9jaGlsZCAgPSBRUGVuKFFDb2xvcigyNTUsMTY1LDApKTsgcGVuX2NoaWxkLnNldFdpZHRoRig0LjApICAjIG9yYW5nZQogICAgICAgIHBlbl9lZGdlICAgPSBRUGVuKHRfZWRnZSk7IHBlbl9lZGdlLnNldFdpZHRoRigxLjIpCiAgICAgICAgYnJ1c2hfdHJhbnNwYXJlbnQgPSBRQnJ1c2goUXQuTm9CcnVzaCkKCiAgICAgICAgcG9zID0ge30KICAgICAgICBjeCwgY3kgPSAwLjAsIDAuMAoKICAgICAgICAjIGNlbnRyZSAoTVlDQUxMKQogICAgICAgIHRyaSA9IHNlbGYuX3RyaWFuZ2xlKGN4LCBjeSwgc2l6ZV9jZW50cmUpCiAgICAgICAgc2VsZi5zY2VuZS5hZGRQb2x5Z29uKHRyaSwgcGVuX215LCBicnVzaF90cmFuc3BhcmVudCkKICAgICAgICB0aXRlbSA9IHNlbGYuc2NlbmUuYWRkVGV4dChteSk7IHRpdGVtLnNldERlZmF1bHRUZXh0Q29sb3IodF90ZXh0KQogICAgICAgIHRiID0gdGl0ZW0uYm91bmRpbmdSZWN0KCkKICAgICAgICB0aXRlbS5zZXRQb3MoY3ggLSB0Yi53aWR0aCgpLzIsIGN5ICsgc2l6ZV9jZW50cmUvMiArIDYpCiAgICAgICAgcl9teSA9IHNpemVfY2VudHJlIC8gKDMqKjAuNSkKICAgICAgICBwb3NbbXldID0gKGN4LCBjeSwgcl9teSkKCiAgICAgICAgIyBwYXJlbnRzIHJpbmcKICAgICAgICBwYXJlbnRfbmFtZXMgPSBzb3J0ZWQocGFyZW50cy5rZXlzKCkpCiAgICAgICAgbiA9IG1heCgxLCBsZW4ocGFyZW50X25hbWVzKSkKICAgICAgICBmb3IgaSwgcCBpbiBlbnVtZXJhdGUocGFyZW50X25hbWVzKToKICAgICAgICAgICAgYW5nID0gKDIqbWF0aC5waSppKS9uCiAgICAgICAgICAgIHB4ID0gY3ggKyBSMSptYXRoLmNvcyhhbmcpOyBweSA9IGN5ICsgUjEqbWF0aC5zaW4oYW5nKQogICAgICAgICAgICByX3NyYyA9IHBvc1tteV1bMl07IHJfZHN0ID0gc2l6ZV9wYXJlbnQgLyAoMyoqMC41KQogICAgICAgICAgICBkcmF3X2VkZ2UoY3gsIGN5LCBweCwgcHksIHJfc3JjLCByX2RzdCwgbGFiZWxfaF9zcmM9bGFiZWxfaCkKICAgICAgICAgICAgcHQgPSBzZWxmLl90cmlhbmdsZShweCwgcHksIHNpemVfcGFyZW50KQogICAgICAgICAgICBzZWxmLnNjZW5lLmFkZFBvbHlnb24ocHQsIHBlbl9wYXJlbnQsIGJydXNoX3RyYW5zcGFyZW50KQogICAgICAgICAgICB0dCA9IHNlbGYuc2NlbmUuYWRkVGV4dChwKTsgdHQuc2V0RGVmYXVsdFRleHRDb2xvcih0X3RleHQpCiAgICAgICAgICAgIGJiID0gdHQuYm91bmRpbmdSZWN0KCkKICAgICAgICAgICAgdHQuc2V0UG9zKHB4IC0gYmIud2lkdGgoKS8yLCBweSArIHNpemVfcGFyZW50LzIgKyA2KQogICAgICAgICAgICBfYWRkX21ldHJpY3NfbGFiZWwocCwgcHgsIHB5ICsgc2l6ZV9wYXJlbnQvMiArIDYsIGJiLmhlaWdodCgpKQogICAgICAgICAgICBwb3NbcF0gPSAocHgsIHB5LCByX2RzdCkKICAgICAgICAgICAga2lkcyA9IHNvcnRlZChjaGlsZHJlbi5nZXQocCwgW10pKQogICAgICAgICAgICBtID0gbWF4KDEsIGxlbihraWRzKSkKICAgICAgICAgICAgZm9yIGosIGMgaW4gZW51bWVyYXRlKGtpZHMpOgogICAgICAgICAgICAgICAgYTIgPSBhbmcgKyAoMiptYXRoLnBpKmopL20gLyAzLjAKICAgICAgICAgICAgICAgIGt4ID0gcHggKyBSMiptYXRoLmNvcyhhMik7IGt5ID0gcHkgKyBSMiptYXRoLnNpbihhMikKICAgICAgICAgICAgICAgIHJfc3JjID0gcG9zW3BdWzJdOyByX2RzdCA9IHNpemVfY2hpbGQgLyAoMyoqMC41KQogICAgICAgICAgICAgICAgZHJhd19lZGdlKHB4LCBweSwga3gsIGt5LCByX3NyYywgcl9kc3QsIGxhYmVsX2hfc3JjPWxhYmVsX2gpCiAgICAgICAgICAgICAgICBrdCA9IHNlbGYuX3RyaWFuZ2xlKGt4LCBreSwgc2l6ZV9jaGlsZCkKICAgICAgICAgICAgICAgIHNlbGYuc2NlbmUuYWRkUG9seWdvbihrdCwgcGVuX2NoaWxkLCBicnVzaF90cmFuc3BhcmVudCkKICAgICAgICAgICAgICAgIHR0MiA9IHNlbGYuc2NlbmUuYWRkVGV4dChjKTsgdHQyLnNldERlZmF1bHRUZXh0Q29sb3IodF90ZXh0KQogICAgICAgICAgICAgICAgYmIyID0gdHQyLmJvdW5kaW5nUmVjdCgpCiAgICAgICAgICAgICAgICB0dDIuc2V0UG9zKGt4IC0gYmIyLndpZHRoKCkvMiwga3kgKyBzaXplX2NoaWxkLzIgKyA2KQogICAgICAgICAgICAgICAgX2FkZF9tZXRyaWNzX2xhYmVsKGMsIGt4LCBreSArIHNpemVfY2hpbGQvMiArIDYsIGJiMi5oZWlnaHQoKSkKICAgICAgICAgICAgICAgIHBvcy5zZXRkZWZhdWx0KGMsIChreCwga3ksIHJfZHN0KSkKCiAgICAgICAgIyBhZGRpdGlvbmFsIGVkZ2VzCiAgICAgICAgZm9yIHNyYywgZHN0IGluIGVkZ2VzOgogICAgICAgICAgICBpZiBzcmMgaW4gcG9zIGFuZCBkc3QgaW4gcG9zOgogICAgICAgICAgICAgICAgeDEsIHkxLCBfID0gcG9zW3NyY107IHgyLCB5MiwgXyA9IHBvc1tkc3RdCiAgICAgICAgICAgICAgICByMSA9IHBvc1tzcmNdWzJdOyByMiA9IHBvc1tkc3RdWzJdCiAgICAgICAgICAgICAgICBkcmF3X2VkZ2UoeDEsIHkxLCB4MiwgeTIsIHIxLCByMiwgbGFiZWxfaF9zcmM9bGFiZWxfaCkKCiAgICAgICAgc2VsZi5yZXNldF92aWV3KCkKCiMgLS0tLS0tLS0tIFRoZW1lIE1hbmFnZXIgLS0tLS0tLS0tCmNsYXNzIFRoZW1lTWFuYWdlcjoKICAgIGRlZiBfX2luaXRfXyhzZWxmKToKICAgICAgICBzZWxmLnRoZW1lcyA9IHsKICAgICAgICAgICAgIkxpZ2h0IjogewogICAgICAgICAgICAgICAgImJnIjogIiNmZmZmZmYiLCAicGFuZWxfYmciOiAiI2Y1ZjVmNSIsICJ0ZXh0IjogIiMwMDAwMDAiLCAiYm9yZGVyIjogIiM0NDQ0NDQiLAogICAgICAgICAgICAgICAgImJ1dHRvbl9iZyI6ICIjZTZlNmU2IiwgImJ1dHRvbl9mZyI6ICIjMDAwMDAwIiwgImlucHV0X2JnIjogIiNmZmZmZmYiLAogICAgICAgICAgICAgICAgIm1hcF9lZGdlIjogIiM1MDUwNTAiCiAgICAgICAgICAgIH0sCiAgICAgICAgICAgICJEYXJrIFJlZCI6IHsKICAgICAgICAgICAgICAgICJiZyI6ICIjMTIxMjEyIiwgInBhbmVsX2JnIjogIiMxZTFlMWUiLCAidGV4dCI6ICIjZmY0ZDRkIiwgImJvcmRlciI6ICIjZmY0ZDRkIiwKICAgICAgICAgICAgICAgICJidXR0b25fYmciOiAiIzJhMmEyYSIsICJidXR0b25fZmciOiAiI2ZmNGQ0ZCIsICJpbnB1dF9iZyI6ICIjMjMyMzIzIiwKICAgICAgICAgICAgICAgICJtYXBfZWRnZSI6ICIjODg0NDQ0IgogICAgICAgICAgICB9LAogICAgICAgICAgICAiRGFyayBHcmVlbiI6IHsKICAgICAgICAgICAgICAgICJiZyI6ICIjMGYxMjEwIiwgInBhbmVsX2JnIjogIiMxNzFhMTgiLCAidGV4dCI6ICIjN0NGQzAwIiwgImJvcmRlciI6ICIjN0NGQzAwIiwKICAgICAgICAgICAgICAgICJidXR0b25fYmciOiAiIzIwMjMyMCIsICJidXR0b25fZmciOiAiIzdDRkMwMCIsICJpbnB1dF9iZyI6ICIjMWIxZTFjIiwKICAgICAgICAgICAgICAgICJtYXBfZWRnZSI6ICIjM2FhMzVhIgogICAgICAgICAgICB9LAogICAgICAgIH0KICAgICAgICBzZWxmLmN1cnJlbnQgPSBzZWxmLnRoZW1lc1siTGlnaHQiXQoKICAgIGRlZiBhcHBseShzZWxmLCB3aW5kb3csIG5hbWU6IHN0cik6CiAgICAgICAgc2VsZi5jdXJyZW50ID0gc2VsZi50aGVtZXMuZ2V0KG5hbWUsIHNlbGYudGhlbWVzWyJMaWdodCJdKQogICAgICAgIHQgPSBzZWxmLmN1cnJlbnQKICAgICAgICBmcHQgPSBnZXRhdHRyKHdpbmRvdywgIl9mb250X3B0IiwgMTIpCiAgICAgICAgCiAgICAgICAgbXQgID0gbWF4KDEyLCBmcHQgKyA4KQogICAgICAgIHBhZCA9IG1heCg0LCAgZnB0IC8vIDIpCiAgICAgICAgCiAgICAgICAgcXNzID0gZicnJwogICAgICAgIFFXaWRnZXQge3sgYmFja2dyb3VuZDoge3RbJ2JnJ119OyBjb2xvcjoge3RbJ3RleHQnXX07IGZvbnQ6IDEycHQgIlZUMzIzIjsgfX0KICAgICAgICBRR3JvdXBCb3gge3sgYmFja2dyb3VuZDoge3RbJ3BhbmVsX2JnJ119OyBib3JkZXI6IDFweCBzb2xpZCB7dFsnYm9yZGVyJ119OyBib3JkZXItcmFkaXVzOiA2cHg7IG1hcmdpbi10b3A6IDE2cHg7IH19CiAgICAgICAgUUdyb3VwQm94Ojp0aXRsZSB7eyBzdWJjb250cm9sLW9yaWdpbjogbWFyZ2luOyBsZWZ0OiA4cHg7IHBhZGRpbmc6IDAgOHB4OyB9fQogICAgICAgIFFQdXNoQnV0dG9uIHt7IGJhY2tncm91bmQ6IHt0WydidXR0b25fYmcnXX07IGNvbG9yOiB7dFsnYnV0dG9uX2ZnJ119OyBib3JkZXI6IDFweCBzb2xpZCB7dFsnYm9yZGVyJ119OyBib3JkZXItcmFkaXVzOiA2cHg7IHBhZGRpbmc6IDRweCAxMHB4OyB9fQogICAgICAgIFFMaW5lRWRpdCwgUVRleHRFZGl0IHt7IGJhY2tncm91bmQ6IHt0WydpbnB1dF9iZyddfTsgY29sb3I6IHt0Wyd0ZXh0J119OyBib3JkZXI6IDFweCBzb2xpZCB7dFsnYm9yZGVyJ119OyBib3JkZXItcmFkaXVzOiA2cHg7IH19CiAgICAgICAgUUxpc3RXaWRnZXQge3sgYmFja2dyb3VuZDoge3RbJ2lucHV0X2JnJ119OyBjb2xvcjoge3RbJ3RleHQnXX07IGJvcmRlcjogMXB4IHNvbGlkIHt0Wydib3JkZXInXX07IGJvcmRlci1yYWRpdXM6IDZweDsgfX0KICAgICAgICBRVG9vbEJhciB7eyBiYWNrZ3JvdW5kOiB7dFsncGFuZWxfYmcnXX07IGJvcmRlci1ib3R0b206IDFweCBzb2xpZCB7dFsnYm9yZGVyJ119OyB9fQogICAgICAgIFFUYWJCYXI6OnRhYiB7eyBiYWNrZ3JvdW5kOiB7dFsncGFuZWxfYmcnXX07IGNvbG9yOiB7dFsndGV4dCddfTsgcGFkZGluZzogNHB4IDEwcHg7IG1hcmdpbjogMnB4OyBib3JkZXI6IDFweCBzb2xpZCB7dFsnYm9yZGVyJ119OyBib3JkZXItYm90dG9tOiBub25lOyB9fQogICAgICAgIFFUYWJCYXI6OnRhYjpzZWxlY3RlZCB7eyBiYWNrZ3JvdW5kOiB7dFsnYmcnXX07IH19CiAgICAgICAgUVN0YXR1c0JhciB7eyBiYWNrZ3JvdW5kOiB7dFsncGFuZWxfYmcnXX07IGNvbG9yOiB7dFsndGV4dCddfTsgYm9yZGVyLXRvcDogMXB4IHNvbGlkIHt0Wydib3JkZXInXX07IH19CiAgICAgICAgJycnCgogICAgICAgIHRyeToKICAgICAgICAgICAgd2luZG93LnNldFN0eWxlU2hlZXQocXNzKQogICAgICAgICAgICBfaW5zdGFsbF92dDMyM19mb250KCkKICAgICAgICAgICAgZnJvbSBQeVF0NS5RdEd1aSBpbXBvcnQgUUZvbnQKICAgICAgICAgICAgd2luZG93LnNldEZvbnQoUUZvbnQoJ1ZUMzIzJywgMTIpKQogICAgICAgICAgICBfbG9nX2ZvbnRfc25hcHNob3QoJ2FwcGx5X3RoZW1lX2FmdGVyX3NldEZvbnQnLCB3aW5kb3cpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBjb2xvcihzZWxmLCBrZXksIGRlZmF1bHQ9IiM4MDgwODAiKToKICAgICAgICByZXR1cm4gc2VsZi5jdXJyZW50LmdldChrZXksIGRlZmF1bHQpCgojIC0tLS0tLS0tLSBNYWluIEFwcCAtLS0tLS0tLS0KIyAtLS0tLS0tLS0tIEFDSyBzdGF0ZSAoaW5zZXJ0ZWQpIC0tLS0tLS0tLS0KQUNLX1RBR19SRSA9IHJlLmNvbXBpbGUociJcW0FDSzooW0EtWmEtejAtOV17NCwxMH0pXF0iKQpERV9NU0dfUkUgPSByZS5jb21waWxlKHIiXlxzKihbQS1aMC05XXsxLDZ9KD86LVswLTldezEsMn0pPylccytERVxzKyhbQS1aMC05XXsxLDZ9KD86LVswLTldezEsMn0pPylccysoLis/KSg/OlxzK1xbQUNLWzpcc10/KFtBLVowLTldezEsMTB9KVxdKT9ccyokIiwgcmUuSSkKCmNsYXNzIEFja1N0YXRlOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFwcCwgYWNrX2lkOiBzdHIsIGJhc2VfdGV4dDogc3RyLCBwYXVzZV9zOiBpbnQpOgogICAgICAgIGZyb20gUHlRdDUuUXRDb3JlIGltcG9ydCBRVGltZXIKICAgICAgICBzZWxmLmFwcCA9IGFwcAogICAgICAgIHNlbGYuYWNrX2lkID0gYWNrX2lkCiAgICAgICAgc2VsZi5iYXNlX3RleHQgPSBiYXNlX3RleHQKICAgICAgICBzZWxmLnBhdXNlX3MgPSBtYXgoMSwgaW50KHBhdXNlX3MpKQogICAgICAgIHNlbGYubWF4X2F0dGVtcHRzID0gMwogICAgICAgIHNlbGYuYXR0ZW1wdHMgPSAwCiAgICAgICAgc2VsZi5kb25lID0gRmFsc2UKICAgICAgICBzZWxmLnRpbWVyID0gUVRpbWVyKCkKICAgICAgICBzZWxmLnRpbWVyLnNldFNpbmdsZVNob3QoVHJ1ZSkKICAgICAgICBzZWxmLnRpbWVyLnRpbWVvdXQuY29ubmVjdChzZWxmLl9vbl9yZXRyeSkKICAgICAgICBzZWxmLmVjaG9fdGV4dHMgPSBzZXQoKQoKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICBzZWxmLl9zZW5kX2F0dGVtcHQoKQoKICAgIGRlZiBfc2VuZF9hdHRlbXB0KHNlbGYpOgogICAgICAgIGlmIHNlbGYuZG9uZTogcmV0dXJuCiAgICAgICAgc2VsZi5hdHRlbXB0cyArPSAxCiAgICAgICAgbGluZSA9IGYie3NlbGYuYmFzZV90ZXh0fSAoYXR0ZW1wdCB7c2VsZi5hdHRlbXB0c30vMykiCiAgICAgICAgaWYgc2VsZi5hcHAuc2VuZF91c2VyX3RleHQobGluZSk6CiAgICAgICAgICAgIHNlbGYuZWNob190ZXh0cy5hZGQoc2VsZi5fbm9ybShsaW5lKSkKICAgICAgICAgICAgaW1wb3J0IHRpbWUKICAgICAgICAgICAgc2VsZi5sYXN0X3R4X3RpbWUgPSB0aW1lLm1vbm90b25pYygpCiAgICAgICAgICAgIHNlbGYuYXBwLl9hY2tfdXBkYXRlX3VpKHNlbGYuYWNrX2lkLCBsaW5lLCBzdGF0dXM9ZiJhdHRlbXB0IHtzZWxmLmF0dGVtcHRzfS8zIikKICAgICAgICAgICAgaW1wb3J0IHJhbmRvbQogICAgICAgICAgICBkZWxheSA9IHNlbGYucGF1c2VfcyArIHJhbmRvbS51bmlmb3JtKDAuMiwgMC43KQogICAgICAgICAgICBzZWxmLnRpbWVyLnN0YXJ0KGludChkZWxheSoxMDAwKSkKICAgICAgICAgICAgc2VsZi5hcHAuX2RpYWcoZiJbQUNLXSBhcm1pbmcgcmV0cnkgaW4ge2RlbGF5Oi4yZn1zIGZvciB7c2VsZi5hY2tfaWR9IikKICAgICAgICBlbHNlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmFwcC5fZGlhZyhmIltBQ0tdIHNlbmQgZmFpbGVkIG9uIGF0dGVtcHQge3NlbGYuYXR0ZW1wdHN9LzMgKHNlcmlhbCBjbG9zZWQ/KSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHNlbGYudGltZXIuc3RhcnQoMTAwMCkKCiAgICBkZWYgX29uX3JldHJ5KHNlbGYpOgogICAgICAgIGlmIHNlbGYuZG9uZTogcmV0dXJuCiAgICAgICAgaWYgc2VsZi5hdHRlbXB0cyA8IHNlbGYubWF4X2F0dGVtcHRzOgogICAgICAgICAgICBzZWxmLmFwcC5fZGlhZyhmIltSRVRSWV0ge3NlbGYuYWNrX2lkfSB7c2VsZi5hdHRlbXB0cysxfS8zIikKICAgICAgICAgICAgc2VsZi5fc2VuZF9hdHRlbXB0KCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmRvbmUgPSBUcnVlCiAgICAgICAgICAgIHRleHQgPSBmIntzZWxmLmJhc2VfdGV4dH0gKEZBSUxFRCBhZnRlciAzLzMpIgogICAgICAgICAgICBzZWxmLmFwcC5fYWNrX3VwZGF0ZV91aShzZWxmLmFja19pZCwgdGV4dCwgc3RhdHVzPSJmYWlsZWQiKQogICAgICAgICAgICBzZWxmLmFwcC5fZGlhZyhmIltBQ0tdIGdpdmluZyB1cCB7c2VsZi5hY2tfaWR9IGFmdGVyIDMvMyIpCgogICAgZGVmIG9uX2Fja19yZWNlaXZlZChzZWxmKToKICAgICAgICBpZiBzZWxmLmRvbmU6IHJldHVybgogICAgICAgIHNlbGYuZG9uZSA9IFRydWUKICAgICAgICBzZWxmLnRpbWVyLnN0b3AoKQogICAgICAgIHRleHQgPSBmIntzZWxmLmJhc2VfdGV4dH0gKEFDSyByZWNlaXZlZCB7c2VsZi5hY2tfaWR9KSIKICAgICAgICBzZWxmLmFwcC5fYWNrX3VwZGF0ZV91aShzZWxmLmFja19pZCwgdGV4dCwgc3RhdHVzPSJhY2siKQoKICAgIGRlZiBfbm9ybShzZWxmLCBzOiBzdHIpIC0+IHN0cjoKICAgICAgICByZXR1cm4gcmUuc3ViKHIiW1xyXG5dKyIsICIiLCBzKS5zdHJpcCgpCgojIC0tLSBOZXR3b3JrIEdyYXBoIHdpZGdldCAoZmFsbGJhY2svcG9ydGFibGUpIC0tLQojIFByb3ZpZGVzIGEgbWluaW1hbCB2aWV3ZXIgZm9yIHRoZSBsaW5rIGdyYXBoIHdoZW4gYSBmdWxsIExpbmtNYXBXaWRnZXQgaXNuJ3QgcHJvdmlkZWQgYnkgbW9kdWxlcy4KZnJvbSBQeVF0NS5RdFdpZGdldHMgaW1wb3J0IFFXaWRnZXQsIFFWQm94TGF5b3V0LCBRTGFiZWwsIFFHcmFwaGljc1ZpZXcsIFFHcmFwaGljc1NjZW5lCmZyb20gUHlRdDUuUXRHdWkgaW1wb3J0IFFQZW4sIFFCcnVzaCwgUUNvbG9yLCBRRm9udApmcm9tIFB5UXQ1LlF0Q29yZSBpbXBvcnQgUXQsIFFUaW1lciwgUVBvaW50RgoKY2xhc3MgTGlua01hcFdpZGdldChRV2lkZ2V0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBnZXRfbXljYWxsLCBnZXRfbGl2ZSwgZ2V0X3RoZW1lKToKICAgICAgICBzdXBlcigpLl9faW5pdF9fKCkKICAgICAgICAjIEFDSy9SZXRyeSArIEF1dG8tQUNLIHN0YXRlCiAgICAgICAgc2VsZi5hY2tfY291bnRlciA9IDEKICAgICAgICBzZWxmLnNlbnRfYnlfYWNrID0ge30KICAgICAgICBzZWxmLnJldHJ5X3RpbWVycyA9IHt9CiAgICAgICAgc2VsZi5fYWNrX3BhdXNlX2RlZmF1bHQgPSAxMi4wCiAgICAgICAgc2VsZi5fYWNrX3NlbnQgPSB7fQogICAgICAgIHNlbGYuX2Fja19zZW50X3R0bCA9IDYwMC4wCiAgICAgICAgc2VsZi5nZXRfbXljYWxsID0gZ2V0X215Y2FsbAogICAgICAgIHNlbGYuZ2V0X2xpdmUgPSBnZXRfbGl2ZQogICAgICAgIHNlbGYuZ2V0X3RoZW1lID0gZ2V0X3RoZW1lCiAgICAgICAgdiA9IFFWQm94TGF5b3V0KHNlbGYpCiAgICAgICAgY3RybCA9IFFIQm94TGF5b3V0KCkKICAgICAgICBzZWxmLnpvb21faW4gPSBRUHVzaEJ1dHRvbigiKyIpCiAgICAgICAgc2VsZi56b29tX291dCA9IFFQdXNoQnV0dG9uKCItIikKICAgICAgICBzZWxmLnJlc2V0X2J0biA9IFFQdXNoQnV0dG9uKCJSRVNFVCIpCiAgICAgICAgZm9yIGIgaW4gKHNlbGYuem9vbV9pbiwgc2VsZi56b29tX291dCwgc2VsZi5yZXNldF9idG4pOgogICAgICAgICAgICBiLnNldFNpemVQb2xpY3koUVNpemVQb2xpY3kuTWluaW11bSwgUVNpemVQb2xpY3kuTWluaW11bSkKICAgICAgICBjdHJsLmFkZFdpZGdldChzZWxmLnpvb21faW4pOyBjdHJsLmFkZFdpZGdldChzZWxmLnpvb21fb3V0KTsgY3RybC5hZGRXaWRnZXQoc2VsZi5yZXNldF9idG4pOyBjdHJsLmFkZFN0cmV0Y2goMSkKICAgICAgICB2LmFkZExheW91dChjdHJsKQogICAgICAgIHNlbGYuc2NlbmUgPSBRR3JhcGhpY3NTY2VuZSgpCiAgICAgICAgc2VsZi52aWV3ID0gUUdyYXBoaWNzVmlldyhzZWxmLnNjZW5lKQogICAgICAgIHNlbGYudmlldy5zZXRTaXplUG9saWN5KFFTaXplUG9saWN5LkV4cGFuZGluZywgUVNpemVQb2xpY3kuUHJlZmVycmVkKQogICAgICAgIHNlbGYudmlldy5zZXRNaW5pbXVtU2l6ZSgzMDAsIDIyMCkKICAgICAgICBzZWxmLnZpZXcuc2V0SG9yaXpvbnRhbFNjcm9sbEJhclBvbGljeShRdC5TY3JvbGxCYXJBc05lZWRlZCkKICAgICAgICBzZWxmLnZpZXcuc2V0VmVydGljYWxTY3JvbGxCYXJQb2xpY3koUXQuU2Nyb2xsQmFyQXNOZWVkZWQpCiAgICAgICAgdi5hZGRXaWRnZXQoc2VsZi52aWV3LCAxKQogICAgICAgIHNlbGYuem9vbV9pbi5jbGlja2VkLmNvbm5lY3QobGFtYmRhOiBzZWxmLnZpZXcuc2NhbGUoMS4xNSwgMS4xNSkpCiAgICAgICAgc2VsZi56b29tX291dC5jbGlja2VkLmNvbm5lY3QobGFtYmRhOiBzZWxmLnZpZXcuc2NhbGUoMS8xLjE1LCAxLzEuMTUpKQogICAgICAgIHNlbGYucmVzZXRfYnRuLmNsaWNrZWQuY29ubmVjdChzZWxmLnJlc2V0X3ZpZXcpCiAgICAgICAgc2VsZi5kcmF3X2dyYXBoKCkKCiAgICBkZWYgcmVzZXRfdmlldyhzZWxmKToKICAgICAgICBzZWxmLnZpZXcucmVzZXRUcmFuc2Zvcm0oKQogICAgICAgIHIgPSBzZWxmLnNjZW5lLml0ZW1zQm91bmRpbmdSZWN0KCkKICAgICAgICBpZiByLmlzVmFsaWQoKToKICAgICAgICAgICAgc2VsZi52aWV3LmZpdEluVmlldyhyLmFkanVzdGVkKC00MCwgLTQwLCA0MCwgNDApLCBRdC5LZWVwQXNwZWN0UmF0aW8pCgogICAgZGVmIF90cmlhbmdsZShzZWxmLCBjeCwgY3ksIHNpemUpOgogICAgICAgIGggPSBzaXplCiAgICAgICAgciA9IGggLyAoMyoqMC41KSAgIyByYWRpdXMgcmVsYXRpb24gZm9yIGVxdWlsYXRlcmFsCiAgICAgICAgcHRzID0gW10KICAgICAgICBmb3IgayBpbiByYW5nZSgzKToKICAgICAgICAgICAgYW5nID0gLW1hdGgucGkvMiArIGsgKiAyKm1hdGgucGkvMyAgIyBwb2ludCB1cAogICAgICAgICAgICBwdHMuYXBwZW5kKFFQb2ludEYoY3ggKyByKm1hdGguY29zKGFuZyksIGN5ICsgciptYXRoLnNpbihhbmcpKSkKICAgICAgICByZXR1cm4gUVBvbHlnb25GKHB0cykKCiAgICBkZWYgZHJhd19ncmFwaChzZWxmKToKICAgICAgICBzZWxmLnNjZW5lLmNsZWFyKCkKICAgICAgICAjIHRoZW1lIGNvbG9ycwogICAgICAgIHQgPSBzZWxmLmdldF90aGVtZSgpIGlmIGhhc2F0dHIoc2VsZiwgJ2dldF90aGVtZScpIGVsc2Uge30KICAgICAgICB0X2VkZ2UgPSBRQ29sb3IodC5nZXQoJ21hcF9lZGdlJywgJyM1MDUwNTAnKSkKICAgICAgICB0X3RleHQgPSBRQ29sb3IodC5nZXQoJ3RleHQnLCAnIzAwMDAwMCcpKQogICAgICAgIHNlbGYudmlldy5zZXRCYWNrZ3JvdW5kQnJ1c2goUUJydXNoKFFDb2xvcih0LmdldCgncGFuZWxfYmcnLCAnI2Y1ZjVmNScpKSkpCgogICAgICAgICMgaGVscGVyOiBjbGlwcGVkIGxpbmUgdG8gYXZvaWQgaWNvbnMvbGFiZWxzIGF0IGVuZHBvaW50cwogICAgICAgIGRlZiBkcmF3X2VkZ2UoYXgsIGF5LCBieCwgYnksIHJBLCByQiwgbGFiZWxfaF9zcmM9MC4wKToKICAgICAgICAgICAgZHgsIGR5ID0gKGJ4LWF4KSwgKGJ5LWF5KQogICAgICAgICAgICBMID0gKGR4KmR4ICsgZHkqZHkpICoqIDAuNQogICAgICAgICAgICBpZiBMIDwgMWUtNjoKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICB1eCwgdXkgPSBkeCAvIEwsIGR5IC8gTAogICAgICAgICAgICBleHRyYV9zcmMgPSAobGFiZWxfaF9zcmMgKyA2LjApIGlmIHV5ID4gMCBlbHNlIDAuMCAgIyBpZiBnb2luZyBkb3dud2FyZCBmcm9tIHNvdXJjZSwgc2tpcCBsYWJlbCBiZWxvdwogICAgICAgICAgICBzeCwgc3kgPSBheCArIHV4ICogKHJBICsgMi4wICsgZXh0cmFfc3JjKSwgYXkgKyB1eSAqIChyQSArIDIuMCArIGV4dHJhX3NyYykKICAgICAgICAgICAgZXgsIGV5ID0gYnggLSB1eCAqIChyQiArIDIuMCksIGJ5IC0gdXkgKiAockIgKyAyLjApCiAgICAgICAgICAgIHNlbGYuc2NlbmUuYWRkTGluZShzeCwgc3ksIGV4LCBleSwgcGVuX2VkZ2UpCgogICAgICAgIG15ID0gYmFzZV9jYWxsc2lnbihzZWxmLmdldF9teWNhbGwoKSBvciAiTVlDQUxMIikKICAgICAgICBwYXJlbnRzLCBjaGlsZHJlbiwgZWRnZXMgPSBzZWxmLmdldF9saXZlKCkKCiAgICAgICAgIyBsYXlvdXQgY29uc3RhbnRzIChoYWxmLXNpemUsIHRoaWNrZXIgYm9yZGVycykKICAgICAgICBSMSwgUjIgPSAyMjAuMCwgMTIwLjAKICAgICAgICBzaXplX2NlbnRyZSA9IDE3LjAKICAgICAgICBzaXplX3BhcmVudCA9IDE0LjAKICAgICAgICBzaXplX2NoaWxkICA9IDExLjAKICAgICAgICBmbSA9IFFGb250TWV0cmljcyhzZWxmLmZvbnQoKSkKICAgICAgICBsYWJlbF9oID0gZm0uaGVpZ2h0KCkKCiAgICAgICAgcGVuX215ID0gUVBlbihRQ29sb3IoImN5YW4iKSk7IHBlbl9teS5zZXRXaWR0aEYoNC4wKQogICAgICAgIHBlbl9wYXJlbnQgPSBRUGVuKFFDb2xvcigwLDI1NSwwKSk7IHBlbl9wYXJlbnQuc2V0V2lkdGhGKDQuMCkgICAjIGxpbWUKICAgICAgICBwZW5fY2hpbGQgID0gUVBlbihRQ29sb3IoMjU1LDE2NSwwKSk7IHBlbl9jaGlsZC5zZXRXaWR0aEYoNC4wKSAgIyBvcmFuZ2UKICAgICAgICBwZW5fZWRnZSAgID0gUVBlbih0X2VkZ2UpOyBwZW5fZWRnZS5zZXRXaWR0aEYoMS4yKQogICAgICAgIGJydXNoX3RyYW5zcGFyZW50ID0gUUJydXNoKFF0Lk5vQnJ1c2gpCgogICAgICAgIHBvcyA9IHt9CiAgICAgICAgY3gsIGN5ID0gMC4wLCAwLjAKCiAgICAgICAgIyBjZW50cmUgKE1ZQ0FMTCkKICAgICAgICB0cmkgPSBzZWxmLl90cmlhbmdsZShjeCwgY3ksIHNpemVfY2VudHJlKQogICAgICAgIHNlbGYuc2NlbmUuYWRkUG9seWdvbih0cmksIHBlbl9teSwgYnJ1c2hfdHJhbnNwYXJlbnQpCiAgICAgICAgdGl0ZW0gPSBzZWxmLnNjZW5lLmFkZFRleHQobXkpOyB0aXRlbS5zZXREZWZhdWx0VGV4dENvbG9yKHRfdGV4dCkKICAgICAgICB0YiA9IHRpdGVtLmJvdW5kaW5nUmVjdCgpCiAgICAgICAgdGl0ZW0uc2V0UG9zKGN4IC0gdGIud2lkdGgoKS8yLCBjeSArIHNpemVfY2VudHJlLzIgKyA2KQogICAgICAgIHJfbXkgPSBzaXplX2NlbnRyZSAvICgzKiowLjUpCiAgICAgICAgcG9zW215XSA9IChjeCwgY3ksIHJfbXkpCgogICAgICAgICMgcGFyZW50cyByaW5nCiAgICAgICAgcGFyZW50X25hbWVzID0gc29ydGVkKHBhcmVudHMua2V5cygpKQogICAgICAgIG4gPSBtYXgoMSwgbGVuKHBhcmVudF9uYW1lcykpCiAgICAgICAgZm9yIGksIHAgaW4gZW51bWVyYXRlKHBhcmVudF9uYW1lcyk6CiAgICAgICAgICAgIGFuZyA9ICgyKm1hdGgucGkqaSkvbgogICAgICAgICAgICBweCA9IGN4ICsgUjEqbWF0aC5jb3MoYW5nKTsgcHkgPSBjeSArIFIxKm1hdGguc2luKGFuZykKICAgICAgICAgICAgcl9zcmMgPSBwb3NbbXldWzJdOyByX2RzdCA9IHNpemVfcGFyZW50IC8gKDMqKjAuNSkKICAgICAgICAgICAgZHJhd19lZGdlKGN4LCBjeSwgcHgsIHB5LCByX3NyYywgcl9kc3QsIGxhYmVsX2hfc3JjPWxhYmVsX2gpCiAgICAgICAgICAgIHB0ID0gc2VsZi5fdHJpYW5nbGUocHgsIHB5LCBzaXplX3BhcmVudCkKICAgICAgICAgICAgc2VsZi5zY2VuZS5hZGRQb2x5Z29uKHB0LCBwZW5fcGFyZW50LCBicnVzaF90cmFuc3BhcmVudCkKICAgICAgICAgICAgdHQgPSBzZWxmLnNjZW5lLmFkZFRleHQocCk7IHR0LnNldERlZmF1bHRUZXh0Q29sb3IodF90ZXh0KQogICAgICAgICAgICBiYiA9IHR0LmJvdW5kaW5nUmVjdCgpCiAgICAgICAgICAgIHR0LnNldFBvcyhweCAtIGJiLndpZHRoKCkvMiwgcHkgKyBzaXplX3BhcmVudC8yICsgNikKICAgICAgICAgICAgcG9zW3BdID0gKHB4LCBweSwgcl9kc3QpCiAgICAgICAgICAgIGtpZHMgPSBzb3J0ZWQoY2hpbGRyZW4uZ2V0KHAsIFtdKSkKICAgICAgICAgICAgbSA9IG1heCgxLCBsZW4oa2lkcykpCiAgICAgICAgICAgIGZvciBqLCBjIGluIGVudW1lcmF0ZShraWRzKToKICAgICAgICAgICAgICAgIGEyID0gYW5nICsgKDIqbWF0aC5waSpqKS9tIC8gMy4wCiAgICAgICAgICAgICAgICBreCA9IHB4ICsgUjIqbWF0aC5jb3MoYTIpOyBreSA9IHB5ICsgUjIqbWF0aC5zaW4oYTIpCiAgICAgICAgICAgICAgICByX3NyYyA9IHBvc1twXVsyXTsgcl9kc3QgPSBzaXplX2NoaWxkIC8gKDMqKjAuNSkKICAgICAgICAgICAgICAgIGRyYXdfZWRnZShweCwgcHksIGt4LCBreSwgcl9zcmMsIHJfZHN0LCBsYWJlbF9oX3NyYz1sYWJlbF9oKQogICAgICAgICAgICAgICAga3QgPSBzZWxmLl90cmlhbmdsZShreCwga3ksIHNpemVfY2hpbGQpCiAgICAgICAgICAgICAgICBzZWxmLnNjZW5lLmFkZFBvbHlnb24oa3QsIHBlbl9jaGlsZCwgYnJ1c2hfdHJhbnNwYXJlbnQpCiAgICAgICAgICAgICAgICB0dDIgPSBzZWxmLnNjZW5lLmFkZFRleHQoYyk7IHR0Mi5zZXREZWZhdWx0VGV4dENvbG9yKHRfdGV4dCkKICAgICAgICAgICAgICAgIGJiMiA9IHR0Mi5ib3VuZGluZ1JlY3QoKQogICAgICAgICAgICAgICAgdHQyLnNldFBvcyhreCAtIGJiMi53aWR0aCgpLzIsIGt5ICsgc2l6ZV9jaGlsZC8yICsgNikKICAgICAgICAgICAgICAgIHBvcy5zZXRkZWZhdWx0KGMsIChreCwga3ksIHJfZHN0KSkKCiAgICAgICAgIyBhZGRpdGlvbmFsIGVkZ2VzCiAgICAgICAgZm9yIHNyYywgZHN0IGluIGVkZ2VzOgogICAgICAgICAgICBpZiBzcmMgaW4gcG9zIGFuZCBkc3QgaW4gcG9zOgogICAgICAgICAgICAgICAgeDEsIHkxLCBfID0gcG9zW3NyY107IHgyLCB5MiwgXyA9IHBvc1tkc3RdCiAgICAgICAgICAgICAgICByMSA9IHBvc1tzcmNdWzJdOyByMiA9IHBvc1tkc3RdWzJdCiAgICAgICAgICAgICAgICBkcmF3X2VkZ2UoeDEsIHkxLCB4MiwgeTIsIHIxLCByMiwgbGFiZWxfaF9zcmM9bGFiZWxfaCkKCiAgICAgICAgc2VsZi5yZXNldF92aWV3KCkKCiMgLS0tLS0tLS0tIFRoZW1lIE1hbmFnZXIgLS0tLS0tLS0tCiMgKFJlbW92ZWQgZHVwbGljYXRlIFRoZW1lTWFuYWdlciBjbGFzcykKCmNsYXNzIEFja1N0YXRlOgogICAgZGVmIF9faW5pdF9fKHNlbGYsIGFwcCwgYWNrX2lkOiBzdHIsIGJhc2VfdGV4dDogc3RyLCBwYXVzZV9zOiBpbnQpOgogICAgICAgIGZyb20gUHlRdDUuUXRDb3JlIGltcG9ydCBRVGltZXIKICAgICAgICBzZWxmLmFwcCA9IGFwcAogICAgICAgIHNlbGYuYWNrX2lkID0gYWNrX2lkCiAgICAgICAgc2VsZi5iYXNlX3RleHQgPSBiYXNlX3RleHQKICAgICAgICBzZWxmLnBhdXNlX3MgPSBtYXgoMSwgaW50KHBhdXNlX3MpKQogICAgICAgIHNlbGYubWF4X2F0dGVtcHRzID0gMwogICAgICAgIHNlbGYuYXR0ZW1wdHMgPSAwCiAgICAgICAgc2VsZi5kb25lID0gRmFsc2UKICAgICAgICBzZWxmLnRpbWVyID0gUVRpbWVyKCkKICAgICAgICBzZWxmLnRpbWVyLnNldFNpbmdsZVNob3QoVHJ1ZSkKICAgICAgICBzZWxmLnRpbWVyLnRpbWVvdXQuY29ubmVjdChzZWxmLl9vbl9yZXRyeSkKICAgICAgICBzZWxmLmVjaG9fdGV4dHMgPSBzZXQoKQoKICAgIGRlZiBzdGFydChzZWxmKToKICAgICAgICBzZWxmLl9zZW5kX2F0dGVtcHQoKQoKICAgIGRlZiBfc2VuZF9hdHRlbXB0KHNlbGYpOgogICAgICAgIGlmIHNlbGYuZG9uZTogcmV0dXJuCiAgICAgICAgc2VsZi5hdHRlbXB0cyArPSAxCiAgICAgICAgbGluZSA9IGYie3NlbGYuYmFzZV90ZXh0fSAoYXR0ZW1wdCB7c2VsZi5hdHRlbXB0c30vMykiCiAgICAgICAgaWYgc2VsZi5hcHAuc2VuZF91c2VyX3RleHQobGluZSk6CiAgICAgICAgICAgIHNlbGYuZWNob190ZXh0cy5hZGQoc2VsZi5fbm9ybShsaW5lKSkKICAgICAgICAgICAgaW1wb3J0IHRpbWUKICAgICAgICAgICAgc2VsZi5sYXN0X3R4X3RpbWUgPSB0aW1lLm1vbm90b25pYygpCiAgICAgICAgICAgIHNlbGYuYXBwLl9hY2tfdXBkYXRlX3VpKHNlbGYuYWNrX2lkLCBsaW5lLCBzdGF0dXM9ZiJhdHRlbXB0IHtzZWxmLmF0dGVtcHRzfS8zIikKICAgICAgICAgICAgaW1wb3J0IHJhbmRvbQogICAgICAgICAgICBkZWxheSA9IHNlbGYucGF1c2VfcyArIHJhbmRvbS51bmlmb3JtKDAuMiwgMC43KQogICAgICAgICAgICBzZWxmLnRpbWVyLnN0YXJ0KGludChkZWxheSoxMDAwKSkKICAgICAgICAgICAgc2VsZi5hcHAuX2RpYWcoZiJbQUNLXSBhcm1pbmcgcmV0cnkgaW4ge2RlbGF5Oi4yZn1zIGZvciB7c2VsZi5hY2tfaWR9IikKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLnRpbWVyLnN0YXJ0KDEwMDApCgogICAgZGVmIF9vbl9yZXRyeShzZWxmKToKICAgICAgICBpZiBzZWxmLmRvbmU6IHJldHVybgogICAgICAgIGlmIHNlbGYuYXR0ZW1wdHMgPCBzZWxmLm1heF9hdHRlbXB0czoKICAgICAgICAgICAgc2VsZi5hcHAuX2RpYWcoZiJbUkVUUlldIHtzZWxmLmFja19pZH0ge3NlbGYuYXR0ZW1wdHMrMX0vMyIpCiAgICAgICAgICAgIHNlbGYuX3NlbmRfYXR0ZW1wdCgpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5kb25lID0gVHJ1ZQogICAgICAgICAgICB0ZXh0ID0gZiJ7c2VsZi5iYXNlX3RleHR9IChGQUlMRUQgYWZ0ZXIgMy8zKSIKICAgICAgICAgICAgc2VsZi5hcHAuX2Fja191cGRhdGVfdWkoc2VsZi5hY2tfaWQsIHRleHQsIHN0YXR1cz0iZmFpbGVkIikKICAgICAgICAgICAgc2VsZi5hcHAuX2RpYWcoZiJbQUNLXSBnaXZpbmcgdXAge3NlbGYuYWNrX2lkfSBhZnRlciAzLzMiKQoKICAgIGRlZiBvbl9hY2tfcmVjZWl2ZWQoc2VsZik6CiAgICAgICAgaWYgc2VsZi5kb25lOiByZXR1cm4KICAgICAgICBzZWxmLmRvbmUgPSBUcnVlCiAgICAgICAgc2VsZi50aW1lci5zdG9wKCkKICAgICAgICB0ZXh0ID0gZiJ7c2VsZi5iYXNlX3RleHR9IChBQ0sgcmVjZWl2ZWQge3NlbGYuYWNrX2lkfSkiCiAgICAgICAgc2VsZi5hcHAuX2Fja191cGRhdGVfdWkoc2VsZi5hY2tfaWQsIHRleHQsIHN0YXR1cz0iYWNrIikKCiAgICBkZWYgX25vcm0oc2VsZiwgczogc3RyKSAtPiBzdHI6CiAgICAgICAgcmV0dXJuIHJlLnN1YihyIltcclxuXSsiLCAiIiwgcykuc3RyaXAoKQoKIyA9PT0gUm9idXN0IENoYXQgU2VjdXJlIENyeXB0byBIZWxwZXJzIChBRVMtMjU2LUdDTSBwcmVmZXJyZWQpID09PQppbXBvcnQgb3MsIGhtYWMsIGhhc2hsaWIsIGJhc2U2NApkZWYgX2tkZl9oa2RmX3NoYTI1NihwYXNzcGhyYXNlOiBzdHIsIHNhbHQ6IGJ5dGVzLCBsZW5ndGg6IGludCA9IDMyKSAtPiBieXRlczoKICAgIHRyeToKICAgICAgICBmcm9tIGNyeXB0b2dyYXBoeS5oYXptYXQucHJpbWl0aXZlcy5rZGYuaGtkZiBpbXBvcnQgSEtERgogICAgICAgIGZyb20gY3J5cHRvZ3JhcGh5Lmhhem1hdC5wcmltaXRpdmVzIGltcG9ydCBoYXNoZXMKICAgICAgICBmcm9tIGNyeXB0b2dyYXBoeS5oYXptYXQuYmFja2VuZHMgaW1wb3J0IGRlZmF1bHRfYmFja2VuZAogICAgICAgIGhrZGYgPSBIS0RGKGFsZ29yaXRobT1oYXNoZXMuU0hBMjU2KCksIGxlbmd0aD1sZW5ndGgsIHNhbHQ9c2FsdCwgaW5mbz1iIlJDLVNlY3VyZVBhZCIsIGJhY2tlbmQ9ZGVmYXVsdF9iYWNrZW5kKCkpCiAgICAgICAgcmV0dXJuIGhrZGYuZGVyaXZlKHBhc3NwaHJhc2UuZW5jb2RlKCJ1dGYtOCIsICJpZ25vcmUiKSkKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgb3V0ID0gYiIiOyBwcmV2ID0gYiIiOyBibG9jayA9IDEKICAgICAgICB3aGlsZSBsZW4ob3V0KSA8IGxlbmd0aDoKICAgICAgICAgICAgcHJldiA9IGhtYWMubmV3KHNhbHQsIHByZXYgKyBwYXNzcGhyYXNlLmVuY29kZSgidXRmLTgiLCJpZ25vcmUiKSArIGIiUkMtU2VjdXJlUGFkIiArIGJ5dGVzKFtibG9ja10pLCBoYXNobGliLnNoYTI1NikuZGlnZXN0KCkKICAgICAgICAgICAgb3V0ICs9IHByZXY7IGJsb2NrICs9IDEKICAgICAgICByZXR1cm4gb3V0WzpsZW5ndGhdCgpkZWYgX3hvcl9zdHJlYW0oZGF0YTogYnl0ZXMsIGtleTogYnl0ZXMpIC0+IGJ5dGVzOgogICAgb3V0ID0gYnl0ZWFycmF5KGxlbihkYXRhKSkKICAgIGZvciBpLGIgaW4gZW51bWVyYXRlKGRhdGEpOiBvdXRbaV0gPSBiIF4ga2V5W2kgJSBsZW4oa2V5KV0KICAgIHJldHVybiBieXRlcyhvdXQpCgpkZWYgcmNfZW5jcnlwdChwbGFpbnRleHQ6IHN0ciwgcGFzc3BocmFzZTogc3RyLCBmb3JjZV9hZXM6IGJvb2w9RmFsc2UpIC0+IHN0cjoKICAgIGlmIG5vdCBwYXNzcGhyYXNlOiByZXR1cm4gcGxhaW50ZXh0CiAgICB0cnk6CiAgICAgICAgZnJvbSBjcnlwdG9ncmFwaHkuaGF6bWF0LnByaW1pdGl2ZXMuY2lwaGVycy5hZWFkIGltcG9ydCBBRVNHQ00KICAgICAgICBzYWx0ID0gb3MudXJhbmRvbSgxNik7IGtleSA9IF9rZGZfaGtkZl9zaGEyNTYocGFzc3BocmFzZSwgc2FsdCwgMzIpCiAgICAgICAgYWVzZ2NtID0gQUVTR0NNKGtleSk7IG5vbmNlID0gb3MudXJhbmRvbSgxMikKICAgICAgICBjdCA9IGFlc2djbS5lbmNyeXB0KG5vbmNlLCBwbGFpbnRleHQuZW5jb2RlKCJ1dGYtOCIsImlnbm9yZSIpLCBiIlJDdjIiKQogICAgICAgIGJsb2IgPSBiIlx4MDIiICsgc2FsdCArIG5vbmNlICsgY3QKICAgICAgICByZXR1cm4gIltFTkMyXSIgKyBiYXNlNjQuYjY0ZW5jb2RlKGJsb2IpLmRlY29kZSgiYXNjaWkiKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBpZiBmb3JjZV9hZXM6CiAgICAgICAgICAgIHJhaXNlCiAgICAgICAgc2FsdCA9IG9zLnVyYW5kb20oMTYpOyBrZXkgPSBfa2RmX2hrZGZfc2hhMjU2KHBhc3NwaHJhc2UsIHNhbHQsIDMyKQogICAgICAgIHggPSBfeG9yX3N0cmVhbShwbGFpbnRleHQuZW5jb2RlKCJ1dGYtOCIsImlnbm9yZSIpLCBrZXkpCiAgICAgICAgYmxvYiA9IGIiXHgwMSIgKyBzYWx0ICsgeAogICAgICAgIHJldHVybiAiW0VOQzFdIiArIGJhc2U2NC5iNjRlbmNvZGUoYmxvYikuZGVjb2RlKCJhc2NpaSIpCgpkZWYgcmNfZGVjcnlwdChjaXBoZXJ0ZXh0OiBzdHIsIHBhc3NwaHJhc2U6IHN0cikgLT4gc3RyOgogICAgaWYgbm90IChjaXBoZXJ0ZXh0LnN0YXJ0c3dpdGgoIltFTkMyXSIpIG9yIGNpcGhlcnRleHQuc3RhcnRzd2l0aCgiW0VOQzFdIikgb3IgY2lwaGVydGV4dC5zdGFydHN3aXRoKCJbRU5DXSIpKTogcmV0dXJuIGNpcGhlcnRleHQKICAgIGlmIG5vdCBwYXNzcGhyYXNlOiByZXR1cm4gY2lwaGVydGV4dAogICAgdHJ5OgogICAgICAgIHJhdyA9IGJhc2U2NC5iNjRkZWNvZGUoY2lwaGVydGV4dC5zcGxpdCgiXSIsMSlbMV0uZW5jb2RlKCJhc2NpaSIpKQogICAgZXhjZXB0IEV4Y2VwdGlvbjogcmV0dXJuIGNpcGhlcnRleHQKICAgIHRyeToKICAgICAgICBpZiBjaXBoZXJ0ZXh0LnN0YXJ0c3dpdGgoIltFTkMyXSIpIGFuZCBsZW4ocmF3KSA+IDErMTYrMTI6CiAgICAgICAgICAgIHNhbHQgPSByYXdbMToxN107IG5vbmNlID0gcmF3WzE3OjI5XTsgY3QgPSByYXdbMjk6XQogICAgICAgICAgICBmcm9tIGNyeXB0b2dyYXBoeS5oYXptYXQucHJpbWl0aXZlcy5jaXBoZXJzLmFlYWQgaW1wb3J0IEFFU0dDTQogICAgICAgICAgICBrZXkgPSBfa2RmX2hrZGZfc2hhMjU2KHBhc3NwaHJhc2UsIHNhbHQsIDMyKQogICAgICAgICAgICBwdCA9IEFFU0dDTShrZXkpLmRlY3J5cHQobm9uY2UsIGN0LCBiIlJDdjIiKQogICAgICAgICAgICByZXR1cm4gcHQuZGVjb2RlKCJ1dGYtOCIsImlnbm9yZSIpCiAgICAgICAgZWxpZiBjaXBoZXJ0ZXh0LnN0YXJ0c3dpdGgoIltFTkMxXSIpIGFuZCBsZW4ocmF3KSA+IDErMTY6CiAgICAgICAgICAgIHNhbHQgPSByYXdbMToxN107IHggPSByYXdbMTc6XTsga2V5ID0gX2tkZl9oa2RmX3NoYTI1NihwYXNzcGhyYXNlLCBzYWx0LCAzMikKICAgICAgICAgICAgcmV0dXJuIF94b3Jfc3RyZWFtKHgsIGtleSkuZGVjb2RlKCJ1dGYtOCIsImlnbm9yZSIpCiAgICAgICAgZWxpZiBjaXBoZXJ0ZXh0LnN0YXJ0c3dpdGgoIltFTkNdIik6CiAgICAgICAgICAgIGtleSA9IGhhc2hsaWIuc2hhMjU2KHBhc3NwaHJhc2UuZW5jb2RlKCJ1dGYtOCIsImlnbm9yZSIpKS5kaWdlc3QoKQogICAgICAgICAgICB4ID0gYmFzZTY0LmI2NGRlY29kZShjaXBoZXJ0ZXh0WzU6XS5lbmNvZGUoImFzY2lpIikpCiAgICAgICAgICAgIHJldHVybiBfeG9yX3N0cmVhbSh4LCBrZXkpLmRlY29kZSgidXRmLTgiLCJpZ25vcmUiKQogICAgZXhjZXB0IEV4Y2VwdGlvbjogcmV0dXJuIGNpcGhlcnRleHQKICAgIHJldHVybiBjaXBoZXJ0ZXh0CiMgPT09IEVuZCBTZWN1cmUgQ3J5cHRvIEhlbHBlcnMgPT09CgojID09PT09PT09IFNlY3VyZSBQYWQgRGlhbG9nIChicmlnaHQgcmVkKSA9PT09PT09PQpmcm9tIFB5UXQ1LlF0V2lkZ2V0cyBpbXBvcnQgUURpYWxvZywgUVZCb3hMYXlvdXQsIFFIQm94TGF5b3V0LCBRTGFiZWwsIFFMaW5lRWRpdCwgUVRleHRFZGl0LCBRUHVzaEJ1dHRvbiwgUU1lc3NhZ2VCb3gsIFFDaGVja0JveApmcm9tIFB5UXQ1LlF0Q29yZSBpbXBvcnQgUXQKCmNsYXNzIFNlY3VyZVBhZERpYWxvZyhRRGlhbG9nKToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBvd25lciwgaW5pdGlhbF90ZXh0OiBzdHIgPSAiIiwgZnJvbV9jYWxsOiBzdHIgPSBOb25lLCBzaG93X3RvOiBib29sID0gVHJ1ZSk6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXyhvd25lcikKICAgICAgICBzZWxmLm93bmVyID0gb3duZXIKICAgICAgICBzZWxmLnNldFdpbmRvd1RpdGxlKCJTZWN1cmUgUGFkIikKICAgICAgICAjIEJyaWdodCBmbGF0IHJlZCBiYWNrZ3JvdW5kLCB3aGl0ZSB0ZXh0CiAgICAgICAgc2VsZi5zZXRTdHlsZVNoZWV0KCJRV2lkZ2V0e2JhY2tncm91bmQtY29sb3I6I0IwMDAyMDtjb2xvcjp3aGl0ZTt9ICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIlFHcm91cEJveHtib3JkZXI6MXB4IHNvbGlkIHJnYmEoMjU1LDI1NSwyNTUsMC4yKTsgbWFyZ2luLXRvcDo2cHg7fSAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICJRTGFiZWx7Y29sb3I6d2hpdGU7fSAiCiAgICAgICAgICAgICAgICAgICAgICAgICAgICJRTGluZUVkaXQsIFFUZXh0RWRpdHtiYWNrZ3JvdW5kOndoaXRlOyBjb2xvcjpibGFjazt9ICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIlFQdXNoQnV0dG9ue2JhY2tncm91bmQ6d2hpdGU7IGNvbG9yOmJsYWNrOyBib3JkZXItcmFkaXVzOjZweDsgcGFkZGluZzo2cHggMTBweDt9ICIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIlFQdXNoQnV0dG9uOmRpc2FibGVke29wYWNpdHk6MC42O30iKQogICAgICAgIHNlbGYuc2V0TWluaW11bVNpemUoOTAwLCA2MjApCiAgICAgICAgdiA9IFFWQm94TGF5b3V0KHNlbGYpCgogICAgICAgICMgUmVjZWl2ZS1tb2RlIGJhbm5lciBhbmQgVE8gdmlzaWJpbGl0eQogICAgICAgIGlmIGZyb21fY2FsbDoKICAgICAgICAgICAgbGFiX2Zyb20gPSBRTGFiZWwoZiJGcm9tOiB7ZnJvbV9jYWxsfSIpCiAgICAgICAgICAgIGxhYl9mcm9tLnNldFN0eWxlU2hlZXQoIlFMYWJlbHtiYWNrZ3JvdW5kOnRyYW5zcGFyZW50O2NvbG9yOiNmZmY7Zm9udC13ZWlnaHQ6Ym9sZDt9IikKICAgICAgICAgICAgdi5hZGRXaWRnZXQobGFiX2Zyb20pCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3Qgc2hvd190bzoKICAgICAgICAgICAgICAgIHNlbGYudG9fZWRpdC5zZXRWaXNpYmxlKEZhbHNlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgIyBXYXJuaW5nCiAgICAgICAgd2FybiA9IFFMYWJlbCgi4pqg77iPIFdhcm5pbmc6IFVzaW5nIEVuY3J5cHRpb24gbWF5IGJyZWFjaCB5b3VyIGxpY2Vuc2UgY29uZGl0aW9ucy4iKQogICAgICAgIHRyeTogd2Fybi5zZXRXb3JkV3JhcChUcnVlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICB3YXJuLnNldFN0eWxlU2hlZXQoIlFMYWJlbHtiYWNrZ3JvdW5kOnRyYW5zcGFyZW50O2NvbG9yOiNmZmVmOGE7Zm9udC13ZWlnaHQ6Ym9sZDt9IikKICAgICAgICB2LmFkZFdpZGdldCh3YXJuKQoKICAgICAgICAjIFRvICsgUGFzc3BocmFzZSByb3cKICAgICAgICByb3cgPSBRSEJveExheW91dCgpCiAgICAgICAgcm93LmFkZFdpZGdldChRTGFiZWwoIlRvIikpCiAgICAgICAgc2VsZi50b19lZGl0ID0gUUxpbmVFZGl0KCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHQgPSAob3duZXIudG9fZWRpdC50ZXh0KCkgb3IgIiIpLnN0cmlwKCkudXBwZXIoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHQgPSAiIgogICAgICAgIHNlbGYudG9fZWRpdC5zZXRUZXh0KHQpOyByb3cuYWRkV2lkZ2V0KHNlbGYudG9fZWRpdCkKCiAgICAgICAgcm93LmFkZFdpZGdldChRTGFiZWwoIlBhc3NwaHJhc2UiKSkKICAgICAgICBzZWxmLnBhc3NfZWRpdCA9IFFMaW5lRWRpdCgpOyBzZWxmLnBhc3NfZWRpdC5zZXRFY2hvTW9kZShRTGluZUVkaXQuUGFzc3dvcmQpCiAgICAgICAgcm93LmFkZFdpZGdldChzZWxmLnBhc3NfZWRpdCkKICAgICAgICB2LmFkZExheW91dChyb3cpCgogICAgICAgICMgRm9yY2UgQUVTLTI1NiByb3cgKGRlZmF1bHQgT0ZGIHNvIHdlIG5ldmVyIGJsb2NrIHNlbmRzIHVuZXhwZWN0ZWRseSkKICAgICAgICByb3cyID0gUUhCb3hMYXlvdXQoKQogICAgICAgIHNlbGYuZm9yY2VfYWVzX2NoayA9IFFDaGVja0JveCgiRm9yY2UgQUVTLTI1NiBFbmNyeXB0aW9uIikKICAgICAgICBzZWxmLmZvcmNlX2Flc19jaGsuc2V0Q2hlY2tlZChUcnVlKQogICAgICAgIHJvdzIuYWRkV2lkZ2V0KHNlbGYuZm9yY2VfYWVzX2Noayk7IHJvdzIuYWRkU3RyZXRjaCgxKQogICAgICAgIHYuYWRkTGF5b3V0KHJvdzIpCgogICAgICAgICMgVGV4dCBhcmVhCiAgICAgICAgc2VsZi50eHQgPSBRVGV4dEVkaXQoKQogICAgICAgIHNlbGYudHh0LnNldFBsYWNlaG9sZGVyVGV4dCgiVHlwZSB5b3VyIG1lc3NhZ2UgaGVyZS4gVXNlIEVuY3J5cHQvRGVjcnlwdCBhcyBuZWVkZWQuIENsaWNrIFNFTkQgdG8gdHJhbnNtaXQuIikKICAgICAgICB2LmFkZFdpZGdldChzZWxmLnR4dCwgMSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGluaXRpYWxfdGV4dDoKICAgICAgICAgICAgICAgIHNlbGYudHh0LnNldFBsYWluVGV4dChpbml0aWFsX3RleHQpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICAjIEJ1dHRvbnMKICAgICAgICBiciA9IFFIQm94TGF5b3V0KCkKICAgICAgICBzZWxmLmJ0bl9lbmMgPSBRUHVzaEJ1dHRvbigiRW5jcnlwdCIpCiAgICAgICAgc2VsZi5idG5fZGVjID0gUVB1c2hCdXR0b24oIkRlY3J5cHQiKQogICAgICAgIHNlbGYuYnRuX3NlbmQgPSBRUHVzaEJ1dHRvbigiU0VORCIpCiAgICAgICAgc2VsZi5idG5fY2xvc2UgPSBRUHVzaEJ1dHRvbigiQ2xvc2UiKQogICAgICAgIGJyLmFkZFN0cmV0Y2goMSk7IGJyLmFkZFdpZGdldChzZWxmLmJ0bl9lbmMpOyBici5hZGRXaWRnZXQoc2VsZi5idG5fZGVjKTsgYnIuYWRkV2lkZ2V0KHNlbGYuYnRuX3NlbmQpOyBici5hZGRXaWRnZXQoc2VsZi5idG5fY2xvc2UpCiAgICAgICAgdi5hZGRMYXlvdXQoYnIpCgogICAgICAgIHNlbGYuYnRuX2Nsb3NlLmNsaWNrZWQuY29ubmVjdChzZWxmLnJlamVjdCkKICAgICAgICBzZWxmLmJ0bl9lbmMuY2xpY2tlZC5jb25uZWN0KHNlbGYuX29uX2VuY3J5cHQpCiAgICAgICAgc2VsZi5idG5fZGVjLmNsaWNrZWQuY29ubmVjdChzZWxmLl9vbl9kZWNyeXB0KQogICAgICAgIHNlbGYuYnRuX3NlbmQuY2xpY2tlZC5jb25uZWN0KHNlbGYuX29uX3NlbmQpCgogICAgZGVmIF9vbl9lbmNyeXB0KHNlbGYpOgogICAgICAgIHR4dCA9IHNlbGYudHh0LnRvUGxhaW5UZXh0KCk7IHB3ID0gc2VsZi5wYXNzX2VkaXQudGV4dCgpCiAgICAgICAgaWYgbm90IHR4dC5zdHJpcCgpOiByZXR1cm4KICAgICAgICB0cnk6CiAgICAgICAgICAgIG91dCA9IHJjX2VuY3J5cHQodHh0LCBwdywgZm9yY2VfYWVzPXNlbGYuZm9yY2VfYWVzX2Noay5pc0NoZWNrZWQoKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBRTWVzc2FnZUJveC53YXJuaW5nKHNlbGYsICJTZWN1cmUgUGFkIiwgIkFFUy0yNTYgcmVxdWlyZWQgYnV0IG5vdCBhdmFpbGFibGUuIEluc3RhbGwgJ2NyeXB0b2dyYXBoeScgb3IgdW5jaGVjayBGb3JjZSBBRVMtMjU2LiIpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIHNlbGYudHh0LnNldFBsYWluVGV4dChvdXQpCgogICAgZGVmIF9vbl9kZWNyeXB0KHNlbGYpOgogICAgICAgIHR4dCA9IHNlbGYudHh0LnRvUGxhaW5UZXh0KCk7IHB3ID0gc2VsZi5wYXNzX2VkaXQudGV4dCgpCiAgICAgICAgaWYgbm90IHR4dC5zdHJpcCgpOiByZXR1cm4KICAgICAgICBzZWxmLnR4dC5zZXRQbGFpblRleHQocmNfZGVjcnlwdCh0eHQsIHB3KSkKCiAgICBkZWYgX29uX3NlbmQoc2VsZik6CiAgICAgICAgdG8gPSAoc2VsZi50b19lZGl0LnRleHQoKSBvciAiIikuc3RyaXAoKS51cHBlcigpCiAgICAgICAgaWYgbm90IHRvOgogICAgICAgICAgICBRTWVzc2FnZUJveC5pbmZvcm1hdGlvbihzZWxmLCAiU2VjdXJlIFBhZCIsICJQbGVhc2UgcHJvdmlkZSBhIFRhcmdldC9UTyBjYWxsc2lnbi4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBtc2cgPSAoc2VsZi50eHQudG9QbGFpblRleHQoKSBvciAiIikuc3RyaXAoKQogICAgICAgIGlmIG5vdCBtc2c6IHJldHVybgogICAgICAgICMgRW5mb3JjZSBBRVMgaWYgcmVxdWVzdGVkCiAgICAgICAgaWYgc2VsZi5mb3JjZV9hZXNfY2hrLmlzQ2hlY2tlZCgpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmcm9tIGNyeXB0b2dyYXBoeS5oYXptYXQucHJpbWl0aXZlcy5jaXBoZXJzLmFlYWQgaW1wb3J0IEFFU0dDTSBhcyBfQUVTX1RFU1QKICAgICAgICAgICAgICAgIF8gPSBfQUVTX1RFU1QKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIFFNZXNzYWdlQm94Lndhcm5pbmcoc2VsZiwgIlNlY3VyZSBQYWQiLCAiQUVTLTI1NiBpcyByZXF1aXJlZCBidXQgbm90IGF2YWlsYWJsZS4gSW5zdGFsbCAnY3J5cHRvZ3JhcGh5JyBvciB1bmNoZWNrIEZvcmNlIEFFUy0yNTYuIikKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIG9rID0gRmFsc2UKICAgICAgICB0cnk6CiAgICAgICAgICAgIG9rID0gYm9vbChzZWxmLm93bmVyLl9zZW5kX3NlY3VyZXBhZCh0bywgbXNnKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBvayA9IEZhbHNlCiAgICAgICAgaWYgb2s6CiAgICAgICAgICAgIHNlbGYuYWNjZXB0KCkKIyA9PT09PT09PSBFbmQgU2VjdXJlIFBhZCBEaWFsb2cgPT09PT09PT0KCgpjbGFzcyBDaGF0QXBwKFFNYWluV2luZG93KToKCiAgICAKCgoKICAgIAoKICAgIGRlZiBfaXNfZW5jcnlwdGVkX2xpbmUoc2VsZiwgczogc3RyKSAtPiBib29sOgogICAgICAgIHRyeToKICAgICAgICAgICAgdCA9IHN0cihzIG9yICIiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHQgPSAiIgogICAgICAgIHJldHVybiAoIltFTkMyXSIgaW4gdCkgb3IgKCJbRU5DMV0iIGluIHQpIG9yICgiW0VOQ10iIGluIHQpCiAgICBkZWYgX21pcnJvcl9wb3NpdGlvbnNfdG9fZ2VvanNvbl9mcm9tX3N0b3JlKHNlbGYpOgogICAgICAgICIiIgogICAgICAgIEctc3R5bGUgbWlycm9yIChjbGVhbik6CiAgICAgICAgICAtIFJlYWRzIGJhc2VfZGlyL3N0b3JlL3Bvc2l0aW9ucy5qc29uCiAgICAgICAgICAtIEluamVjdHMgTVlDQUxMIGZyb20gVUkvc2V0dGluZ3MgaWYgZml4ZWQgY29vcmRzIGF2YWlsYWJsZSAoc2V0dGluZ3MtZml4ZWQpIHdoZW4gbm90IGFscmVhZHkgcHJlc2VudAogICAgICAgICAgLSBXcml0ZXMgQk9USCBiYXNlX2Rpci9zdG9yZS9tYXBzL3Bvc2l0aW9ucy5nZW9qc29uIGFuZCBwb3NpdGlvbi5nZW9qc29uCiAgICAgICAgICAtIEdlb0pTT04gdXNlcyBbbG9uLCBsYXRdLCBpbmNsdWRlcyBnZW5lcmF0ZWRfYXQgYW5kIHZlcnNpb24uCiAgICAgICAgIiIiCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgb3MsIGpzb24sIGRhdGV0aW1lLCB0aW1lCiAgICAgICAgICAgIGJhc2UgPSBhcHBfYmFzZV9kaXIoKQogICAgICAgICAgICBzdG9yZV9kaXIgPSBvcy5wYXRoLmpvaW4oYmFzZSwgInN0b3JlIikKICAgICAgICAgICAgbWFwc19kaXIgPSBvcy5wYXRoLmpvaW4oc3RvcmVfZGlyLCAibWFwcyIpCiAgICAgICAgICAgIG9zLm1ha2VkaXJzKG1hcHNfZGlyLCBleGlzdF9vaz1UcnVlKQoKICAgICAgICAgICAgc3JjX3BhdGggPSBvcy5wYXRoLmpvaW4oc3RvcmVfZGlyLCAicG9zaXRpb25zLmpzb24iKQogICAgICAgICAgICBwb3NpdGlvbnMgPSB7fQogICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShzcmNfcGF0aCk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgd2l0aCBvcGVuKHNyY19wYXRoLCAiciIsIGVuY29kaW5nPSJ1dGYtOCIpIGFzIGY6CiAgICAgICAgICAgICAgICAgICAgICAgIGRhdGEgPSBqc29uLmxvYWQoZikgb3Ige30KICAgICAgICAgICAgICAgICAgICAgICAgcG9zaXRpb25zID0gZGF0YS5nZXQoInBvc2l0aW9ucyIpIG9yIHt9CiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9ucyA9IHt9CgogICAgICAgICAgICAjIC0tLSBJbmplY3QgTVlDQUxMIHdpdGggZml4ZWQgY29vcmRzIGlmIGF2YWlsYWJsZSBhbmQgbm90IHByZXNlbnQgLS0tCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICMgUHJlZmVyIFVJIHdpZGdldHMKICAgICAgICAgICAgICAgIG15Y2FsbCA9ICIiCiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdteWNhbGxfZWRpdCcpIGFuZCBzZWxmLm15Y2FsbF9lZGl0IGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIG15Y2FsbCA9IChzZWxmLm15Y2FsbF9lZGl0LnRleHQoKSBvciAiIikuc3RyaXAoKS51cHBlcigpCiAgICAgICAgICAgICAgICAjIEZhbGxiYWNrIHRvIHNldHRpbmdzIGRpY3QKICAgICAgICAgICAgICAgIGlmIG5vdCBteWNhbGw6CiAgICAgICAgICAgICAgICAgICAgZm9yIGF0dHIgaW4gKCdzZXR0aW5ncycsJ19zZXR0aW5ncycsJ2NvbmZpZycsJ19jb25maWcnKToKICAgICAgICAgICAgICAgICAgICAgICAgZCA9IGdldGF0dHIoc2VsZiwgYXR0ciwgTm9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZvciBrZXkgaW4gKCdNWUNBTEwnLCdteWNhbGwnLCdjYWxsc2lnbicsJ215X2NhbGwnKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBkLmdldChrZXkpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBteWNhbGwgPSBzdHIoZFtrZXldKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgbXljYWxsOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgICAgICBkZWYgX3RyeV9mbG9hdCh4KToKICAgICAgICAgICAgICAgICAgICB0cnk6IHJldHVybiBmbG9hdCh4KQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdDogcmV0dXJuIE5vbmUKCiAgICAgICAgICAgICAgICBmbGF0ID0gZmxvbiA9IE5vbmUKICAgICAgICAgICAgICAgICMgVUkgZml4ZWQgbGF0L2xvbiB3aWRnZXRzIGlmIHByZXNlbnQKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ2ZpeGVkX2xhdF9lZGl0JykgYW5kIGhhc2F0dHIoc2VsZiwgJ2ZpeGVkX2xvbl9lZGl0Jyk6CiAgICAgICAgICAgICAgICAgICAgZmxhdCA9IF90cnlfZmxvYXQoZ2V0YXR0cihzZWxmLmZpeGVkX2xhdF9lZGl0LCAndGV4dCcsIGxhbWJkYTogTm9uZSkoKSkKICAgICAgICAgICAgICAgICAgICBmbG9uID0gX3RyeV9mbG9hdChnZXRhdHRyKHNlbGYuZml4ZWRfbG9uX2VkaXQsICd0ZXh0JywgbGFtYmRhOiBOb25lKSgpKQoKICAgICAgICAgICAgICAgICMgRmFsbGJhY2sgdG8gc2V0dGluZ3MKICAgICAgICAgICAgICAgIGlmIGZsYXQgaXMgTm9uZSBvciBmbG9uIGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgZm9yIGF0dHIgaW4gKCdzZXR0aW5ncycsJ19zZXR0aW5ncycsJ2NvbmZpZycsJ19jb25maWcnKToKICAgICAgICAgICAgICAgICAgICAgICAgZCA9IGdldGF0dHIoc2VsZiwgYXR0ciwgTm9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxhdF9rZXkgPSBuZXh0KChrIGZvciBrIGluICgnbXlfbGF0JywnaG9tZV9sYXQnLCdmaXhlZF9sYXQnLCdsYXQnLCdsYXRpdHVkZScpIGlmIGsgaW4gZCksIE5vbmUpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb25fa2V5ID0gbmV4dCgoayBmb3IgayBpbiAoJ215X2xvbicsJ2hvbWVfbG9uJywnZml4ZWRfbG9uJywnbG9uJywnbG9uZ2l0dWRlJykgaWYgayBpbiBkKSwgTm9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIGxhdF9rZXkgYW5kIGxvbl9rZXk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxhdCA9IF90cnlfZmxvYXQoZC5nZXQobGF0X2tleSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZmxvbiA9IF90cnlfZmxvYXQoZC5nZXQobG9uX2tleSkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKCiAgICAgICAgICAgICAgICBpZiBteWNhbGwgYW5kIGZsYXQgaXMgbm90IE5vbmUgYW5kIGZsb24gaXMgbm90IE5vbmUgYW5kIG15Y2FsbCBub3QgaW4gcG9zaXRpb25zOgogICAgICAgICAgICAgICAgICAgIHBvc2l0aW9uc1tteWNhbGxdID0gewogICAgICAgICAgICAgICAgICAgICAgICAnbGF0JzogZmxvYXQoZmxhdCksCiAgICAgICAgICAgICAgICAgICAgICAgICdsb24nOiBmbG9hdChmbG9uKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ2xhc3RfdXBkYXRlJzogaW50KHRpbWUudGltZSgpKSwKICAgICAgICAgICAgICAgICAgICAgICAgJ3NvdXJjZSc6ICdzZXR0aW5ncy1maXhlZCcsCiAgICAgICAgICAgICAgICAgICAgICAgICdoaXN0b3J5JzogW10KICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICAjIEhlbHBlciB0byBJU08KICAgICAgICAgICAgZGVmIF90b19pc28odik6CiAgICAgICAgICAgICAgICBpbXBvcnQgZGF0ZXRpbWUKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiB2IGlzIE5vbmU6IHJldHVybiBOb25lCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZSh2LCAoaW50LCBmbG9hdCkpOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gZGF0ZXRpbWUuZGF0ZXRpbWUudXRjZnJvbXRpbWVzdGFtcCh2KS5yZXBsYWNlKG1pY3Jvc2Vjb25kPTApLmlzb2Zvcm1hdCgpICsgIloiCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZSh2LCBzdHIpOiByZXR1cm4gdgogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKCiAgICAgICAgICAgIGZlYXRzID0gW10KICAgICAgICAgICAgZm9yIGNhbGwsIGVudCBpbiAocG9zaXRpb25zLml0ZW1zKCkgaWYgaXNpbnN0YW5jZShwb3NpdGlvbnMsIGRpY3QpIGVsc2UgW10pOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGxhdCA9IGZsb2F0KGVudC5nZXQoImxhdCIpKQogICAgICAgICAgICAgICAgICAgIGxvbiA9IGZsb2F0KGVudC5nZXQoImxvbiIpKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgbGFzdF9oZWFyZCA9IF90b19pc28oZW50LmdldCgibGFzdF9oZWFyZCIpIG9yIGVudC5nZXQoInRzIikgb3IgZW50LmdldCgibGFzdF91cGRhdGUiKSkKICAgICAgICAgICAgICAgIGxhc3RfdXBkYXRlID0gX3RvX2lzbyhlbnQuZ2V0KCJsYXN0X3VwZGF0ZSIpIG9yIGVudC5nZXQoInRzIikgb3IgZW50LmdldCgibGFzdF9oZWFyZCIpKQogICAgICAgICAgICAgICAgc3JjID0gZW50LmdldCgic3JjIikgb3IgZW50LmdldCgic291cmNlIikgb3IgImJlYWNvbiIKICAgICAgICAgICAgICAgIGhpc3QgPSBbXQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHJhd19oaXN0ID0gZW50LmdldCgiaGlzdG9yeSIpIG9yIFtdCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShyYXdfaGlzdCwgbGlzdCk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZvciBoIGluIHJhd19oaXN0Wy01MDpdOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UoaCwgZGljdCk6IGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGxhdCA9IGZsb2F0KGguZ2V0KCJsYXQiKSk7IGhsb24gPSBmbG9hdChoLmdldCgibG9uIikpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBodCA9IGguZ2V0KCJ0Iikgb3IgaC5nZXQoInRzIikgb3IgaC5nZXQoInRpbWUiKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaGlzdC5hcHBlbmQoeyJ0IjogaHQsICJsYXQiOiBobGF0LCAibG9uIjogaGxvbn0pCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgICAgICBmZWF0cy5hcHBlbmQoewogICAgICAgICAgICAgICAgICAgICJ0eXBlIjogIkZlYXR1cmUiLAogICAgICAgICAgICAgICAgICAgICJnZW9tZXRyeSI6IHsidHlwZSI6ICJQb2ludCIsICJjb29yZGluYXRlcyI6IFtsb24sIGxhdF19LAogICAgICAgICAgICAgICAgICAgICJwcm9wZXJ0aWVzIjogewogICAgICAgICAgICAgICAgICAgICAgICAiY2FsbHNpZ24iOiBzdHIoY2FsbCksCiAgICAgICAgICAgICAgICAgICAgICAgICJuYW1lIjogc3RyKGNhbGwpLAogICAgICAgICAgICAgICAgICAgICAgICAibGF0IjogbGF0LCAibG9uIjogbG9uLAogICAgICAgICAgICAgICAgICAgICAgICAibGFzdF9oZWFyZCI6IGxhc3RfaGVhcmQsCiAgICAgICAgICAgICAgICAgICAgICAgICJsYXN0X3VwZGF0ZSI6IGxhc3RfdXBkYXRlLAogICAgICAgICAgICAgICAgICAgICAgICAic291cmNlIjogc3JjLAogICAgICAgICAgICAgICAgICAgICAgICAiaGlzdG9yeSI6IGhpc3QKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICB9KQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdmVyc2lvbiA9IEFQUF9WRVJTSU9OCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICB2ZXJzaW9uID0gIjEuNS5EIgogICAgICAgICAgICBnZW5lcmF0ZWRfYXQgPSBfX2ltcG9ydF9fKCdkYXRldGltZScpLmRhdGV0aW1lLnV0Y25vdygpLnJlcGxhY2UobWljcm9zZWNvbmQ9MCkuaXNvZm9ybWF0KCkgKyAiWiIKCiAgICAgICAgICAgIGdqID0gewogICAgICAgICAgICAgICAgInR5cGUiOiAiRmVhdHVyZUNvbGxlY3Rpb24iLAogICAgICAgICAgICAgICAgImZlYXR1cmVzIjogZmVhdHMsCiAgICAgICAgICAgICAgICAiZ2VuZXJhdGVkX2F0IjogZ2VuZXJhdGVkX2F0LAogICAgICAgICAgICAgICAgInZlcnNpb24iOiB2ZXJzaW9uCiAgICAgICAgICAgIH0KCiAgICAgICAgICAgIGZvciBvdXRuYW1lIGluICgicG9zaXRpb25zLmdlb2pzb24iLCAicG9zaXRpb24uZ2VvanNvbiIpOgogICAgICAgICAgICAgICAgdG1wID0gb3MucGF0aC5qb2luKG1hcHNfZGlyLCBvdXRuYW1lICsgIi50bXAiKQogICAgICAgICAgICAgICAgd2l0aCBvcGVuKHRtcCwgInciLCBlbmNvZGluZz0idXRmLTgiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGpzb24uZHVtcChnaiwgZiwgZW5zdXJlX2FzY2lpPUZhbHNlKQogICAgICAgICAgICAgICAgb3MucmVwbGFjZSh0bXAsIG9zLnBhdGguam9pbihtYXBzX2Rpciwgb3V0bmFtZSkpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgIyAtLS0gQ29ubmVjdCBidXR0b24gdGhlbWluZyBoZWxwZXJzIC0tLQogICAgZGVmIF90aGVtZV9uYW1lKHNlbGYpOgogICAgICAgICcnJ0Jlc3QtZWZmb3J0IHRoZW1lIG5hbWUgZnJvbSB0aGVtZV9jb21ibyBvciBzZXR0aW5ncy4nJycKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ3RoZW1lX2NvbWJvJykgYW5kIGhhc2F0dHIoc2VsZi50aGVtZV9jb21ibywgJ2N1cnJlbnRUZXh0Jyk6CiAgICAgICAgICAgICAgICBuID0gKHNlbGYudGhlbWVfY29tYm8uY3VycmVudFRleHQoKSBvciAnJykuc3RyaXAoKQogICAgICAgICAgICAgICAgaWYgbjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICB0cnk6CiAgICAgICAgICAgIHN0ID0gbG9hZF9qc29uKCdzZXR0aW5ncy5qc29uJykgb3Ige30KICAgICAgICAgICAgcmV0dXJuIHN0LmdldCgndGhlbWUnLCAnJykgb3IgJycKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gJycKICAgIAogICAgZGVmIF9maW5kX2Nvbm5lY3RfYnV0dG9uKHNlbGYpOgogICAgICAgICcnJ1RyeSB0byBsb2NhdGUgdGhlIENvbm5lY3QgYnV0dG9uIGluc3RhbmNlLicnJwogICAgICAgICMgQ29tbW9uIGF0dHJpYnV0ZSBuYW1lcyBmaXJzdAogICAgICAgIGZvciBjYW5kIGluICgnY29ubmVjdF9idXR0b24nLCAnc2VyaWFsX2Nvbm5lY3RfYnRuJywgJ2J0bl9jb25uZWN0JywgJ2Nvbm5lY3RCdG4nKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgYnRuID0gZ2V0YXR0cihzZWxmLCBjYW5kLCBOb25lKQogICAgICAgICAgICAgICAgaWYgYnRuOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBidG4KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAjIEZhbGxiYWNrOiBzY2FuIGJ5IHZpc2libGUgdGV4dAogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBQeVF0NS5RdFdpZGdldHMgaW1wb3J0IFFQdXNoQnV0dG9uCiAgICAgICAgICAgIGZvciBidG4gaW4gc2VsZi5maW5kQ2hpbGRyZW4oUVB1c2hCdXR0b24pOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHQgPSBidG4udGV4dCgpLnN0cmlwKCkubG93ZXIoKQogICAgICAgICAgICAgICAgICAgIGlmIHQgPT0gJ2Nvbm5lY3QnOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gYnRuCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiBOb25lCiAgICAKICAgIGRlZiBfc3R5bGVfY29ubmVjdF9idXR0b24oc2VsZiwgc3RhdGU9J25vcm1hbCcpOgogICAgICAgICcnJ0FwcGx5IHRoZW1lZCBzdHlsaW5nIHRvIHRoZSBDb25uZWN0IGJ1dHRvbjsgbm8gdGV4dCBjaGFuZ2VzLicnJwogICAgICAgIHRyeToKICAgICAgICAgICAgYnRuID0gc2VsZi5fZmluZF9jb25uZWN0X2J1dHRvbigpCiAgICAgICAgICAgIGlmIG5vdCBidG46CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgdGhlbWUgPSAoc2VsZi5fdGhlbWVfbmFtZSgpIG9yICcnKS5sb3dlcigpCiAgICAgICAgICAgIGlmIHN0YXRlID09ICdjb25uZWN0ZWQnIGFuZCAnZGFyayBncmVlbicgaW4gdGhlbWU6CiAgICAgICAgICAgICAgICAjIEludmVydCBmb3IgRGFyayBHcmVlbjogbGltZSBiYWNrZ3JvdW5kLCBibGFjayB0ZXh0CiAgICAgICAgICAgICAgICBidG4uc2V0U3R5bGVTaGVldCgnYmFja2dyb3VuZDogbGltZTsgY29sb3I6IGJsYWNrOycpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAjIFJldmVydCB0byB0aGVtZSBkZWZhdWx0CiAgICAgICAgICAgICAgICBidG4uc2V0U3R5bGVTaGVldCgnJykgICMgY2xlYXJzIGlubGluZSBzdHlsZSwgbGV0dGluZyB0aGVtZS9hcHAtd2lkZSBzdHlsZXNoZWV0IHRha2Ugb3ZlcgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICMgLS0tIGVuZCBoZWxwZXJzIC0tLQoKICAgICMgLS0tIE1pbmltYWwgc2VyaWFsIGJ1dHRvbiBoYW5kbGVycyAobm8gZXh0ZXJuYWwgZGVwZW5kZW5jaWVzKSAtLS0KICAgIGRlZiBfb25fY29ubmVjdF9jbGljayhzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgZ2V0IHNlbGVjdGVkIHBvcnQgKGRvIG5vdCBkZXBlbmQgb24gZXh0ZXJuYWwgZ2V0dGVycykKICAgICAgICAgICAgcG9ydCA9ICIiCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHBvcnQgPSAoc2VsZi5zZXJpYWxfY29tYm8uY3VycmVudFRleHQoKSBvciAiIikuc3RyaXAoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHBvcnQgPSAoc2VsZi5jb21ib2JveF9wb3J0LmN1cnJlbnRUZXh0KCkgb3IgIiIpLnN0cmlwKCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBpZiBub3QgcG9ydDoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBRTWVzc2FnZUJveC53YXJuaW5nKHNlbGYsICJTZXJpYWwiLCAiUGxlYXNlIHNlbGVjdCBhIENPTSBwb3J0IGZpcnN0LiIpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICBiYXVkID0gZ2V0YXR0cihzZWxmLCAiX3NlcmlhbF9iYXVkX2RlZmF1bHQiLCAzODQwMCkKICAgICAgICAgICAgIyBvcGVuIHVzaW5nIGV4aXN0aW5nIG1ldGhvZCBpZiBhdmFpbGFibGUKICAgICAgICAgICAgb2sgPSBGYWxzZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvayA9IHNlbGYuX29wZW5fc2VyaWFsKHBvcnQsIGJhdWQpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBvayA9IEZhbHNlCiAgICAgICAgICAgIGlmIG9rOgogICAgICAgICAgICAgICAgIyBzdGFydCByZWFkZXIgdGhyZWFkIGlmIGRlZmluZWQKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBub3QgaGFzYXR0cihzZWxmLCAicmVhZGVyX3RocmVhZCIpIG9yIHNlbGYucmVhZGVyX3RocmVhZCBpcyBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLnJlYWRlcl90aHJlYWQgPSBTZXJpYWxSZWFkZXJUaHJlYWQoc2VsZikKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWFkZXJfdGhyZWFkLmxpbmVfcmVjZWl2ZWQuY29ubmVjdChzZWxmLl9vbl9zZXJpYWxfdGhyZWFkX2xpbmUpCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucmVhZGVyX3RocmVhZC5zdGFydCgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zdGF0dXMoIkNvbm5lY3RlZCIpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3R5bGVfY29ubmVjdF9idXR0b24oJ2Nvbm5lY3RlZCcpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjIG9wdGlvbmFsIGJ1dHRvbiB0ZXh0IGZlZWRiYWNrLCBidXQgZG9uJ3QgcmVseSBvbiBzcGVjaWZpYyBuYW1lcwogICAgICAgICAgICAgICAgICAgIGZyb20gUHlRdDUuUXRXaWRnZXRzIGltcG9ydCBRUHVzaEJ1dHRvbgogICAgICAgICAgICAgICAgICAgIGZvciBidG4gaW4gc2VsZi5maW5kQ2hpbGRyZW4oUVB1c2hCdXR0b24pOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBidG4udGV4dCgpLnN0cmlwKCkubG93ZXIoKSA9PSAiY29ubmVjdCI6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnRuLnNldFRleHQoIkNvbm5lY3QiKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgIyBuZXZlciBjcmFzaCBmcm9tIGEgY2xpY2sKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBfb25fZGlzY29ubmVjdF9jbGljayhzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgc3RvcCByZWFkZXIgdGhyZWFkIGlmIHByZXNlbnQKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAicmVhZGVyX3RocmVhZCIpIGFuZCBzZWxmLnJlYWRlcl90aHJlYWQ6CiAgICAgICAgICAgICAgICAgICAgdHJ5OiBzZWxmLnJlYWRlcl90aHJlYWQuc3RvcCgpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAgICAgICAgIHRyeTogc2VsZi5yZWFkZXJfdGhyZWFkLndhaXQoNTAwKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgICAgICAgICBzZWxmLnJlYWRlcl90aHJlYWQgPSBOb25lCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICMgY2xvc2Ugc2VyaWFsIHVzaW5nIGV4aXN0aW5nIG1ldGhvZCBpZiBhdmFpbGFibGUKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fY2xvc2Vfc2VyaWFsKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgIyBmZWVkYmFjawogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLl9zdGF0dXMoIkRpc2Nvbm5lY3RlZCIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZyb20gUHlRdDUuUXRXaWRnZXRzIGltcG9ydCBRUHVzaEJ1dHRvbgogICAgICAgICAgICAgICAgZm9yIGJ0biBpbiBzZWxmLmZpbmRDaGlsZHJlbihRUHVzaEJ1dHRvbik6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBpZiBidG4udGV4dCgpLnN0cmlwKCkubG93ZXIoKSBpbiAoImNvbm5lY3RlZC4uLiIsICJjb25uZWN0ZWQg4oCmIik6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBidG4uc2V0VGV4dCgiQ29ubmVjdCIpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICMgLS0tIGVuZCBtaW5pbWFsIHNlcmlhbCBoYW5kbGVycyAtLS0KCiAgICBkZWYgX29uX21vbml0b3JfYWxsX3RvZ2dsZWQoc2VsZiwgc3RhdGU6IGludCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBvbiA9IGJvb2woc3RhdGUpCiAgICAgICAgICAgICMgUGVyc2lzdCBtb25pdG9yX2FsbCBpbiBzZXR0aW5ncwogICAgICAgICAgICBzYXZlX2pzb24oJ3NldHRpbmdzLmpzb24nLCBzZWxmLnNldHRpbmdzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICAnJydVSS1vbmx5IHRvZ2dsZTsgbm8gVE5DIGNvbW1hbmRzLicnJwogICAgICAgIHRyeToKICAgICAgICAgICAgb24gPSBib29sKHN0YXRlKQogICAgICAgICAgICBtc2cgPSAi8J+foCBNb25pdG9yIEFsbDogT04gKHNob3dpbmcgcmF3IFJYOyBmaWx0ZXJzIG9mZikiIGlmIG9uIGVsc2UgIvCfn6IgTW9uaXRvciBBbGw6IE9GRiAoYXBwbHlpbmcgZmlsdGVyczogTVlDQUxML0NRL0ZsZWV0KSIKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAiX2FwcGVuZF9zeXMiKToKICAgICAgICAgICAgICAgIHNlbGYuX2FwcGVuZF9zeXMobXNnKQogICAgICAgICAgICAjIE9wdGlvbmFsOiByZWZyZXNoIGJlYWNvbnMgVUkgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgIl9yZWZyZXNoX2JlYWNvbnNfdWkiKToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9yZWZyZXNoX2JlYWNvbnNfdWkoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX3RzX3ByZWZpeChzZWxmKSAtPiBzdHI6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZQogICAgICAgICAgICByZXR1cm4gZGF0ZXRpbWUubm93KCkuc3RyZnRpbWUoIlslWS0lbS0lZCAlSDolTTolU10gIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gIiIKCiAgICBkZWYgX2FwcGVuZF9yeF91aV9vbmx5KHNlbGYsIHRleHQ6IHN0cik6CiAgICAgICAgJycnQXBwZW5kIGEgbGluZSB0byB0aGUgTWVzc2FnZXMgbGlzdCB3aXRob3V0IHBlcnNpc3RpbmcgdG8gbWVzc2FnZXNfdjEuanNvbi4nJycKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZyb20gUHlRdDUuUXRXaWRnZXRzIGltcG9ydCBRTGlzdFdpZGdldEl0ZW0KICAgICAgICAgICAgdHh0ID0gc3RyKHRleHQpCiAgICAgICAgICAgICMgU3RyaXAgYW55IGxlYWRpbmcgW01PTl0gdGFnIHVuaXZlcnNhbGx5CiAgICAgICAgICAgIGlmIHR4dC5zdGFydHN3aXRoKCdbTU9OXSAnKToKICAgICAgICAgICAgICAgIHR4dCA9IHR4dFs2Ol0KICAgICAgICAgICAgZWxpZiB0eHQuc3RhcnRzd2l0aCgnW01PTl0nKToKICAgICAgICAgICAgICAgIHR4dCA9IHR4dFs1Ol0KICAgICAgICAgICAgaXRlbSA9IFFMaXN0V2lkZ2V0SXRlbShzZWxmLl90c19wcmVmaXgoKSArIHR4dCkKCiAgICAgICAgICAgICMgPT09IEN5YW4gaGlnaGxpZ2h0IGZvciBtZXNzYWdlcyBhZGRyZXNzZWQgdG8gTVlDQUxMIGluICI8TVlDQUxMPiBERSA8Y2FsbHNpZ24+IC4uLiIgZm9ybWF0ID09PQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmcm9tIFB5UXQ1LlF0R3VpIGltcG9ydCBRQnJ1c2gsIFFDb2xvcgogICAgICAgICAgICAgICAgbXljYWxsID0gKHNlbGYubXljYWxsX2VkaXQudGV4dCgpIG9yICIiKS5zdHJpcCgpLnVwcGVyKCkgaWYgaGFzYXR0cihzZWxmLCAibXljYWxsX2VkaXQiKSBlbHNlICJNWUNBTEwiCiAgICAgICAgICAgICAgICAjIE1hdGNoOiAiPE1ZQ0FMTD4gREUgPGNhbGxzaWduPiBNZXNzYWdlIFtBQ0tubm5uXSIgKEFDSyBvcHRpb25hbCwgY2FzZS1pbnNlbnNpdGl2ZSkKICAgICAgICAgICAgICAgIGlmIHJlLm1hdGNoKHJmJ15ccyp7cmUuZXNjYXBlKG15Y2FsbCl9XHMrREVccytbQS1aMC05XXsxLDZ9KD86LVswLTldezEsMn0pP1xzKy4rPyg/OlxzK1xbQUNLWzpcc10/W0EtWjAtOV17NCwxMH1cXSk/XHMqJCcsIHR4dCwgcmUuSUdOT1JFQ0FTRSk6CiAgICAgICAgICAgICAgICAgICAgaXRlbS5zZXRGb3JlZ3JvdW5kKFFCcnVzaChRQ29sb3IoImN5YW4iKSkpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICMgPT09IGVuZCBjeWFuIGhpZ2hsaWdodCA9PT0KICAgICAgICAgICAgIyBPcHRpb25hbDogY29sb3IgZm9yIG1vbml0b3Itb25seQogICAgICAgICAgICAjIGZyb20gUHlRdDUuUXRHdWkgaW1wb3J0IFFCcnVzaCwgUUNvbG9yCiAgICAgICAgICAgICMgaXRlbS5zZXRGb3JlZ3JvdW5kKFFCcnVzaChRQ29sb3IoMjU1LDE2NSwwKSkpCiAgICAgICAgICAgIHNlbGYubWVzc2FnZXNfbGlzdC5pbnNlcnRJdGVtKDAsIGl0ZW0pCiAgICAgICAgICAgIHNlbGYubWVzc2FnZXNfbGlzdC5zZXRDdXJyZW50Um93KDApCiAgICAgICAgICAgIHNlbGYubWVzc2FnZXNfbGlzdC5zZXRDdXJyZW50Um93KDApCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBfZW5zdXJlX2NvbG9yX2F0dHJzKHNlbGYpOgogICAgICAgICcnJ0ZhbGxiYWNrIFFDb2xvci1iYXNlZCBwYWxldHRlIHNvIFFCcnVzaCguLi4sIFFDb2xvcikgY2FsbHMgYXJlIHNhZmUgYmVmb3JlIHRoZW1lIGxvYWRzLicnJwogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBQeVF0NS5RdEd1aSBpbXBvcnQgUUNvbG9yCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgIyBBcyBhIGxhc3QgcmVzb3J0LCBsZWF2ZSBhdHRyaWJ1dGVzIHVuc2V0OyBjYWxsZXIgc2hvdWxkIGd1YXJkLgogICAgICAgICAgICByZXR1cm4KICAgICAgICBkZWZhdWx0cyA9IHsKICAgICAgICAgICAgIyBLZWVwIGJvdGggU0VOVCBhbmQgVFggc3lub255bXMgZm9yIGxlZ2FjeSBjb2RlcGF0aHMKICAgICAgICAgICAgIkNPTE9SX1NFTlQiOiBRQ29sb3IoIiMwODhGOEYiKSwgICAgICAjIGJyaWdodCBncmVlbgogICAgICAgICAgICAiQ09MT1JfVFgiOiAgIFFDb2xvcigwLCAxNzYsIDI1NSksICAgICMgYmx1ZS1pc2ggZm9yIFRYIHRleHQgaWYgdXNlZAogICAgICAgICAgICAiQ09MT1JfUlgiOiAgIFFDb2xvcigyNTUsIDE2NSwgMCksICAgICMgb3JhbmdlCiAgICAgICAgICAgICJDT0xPUl9BQ0siOiAgUUNvbG9yKDAsIDIwMCwgMCksICAgICAgIyBkYXJrIGdyZWVuCiAgICAgICAgICAgICJDT0xPUl9TWVMiOiAgUUNvbG9yKDE3MCwgMTcwLCAxNzApLCAgIyBncmV5CiAgICAgICAgICAgICJDT0xPUl9FUlIiOiAgUUNvbG9yKDI1NSwgODIsIDgyKSwgICAgIyByZWQKICAgICAgICB9CiAgICAgICAgZm9yIGssIHYgaW4gZGVmYXVsdHMuaXRlbXMoKToKICAgICAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgaykgb3IgZ2V0YXR0cihzZWxmLCBrKSBpcyBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNldGF0dHIoc2VsZiwgaywgdikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwoKCiAgICBkZWYgX251a2VfbG9ja19zaXplKHNlbGYpOgogICAgICAgICMgTG9jayB3aW5kb3cgaGVpZ2h0IHRvIGN1cnJlbnQgdmFsdWUgKG51Y2xlYXIgb3B0aW9uKQogICAgICAgIHRyeToKICAgICAgICAgICAgaCA9IHNlbGYuaGVpZ2h0KCkKICAgICAgICAgICAgaWYgaCA+IDA6CiAgICAgICAgICAgICAgICBzZWxmLnNldE1pbmltdW1IZWlnaHQoaCkKICAgICAgICAgICAgICAgIHNlbGYuc2V0TWF4aW11bUhlaWdodChoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX251a2VfdW5sb2NrX3NpemUoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnNldE1pbmltdW1IZWlnaHQoMCkKICAgICAgICAgICAgc2VsZi5zZXRNYXhpbXVtSGVpZ2h0KDE2Nzc3MjE1KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgIGRlZiBzaG93RXZlbnQoc2VsZiwgZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBmcm9tIFB5UXQ1LlF0Q29yZSBpbXBvcnQgUVRpbWVyCiAgICAgICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYsICdfc2hvd25fb25jZScpOgogICAgICAgICAgICAgICAgc2VsZi5fc2hvd25fb25jZSA9IFRydWUKICAgICAgICAgICAgICAgIGlmIGdldGF0dHIoc2VsZiwgJ19zdGFydF9tYXhpbWl6ZWQnLCBGYWxzZSk6CiAgICAgICAgICAgICAgICAgICAgIyBNYXhpbWl6ZSBvbiBmaXJzdCBzaG93LCB0aGVuIGxvY2sgdG8gdGhhdCBoZWlnaHQgdG8gcHJldmVudCB0YWIgZ3Jvd3RoCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zaG93TWF4aW1pemVkKCkKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIFFUaW1lci5zaW5nbGVTaG90KDAsIHNlbGYuX251a2VfbG9ja19zaXplKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBOb3JtYWwgc3RhcnR1cDogbG9jayB0byBpbml0aWFsIGhlaWdodAogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fbnVrZV9sb2NrX3NpemUoKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIHN1cGVyKCkuc2hvd0V2ZW50KGUpCgogICAgZGVmIF9saW5rX2dyYXBoX3BydW5lKHNlbGYsIGV4cGlyeV9zZWM9MzYwMCk6CiAgICAgICAgJycnUHJ1bmUgbGluayBncmFwaCBwYXJlbnRzIHdob3NlIGxhc3Qgc2VlbiB0aW1lc3RhbXAgaW4gcG9zaXRpb25zIGlzIG9sZGVyIHRoYW4gZXhwaXJ5X3NlYy4KICAgICAgICBUaGlzIHJlbW92ZXMgcGFyZW50IGVudHJpZXMgZnJvbSBzZWxmLl9ncmFwaF9wYXJlbnRzIGFuZCBwZXJzaXN0cyB0aGUgbGlua19ncmFwaCBmaWxlIGlmIGNoYW5nZWQuJycnCiAgICAgICAgdHJ5OgogICAgICAgICAgICBub3cgPSBpbnQodGltZS50aW1lKCkpCiAgICAgICAgICAgIHBvcyA9IGdldGF0dHIoc2VsZiwgJ19wb3NpdGlvbnMnLCB7fSkgb3Ige30KICAgICAgICAgICAgZ3AgPSBnZXRhdHRyKHNlbGYsICdfZ3JhcGhfcGFyZW50cycsIHt9KSBvciB7fQogICAgICAgICAgICByZW1vdmVkID0gRmFsc2UKICAgICAgICAgICAgdG9fcmVtb3ZlID0gW10KICAgICAgICAgICAgZm9yIHBhcmVudCBpbiBsaXN0KGdwLmtleXMoKSk6CiAgICAgICAgICAgICAgICBwX2tleSA9IHBhcmVudAogICAgICAgICAgICAgICAgIyBmaW5kIGxhc3RfdXBkYXRlIGluIHBvc2l0aW9ucyBpZiBwcmVzZW50CiAgICAgICAgICAgICAgICBlbnQgPSBwb3MuZ2V0KHBfa2V5KSBvciBwb3MuZ2V0KHBfa2V5LnVwcGVyKCkpIG9yIHBvcy5nZXQocF9rZXkubG93ZXIoKSkgb3Ige30KICAgICAgICAgICAgICAgIGxhc3QgPSBlbnQuZ2V0KCdsYXN0X3VwZGF0ZScpCiAgICAgICAgICAgICAgICBpZiBsYXN0IGlzIE5vbmU6CiAgICAgICAgICAgICAgICAgICAgIyBJZiB0aGVyZSdzIG5vIHBvc2l0aW9uIGVudHJ5IGZvciB0aGlzIHBhcmVudCwgd2UgdHJlYXQgYXMgc3RhbGUKICAgICAgICAgICAgICAgICAgICB0b19yZW1vdmUuYXBwZW5kKHBhcmVudCkKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGxhc3RfdHMgPSBpbnQobGFzdCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgdG9fcmVtb3ZlLmFwcGVuZChwYXJlbnQpCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGlmIGxhc3RfdHMgPCAobm93IC0gaW50KGV4cGlyeV9zZWMpKToKICAgICAgICAgICAgICAgICAgICB0b19yZW1vdmUuYXBwZW5kKHBhcmVudCkKICAgICAgICAgICAgZm9yIHAgaW4gdG9fcmVtb3ZlOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGdwLnBvcChwLCBOb25lKQogICAgICAgICAgICAgICAgICAgIHJlbW92ZWQgPSBUcnVlCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgaWYgcmVtb3ZlZDoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAjIHBlcnNpc3QgY2hhbmdlIHVzaW5nIGV4aXN0aW5nIHNhdmUgcm91dGluZSBpZiBhdmFpbGFibGUKICAgICAgICAgICAgICAgICAgICBzYXZlX2ZuID0gZ2V0YXR0cihzZWxmLCAnX3NhdmVfbGlua19ncmFwaCcsIE5vbmUpCiAgICAgICAgICAgICAgICAgICAgaWYgY2FsbGFibGUoc2F2ZV9mbik6CiAgICAgICAgICAgICAgICAgICAgICAgIHNhdmVfZm4oKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgZmFsbGJhY2s6IHdyaXRlIHN0b3JlL2xpbmtfZ3JhcGguanNvbgogICAgICAgICAgICAgICAgICAgICAgICBpbXBvcnQganNvbiwgb3MKICAgICAgICAgICAgICAgICAgICAgICAgc3RvcmUgPSBvcy5wYXRoLmpvaW4ob3MucGF0aC5kaXJuYW1lKF9fZmlsZV9fKSwgJ3N0b3JlJykKICAgICAgICAgICAgICAgICAgICAgICAgb3MubWFrZWRpcnMoc3RvcmUsIGV4aXN0X29rPVRydWUpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpdGggb3Blbihvcy5wYXRoLmpvaW4oc3RvcmUsICdsaW5rX2dyYXBoLmpzb24nKSwgJ3cnLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmaDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGpzb24uZHVtcCh7J3BhcmVudHMnOiBncCwgJ2NoaWxkcmVuJzogZ3AsICdlZGdlcyc6IFtdfSwgZmgsIGluZGVudD0yKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICMgdXBkYXRlIGluLW1lbW9yeQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLl9ncmFwaF9wYXJlbnRzID0gZ3AKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgIyAtLS0tIE1ldHJpY3MgaGVscGVycyAoU3RlcCBEKSAtLS0tCiAgICBkZWYgX215X3Bvc2l0aW9uKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgZ2V0YXR0cihzZWxmLCAnX2JlYWNvbl9jb29yZHNfZW5hYmxlZCcsIEZhbHNlKToKICAgICAgICAgICAgICAgIGxhdCA9IGdldGF0dHIoc2VsZiwgJ19iZWFjb25fY29vcmRzX2xhdCcsIE5vbmUpCiAgICAgICAgICAgICAgICBsb24gPSBnZXRhdHRyKHNlbGYsICdfYmVhY29uX2Nvb3Jkc19sb24nLCBOb25lKQogICAgICAgICAgICAgICAgaWYgbGF0IGlzIG5vdCBOb25lIGFuZCBsb24gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGZsb2F0KGxhdCksIGZsb2F0KGxvbikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBteWMgPSAoc2VsZi5teWNhbGxfZWRpdC50ZXh0KCkgb3IgJycpLnN0cmlwKCkudXBwZXIoKSBpZiBoYXNhdHRyKHNlbGYsICdteWNhbGxfZWRpdCcpIGVsc2UgJycKICAgICAgICAgICAgaWYgbm90IG15YzoKICAgICAgICAgICAgICAgIHJldHVybiAoTm9uZSwgTm9uZSkKICAgICAgICAgICAgYiA9IGJhc2VfY2FsbHNpZ24obXljKQogICAgICAgICAgICBwb3MgPSBnZXRhdHRyKHNlbGYsICdfcG9zaXRpb25zJywge30pIG9yIHt9CiAgICAgICAgICAgIGVudCA9IHBvcy5nZXQoYikgb3Ige30KICAgICAgICAgICAgbGF0ID0gZW50LmdldCgnbGF0Jyk7IGxvbiA9IGVudC5nZXQoJ2xvbicpCiAgICAgICAgICAgIGlmIGxhdCBpcyBub3QgTm9uZSBhbmQgbG9uIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgcmV0dXJuIGZsb2F0KGxhdCksIGZsb2F0KGxvbikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIChOb25lLCBOb25lKQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnbGlua21hcCcpIGFuZCBoYXNhdHRyKHNlbGYubGlua21hcCwgJ2RyYXdfZ3JhcGgnKToKICAgICAgICAgICAgICAgIHNlbGYubGlua21hcC5kcmF3X2dyYXBoKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLl9yZWZyZXNoX2JlYWNvbnNfdWkoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX3N0YXRpb25fcG9zaXRpb24oc2VsZiwgY2FsbHNpZ246IHN0cik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBjcyA9IGJhc2VfY2FsbHNpZ24oY2FsbHNpZ24gb3IgJycpCiAgICAgICAgICAgIHBvcyA9IGdldGF0dHIoc2VsZiwgJ19wb3NpdGlvbnMnLCB7fSkgb3Ige30KICAgICAgICAgICAgZW50ID0gcG9zLmdldChjcykgb3Ige30KICAgICAgICAgICAgbGF0ID0gZW50LmdldCgnbGF0Jyk7IGxvbiA9IGVudC5nZXQoJ2xvbicpCiAgICAgICAgICAgIGlmIGxhdCBpcyBub3QgTm9uZSBhbmQgbG9uIGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgcmV0dXJuIGZsb2F0KGxhdCksIGZsb2F0KGxvbikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIChOb25lLCBOb25lKQoKICAgIGRlZiBfbWV0cmljX2Zyb21fbXljYWxsKHNlbGYsIGNhbGxzaWduOiBzdHIpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IGNhbGxzaWduOgogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgbXlfbGF0LCBteV9sb24gPSBzZWxmLl9teV9wb3NpdGlvbigpCiAgICAgICAgICAgIGlmIG15X2xhdCBpcyBOb25lIG9yIG15X2xvbiBpcyBOb25lOgogICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgc3RfbGF0LCBzdF9sb24gPSBzZWxmLl9zdGF0aW9uX3Bvc2l0aW9uKGNhbGxzaWduKQogICAgICAgICAgICBpZiBzdF9sYXQgaXMgTm9uZSBvciBzdF9sb24gaXMgTm9uZToKICAgICAgICAgICAgICAgIHJldHVybiBOb25lCiAgICAgICAgICAgIGttID0gX2dlb19oYXZlcnNpbmVfa20obXlfbGF0LCBteV9sb24sIHN0X2xhdCwgc3RfbG9uKQogICAgICAgICAgICBtaSA9IGttICogMC42MjEzNzEKICAgICAgICAgICAgZGVnID0gX2dlb19pbml0aWFsX2JlYXJpbmdfZGVnKG15X2xhdCwgbXlfbG9uLCBzdF9sYXQsIHN0X2xvbikKICAgICAgICAgICAgY2FyZCA9IF9nZW9fY2FyZGluYWwxNihkZWcpCiAgICAgICAgICAgIGRlZiBfZm10KHgpOiByZXR1cm4gZiJ7eDouMWZ9IiBpZiB4IDwgMTAwIGVsc2UgZiJ7eDouMGZ9IgogICAgICAgICAgICByZXR1cm4geyJrbSI6IGttLCAibWkiOiBtaSwgImRlZyI6IGRlZywgImNhcmQiOiBjYXJkLAogICAgICAgICAgICAgICAgICAgICJrbV9zdHIiOiBfZm10KGttKSwgIm1pX3N0ciI6IF9mbXQobWkpLAogICAgICAgICAgICAgICAgICAgICJkZWdfc3RyIjogZiJ7aW50KHJvdW5kKGRlZykpJTM2MDowM2R9In0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgZGVmIF9hcHBseV90eF9jb2xvcl9mb3JfdGhlbWUoc2VsZiwgdGhlbWVfbmFtZTogc3RyID0gJycpOgogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBQeVF0NS5RdEd1aSBpbXBvcnQgUUNvbG9yCiAgICAgICAgICAgIHNlbGYuQ09MT1JfU0VOVCA9IFFDb2xvcignIzA4OEY4RicpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBfc3RyaXBfYWNrX2lkKHNlbGYsIHRleHQ6IHN0cikgLT4gc3RyOgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHJlIGFzIF9yZQogICAgICAgICAgICB0ID0gKHRleHQgb3IgJycpCiAgICAgICAgICAgICMgUmVtb3ZlIFtBQ0s6IyMjI10KICAgICAgICAgICAgdCA9IF9yZS5zdWIocidccypcW0FDSzpbMC05QS1aXXs0LDh9XF1ccyonLCAnICcsIHQsIGZsYWdzPV9yZS5JKQogICAgICAgICAgICAjIFJlbW92ZSB0cmFpbGluZyBzdGF0dXMgZGVjb3JhdGlvbnMgbGlrZSAoYXR0ZW1wdCAxLzMpIG9yIChGQUlMRUQgYWZ0ZXIgMy8zKQogICAgICAgICAgICB0ID0gX3JlLnN1YihyJ1xzKlwoKD86YXR0ZW1wdFxzK1xkLzN8ZmFpbGVkXHMrYWZ0ZXJccyszLzMpXClccyonLCAnICcsIHQsIGZsYWdzPV9yZS5JKQogICAgICAgICAgICByZXR1cm4gdC5zdHJpcCgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcmV0dXJuIHRleHQKCiAgICBkZWYgX3RpY2tzX2Zvcl9zdGF0dXMoc2VsZiwgc3RhdHVzOiBzdHIpIC0+IHN0cjoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHMgPSAoc3RhdHVzIG9yICcnKS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICAgICAgaWYgcy5zdGFydHN3aXRoKCdhdHRlbXB0Jyk6CiAgICAgICAgICAgICAgICByZXR1cm4gJyDinJMnCiAgICAgICAgICAgIGlmIHMgPT0gJ2Fjaycgb3IgJ2Fja2VkJyBpbiBzOgogICAgICAgICAgICAgICAgcmV0dXJuICcg4pyT4pyTJwogICAgICAgICAgICBpZiBzLnN0YXJ0c3dpdGgoJ2ZhaWxlZCcpOgogICAgICAgICAgICAgICAgcmV0dXJuICcg4pyXJwogICAgICAgICAgICByZXR1cm4gJycKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gJycKICAgIGRlZiBfdXBkYXRlX2xhc3RfdHhfbGFiZWwoc2VsZik6CiAgICAgICAgaW1wb3J0IGRhdGV0aW1lIGFzIF9kdAogICAgICAgIHRyeToKICAgICAgICAgICAgdHMgPSBnZXRhdHRyKHNlbGYsICdfbGFzdF90eF9pc28nLCBOb25lKQogICAgICAgICAgICBpZiBub3QgdHM6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5sYXN0X3R4X2xhYmVsLnNldFRleHQoJ0xhc3QgVFg6IOKAlCcpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICBkdCA9IF9kdC5kYXRldGltZS5mcm9taXNvZm9ybWF0KHRzLnJlcGxhY2UoJ1onLCcrMDA6MDAnKSkKICAgICAgICAgICAgbm93ID0gX2R0LmRhdGV0aW1lLm5vdyhfZHQudGltZXpvbmUudXRjKQogICAgICAgICAgICBkZWx0YSA9IG1heCgwLCBpbnQoKG5vdyAtIGR0KS50b3RhbF9zZWNvbmRzKCkpKQogICAgICAgICAgICBtLCBzID0gZGl2bW9kKGRlbHRhLCA2MCkKICAgICAgICAgICAgaCwgbSA9IGRpdm1vZChtLCA2MCkKICAgICAgICAgICAgaWYgaDoKICAgICAgICAgICAgICAgIHR4dCA9IGYne2h9aCB7bX1tIHtzfXMgYWdvJwogICAgICAgICAgICBlbGlmIG06CiAgICAgICAgICAgICAgICB0eHQgPSBmJ3ttfW0ge3N9cyBhZ28nCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB0eHQgPSBmJ3tzfXMgYWdvJwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmxhc3RfdHhfbGFiZWwuc2V0VGV4dChmJ0xhc3QgVFg6IHt0eHR9JykKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLmxhc3RfdHhfbGFiZWwuc2V0VGV4dCgnTGFzdCBUWDog4oCUJykKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX3RvdWNoX2xhc3RfdHgoc2VsZiwgaXNvPU5vbmUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaXNvIGlzIE5vbmU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaXNvID0gc2VsZi5fdXRjX25vd19pc28oKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBpbXBvcnQgZGF0ZXRpbWUgYXMgX2R0CiAgICAgICAgICAgICAgICAgICAgaXNvID0gX2R0LmRhdGV0aW1lLm5vdyhfZHQudGltZXpvbmUudXRjKS5pc29mb3JtYXQodGltZXNwZWM9J3NlY29uZHMnKS5yZXBsYWNlKCcrMDA6MDAnLCdaJykKICAgICAgICAgICAgc2VsZi5fbGFzdF90eF9pc28gPSBpc28KICAgICAgICAgICAgc2VsZi5fdXBkYXRlX2xhc3RfdHhfbGFiZWwoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKIyA9PT09PSBGaWxlIFRyYW5zZmVyIChVcGxvYWQg4oaSIE1FVEEvT0svUEFSVC9FTkQgd2l0aCBQSU5HL1BPTkcgcHJvYmVzKSA9PT09PQogICAgZGVmIF9maWxlX21ha2VfZmlkKHNlbGYsIHdpZHRoPTUpOgogICAgICAgIGltcG9ydCByYW5kb20sIHN0cmluZwogICAgICAgIHJldHVybiAnJy5qb2luKHJhbmRvbS5jaG9pY2Uoc3RyaW5nLmFzY2lpX3VwcGVyY2FzZSArIHN0cmluZy5kaWdpdHMpIGZvciBfIGluIHJhbmdlKHdpZHRoKSkKCiAgICBkZWYgX2ZpbGVfY2h1bmtzKHNlbGYsIGRhdGE6IGJ5dGVzLCBtYXhfYjY0X3Blcl9saW5lPTE4MCk6CiAgICAgICAgcmF3ID0gKG1heF9iNjRfcGVyX2xpbmUgKiAzKSAvLyA0CiAgICAgICAgZm9yIGkgaW4gcmFuZ2UoMCwgbGVuKGRhdGEpLCByYXcpOgogICAgICAgICAgICB5aWVsZCBkYXRhW2k6aStyYXddCgogICAgZGVmIF9nZXRfdGFyZ2V0X2NhbGwoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICB0ID0gKHNlbGYudG9fZWRpdC50ZXh0KCkgb3IgIiIpLnN0cmlwKCkudXBwZXIoKQogICAgICAgICAgICByZXR1cm4gdAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHJldHVybiAiIgoKICAgIGRlZiBfc2VuZF9wcm90b2NvbF9saW5lKHNlbGYsIHBheWxvYWQ6IHN0ciwgdG86IHN0cik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBtZSA9IChzZWxmLm15Y2FsbF9lZGl0LnRleHQoKSBvciAiIikuc3RyaXAoKS51cHBlcigpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgbWUgPSAiIgogICAgICAgIGlmIG5vdCB0byBvciBub3QgbWU6CiAgICAgICAgICAgIHRyeTogc2VsZi5fc3RhdHVzKCJUYXJnZXQvTXlDQUxMIG1pc3NpbmcgZm9yIGZpbGUgdHJhbnNmZXIiKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGxpbmUgPSBmInt0b30gREUge21lfSB7cGF5bG9hZH0iCiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gc2VsZi5zZW5kX3VzZXJfdGV4dChsaW5lKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfc2VuZF93aXRoX2FjayhzZWxmLCBwYXlsb2FkOiBzdHIsIHRvOiBzdHIsIGFja19pZDogc3RyKToKICAgICAgICAjIFN0ZXAgMzogdHJhY2sgd2hvIGlzIGFsbG93ZWQgdG8gQUNLIHRoaXMgaWQKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYsICdfcGVuZGluZ19vdXRib3gnKToKICAgICAgICAgICAgICAgIHNlbGYuX3BlbmRpbmdfb3V0Ym94ID0ge30KICAgICAgICAgICAgc2VsZi5fcGVuZGluZ19vdXRib3hbYWNrX2lkXSA9IHsndGFyZ2V0JzogKHRvIG9yICcnKS5zdHJpcCgpLnVwcGVyKCksICd0cyc6IF90aW1lX2Fjay5tb25vdG9uaWMoKX0KICAgICAgICAgICAgIyBwcnVuZSA+MTUgbWludXRlcwogICAgICAgICAgICBmb3IgaywgdiBpbiBsaXN0KHNlbGYuX3BlbmRpbmdfb3V0Ym94Lml0ZW1zKCkpOgogICAgICAgICAgICAgICAgaWYgKF90aW1lX2Fjay5tb25vdG9uaWMoKSAtIHYuZ2V0KCd0cycsIDApKSA+IDkwMDoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9wZW5kaW5nX291dGJveC5wb3AoaywgTm9uZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgbXNnID0gZiJ7cGF5bG9hZH0gW0FDSzp7YWNrX2lkfV0iCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhID0gQWNrU3RhdGUoc2VsZiwgYWNrX2lkLCBmInt0b30gREUgIiArIChzZWxmLm15Y2FsbF9lZGl0LnRleHQoKS5zdHJpcCgpLnVwcGVyKCkgaWYgaGFzYXR0cihzZWxmLCAibXljYWxsX2VkaXQiKSBlbHNlICJNWUNBTEwiKSArICIgIiArIG1zZywgaW50KGdldGF0dHIoc2VsZiwgIl9hY2tfcGF1c2UiLCAxMikpKQogICAgICAgICAgICBpZiBnZXRhdHRyKHNlbGYsICJfYWNrX3N0YXRlcyIsIE5vbmUpIGlzIE5vbmU6CiAgICAgICAgICAgICAgICBzZWxmLl9hY2tfc3RhdGVzID0ge30KICAgICAgICAgICAgc2VsZi5fYWNrX3N0YXRlc1thY2tfaWRdID0gYQogICAgICAgICAgICBhLnN0YXJ0KCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBzZWxmLl9zZW5kX3Byb3RvY29sX2xpbmUobXNnLCB0bykKCiAgICAjIC0tLSBTZW5kZXItc2lkZTogd2FpdCBmb3IgRklMRSBPSyBhbmQgYmV0d2Vlbi1wYXJ0IFBJTkcvUE9ORyBwcm9iZSAtLS0KICAgIGRlZiBfd2FpdF9maWxlX29rKHNlbGYsIGZpZDogc3RyLCB0aW1lb3V0PTMwKToKICAgICAgICBpbXBvcnQgdGltZQogICAgICAgIHNlbGYuX2ZpbGVfbGFzdF9vayA9ICIiCiAgICAgICAgdDAgPSB0aW1lLnRpbWUoKQogICAgICAgIHdoaWxlIHRpbWUudGltZSgpIC0gdDAgPCB0aW1lb3V0OgogICAgICAgICAgICAjIENoZWNrIGZsYWcgc2V0IGJ5IFJYIG9uICdGSUxFIE9LIFtGSUQ6ZmlkXScKICAgICAgICAgICAgaWYgZ2V0YXR0cihzZWxmLCAiX2ZpbGVfbGFzdF9vayIsICIiKSA9PSBmaWQ6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBRQXBwbGljYXRpb24ucHJvY2Vzc0V2ZW50cygpCiAgICAgICAgICAgIHRpbWUuc2xlZXAoMC4xKQogICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfd2FpdF9wcm9iZV9wb25nKHNlbGYsIGZpZDogc3RyLCB0bzogc3RyLCB0aW1lb3V0PTMwLCBpbnRlcnZhbD0zKToKICAgICAgICBpbXBvcnQgdGltZQogICAgICAgIHQwID0gdGltZS50aW1lKCkKICAgICAgICB0cmllcyA9IDAKICAgICAgICB3aGlsZSB0aW1lLnRpbWUoKSAtIHQwIDwgdGltZW91dDoKICAgICAgICAgICAgIyBTZW5kIFBJTkcKICAgICAgICAgICAgc2VsZi5fc2VuZF9wcm90b2NvbF9saW5lKGYiRklMRSBQSU5HIFtGSUQ6e2ZpZH1dIiwgdG8pCiAgICAgICAgICAgIHRyaWVzICs9IDEKICAgICAgICAgICAgIyBXYWl0IGludGVydmFsLCBsb29rIGZvciBQT05HIGZsYWcKICAgICAgICAgICAgdDEgPSB0aW1lLnRpbWUoKQogICAgICAgICAgICB3aGlsZSB0aW1lLnRpbWUoKSAtIHQxIDwgaW50ZXJ2YWw6CiAgICAgICAgICAgICAgICBpZiBnZXRhdHRyKHNlbGYsICJfZmlsZV9sYXN0X3BvbmciLCAiIikgPT0gZmlkOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgICAgICBRQXBwbGljYXRpb24ucHJvY2Vzc0V2ZW50cygpCiAgICAgICAgICAgICAgICB0aW1lLnNsZWVwKDAuMDUpCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIHNlbmRfZmlsZV9wYXRoKHNlbGYsIHBhdGg6IHN0cik6CiAgICAgICAgJycnVXBsb2FkLW9ubHkgZmlsZSBzZW5kIHdpdGggc3RyaWN0IGFjY2VwdCAoRklMRSBPSykgKyBQSU5HL1BPTkcgYmV0d2VlbiBwYXJ0cy4gU2VuZGVyIGNhcCA1MDAgS0IuJycnCiAgICAgICAgaW1wb3J0IG9zLCBoYXNobGliLCBiYXNlNjQsIHRpbWUKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRvID0gc2VsZi5fZ2V0X3RhcmdldF9jYWxsKCkKICAgICAgICAgICAgaWYgbm90IHRvOgogICAgICAgICAgICAgICAgUU1lc3NhZ2VCb3guaW5mb3JtYXRpb24oc2VsZiwgIlNlbmQgRmlsZSIsICJQbGVhc2Ugc2V0IGEgVGFyZ2V0L1RPIGNhbGxzaWduIGZpcnN0LiIpCiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgd2l0aCBvcGVuKHBhdGgsICJyYiIpIGFzIGY6CiAgICAgICAgICAgICAgICBkYXRhID0gZi5yZWFkKCkKCiAgICAgICAgICAgICMgU2VuZGVyLXNpZGUgY2FwCiAgICAgICAgICAgIE1BWF9GSUxFX1NJWkUgPSA1MDAgKiAxMDI0CiAgICAgICAgICAgIGlmIGxlbihkYXRhKSA+IE1BWF9GSUxFX1NJWkU6CiAgICAgICAgICAgICAgICB0cnk6IHNlbGYuX3N0YXR1cyhmIkZpbGUgdG9vIGxhcmdlOiB7bGVuKGRhdGEpfSBieXRlcyAobGltaXQge01BWF9GSUxFX1NJWkV9IGJ5dGVzKS4iKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAgICAgUU1lc3NhZ2VCb3gud2FybmluZyhzZWxmLCAiU2VuZCBGaWxlIiwgZiJGaWxlIHRvbyBsYXJnZToge2xlbihkYXRhKX0gYnl0ZXMgKGxpbWl0IHtNQVhfRklMRV9TSVpFfSBieXRlcykuIikKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgbmFtZSA9IG9zLnBhdGguYmFzZW5hbWUocGF0aCkKICAgICAgICAgICAgc2hhMSA9IGhhc2hsaWIuc2hhMShkYXRhKS5oZXhkaWdlc3QoKQogICAgICAgICAgICBmaWQgID0gc2VsZi5fZmlsZV9tYWtlX2ZpZCgpCiAgICAgICAgICAgIHBhcnRzID0gbGlzdChzZWxmLl9maWxlX2NodW5rcyhkYXRhKSkKICAgICAgICAgICAgTiA9IGxlbihwYXJ0cykKCiAgICAgICAgICAgICMgMSkgT2ZmZXIKICAgICAgICAgICAgbWV0YSA9IGYnRklMRSBNRVRBIG5hbWU9IntuYW1lfSIgc2l6ZT17bGVuKGRhdGEpfSBzaGExPXtzaGExfSBbRklEOntmaWR9XScKICAgICAgICAgICAgc2VsZi5fc2VuZF9wcm90b2NvbF9saW5lKG1ldGEsIHRvKQogICAgICAgICAgICB0cnk6IHNlbGYuX3N0YXR1cyhmIk9mZmVyZWQgZmlsZToge25hbWV9ICh7bGVuKGRhdGEpfSBieXRlcykg4oCUIHdhaXRpbmcgZm9yIE9L4oCmIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwoKICAgICAgICAgICAgIyAyKSBXYWl0IGZvciBGSUxFIE9LCiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl93YWl0X2ZpbGVfb2soZmlkLCB0aW1lb3V0PTMwKToKICAgICAgICAgICAgICAgIHRyeTogc2VsZi5fc3RhdHVzKCJGaWxlIG9mZmVyIGRlY2xpbmVkIG9yIHRpbWVkIG91dC4iKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICAjIDMpIFNlbmQgcGFydHMgd2l0aCBpbnRlci1jaHVuayBQSU5HL1BPTkcKICAgICAgICAgICAgZm9yIGksIGNodW5rIGluIGVudW1lcmF0ZShwYXJ0cywgc3RhcnQ9MSk6CiAgICAgICAgICAgICAgICBpZiBpID4gMToKICAgICAgICAgICAgICAgICAgICBpZiBub3Qgc2VsZi5fd2FpdF9wcm9iZV9wb25nKGZpZCwgdG8sIHRpbWVvdXQ9MzAsIGludGVydmFsPTMpOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6IHNlbGYuX3N0YXR1cygiUmVjZWl2ZXIgdW5yZXNwb25zaXZlIChubyBQT05HKSDigJQgYWJvcnRpbmcgZmlsZSBzZW5kLiIpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICBiNjQgPSBiYXNlNjQuYjY0ZW5jb2RlKGNodW5rKS5kZWNvZGUoImFzY2lpIikKICAgICAgICAgICAgICAgIHBheWxvYWQgPSBmJ0ZJTEUgUEFSVCB7aX0ve059IFtGSUQ6e2ZpZH1dIHtiNjR9JwogICAgICAgICAgICAgICAgYWNrX2lkID0gc2VsZi5fZmlsZV9tYWtlX2ZpZCg0KQogICAgICAgICAgICAgICAgc2VsZi5fc2VuZF93aXRoX2FjayhwYXlsb2FkLCB0bywgYWNrX2lkKQogICAgICAgICAgICAgICAgIyBicmllZiBVSSBicmVhdGhpbmcgcm9vbQogICAgICAgICAgICAgICAgUUFwcGxpY2F0aW9uLnByb2Nlc3NFdmVudHMoKTsgdGltZS5zbGVlcCgwLjA1KQoKICAgICAgICAgICAgIyA0KSBFbmQKICAgICAgICAgICAgZW5kID0gZidGSUxFIEVORCBbRklEOntmaWR9XScKICAgICAgICAgICAgc2VsZi5fc2VuZF9wcm90b2NvbF9saW5lKGVuZCwgdG8pCiAgICAgICAgICAgIHRyeTogc2VsZi5fc3RhdHVzKGYiRmlsZSBzZW50OiB7bmFtZX0gKHtsZW4oZGF0YSl9IGJ5dGVzKSBpbiB7Tn0gcGFydHMuIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgdHJ5OiBzZWxmLl9zdGF0dXMoZiJGaWxlIHNlbmQgZmFpbGVkOiB7ZX0iKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfb25fdXBsb2FkX2ZpbGVfc2VsZWN0ZWQoc2VsZiwgcGF0aDogc3RyKToKICAgICAgICByZXR1cm4gc2VsZi5zZW5kX2ZpbGVfcGF0aChwYXRoKQoKICAgICMgLS0tIFJlY2VpdmVyLXNpZGU6IG9mZmVycyBsaXN0ICsgT0svTk8gKyBQT05HICsgcmVhc3NlbWJseSAtLS0KICAgIGRlZiBfZW5zdXJlX2ZpbGVfc3RhdGUoc2VsZik6CiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgIl9maWxlX29mZmVycyIpOiBzZWxmLl9maWxlX29mZmVycyA9IHt9CiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgIl9maWxlX3J4Iik6IHNlbGYuX2ZpbGVfcnggPSB7fQogICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYsICJfZmlsZV9sYXN0X29rIik6IHNlbGYuX2ZpbGVfbGFzdF9vayA9ICIiCiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgIl9maWxlX2xhc3RfcG9uZyIpOiBzZWxmLl9maWxlX2xhc3RfcG9uZyA9ICIiCgogICAgZGVmIF9pbmNvbWluZ19zZWxlY3RlZF9zaWQoc2VsZik6CiAgICAgICAgaXQgPSBzZWxmLmluY29taW5nX2xpc3QuY3VycmVudEl0ZW0oKQogICAgICAgIHJldHVybiBpdC50ZXh0KCkgaWYgaXQgZWxzZSBOb25lCgogICAgZGVmIF9pbmNvbWluZ19hY2NlcHRfc2VsZWN0ZWQoc2VsZik6CiAgICAgICAgc2VsZi5fZW5zdXJlX2ZpbGVfc3RhdGUoKQogICAgICAgIGl0ID0gc2VsZi5pbmNvbWluZ19saXN0LmN1cnJlbnRJdGVtKCkKICAgICAgICBpZiBub3QgaXQ6IAogICAgICAgICAgICBzZWxmLl9zdGF0dXMoIk5vIGluY29taW5nIGZpbGUgc2VsZWN0ZWQuIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgdHh0ID0gaXQudGV4dCgpCiAgICAgICAgbSA9IHJlLnNlYXJjaChyJ1xbKFswLTlBLVpdezQsNn0pXF0nLCB0eHQpCiAgICAgICAgZmlkID0gbS5ncm91cCgxKSBpZiBtIGVsc2UgTm9uZQogICAgICAgIGlmIG5vdCBmaWQgb3IgZmlkIG5vdCBpbiBzZWxmLl9maWxlX29mZmVyczoKICAgICAgICAgICAgc2VsZi5fc3RhdHVzKCJJbnZhbGlkIHNlbGVjdGlvbi4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBmcm0gPSBzZWxmLl9maWxlX29mZmVyc1tmaWRdLmdldCgiZnJvbSIsIiIpCiAgICAgICAgIyBTZW5kIE9LIGJhY2sgdG8gc2VuZGVyCiAgICAgICAgc2VsZi5fc2VuZF9wcm90b2NvbF9saW5lKGYiRklMRSBPSyBbRklEOntmaWR9XSIsIGZybSkKICAgICAgICBzZWxmLl9zdGF0dXMoZiJBY2NlcHRlZCBmaWxlIFtGSUQ6e2ZpZH1dIGZyb20ge2ZybX0iKQogICAgICAgICMgS2VlcCBpbiBsaXN0IHVudGlsIEVORCBjb21wbGV0ZXMKCiAgICBkZWYgX2luY29taW5nX2RlY2xpbmVfc2VsZWN0ZWQoc2VsZik6CiAgICAgICAgc2VsZi5fZW5zdXJlX2ZpbGVfc3RhdGUoKQogICAgICAgIGl0ID0gc2VsZi5pbmNvbWluZ19saXN0LmN1cnJlbnRJdGVtKCkKICAgICAgICBpZiBub3QgaXQ6IAogICAgICAgICAgICBzZWxmLl9zdGF0dXMoIk5vIGluY29taW5nIGZpbGUgc2VsZWN0ZWQuIikKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgdHh0ID0gaXQudGV4dCgpCiAgICAgICAgbSA9IHJlLnNlYXJjaChyJ1xbKFswLTlBLVpdezQsNn0pXF0nLCB0eHQpCiAgICAgICAgZmlkID0gbS5ncm91cCgxKSBpZiBtIGVsc2UgTm9uZQogICAgICAgIGlmIG5vdCBmaWQgb3IgZmlkIG5vdCBpbiBzZWxmLl9maWxlX29mZmVyczoKICAgICAgICAgICAgc2VsZi5fc3RhdHVzKCJJbnZhbGlkIHNlbGVjdGlvbi4iKQogICAgICAgICAgICByZXR1cm4KICAgICAgICBmcm0gPSBzZWxmLl9maWxlX29mZmVyc1tmaWRdLmdldCgiZnJvbSIsIiIpCiAgICAgICAgc2VsZi5fc2VuZF9wcm90b2NvbF9saW5lKGYiRklMRSBOTyBbRklEOntmaWR9XSIsIGZybSkKICAgICAgICBzZWxmLl9zdGF0dXMoZiJEZWNsaW5lZCBmaWxlIFtGSUQ6e2ZpZH1dIGZyb20ge2ZybX0iKQogICAgICAgICMgUmVtb3ZlIGZyb20gVUkgYW5kIHN0YXRlCiAgICAgICAgcm93ID0gc2VsZi5pbmNvbWluZ19saXN0LnJvdyhzZWxmLmluY29taW5nX2xpc3QuY3VycmVudEl0ZW0oKSkKICAgICAgICBzZWxmLmluY29taW5nX2xpc3QudGFrZUl0ZW0ocm93KQogICAgICAgIHRyeTogZGVsIHNlbGYuX2ZpbGVfb2ZmZXJzW2ZpZF0KICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCgogICAgZGVmIF9pbmNvbWluZ19yZXNldF93aW5kb3coc2VsZik6CiAgICAgICAgc2VsZi5fZW5zdXJlX2ZpbGVfc3RhdGUoKQogICAgICAgIHNlbGYuaW5jb21pbmdfbGlzdC5jbGVhcigpCiAgICAgICAgc2VsZi5fZmlsZV9vZmZlcnMuY2xlYXIoKQogICAgICAgIHNlbGYuX3N0YXR1cygiSW5jb21pbmcgZmlsZSB3aW5kb3cgcmVzZXQuIikKCiAgICBkZWYgX3J4X2hhbmRsZV9maWxlX2xpbmUoc2VsZiwgdG86IHN0ciwgZnJtOiBzdHIsIG1zZzogc3RyKSAtPiBib29sOgogICAgICAgICcnJ1BhcnNlIEZJTEUgZnJhbWVzOyBkcml2ZSBvZmZlcnMgKyByZXNwb25kIHRvIFBJTkc7IHJlYXNzZW1ibGUgdG8gc3RvcmUvaW5ib3gvJycnCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3QgbXNnLnN0YXJ0c3dpdGgoIkZJTEUgIik6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgaW1wb3J0IHJlLCBiYXNlNjQsIG9zLCBoYXNobGliCiAgICAgICAgICAgIHNlbGYuX2Vuc3VyZV9maWxlX3N0YXRlKCkKICAgICAgICAgICAgbWUgPSAoc2VsZi5teWNhbGxfZWRpdC50ZXh0KCkuc3RyaXAoKS51cHBlcigpIGlmIGhhc2F0dHIoc2VsZiwgIm15Y2FsbF9lZGl0IikgZWxzZSAiIikKICAgICAgICAgICAgIyBQSU5HL1BPTkcgcXVpY2sgcGF0aAogICAgICAgICAgICBpZiBtc2cuc3RhcnRzd2l0aCgiRklMRSBQSU5HIik6CiAgICAgICAgICAgICAgICBtZiA9IHJlLnNlYXJjaChyJ1xbRklEOihbMC05QS1aXSspXF0nLCBtc2cpCiAgICAgICAgICAgICAgICBpZiBtZjoKICAgICAgICAgICAgICAgICAgICBmaWQgPSBtZi5ncm91cCgxKQogICAgICAgICAgICAgICAgICAgICMgUmVwbHkgUE9ORwogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NlbmRfcHJvdG9jb2xfbGluZShmIkZJTEUgUE9ORyBbRklEOntmaWR9XSIsIGZybSkKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGlmIG1zZy5zdGFydHN3aXRoKCJGSUxFIFBPTkciKToKICAgICAgICAgICAgICAgIG1mID0gcmUuc2VhcmNoKHInXFtGSUQ6KFswLTlBLVpdKylcXScsIG1zZykKICAgICAgICAgICAgICAgIGlmIG1mOgogICAgICAgICAgICAgICAgICAgIHNlbGYuX2ZpbGVfbGFzdF9wb25nID0gbWYuZ3JvdXAoMSkKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIGlmIG1zZy5zdGFydHN3aXRoKCJGSUxFIE9LIik6CiAgICAgICAgICAgICAgICBtZiA9IHJlLnNlYXJjaChyJ1xbRklEOihbMC05QS1aXSspXF0nLCBtc2cpCiAgICAgICAgICAgICAgICBpZiBtZjoKICAgICAgICAgICAgICAgICAgICBzZWxmLl9maWxlX2xhc3Rfb2sgPSBtZi5ncm91cCgxKQogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgaWYgbXNnLnN0YXJ0c3dpdGgoIkZJTEUgTk8iKToKICAgICAgICAgICAgICAgICMgU2VuZGVyIGNhbiBvcHRpb25hbGx5IGhhbmRsZSB0aGlzOyBoZXJlIHdlIGp1c3QgY29uc3VtZSBpdAogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKCiAgICAgICAgICAgICMgRnJvbSBoZXJlOiBNRVRBL1BBUlQvRU5ECiAgICAgICAgICAgIG1maWQgPSByZS5zZWFyY2gocidcW0ZJRDooWzAtOUEtWl0rKVxdJywgbXNnKQogICAgICAgICAgICBmaWQgPSBtZmlkLmdyb3VwKDEpIGlmIG1maWQgZWxzZSBOb25lCiAgICAgICAgICAgIGlmIG5vdCBmaWQ6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgIyBPZmZlcgogICAgICAgICAgICBpZiBtc2cuc3RhcnRzd2l0aCgiRklMRSBNRVRBIik6CiAgICAgICAgICAgICAgICBtbmFtZSA9IHJlLnNlYXJjaChyJ25hbWU9IihbXiJdKykiJywgbXNnKQogICAgICAgICAgICAgICAgbXNpemUgPSByZS5zZWFyY2gocidzaXplPShcZCspJywgbXNnKQogICAgICAgICAgICAgICAgbXNoYTEgPSByZS5zZWFyY2gocidzaGExPShbMC05YS1mQS1GXXs0MH0pJywgbXNnKQogICAgICAgICAgICAgICAgaWYgbW5hbWUgYW5kIG1zaXplIGFuZCBtc2hhMToKICAgICAgICAgICAgICAgICAgICBtZXRhID0geyJuYW1lIjogb3MucGF0aC5iYXNlbmFtZShtbmFtZS5ncm91cCgxKSksICJzaXplIjogaW50KG1zaXplLmdyb3VwKDEpKSwgInNoYTEiOiBtc2hhMS5ncm91cCgxKS5sb3dlcigpLCAiZnJvbSI6IGZybX0KICAgICAgICAgICAgICAgICAgICBzZWxmLl9maWxlX29mZmVyc1tmaWRdID0gbWV0YQogICAgICAgICAgICAgICAgICAgICMgQWRkIHRvIFVJIGxpc3QKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5jb21pbmdfbGlzdC5hZGRJdGVtKGYiW3tmaWR9XSB7ZnJtfSDihpIge21ldGFbJ25hbWUnXX0gKHttZXRhWydzaXplJ119IEIpIikKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgIyBQYXJ0cwogICAgICAgICAgICBpZiBtc2cuc3RhcnRzd2l0aCgiRklMRSBQQVJUIik6CiAgICAgICAgICAgICAgICAjIE9ubHkgYWNjZXB0IHBhcnRzIGlmIHdlJ3ZlIGFscmVhZHkgc2VudCBPSyBvciBhdXRvLWFjY2VwdCAoaWYgeW91IGxhdGVyIGFkZCBpdCkKICAgICAgICAgICAgICAgICMgRm9yIG5vdywgYWNjZXB0IGFueXdheSwgYnV0IHlvdSBjYW4gZ2F0ZSBvbiBvZmZlcnMgaWYgcmVxdWlyZWQuCiAgICAgICAgICAgICAgICBtcCA9IHJlLnNlYXJjaChyJ0ZJTEUgUEFSVCAoXGQrKS8oXGQrKVxzK1xbRklEOlteXF1dK1xdXHMrKC4rPykoXHMrXFtBQ0s6WzAtOUEtWmEtel0rXF0pPyQnLCBtc2cpCiAgICAgICAgICAgICAgICBpZiBtcDoKICAgICAgICAgICAgICAgICAgICBpID0gaW50KG1wLmdyb3VwKDEpKTsgTiA9IGludChtcC5ncm91cCgyKSk7IGI2NCA9IG1wLmdyb3VwKDMpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBiID0gc2VsZi5fZmlsZV9yeC5zZXRkZWZhdWx0KGZpZCwgeyJtZXRhIjogc2VsZi5fZmlsZV9vZmZlcnMuZ2V0KGZpZCwge30pLCAicGFydHMiOiB7fSwgIk4iOiBOLCAiZnJvbSI6IGZybX0pCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBiWyJwYXJ0cyJdW2ldID0gYmFzZTY0LmI2NGRlY29kZShiNjQuZW5jb2RlKCJhc2NpaSIpLCB2YWxpZGF0ZT1UcnVlKQogICAgICAgICAgICAgICAgICAgICAgICBiWyJOIl0gPSBOCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgICMgSWYgQUNLIHRva2VuIHByZXNlbnQsIHdlIGVjaG8gaXQgKHNvIHNlbmRlcidzIHJldHJ5IGVuZ2luZSBjYW4gc3RvcCkKICAgICAgICAgICAgICAgICAgICBtYWNrID0gcmUuc2VhcmNoKHInXFtBQ0s6KFswLTlBLVphLXpdezQsMTB9KVxdJywgbXNnKQogICAgICAgICAgICAgICAgICAgIGlmIG1hY2s6CiAgICAgICAgICAgICAgICAgICAgICAgIGFja19pZCA9IG1hY2suZ3JvdXAoMSkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2VuZF9wcm90b2NvbF9saW5lKGYiW0FDSzp7YWNrX2lkfV0iLCBmcm0pCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgaWYgbXNnLnN0YXJ0c3dpdGgoIkZJTEUgRU5EIik6CiAgICAgICAgICAgICAgICBiID0gc2VsZi5fZmlsZV9yeC5nZXQoZmlkLCB7fSkKICAgICAgICAgICAgICAgIG1ldGEgPSBiLmdldCgibWV0YSIpIG9yIHNlbGYuX2ZpbGVfb2ZmZXJzLmdldChmaWQsIHt9KQogICAgICAgICAgICAgICAgTiA9IGIuZ2V0KCJOIikgb3IgMAogICAgICAgICAgICAgICAgaWYgbm90IG1ldGEgb3Igbm90IE4gb3IgbGVuKGIuZ2V0KCJwYXJ0cyIsIHt9KSkgIT0gTjoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAgICAgZGF0YSA9IGInJy5qb2luKGJbInBhcnRzIl1baV0gZm9yIGkgaW4gcmFuZ2UoMSwgTisxKSkKICAgICAgICAgICAgICAgIGlmIGhhc2hsaWIuc2hhMShkYXRhKS5oZXhkaWdlc3QoKS5sb3dlcigpICE9IG1ldGEuZ2V0KCJzaGExIiwiIik6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICAgICAgICAgICMgU2F2ZSB0byBzdG9yZS9pbmJveAogICAgICAgICAgICAgICAgZGVmIF9yY19zdG9yZSgpOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgYmFzZSA9IChvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKHN5cy5leGVjdXRhYmxlKSkgaWYgZ2V0YXR0cihzeXMsICJmcm96ZW4iLCBGYWxzZSkgZWxzZSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkpCiAgICAgICAgICAgICAgICAgICAgICAgIHN0b3JlID0gb3MucGF0aC5qb2luKGJhc2UsICJzdG9yZSIpOyBvcy5tYWtlZGlycyhzdG9yZSwgZXhpc3Rfb2s9VHJ1ZSk7IHJldHVybiBzdG9yZQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiAic3RvcmUiCiAgICAgICAgICAgICAgICBpbmJveCA9IG9zLnBhdGguam9pbihfcmNfc3RvcmUoKSwgImluYm94Iik7IG9zLm1ha2VkaXJzKGluYm94LCBleGlzdF9vaz1UcnVlKQogICAgICAgICAgICAgICAgb3V0ID0gb3MucGF0aC5qb2luKGluYm94LCBtZXRhWyJuYW1lIl0pCiAgICAgICAgICAgICAgICBiYXNlcCwgZXh0ID0gb3MucGF0aC5zcGxpdGV4dChvdXQpOyBrID0gMQogICAgICAgICAgICAgICAgd2hpbGUgb3MucGF0aC5leGlzdHMob3V0KToKICAgICAgICAgICAgICAgICAgICBvdXQgPSBmIntiYXNlcH0oe2t9KXtleHR9IjsgayArPSAxCiAgICAgICAgICAgICAgICB3aXRoIG9wZW4ob3V0LCAid2IiKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIGYud3JpdGUoZGF0YSkKICAgICAgICAgICAgICAgICMgQ2xlYW51cCArIFVJCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgZmlkIGluIHNlbGYuX2ZpbGVfb2ZmZXJzOiBkZWwgc2VsZi5fZmlsZV9vZmZlcnNbZmlkXQogICAgICAgICAgICAgICAgICAgIGlmIGZpZCBpbiBzZWxmLl9maWxlX3J4OiBkZWwgc2VsZi5fZmlsZV9yeFtmaWRdCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyByZW1vdmUgbGlzdCBpdGVtCiAgICAgICAgICAgICAgICAgICAgZm9yIHIgaW4gcmFuZ2Uoc2VsZi5pbmNvbWluZ19saXN0LmNvdW50KCktMSwgLTEsIC0xKToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZiJbe2ZpZH1dIiBpbiAoc2VsZi5pbmNvbWluZ19saXN0Lml0ZW0ocikudGV4dCgpIG9yICIiKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuaW5jb21pbmdfbGlzdC50YWtlSXRlbShyKTsgYnJlYWsKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgICAgIHNlbGYuX3N0YXR1cyhmIlJlY2VpdmVkIGZpbGUgZnJvbSB7ZnJtfToge21ldGEuZ2V0KCduYW1lJywnPycpfSIpCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICMgPT09PT0gRW5kIEZpbGUgVHJhbnNmZXIgPT09PT0KCiAgICAKCiAgICAjIC0tLS0gUG9zaXRpb25zIHN0b3JlIChwb3NpdGlvbnMuanNvbikgLS0tLQogICAgZGVmIF9sb2FkX3Bvc2l0aW9ucyhzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGQgPSBsb2FkX2pzb24oJ3Bvc2l0aW9ucy5qc29uJykgb3Ige30KICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkLCBkaWN0KToKICAgICAgICAgICAgICAgIHJldHVybiBkCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiB7fQoKICAgIGRlZiBfc2F2ZV9wb3NpdGlvbnMoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzYXZlX2pzb24oJ3Bvc2l0aW9ucy5qc29uJywgZ2V0YXR0cihzZWxmLCAnX3Bvc2l0aW9ucycsIHt9KSkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fbWlycm9yX3Bvc2l0aW9uc190b19nZW9qc29uX2Zyb21fc3RvcmUoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLl9taXJyb3JfcG9zaXRpb25zX3RvX2dlb2pzb25fZnJvbV9zdG9yZSgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBfcG9zaXRpb25zX3Vwc2VydChzZWxmLCBjYWxsc2lnbjogc3RyLCBsYXQ6IGZsb2F0LCBsb246IGZsb2F0LCBzb3VyY2U6IHN0ciA9ICdiZWFjb24tZml4ZWQnKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG5vdCBjYWxsc2lnbjoKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICBjcyA9IHN0cihjYWxsc2lnbikudXBwZXIoKS5zdHJpcCgpCiAgICAgICAgICAgIGxhdCA9IGZsb2F0KGxhdCk7IGxvbiA9IGZsb2F0KGxvbikKICAgICAgICAgICAgbm93ID0gaW50KF9faW1wb3J0X18oJ3RpbWUnKS50aW1lKCkpCiAgICAgICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYsICdfcG9zaXRpb25zJykgb3Igbm90IGlzaW5zdGFuY2Uoc2VsZi5fcG9zaXRpb25zLCBkaWN0KToKICAgICAgICAgICAgICAgIHNlbGYuX3Bvc2l0aW9ucyA9IHt9CiAgICAgICAgICAgIGVudHJ5ID0gc2VsZi5fcG9zaXRpb25zLmdldChjcykgb3Ige30KICAgICAgICAgICAgaGlzdCA9IGVudHJ5LmdldCgnaGlzdG9yeScpIG9yIFtdCiAgICAgICAgICAgIGhpc3QuYXBwZW5kKHsndCc6IG5vdywgJ2xhdCc6IGZsb2F0KGxhdCksICdsb24nOiBmbG9hdChsb24pfSkKICAgICAgICAgICAgaWYgbGVuKGhpc3QpID4gNTA6CiAgICAgICAgICAgICAgICBoaXN0ID0gaGlzdFstNTA6XQogICAgICAgICAgICBlbnRyeS51cGRhdGUoeydsYXQnOiBmbG9hdChsYXQpLCAnbG9uJzogZmxvYXQobG9uKSwgJ2xhc3RfdXBkYXRlJzogbm93LCAnc291cmNlJzogc291cmNlLCAnaGlzdG9yeSc6IGhpc3R9KQogICAgICAgICAgICBzZWxmLl9wb3NpdGlvbnNbY3NdID0gZW50cnkKICAgICAgICAgICAgc2VsZi5fc2F2ZV9wb3NpdGlvbnMoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX3Bvc2l0aW9uc19wcnVuZShzZWxmLCBleHBpcnlfc2VjOiBpbnQgPSAzNjAwKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIG5vdyA9IGludChfX2ltcG9ydF9fKCd0aW1lJykudGltZSgpKQogICAgICAgICAgICBpZiBub3QgaGFzYXR0cihzZWxmLCAnX3Bvc2l0aW9ucycpIG9yIG5vdCBpc2luc3RhbmNlKHNlbGYuX3Bvc2l0aW9ucywgZGljdCk6CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgcmVtb3ZlZCA9IFtdCiAgICAgICAgICAgIGZvciBjcywgZW50cnkgaW4gbGlzdChzZWxmLl9wb3NpdGlvbnMuaXRlbXMoKSk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbGFzdCA9IGludChlbnRyeS5nZXQoJ2xhc3RfdXBkYXRlJykgb3IgMCkKICAgICAgICAgICAgICAgICAgICBpZiBub3cgLSBsYXN0ID4gaW50KGV4cGlyeV9zZWMpOgogICAgICAgICAgICAgICAgICAgICAgICByZW1vdmVkLmFwcGVuZChjcykKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcG9zaXRpb25zLnBvcChjcywgTm9uZSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBpZiByZW1vdmVkOgogICAgICAgICAgICAgICAgc2VsZi5fc2F2ZV9wb3NpdGlvbnMoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAjIC0tLS0gQmVhY29uIGNvb3JkaW5hdGUgcGVyc2lzdGVuY2UgLS0tLQogICAgICAgICMgcHJ1bmUgbGluayBncmFwaCBwYXJlbnRzIHRvIG1hdGNoIHBvc2l0aW9uIGV4cGlyeQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fbGlua19ncmFwaF9wcnVuZShleHBpcnlfc2VjPWV4cGlyeV9zZWMpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBfbG9hZF9iZWFjb25fY29vcmRzX2Zyb21fc2V0dGluZ3Moc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzID0gc2VsZi5fc2V0dGluZ3NfZ2V0KCkKICAgICAgICAgICAgYiA9IHMuZ2V0KCdiZWFjb24nKSBvciB7fQogICAgICAgICAgICBjID0gYi5nZXQoJ2Nvb3JkcycpIG9yIHt9CiAgICAgICAgICAgIHJldHVybiB7CiAgICAgICAgICAgICAgICAnZW5hYmxlZCc6IGJvb2woYy5nZXQoJ2VuYWJsZWQnLCBGYWxzZSkpLAogICAgICAgICAgICAgICAgJ2xhdCc6IGMuZ2V0KCdsYXQnLCBOb25lKSwKICAgICAgICAgICAgICAgICdsb24nOiBjLmdldCgnbG9uJywgTm9uZSksCiAgICAgICAgICAgICAgICAnbGFzdF90cyc6IGMuZ2V0KCdsYXN0X3RzJywgTm9uZSkKICAgICAgICAgICAgfQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHJldHVybiB7J2VuYWJsZWQnOiBGYWxzZSwgJ2xhdCc6IE5vbmUsICdsb24nOiBOb25lLCAnbGFzdF90cyc6IE5vbmV9CgogICAgZGVmIF9zYXZlX2JlYWNvbl9jb29yZHNfdG9fc2V0dGluZ3Moc2VsZiwgZW5hYmxlZD1Ob25lLCBsYXQ9Tm9uZSwgbG9uPU5vbmUsIGxhc3RfdHM9Tm9uZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzID0gc2VsZi5fc2V0dGluZ3NfZ2V0KCkKICAgICAgICAgICAgYiA9IHMuZ2V0KCdiZWFjb24nKSBvciB7fQogICAgICAgICAgICBjID0gYi5nZXQoJ2Nvb3JkcycpIG9yIHt9CiAgICAgICAgICAgIGlmIGVuYWJsZWQgaXMgbm90IE5vbmU6IGNbJ2VuYWJsZWQnXSA9IGJvb2woZW5hYmxlZCkKICAgICAgICAgICAgaWYgbGF0IGlzIG5vdCBOb25lOiBjWydsYXQnXSA9IGxhdAogICAgICAgICAgICBpZiBsb24gaXMgbm90IE5vbmU6IGNbJ2xvbiddID0gbG9uCiAgICAgICAgICAgIGlmIGxhc3RfdHMgaXMgbm90IE5vbmU6IGNbJ2xhc3RfdHMnXSA9IGxhc3RfdHMKICAgICAgICAgICAgYlsnY29vcmRzJ10gPSBjCiAgICAgICAgICAgIHNbJ2JlYWNvbiddID0gYgogICAgICAgICAgICBzZWxmLl9zZXR0aW5nc19zZXQocykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgZGVmIF9wdXJnZV9zZWxmX2Zyb21fZ3JhcGgoc2VsZik6CiAgICAgICAgJycnUmVtb3ZlIG91ciBvd24gY2FsbHNpZ24gZnJvbSBncmFwaCBwYXJlbnRzL2NoaWxkcmVuIGFuZCBzYXZlIGJlc3QtZWZmb3J0LicnJwogICAgICAgIHRyeToKICAgICAgICAgICAgbXljID0gc2VsZi5teWNhbGxfZWRpdC50ZXh0KCkuc3RyaXAoKS51cHBlcigpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgbXljID0gIiIKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUGFyZW50cwogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdfZ3JhcGhfcGFyZW50cycpIGFuZCBpc2luc3RhbmNlKHNlbGYuX2dyYXBoX3BhcmVudHMsIGRpY3QpOgogICAgICAgICAgICAgICAgc2VsZi5fZ3JhcGhfcGFyZW50cy5wb3AobXljLCBOb25lKQogICAgICAgICAgICAgICAgZm9yIGssIHYgaW4gbGlzdChzZWxmLl9ncmFwaF9wYXJlbnRzLml0ZW1zKCkpOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fZ3JhcGhfcGFyZW50c1trXSA9IFtjIGZvciBjIGluIHYgaWYgKGMgb3IgJycpLnVwcGVyKCkgIT0gbXljXQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgIyBTYXZlIGlmIGhlbHBlciBleGlzdHMKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fc2F2ZV9saW5rX2dyYXBoKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICBkZWYgX2NvbmRpdGlvbmFsX2FkZF9tZXNzYWdlKHNlbGYsICphcmdzLCAqKmt3YXJncyk6CiAgICAgICAgaWYgZ2V0YXR0cihzZWxmLCAnX3N1cHByZXNzX25leHRfbG9nJywgRmFsc2UpOgogICAgICAgICAgICBzZWxmLl9zdXBwcmVzc19uZXh0X2xvZyA9IEZhbHNlCiAgICAgICAgICAgIHJldHVybgogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIHNlbGYubWVzc2FnZXNfbGlzdC5hZGRJdGVtKCphcmdzLCAqKmt3YXJncykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICBkZWYgX3N0YXR1cyhzZWxmLCBtc2c6IHN0ciA9ICIiLCBtczogaW50ID0gMjAwMCk6CiAgICAgICAgJycnU2hvdyBhIHRyYW5zaWVudCBtZXNzYWdlIGluIHRoZSBzdGF0dXMgYmFyOyBjcmVhdGUgaXQgaWYgbWlzc2luZy4nJycKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZyb20gUHlRdDUuUXRXaWRnZXRzIGltcG9ydCBRU3RhdHVzQmFyCiAgICAgICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYsICJzdGF0dXNfYmFyIikgb3Igc2VsZi5zdGF0dXNfYmFyIGlzIE5vbmU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5zdGF0dXNfYmFyID0gUVN0YXR1c0JhcigpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5zZXRTdGF0dXNCYXIoc2VsZi5zdGF0dXNfYmFyKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAjIEZhbGxiYWNrOiB1c2UgYnVpbHQtaW4gc3RhdHVzQmFyKCkgaWYgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zdGF0dXMoc3RyKG1zZyksIGludChtcykpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICBzZWxmLl9zdGF0dXMoc3RyKG1zZyksIGludChtcykpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgZGVmIF9zZXR0aW5nc19nZXQoc2VsZikgLT4gZGljdDoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldHVybiBsb2FkX2pzb24oInNldHRpbmdzLmpzb24iKSBvciB7fQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHJldHVybiB7fQoKICAgIGRlZiBfc2V0dGluZ3Nfc2V0KHNlbGYsIG5ld19zZXR0aW5nczogZGljdCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzYXZlX2pzb24oInNldHRpbmdzLmpzb24iLCBuZXdfc2V0dGluZ3MpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKCiAgICBkZWYgX2xvYWRfc2VyaWFsX2Zyb21fc2V0dGluZ3Moc2VsZik6CgogICAgICAgIHMgPSBzZWxmLl9zZXR0aW5nc19nZXQoKQoKICAgICAgICBzZCA9IHMuZ2V0KCJzZXJpYWwiKSBvciB7fQoKICAgICAgICBzZWxmLl9zZXJpYWxfcG9ydF9kZWZhdWx0ID0gc2QuZ2V0KCJwb3J0IiwgIiIpCgogICAgICAgIHRyeToKCiAgICAgICAgICAgIHNlbGYuX3NlcmlhbF9iYXVkX2RlZmF1bHQgPSBpbnQoc2QuZ2V0KCJiYXVkIiwgMzg0MDApKQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgoKICAgICAgICAgICAgc2VsZi5fc2VyaWFsX2JhdWRfZGVmYXVsdCA9IDM4NDAwCgogICAgICAgIHRyeToKCiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgInNlcmlhbF9jb21ibyIpIGFuZCBzZWxmLl9zZXJpYWxfcG9ydF9kZWZhdWx0OgoKICAgICAgICAgICAgICAgIGl4ID0gc2VsZi5zZXJpYWxfY29tYm8uZmluZFRleHQoc2VsZi5fc2VyaWFsX3BvcnRfZGVmYXVsdCkKCiAgICAgICAgICAgICAgICBpZiBpeCA+PSAwOgoKICAgICAgICAgICAgICAgICAgICBzZWxmLnNlcmlhbF9jb21iby5zZXRDdXJyZW50SW5kZXgoaXgpCgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CgogICAgICAgICAgICBwYXNzCgoKICAgIGRlZiBfc2F2ZV9zZXJpYWxfdG9fc2V0dGluZ3Moc2VsZiwgcG9ydDogc3RyLCBiYXVkOiBpbnQpOgoKICAgICAgICBzID0gc2VsZi5fc2V0dGluZ3NfZ2V0KCkKCiAgICAgICAgc1sic2VyaWFsIl0gPSB7InBvcnQiOiBzdHIocG9ydCBvciAiIiksICJiYXVkIjogaW50KGJhdWQgb3IgMzg0MDApfQoKICAgICAgICBzZWxmLl9zZXR0aW5nc19zZXQocykKCiAgICBkZWYgX2xvYWRfYmVhY29uX2Zyb21fc2V0dGluZ3Moc2VsZik6CiAgICAgICAgcyA9IHNlbGYuX3NldHRpbmdzX2dldCgpCiAgICAgICAgYiA9IHMuZ2V0KCJiZWFjb24iKSBvciB7fQogICAgICAgIGVuYWJsZWQgPSBib29sKGIuZ2V0KCJlbmFibGVkIiwgRmFsc2UpKQogICAgICAgIG1pbnV0ZXMgPSBpbnQoYi5nZXQoIm1pbnV0ZXMiLCAxNSkpCiAgICAgICAgcmV0dXJuIGVuYWJsZWQsIG1heCgxLCBtaW51dGVzKQoKICAgIGRlZiBfc2F2ZV9iZWFjb25fdG9fc2V0dGluZ3Moc2VsZiwgZW5hYmxlZDogYm9vbCwgbWludXRlczogaW50KToKICAgICAgICBzID0gc2VsZi5fc2V0dGluZ3NfZ2V0KCkKICAgICAgICBzWyJiZWFjb24iXSA9IHsiZW5hYmxlZCI6IGJvb2woZW5hYmxlZCksICJtaW51dGVzIjogaW50KG1pbnV0ZXMpfQogICAgICAgIHNlbGYuX3NldHRpbmdzX3NldChzKQoKICAgIGRlZiBfZW5hYmxlX2JlYWNvbihzZWxmLCBtaW51dGVzOiBpbnQsIGltbWVkaWF0ZTogYm9vbCA9IEZhbHNlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIG1pbnMgPSBtYXgoMSwgaW50KG1pbnV0ZXMpKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIG1pbnMgPSAxNQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgImJlYWNvbl90aW1lciIpOgogICAgICAgICAgICAgICAgc2VsZi5iZWFjb25fdGltZXIgPSBRVGltZXIoc2VsZikKICAgICAgICAgICAgICAgIHNlbGYuYmVhY29uX3RpbWVyLnRpbWVvdXQuY29ubmVjdChzZWxmLl9zZW5kX2JlYWNvbikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5iZWFjb25fdGltZXIudGltZW91dC5kaXNjb25uZWN0KCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgc2VsZi5iZWFjb25fdGltZXIuc2V0U2luZ2xlU2hvdChGYWxzZSkKICAgICAgICAgICAgc2VsZi5iZWFjb25fdGltZXIuc3RvcCgpCiAgICAgICAgICAgIHNlbGYuYmVhY29uX3RpbWVyLnNldEludGVydmFsKG1pbnMgKiA2MF8wMDApCiAgICAgICAgICAgIHNlbGYuYmVhY29uX3RpbWVyLnRpbWVvdXQuY29ubmVjdChzZWxmLl9zZW5kX2JlYWNvbikKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5iZWFjb25fdGltZXIudGltZW91dC5kaXNjb25uZWN0KCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgc2VsZi5iZWFjb25fdGltZXIudGltZW91dC5jb25uZWN0KHNlbGYuX3NlbmRfYmVhY29uKQogICAgICAgICAgICBzZWxmLmJlYWNvbl90aW1lci5zdGFydCgpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX3N0YXR1cyhmJ0JlYWNvbiBhcm1lZDogZXZlcnkge21pbnN9IG1pbicsIDI1MDApCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICMgQ2FuY2VsIGFueSBwZW5kaW5nIGF1dG8tc3RhcnQgc28gdXNlciBjaG9pY2UgcGVyc2lzdHMKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnYXV0b19iZWFjb25fdGltZXInKSBhbmQgc2VsZi5hdXRvX2JlYWNvbl90aW1lci5pc0FjdGl2ZSgpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuYXV0b19iZWFjb25fdGltZXIuc3RvcCgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHNlbGYuX3NhdmVfYmVhY29uX3RvX3NldHRpbmdzKFRydWUsIG1pbnMpCiAgICAgICAgICAgIGlmIGltbWVkaWF0ZToKICAgICAgICAgICAgICAgIHNlbGYuX3NlbmRfYmVhY29uKCkKICAgICAgICAKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fdG91Y2hfbGFzdF90eCgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBfZGlzYWJsZV9iZWFjb24oc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICJiZWFjb25fdGltZXIiKToKICAgICAgICAgICAgICAgIHNlbGYuYmVhY29uX3RpbWVyLnN0b3AoKQogICAgICAgICAgICBzZWxmLl9zYXZlX2JlYWNvbl90b19zZXR0aW5ncyhGYWxzZSwgMCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgZGVmIF93aXJlX2JlYWNvbl9idXR0b25zKHNlbGYpOgogICAgICAgICcnJ0ZpbmQgYnV0dG9ucyBsYWJlbGVkICc1IG1pbicsICcxMCBtaW4nLCAnMTUgbWluJyBhbmQgd2lyZSB0aGVtIHRvIHNldCAmIHNlbmQgaW1tZWRpYXRlbHkuJycnCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmcm9tIFB5UXQ1LlF0V2lkZ2V0cyBpbXBvcnQgUVB1c2hCdXR0b24KICAgICAgICAgICAgZm9yIGJ0biBpbiBzZWxmLmZpbmRDaGlsZHJlbihRUHVzaEJ1dHRvbik6CiAgICAgICAgICAgICAgICB0ID0gYnRuLnRleHQoKS5zdHJpcCgpLmxvd2VyKCkKICAgICAgICAgICAgICAgIGlmIHQgaW4gKCI1IG1pbiIsICI1bWlucyIsICI1IG1pbnV0ZXMiLCAiNW0iKToKICAgICAgICAgICAgICAgICAgICB0cnk6IGJ0bi5jbGlja2VkLmRpc2Nvbm5lY3QoKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgICAgICAgICBidG4uY2xpY2tlZC5jb25uZWN0KGxhbWJkYSBjaGVja2VkPUZhbHNlOiBzZWxmLl9lbmFibGVfYmVhY29uKDUsIGltbWVkaWF0ZT1UcnVlKSkKICAgICAgICAgICAgICAgIGVsaWYgdCBpbiAoIjEwIG1pbiIsICIxMG1pbnMiLCAiMTAgbWludXRlcyIsICIxMG0iKToKICAgICAgICAgICAgICAgICAgICB0cnk6IGJ0bi5jbGlja2VkLmRpc2Nvbm5lY3QoKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgICAgICAgICBidG4uY2xpY2tlZC5jb25uZWN0KGxhbWJkYSBjaGVja2VkPUZhbHNlOiBzZWxmLl9lbmFibGVfYmVhY29uKDEwLCBpbW1lZGlhdGU9VHJ1ZSkpCiAgICAgICAgICAgICAgICBlbGlmIHQgaW4gKCIxNSBtaW4iLCAiMTVtaW5zIiwgIjE1IG1pbnV0ZXMiLCAiMTVtIik6CiAgICAgICAgICAgICAgICAgICAgdHJ5OiBidG4uY2xpY2tlZC5kaXNjb25uZWN0KCkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgICAgICAgICAgYnRuLmNsaWNrZWQuY29ubmVjdChsYW1iZGEgY2hlY2tlZD1GYWxzZTogc2VsZi5fZW5hYmxlX2JlYWNvbigxNSwgaW1tZWRpYXRlPVRydWUpKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX3NlbmRfYmVhY29uKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGlhZ19sb2coJ1RJTUVSOiBfc2VuZF9iZWFjb24gdGljaycpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIG1lID0gc2VsZi5teWNhbGxfZWRpdC50ZXh0KCkuc3RyaXAoKS51cHBlcigpIGlmIGhhc2F0dHIoc2VsZiwgJ215Y2FsbF9lZGl0JykgZWxzZSAnJwogICAgICAgICAgICBpZiBub3QgbWU6CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgY2hpbGRyZW4gPSBbXQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmb3IgY2FuZCBpbiAoJ2hlYXJkX3N0YXRpb25zJywnYmVhY29uc19oZWFyZCcsJ2xpbmtfZ3JhcGgnLCdfYmVhY29ucycsJ19oZWFyZCcpOgogICAgICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgY2FuZCk6CiAgICAgICAgICAgICAgICAgICAgICAgIG9iaiA9IGdldGF0dHIoc2VsZiwgY2FuZCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShvYmosIGRpY3QpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW4uZXh0ZW5kKGxpc3Qob2JqLmtleXMoKSkpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGNoaWxkcmVuID0gc29ydGVkKHsoYyBvciAnJykuc3RyaXAoKS51cHBlcigpIGZvciBjIGluIGNoaWxkcmVuIGlmIGlzaW5zdGFuY2UoYywgc3RyKSBhbmQgYyBhbmQgKGMgb3IgJycpLnN0cmlwKCkudXBwZXIoKSAhPSBtZX0pWzoxMl0KICAgICAgICAgICAgbGluZSA9IGYiLi57bWV9IgogICAgICAgICAgICAjIE9wdGlvbmFsbHkgYXBwZW5kIExhdC9Mb24gZXZlcnkgMzAgbWludXRlcyBvciB3aGVuIGZvcmNlZCBvbmNlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGltcG9ydCB0aW1lIGFzIF90CiAgICAgICAgICAgICAgICBpZiBnZXRhdHRyKHNlbGYsICdfYmVhY29uX2Nvb3Jkc19lbmFibGVkJywgRmFsc2UpIGFuZCBzZWxmLl9iZWFjb25fY29vcmRzX2xhdCBpcyBub3QgTm9uZSBhbmQgc2VsZi5fYmVhY29uX2Nvb3Jkc19sb24gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgbGFzdCA9IGdldGF0dHIoc2VsZiwgJ19iZWFjb25fY29vcmRzX2xhc3RfdHMnLCBOb25lKSBvciAwCiAgICAgICAgICAgICAgICAgICAgbm93ID0gaW50KF90LnRpbWUoKSkKICAgICAgICAgICAgICAgICAgICBmb3JjZV9vbmNlID0gYm9vbChnZXRhdHRyKHNlbGYsICdfYmVhY29uX2Nvb3Jkc19mb3JjZV9vbmNlJywgRmFsc2UpKQogICAgICAgICAgICAgICAgICAgIGlmIGZvcmNlX29uY2Ugb3IgKG5vdyAtIGludChsYXN0KSA+PSAxODAwKToKICAgICAgICAgICAgICAgICAgICAgICAgbGluZSArPSBmIiBMYXQge2Zsb2F0KHNlbGYuX2JlYWNvbl9jb29yZHNfbGF0KTouNWZ9IExvbiB7ZmxvYXQoc2VsZi5fYmVhY29uX2Nvb3Jkc19sb24pOi41Zn0iCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2JlYWNvbl9jb29yZHNfbGFzdF90cyA9IG5vdwogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9zYXZlX2JlYWNvbl9jb29yZHNfdG9fc2V0dGluZ3MobGFzdF90cz1ub3cpCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3Bvc2l0aW9uc191cHNlcnQobWUsIHNlbGYuX2JlYWNvbl9jb29yZHNfbGF0LCBzZWxmLl9iZWFjb25fY29vcmRzX2xvbiwgc291cmNlPSdiZWFjb24tZml4ZWQnKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgICAgICBpZiBmb3JjZV9vbmNlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fYmVhY29uX2Nvb3Jkc19mb3JjZV9vbmNlID0gRmFsc2UKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgZm9yIGMgaW4gY2hpbGRyZW46CiAgICAgICAgICAgICAgICBsaW5lICs9IGYiIC97Y30iCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX3NlcmlhbF93cml0ZV90ZXh0KGxpbmUgKyAiXHIiKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3RvdWNoX2xhc3RfdHgoKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgZGVmIF9pc19zeXN0ZW1fbm9pc2Uoc2VsZiwgbGluZTogc3RyKSAtPiBib29sOgogICAgICAgIHJldHVybiAoIiVDT05ORUNUIiBpbiBsaW5lKSBvciAoIiVESVNDT05OIiBpbiBsaW5lKQoKICAgIGRlZiBfaXNfdmFsaWRfYWNrKHNlbGYsIGxpbmU6IHN0ciwgc3JjX2NhbGw6IHN0ciA9ICIiLCBkc3RfY2FsbDogc3RyID0gIiIpIC0+IHN0ciBvciBOb25lOgogICAgICAgIGlmIHNlbGYuX2lzX3N5c3RlbV9ub2lzZShsaW5lKToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBtID0gc2VsZi5fQUNLX1RPS0VOLnNlYXJjaChsaW5lKQogICAgICAgIGlmIG5vdCBtOgogICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGFjayA9IG0uZ3JvdXAoMSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHAgPSBnZXRhdHRyKHNlbGYsICJwZW5kaW5nX2FjayIsIE5vbmUpCiAgICAgICAgICAgIGlmIHAgYW5kIHAuZ2V0KCJpZCIpIGFuZCBhY2sgIT0gcC5nZXQoImlkIik6CiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgICAgICBpZiBwIGFuZCBwLmdldCgidG8iKSBhbmQgc3JjX2NhbGw6CiAgICAgICAgICAgICAgICBpZiBzcmNfY2FsbC5zdHJpcCgpLnVwcGVyKCkgIT0gcFsidG8iXS5zdHJpcCgpLnVwcGVyKCk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAibXljYWxsX2VkaXQiKSBhbmQgZHN0X2NhbGw6CiAgICAgICAgICAgICAgICBteSA9IHNlbGYubXljYWxsX2VkaXQudGV4dCgpLnN0cmlwKCkudXBwZXIoKQogICAgICAgICAgICAgICAgaWYgbXkgYW5kIGRzdF9jYWxsLnN0cmlwKCkudXBwZXIoKSAhPSBteToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgIm15Y2FsbF9lZGl0IikgYW5kIHNyY19jYWxsOgogICAgICAgICAgICAgICAgaWYgc3JjX2NhbGwuc3RyaXAoKS51cHBlcigpID09IHNlbGYubXljYWxsX2VkaXQudGV4dCgpLnN0cmlwKCkudXBwZXIoKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gYWNrCiAgICAKCiAgICBkZWYgX2Vuc3VyZV9zdG9yZV9wYXRocyhzZWxmKToKICAgICAgICAnJydFbnN1cmUgJ3N0b3JlLycgZXhpc3RzOyBtaWdyYXRlIHN0b3JlL21lc3NhZ2VzLXYxLmpzb24gLT4gc3RvcmUvbWVzc2FnZXNfdjEuanNvbiBpZiBuZWVkZWQuJycnCiAgICAgICAgaW1wb3J0IG9zLCBqc29uCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5pc2Rpcignc3RvcmUnKToKICAgICAgICAgICAgICAgIG9zLm1ha2VkaXJzKCdzdG9yZScsIGV4aXN0X29rPVRydWUpCiAgICAgICAgICAgIGRhc2ggPSBvcy5wYXRoLmpvaW4oJ3N0b3JlJywnbWVzc2FnZXMtdjEuanNvbicpCiAgICAgICAgICAgIHVuZGVyID0gb3MucGF0aC5qb2luKCdzdG9yZScsJ21lc3NhZ2VzX3YxLmpzb24nKQogICAgICAgICAgICBpZiBvcy5wYXRoLmlzZmlsZShkYXNoKSBhbmQgbm90IG9zLnBhdGguaXNmaWxlKHVuZGVyKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICB3aXRoIG9wZW4oZGFzaCwncicsZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjogZGF0YSA9IGpzb24ubG9hZChmKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBkYXRhID0gTm9uZQogICAgICAgICAgICAgICAgaWYgZGF0YSBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHdpdGggb3Blbih1bmRlciwndycsZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoganNvbi5kdW1wKGRhdGEsZixlbnN1cmVfYXNjaWk9RmFsc2UsaW5kZW50PTIpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgdHJ5OiBkaWFnX2xvZyhmIltTVE9SRV0gZW5zdXJlL21pZ3JhdGUgZmFpbGVkOiB7ZX0iKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICBkZWYgX3V0Y19ub3dfaXNvKHNlbGYpOgogICAgICAgIGltcG9ydCBkYXRldGltZSBhcyBfZHQKICAgICAgICByZXR1cm4gX2R0LmRhdGV0aW1lLm5vdyhfZHQudGltZXpvbmUudXRjKS5pc29mb3JtYXQoKS5yZXBsYWNlKCIrMDA6MDAiLCJaIikKCiAgICBkZWYgX3V0Y19kaXNwbGF5X2htcyhzZWxmLCB0c19pc286IHN0cikgLT4gc3RyOgogICAgICAgIGltcG9ydCBkYXRldGltZSBhcyBfZHQKICAgICAgICB0cnk6CiAgICAgICAgICAgIHMgPSAodHNfaXNvIG9yICIiKS5yZXBsYWNlKCJaIiwiKzAwOjAwIikKICAgICAgICAgICAgdCA9IF9kdC5kYXRldGltZS5mcm9taXNvZm9ybWF0KHMpLnRpbWUoKQogICAgICAgICAgICByZXR1cm4gZiIoVVRDKSB7dC5zdHJmdGltZSgnJUg6JU06JVMnKX0iCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcmV0dXJuICIoVVRDKSAwMDowMDowMCIKICAgIGRlZiBfZW5zdXJlX2hlYWRlcl90b3Aoc2VsZiwgdHNfaXNvOiBzdHIpOgogICAgICAgICcnJ0Vuc3VyZSB0aGUgVUsgZGF0ZSBoZWFkZXIgaXMgYXQgaW5kZXggMC4KICAgICAgICAtIElmIGFuIGV4aXN0aW5nIGhlYWRlciBpcyBlbHNld2hlcmUgb3IgaGFzIHRoZSB3cm9uZyB0ZXh0LCByZW1vdmUgaXQgYW5kIHBsYWNlIHRoZSBjb3JyZWN0IG9uZSBhdCAwLgogICAgICAgIC0gU3dhbGxvdyBlcnJvcnMgc28gU0VORC9SWC9BQ0sgbmV2ZXIgYnJlYWsuCiAgICAgICAgJycnCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgZGF0ZXRpbWUgYXMgX2R0CiAgICAgICAgICAgIHMgPSAodHNfaXNvIG9yICcnKS5yZXBsYWNlKCdaJywnJykuc3BsaXQoJy4nKVswXQogICAgICAgICAgICBkID0gX2R0LmRhdGV0aW1lLmZyb21pc29mb3JtYXQocykuZGF0ZSgpIGlmIHMgZWxzZSBfZHQuZGF0ZXRpbWUubm93KCkuZGF0ZSgpCiAgICAgICAgICAgICMgQ29tcG9zZSBoZWFkZXIgdGV4dCB1c2luZyBleGlzdGluZyBmb3JtYXR0ZXIgaWYgcHJlc2VudAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBoZWFkZXJfdHh0ID0gIuKUgOKUgOKUgOKUgOKUgOKUgCAiICsgc2VsZi5fdWtfZGF0ZV9zdHIodHNfaXNvKSArICIgIiArICLilIDilIDilIDilIDilIDilIAiCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBoZWFkZXJfdHh0ID0gZiLilIDilIDilIDilIDilIDilIAge2QuZGF5fSB7ZC5zdHJmdGltZSgnJUInKX0ge2QueWVhcn0gIiArICLilIDilIDilIDilIDilIDilIAiCgogICAgICAgICAgICAjIEZpbmQgYW55IGV4aXN0aW5nIGhlYWRlciBpbiB0aGUgbGlzdAogICAgICAgICAgICBleGlzdGluZ19pZHggPSBOb25lCiAgICAgICAgICAgIGZvciBpIGluIHJhbmdlKHNlbGYubWVzc2FnZXNfbGlzdC5jb3VudCgpKToKICAgICAgICAgICAgICAgIGl0ID0gc2VsZi5tZXNzYWdlc19saXN0Lml0ZW0oaSkKICAgICAgICAgICAgICAgIGlmIGl0IGFuZCBpdC5kYXRhKFF0LlVzZXJSb2xlKSA9PSAnZGF0ZWhlYWRlcic6CiAgICAgICAgICAgICAgICAgICAgZXhpc3RpbmdfaWR4ID0gaQogICAgICAgICAgICAgICAgICAgIGJyZWFrCgogICAgICAgICAgICAjIElmIGhlYWRlciBleGlzdHMgYnV0IG5vdCBhdCB0b3Agb3IgaGFzIHdyb25nIHRleHQgLT4gcmVtb3ZlIGl0CiAgICAgICAgICAgIGlmIGV4aXN0aW5nX2lkeCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGl0ID0gc2VsZi5tZXNzYWdlc19saXN0Lml0ZW0oZXhpc3RpbmdfaWR4KQogICAgICAgICAgICAgICAgaWYgZXhpc3RpbmdfaWR4ICE9IDAgb3IgKGl0IGFuZCBpdC50ZXh0KCkgIT0gaGVhZGVyX3R4dCk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5tZXNzYWdlc19saXN0LnRha2VJdGVtKGV4aXN0aW5nX2lkeCkKCiAgICAgICAgICAgICMgRW5zdXJlIGhlYWRlciBhdCBpbmRleCAwIHdpdGggY29ycmVjdCB0ZXh0CiAgICAgICAgICAgIHRvcCA9IHNlbGYubWVzc2FnZXNfbGlzdC5pdGVtKDApIGlmIHNlbGYubWVzc2FnZXNfbGlzdC5jb3VudCgpID4gMCBlbHNlIE5vbmUKICAgICAgICAgICAgaWYgKG5vdCB0b3ApIG9yICh0b3AuZGF0YShRdC5Vc2VyUm9sZSkgIT0gJ2RhdGVoZWFkZXInKSBvciAodG9wLnRleHQoKSAhPSBoZWFkZXJfdHh0KToKICAgICAgICAgICAgICAgIG5ld19pdCA9IFFMaXN0V2lkZ2V0SXRlbShoZWFkZXJfdHh0KQogICAgICAgICAgICAgICAgdHJ5OiBuZXdfaXQuc2V0VGV4dEFsaWdubWVudChRdC5BbGlnbkhDZW50ZXIpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgZnJvbSBQeVF0NS5RdEd1aSBpbXBvcnQgUUJydXNoLCBRQ29sb3IKICAgICAgICAgICAgICAgICAgICBuZXdfaXQuc2V0Rm9yZWdyb3VuZChRQnJ1c2goUUNvbG9yKDEyOCwxMjgsMTI4KSkpCiAgICAgICAgICAgICAgICAgICAgZiA9IG5ld19pdC5mb250KCk7IGYuc2V0Qm9sZChUcnVlKTsgbmV3X2l0LnNldEZvbnQoZikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgICAgIG5ld19pdC5zZXREYXRhKFF0LlVzZXJSb2xlLCAnZGF0ZWhlYWRlcicpCiAgICAgICAgICAgICAgICBzZWxmLm1lc3NhZ2VzX2xpc3QuaW5zZXJ0SXRlbSgwLCBuZXdfaXQpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkaWFnX2xvZyhmIltIRUFERVJdIGVuc3VyZV9oZWFkZXJfdG9wIGZhaWxlZDoge2V9IikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgIGRlZiBfdWtfZGF0ZV9zdHIoc2VsZiwgdHNfaXNvOiBzdHIpIC0+IHN0cjoKICAgICAgICBpbXBvcnQgZGF0ZXRpbWUgYXMgX2R0CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzID0gKHRzX2lzbyBvciAiIikucmVwbGFjZSgnWicsJycpLnNwbGl0KCcuJylbMF0KICAgICAgICAgICAgZCA9IF9kdC5kYXRldGltZS5mcm9taXNvZm9ybWF0KHMpLmRhdGUoKSBpZiBzIGVsc2UgX2R0LmRhdGV0aW1lLm5vdygpLmRhdGUoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGQgPSBfZHQuZGF0ZXRpbWUubm93KCkuZGF0ZSgpCiAgICAgICAgcmV0dXJuIGYie2QuZGF5fSB7ZC5zdHJmdGltZSgnJUInKX0ge2QueWVhcn0iCiAgICBkZWYgX21heWJlX2luc2VydF9kYXRlX2hlYWRlcihzZWxmLCAqYXJncywgKiprd2FyZ3MpOgogICAgICAgIHJldHVybiBOb25lCgogICAgZGVmIF9mbXRfZGlzcF9wcmVmaXgoc2VsZiwgdHNfaXNvOiBzdHIpIC0+IHN0cjoKICAgICAgICBpbXBvcnQgZGF0ZXRpbWUgYXMgX2R0CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiB0c19pc286CiAgICAgICAgICAgICAgICBzID0gdHNfaXNvLnJlcGxhY2UoJ1onLCAnKzAwOjAwJykKICAgICAgICAgICAgICAgIHV0Y19kdCA9IF9kdC5kYXRldGltZS5mcm9taXNvZm9ybWF0KHMpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICB1dGNfZHQgPSBfZHQuZGF0ZXRpbWUubm93KF9kdC50aW1lem9uZS51dGMpCiAgICAgICAgICAgIGxvY2FsX2R0ID0gdXRjX2R0LmFzdGltZXpvbmUoKQogICAgICAgICAgICByZXR1cm4gZiJbe2xvY2FsX2R0LnN0cmZ0aW1lKCclZC0lYi0lWSAlSDolTTolUycpfV0gIgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHJldHVybiBmIlt7X2R0LmRhdGV0aW1lLm5vdygpLnN0cmZ0aW1lKCclZC0lYi0lWSAlSDolTTolUycpfV0gIgogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcmV0dXJuICJbLS1dICIKICAgIGRlZiBfZGlhZyhzZWxmLCBtc2c6IHN0cik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBkaWFnX2xvZyhtc2cpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcHJpbnQobXNnKQoKICAgIAogICAgZGVmIF9tZXNzYWdlX3Nob3VsZF9kaXNwbGF5KHNlbGYsIG5vcm1fbGluZTogc3RyKSAtPiBib29sOgogICAgICAgIHRyeToKICAgICAgICAgICAgbGluZSA9IChub3JtX2xpbmUgb3IgJycpLnN0cmlwKCkKICAgICAgICAgICAgaWYgbm90IGxpbmU6CiAgICAgICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICAgICAgIyBVcmdlbnQga2V5d29yZHMKICAgICAgICAgICAgaWYgcmUuc2VhcmNoKHInXGIoU09TfE1BWURBWXxVUkdFTlQpXGInLCBsaW5lLCByZS5JKToKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgICAgIG0gPSByZS5zZWFyY2gocicoW0EtWjAtOS9dKylccytERVxzKyhbQS1aMC05L10rKScsIGxpbmUsIHJlLkkpCiAgICAgICAgICAgIHRvX2NzICA9IChtLmdyb3VwKDEpIGlmIG0gZWxzZSAnJykuc3RyaXAoKS51cHBlcigpCiAgICAgICAgICAgIGZybV9jcyA9IChtLmdyb3VwKDIpIGlmIG0gZWxzZSAnJykuc3RyaXAoKS51cHBlcigpCiAgICAgICAgICAgIG15ID0gKHNlbGYubXljYWxsX2VkaXQudGV4dCgpLnN0cmlwKCkudXBwZXIoKSBpZiBoYXNhdHRyKHNlbGYsICdteWNhbGxfZWRpdCcpIGVsc2UgJycpCiAgICAgICAgICAgIGlmIHRvX2NzIGFuZCAodG9fY3MgPT0gbXkgb3IgdG9fY3MgPT0gJ0NRJyk6CiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICAjIFdoaXRlbGlzdCBtb2RlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGZsZWV0ID0gZ2V0YXR0cihzZWxmLCAnZmxlZXQnLCBOb25lKQogICAgICAgICAgICAgICAgaWYgZmxlZXQgYW5kIGdldGF0dHIoZmxlZXQsICdlbmFibGVkJywgRmFsc2UpOgogICAgICAgICAgICAgICAgICAgIGFjdGl2ZSA9IHNldCgoZmxlZXQuYWN0aXZlX2ZsZWV0cyBvciBbXSkgaWYgaGFzYXR0cihmbGVldCwgJ2FjdGl2ZV9mbGVldHMnKSBlbHNlIFtdKQogICAgICAgICAgICAgICAgICAgIG1lbWJlcnMgPSBzZXQoKQogICAgICAgICAgICAgICAgICAgIGZvciBmIGluIGdldGF0dHIoZmxlZXQsICdmbGVldHMnLCBbXSkgb3IgW106CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGYuZ2V0KCduYW1lJykgaW4gYWN0aXZlOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgZm9yIG0yIGluIGYuZ2V0KCdtZW1iZXJzJywgW10pIG9yIFtdOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIG1lbWJlcnMuYWRkKHN0cihtMikudXBwZXIoKSkKICAgICAgICAgICAgICAgICAgICBiX3RvID0gcmUuc3ViKHInLVxkKyQnLCAnJywgdG9fY3MpCiAgICAgICAgICAgICAgICAgICAgYl9mciA9IHJlLnN1YihyJy1cZCskJywgJycsIGZybV9jcykKICAgICAgICAgICAgICAgICAgICBpZiBiX3RvIGluIG1lbWJlcnMgb3IgYl9mciBpbiBtZW1iZXJzOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgIGRlZiBfYXBwZW5kX3J4KHNlbGYsIGxpbmU6IHN0cik6CiAgICAgICAgIyBGMjZhOiBkcm9wIHNlbGYtVFggbW9uaXRvciBlY2hvZXMKICAgICAgICBpZiBfcmNfZHJvcF9jb25zb2xlX2VjaG8oc2VsZiwgbGluZSk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICAjIFNhbml0aXplOiByZW1vdmUgYW55IHN0cmF5IFtNT05dIHRhZ3Mgb24gUlggbGluZXMKICAgICAgICBpZiBpc2luc3RhbmNlKGxpbmUsIHN0cikgYW5kIGxpbmUuc3RhcnRzd2l0aCgnW01PTl0nKToKICAgICAgICAgICAgbGluZSA9IGxpbmUucmVwbGFjZSgnW01PTl0gJywgJycpLnJlcGxhY2UoJ1tNT05dJywgJycpCgogICAgICAgICMgTUVTU0FHRSBGSUxURVIgRU5GT1JDRUQKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9tZXNzYWdlX3Nob3VsZF9kaXNwbGF5KGxpbmUpOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgICMgU2tpcCBVSSBsb2dnaW5nIGZvciBiZWFjb24gbGluZXMgbGlrZSAnLi5DQUxMIC9DSElMRCAuLi4nCiAgICAgICAgdHJ5OgogICAgICAgICAgICBfdCA9IChsaW5lIG9yICcnKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICAgICAgaW1wb3J0IHJlIGFzIF9yZQogICAgICAgICAgICBpZiBfcmUubWF0Y2gocideXC57Mn1bQS1aMC05XSsoXHMqL1tBLVowLTldKykqXHMqJCcsIF90KToKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICAjIE1FU1NBR0UgRklMVEVSIEFQUExJRUQKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9tZXNzYWdlX3Nob3VsZF9kaXNwbGF5KGxpbmUpOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICBpbXBvcnQgZGF0ZXRpbWUgYXMgX2R0CiAgICAgICAgdHMgPSBfZHQuZGF0ZXRpbWUubm93KCkuaXNvZm9ybWF0KHRpbWVzcGVjPSdzZWNvbmRzJykKICAgICAgICBwcmVmaXggPSBzZWxmLl9mbXRfZGlzcF9wcmVmaXgodHMpCgogICAgICAgIGl0ID0gUUxpc3RXaWRnZXRJdGVtKHByZWZpeCArIGxpbmUpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmcm9tIFB5UXQ1LlF0R3VpIGltcG9ydCBRQ29sb3IsIFFCcnVzaAogICAgICAgICAgICBmcm9tIFB5UXQ1LlF0Q29yZSBpbXBvcnQgUXQKICAgICAgICAgICAgYyA9IE5vbmUKICAgICAgICAgICAgX3MgPSAobGluZSBvciAnJykuc3RyaXAoKQogICAgICAgICAgICBteSA9ICcnCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG15ID0gKHNlbGYuZ2V0X215Y2FsbCgpIG9yICcnKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIG15ID0gJycKICAgICAgICAgICAgdG9fY3MgPSAnJwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBtID0gREVfTVNHX1JFLm1hdGNoKF9zKQogICAgICAgICAgICAgICAgaWYgbToKICAgICAgICAgICAgICAgICAgICB0b19jcyA9IChtLmdyb3VwKDIpIG9yICcnKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHRvX2NzID0gJycKICAgICAgICAgICAgaWYgdG9fY3MgYW5kIG15IGFuZCB0b19jcyAhPSBteToKICAgICAgICAgICAgICAgIGMgPSBRQ29sb3IoJyMwODhGOEYnKQogICAgICAgICAgICBlbGlmIHRvX2NzIGFuZCBteSBhbmQgdG9fY3MgPT0gbXk6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgYyA9IFFDb2xvcihzZWxmLkNPTE9SX1JYKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBjID0gUUNvbG9yKCcjMDBGRjAwJykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGMgPSBRQ29sb3IoJyMwODhGOEYnKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpdC5zZXRGb3JlZ3JvdW5kKFFCcnVzaChjKSkKICAgICAgICAgICAgICAgIGl0LnNldERhdGEoUXQuRm9yZWdyb3VuZFJvbGUsIGMpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICBpdC5zZXREYXRhKFF0LlVzZXJSb2xlLCAncngnKQoKICAgICAgICAjIElOU0VSVCBJTlRPIFVJIE5PVwogICAgICAgIHRyeToKICAgICAgICAgICAgdHJ5OgoKICAgICAgICAgICAgICAgIF9lbmNfZ3VhcmQgPSAobGluZSBpZiAibGluZSIgaW4gbG9jYWxzKCkgZWxzZSB0ZXh0IGlmICJ0ZXh0IiBpbiBsb2NhbHMoKSBlbHNlIG1zZyBpZiAibXNnIiBpbiBsb2NhbHMoKSBlbHNlICIiKQoKICAgICAgICAgICAgICAgIGlmIHNlbGYuX2lzX2VuY3J5cHRlZF9saW5lKF9lbmNfZ3VhcmQpOgoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICAgICAgZWxzZToKCiAgICAgICAgICAgICAgICAgICAgc2VsZi5tZXNzYWdlc19saXN0Lmluc2VydEl0ZW0oMCwgaXQpCgogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgoKICAgICAgICAgICAgICAgIHNlbGYubWVzc2FnZXNfbGlzdC5pbnNlcnRJdGVtKDAsIGl0KQoKICAgICAgICAgICAgc2VsZi5tZXNzYWdlc19saXN0LnNjcm9sbFRvVG9wKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgICAgICMgUGVyc2lzdCB0byBzdG9yZSBhcyBVVEMgZm9yIGR1cmFiaWxpdHkKICAgICAgICB0cnk6CiAgICAgICAgICAgIF90cyA9IHNlbGYuX3V0Y19ub3dfaXNvKCkKICAgICAgICAgICAgc2VsZi5fbWVzc2FnZXMuYXBwZW5kKHsnbGluZSc6IGxpbmUsICdyb2xlJzogJ3J4JywgJ3RzJzogX3RzLCAndHNfZGlzcGxheSc6IGdldGF0dHIoc2VsZiwgJ191dGNfZGlzcGxheV9obXMnLCBsYW1iZGEgczogJycpKF90cyl9KQogICAgICAgICAgICBzZWxmLl9zYXZlX21lc3NhZ2VzX3RvX3N0b3JlKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgICAgIGl0LnNldERhdGEoUXQuVXNlclJvbGUsJ3J4JykKCiAgICAgICAgCgogICAgICAgIHRyeToKCiAgICAgICAgICAgIChfdHM6PXNlbGYuX3V0Y19ub3dfaXNvKCksIHNlbGYuX21lc3NhZ2VzLmFwcGVuZCh7J2xpbmUnOiBsaW5lLCAncm9sZSc6ICdyeCcsICd0cyc6IF90cywgJ3RzX2Rpc3BsYXknOiBnZXRhdHRyKHNlbGYsICdfdXRjX2Rpc3BsYXlfaG1zJywgbGFtYmRhIHM6ICcnKShfdHMpfSkpIGFuZCBOb25lCgogICAgICAgICAgICBzZWxmLl9zYXZlX21lc3NhZ2VzX3RvX3N0b3JlKCkKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKCiAgICAgICAgICAgIHBhc3MKCiAgICAKICAgIAogICAgZGVmIF9wZXJzaXN0X3R4KHNlbGYsIG9iajogZGljdCk6CiAgICAgICAgIyBQZXJzaXN0IGEgbWVzc2FnZSB0byBzdG9yZSwgY29sbGFwc2luZyBieSBhY2tfaWQgc28gb25seSB0aGUgbGF0ZXN0IHN0YXR1cyByZW1haW5zLgogICAgICAgIHRyeToKICAgICAgICAgICAgIyBOb3JtYWxpemUgdGltZXN0YW1wIHRvIFVUQyBJU08gWgogICAgICAgICAgICBfdHMgPSBvYmouZ2V0KCd0cycpIG9yIChzZWxmLl91dGNfbm93X2lzbygpIGlmIGhhc2F0dHIoc2VsZiwgJ191dGNfbm93X2lzbycpIGVsc2UgTm9uZSkKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShfdHMsIHN0cikgYW5kIF90cy5lbmRzd2l0aCgnKzAwOjAwJyk6CiAgICAgICAgICAgICAgICBfdHMgPSBfdHMucmVwbGFjZSgnKzAwOjAwJywnWicpCiAgICAgICAgICAgIG9ialsndHMnXSA9IF90cwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBvYmpbJ3RzX2Rpc3BsYXknXSA9IHNlbGYuX3V0Y19kaXNwbGF5X2htcyhfdHMpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgJ19tZXNzYWdlcycpIG9yIG5vdCBpc2luc3RhbmNlKHNlbGYuX21lc3NhZ2VzLCBsaXN0KToKICAgICAgICAgICAgICAgIHNlbGYuX21lc3NhZ2VzID0gW10KICAgICAgICAgICAgIyBJZiB3ZSBoYXZlIGFuIGFja19pZCwgcmVwbGFjZSB0aGUgbW9zdCByZWNlbnQgZW50cnkgd2l0aCBzYW1lIGFja19pZCBpbnN0ZWFkIG9mIGFwcGVuZGluZwogICAgICAgICAgICBhY2tfaWQgPSBzdHIob2JqLmdldCgnYWNrX2lkJykgb3IgJycpLnN0cmlwKCkKICAgICAgICAgICAgaWYgYWNrX2lkOgogICAgICAgICAgICAgICAgcmVwbGFjZWQgPSBGYWxzZQogICAgICAgICAgICAgICAgZm9yIGlkeCBpbiByYW5nZShsZW4oc2VsZi5fbWVzc2FnZXMpLTEsIC0xLCAtMSk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBpZiBzdHIoc2VsZi5fbWVzc2FnZXNbaWR4XS5nZXQoJ2Fja19pZCcpIG9yICcnKS5zdHJpcCgpID09IGFja19pZDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX21lc3NhZ2VzW2lkeF0gPSBvYmoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJlcGxhY2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgYnJlYWsKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICBpZiBub3QgcmVwbGFjZWQ6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fbWVzc2FnZXMuYXBwZW5kKG9iaikKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICMgTm8gYWNrX2lkOiBmYWxsIGJhY2sgdG8gZXhhY3QtbGFzdCBkZS1kdXBlIChsaW5lK3N0YXR1cykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBsYXN0ID0gc2VsZi5fbWVzc2FnZXNbLTFdIGlmIHNlbGYuX21lc3NhZ2VzIGVsc2UgTm9uZQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBsYXN0ID0gTm9uZQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShsYXN0LCBkaWN0KSBhbmQgXAogICAgICAgICAgICAgICAgICAgc3RyKGxhc3QuZ2V0KCdsaW5lJywnJykpID09IHN0cihvYmouZ2V0KCdsaW5lJywnJykpIGFuZCBcCiAgICAgICAgICAgICAgICAgICBzdHIobGFzdC5nZXQoJ3N0YXR1cycsJycpKSA9PSBzdHIob2JqLmdldCgnc3RhdHVzJywnJykpOgogICAgICAgICAgICAgICAgICAgICMgc2tpcCBleGFjdCBkdXBsaWNhdGUKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIHNlbGYuX21lc3NhZ2VzLmFwcGVuZChvYmopCiAgICAgICAgICAgIHNlbGYuX3NhdmVfbWVzc2FnZXNfdG9fc3RvcmUoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX2Fja191cGRhdGVfdWkoc2VsZiwgYWNrX2lkOiBzdHIsIG5ld190ZXh0OiBzdHIsIHN0YXR1czogc3RyKToKICAgICAgICBpdCA9IHNlbGYuX2Fja19pdGVtcy5nZXQoYWNrX2lkKQogICAgICAgIGlmIGl0IGlzIE5vbmU6CiAgICAgICAgICAgIGl0ID0gUUxpc3RXaWRnZXRJdGVtKHNlbGYuX3N0cmlwX2Fja19pZChuZXdfdGV4dCkgKyBzZWxmLl90aWNrc19mb3Jfc3RhdHVzKHN0YXR1cykpOyBpdC5zZXRGb3JlZ3JvdW5kKFFCcnVzaChzZWxmLkNPTE9SX1NFTlQpKTsgaXQuc2V0RGF0YShRdC5Vc2VyUm9sZSwnc2VudCcpCiAgICAgICAgICAgIGltcG9ydCBkYXRldGltZSBhcyBfZHQKICAgICAgICAgICAgX25vdyA9IF9kdC5kYXRldGltZS5ub3coKS5pc29mb3JtYXQodGltZXNwZWM9J3NlY29uZHMnKQogICAgICAgICAgICBzZWxmLl9lbnN1cmVfaGVhZGVyX3RvcChfbm93KQogICAgICAgICAgICBfaWR4ID0gMSBpZiAoc2VsZi5tZXNzYWdlc19saXN0LmNvdW50KCk+MCBhbmQgc2VsZi5tZXNzYWdlc19saXN0Lml0ZW0oMCkgYW5kIHNlbGYubWVzc2FnZXNfbGlzdC5pdGVtKDApLmRhdGEoUXQuVXNlclJvbGUpPT0nZGF0ZWhlYWRlcicpIGVsc2UgMAogICAgICAgICAgICBzZWxmLm1lc3NhZ2VzX2xpc3QuaW5zZXJ0SXRlbShfaWR4LCBpdCkKICAgICAgICAgICAgc2VsZi5fYWNrX2l0ZW1zW2Fja19pZF0gPSBpdAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIG9sZCA9IGl0LnRleHQoKTsgcHJlZml4ID0gKG9sZC5zcGxpdCgnXSAnLDEpWzBdICsgJ10gJykgaWYgKCddICcgaW4gb2xkKSBlbHNlICcnOwogICAgICAgICAgICBpdC5zZXRUZXh0KHByZWZpeCArIHNlbGYuX3N0cmlwX2Fja19pZChuZXdfdGV4dCkgKyBzZWxmLl90aWNrc19mb3Jfc3RhdHVzKHN0YXR1cykpCiAgICAgICAgc2VsZi5tZXNzYWdlc19saXN0LnNjcm9sbFRvVG9wKCkKICAgICAgICBzZWxmLl90b3VjaF9sYXN0X3R4KCkKICAgICAgICBzZWxmLl9wZXJzaXN0X3R4KHsnbGluZSc6IG5ld190ZXh0LCAncm9sZSc6ICgndHgnIGlmIHN0YXR1cy5zdGFydHN3aXRoKCdhdHRlbXB0JykgZWxzZSAoJ2Fja2VkJyBpZiBzdGF0dXM9PSdhY2snIGVsc2UgJ3R4JykpLCAndHMnOiBkYXRldGltZS5kYXRldGltZS5ub3coKS5pc29mb3JtYXQodGltZXNwZWM9J3NlY29uZHMnKSwgJ2Fja19pZCc6IGFja19pZCwgJ3N0YXR1cyc6IHN0YXR1c30pCgogICAgZGVmIF9vbl9zZXJpYWxfdGhyZWFkX2xpbmUoc2VsZiwgbGluZTogc3RyKToKCiAgICAgICAgIyBQUklPUklUWTogPEZST00+IERFIDxUTz4gPE1FU1NBR0U+IFtBQ0sgbm5ubl0KICAgICAgICB0cnk6CiAgICAgICAgICAgIF9zID0gKGxpbmUgb3IgJycpLnN0cmlwKCkKICAgICAgICAgICAgbSA9IERFX01TR19SRS5tYXRjaChfcykKICAgICAgICAgICAgaWYgbToKICAgICAgICAgICAgICAgIGZybV9jcyA9IChtLmdyb3VwKDEpIG9yICcnKS51cHBlcigpCiAgICAgICAgICAgICAgICB0b19jcyAgPSAobS5ncm91cCgyKSBvciAnJykudXBwZXIoKQogICAgICAgICAgICAgICAgbXNnICAgID0gKG0uZ3JvdXAoMykgb3IgJycpLnN0cmlwKCkKICAgICAgICAgICAgICAgIGFja2lkICA9IChtLmdyb3VwKDQpIG9yICcnKS51cHBlcigpIGlmIG0uZ3JvdXAoNCkgZWxzZSBOb25lCiAgICAgICAgICAgICAgICBteSA9ICcnCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbXkgPSAoc2VsZi5nZXRfbXljYWxsKCkgb3IgJycpLnVwcGVyKCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgbXkgPSAoZ2V0YXR0cihzZWxmLCAnbXljYWxsJywgJycpIG9yICcnKS51cHBlcigpCiAgICAgICAgICAgICAgICAjIElnbm9yZSBzZWxmLWVjaG8ganVzdCBpbiBjYXNlCiAgICAgICAgICAgICAgICBpZiBmcm1fY3MgYW5kIG15IGFuZCBmcm1fY3MgPT0gbXk6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICAjIElmIGFkZHJlc3NlZCB0byBtZSBvciBicm9hZGNhc3QtbGlrZSwgYWNjZXB0IGltbWVkaWF0ZWx5CiAgICAgICAgICAgICAgICBpZiBub3QgdG9fY3Mgb3IgKG15IGFuZCB0b19jcyA9PSBteSk6CiAgICAgICAgICAgICAgICAgICAgIyBVcGRhdGUgQUNLIHN0YXRlIGlmIHByZXNlbnQKICAgICAgICAgICAgICAgICAgICBpZiBhY2tpZDoKICAgICAgICAgICAgICAgICAgICAgICAgc3QgPSAoZ2V0YXR0cihzZWxmLCAnX2Fja19zdGF0ZXMnLCB7fSkgb3Ige30pLmdldChhY2tpZCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgc3Q6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdC5vbl9hY2tfcmVjZWl2ZWQoKQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fYXBwZW5kX3J4KF9zKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgoKCiAgICAgICAgIyBNb25pdG9yLW9ubHkgcmF3IGRpc3BsYXkgKG5vIHBlcnNpc3RlbmNlKSB3aGVuIGNoZWNrYm94IGlzIE9OCiAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcyA9IChsaW5lIG9yICcnKS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBzOgogICAgICAgICAgICAgICAgICAgIGlzX21vbml0b3IgPSBzLmxvd2VyKCkuc3RhcnRzd2l0aCgnZm0gJykgb3IgJyBwaWQgJyBpbiBzLmxvd2VyKCkKICAgICAgICAgICAgICAgICAgICBhcHJzX2xpa2UgPSBzWzoxXSBpbiAoJyEnLCAnLycsICc9JywgJ0AnKQogICAgICAgICAgICAgICAgICAgIGlmIHMuc3RhcnRzd2l0aCgnW0tJU1NdJykgb3Igcy5zdGFydHN3aXRoKCdbQVBSU10nKSBvciBpc19tb25pdG9yIG9yIGFwcnNfbGlrZToKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnX2FwcGVuZF9yeF91aV9vbmx5Jyk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9hcHBlbmRfcnhfdWlfb25seShzKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgoKICAgICAgICAjIEFsd2F5cyBwYXJzZSBiZWFjb25zIHNvIEJlYWNvbnMgSGVhcmQgdXBkYXRlcyByZWdhcmRsZXNzIG9mIG1vbml0b3Igc3RhdGUKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgIl9zY2FuX2Zvcl9iZWFjb25fbGluZSIpOgogICAgICAgICAgICAgICAgc2VsZi5fc2Nhbl9mb3JfYmVhY29uX2xpbmUobGluZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgICAgICMgQUNLIGRldGVjdGlvbiBGSVJTVCAod29ya3MgaW4gYm90aCBtb25pdG9yIG1vZGVzKQogICAgICAgIHRyeToKICAgICAgICAgICAgc19hY2sgPSAobGluZSBvciAiIikKICAgICAgICAgICAgbV9hY2sgPSBBQ0tfVEFHX1JFLnNlYXJjaChzX2FjaykKICAgICAgICAgICAgaWYgbV9hY2s6CiAgICAgICAgICAgICAgICBhY2tfaWQgPSAobV9hY2suZ3JvdXAoMSkgb3IgIiIpLnVwcGVyKCkKICAgICAgICAgICAgICAgIHN0ID0gZ2V0YXR0cihzZWxmLCAiX2Fja19zdGF0ZXMiLCB7fSkuZ2V0KGFja19pZCkgaWYgaGFzYXR0cihzZWxmLCAiX2Fja19zdGF0ZXMiKSBlbHNlIE5vbmUKICAgICAgICAgICAgICAgIGlmIHN0OgogICAgICAgICAgICAgICAgICAgIHN0Lm9uX2Fja19yZWNlaXZlZCgpCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9hcHBlbmRfc3lzKGYi4pyUIEFjayB7YWNrX2lkfSByZWNlaXZlZCIpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICAjIE1vbml0b3Itb25seSByYXcgS0lTUy9BUFJTIGRpc3BsYXkgKG5vIHBlcnNpc3RlbmNlOyBvbmx5IHdoZW4gTW9uaXRvciBBbGwgaXMgT04pCiAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcyA9IChsaW5lIG9yICcnKS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBzOgogICAgICAgICAgICAgICAgICAgICMgSWYgdGhlIFROQyBpcyBhbHJlYWR5IG91dHB1dHRpbmcgbW9uaXRvciB0ZXh0IChlLmcuLCAnZm0gU1JDIHRvIERTVCAuLi4gcGlkIEYwJykKICAgICAgICAgICAgICAgICAgICBpc19tb25pdG9yID0gcy5sb3dlcigpLnN0YXJ0c3dpdGgoJ2ZtICcpIG9yICcgcGlkICcgaW4gcy5sb3dlcigpCiAgICAgICAgICAgICAgICAgICAgIyBBbHNvIGNhdGNoIEFQUlMgaW5mbyBsaW5lcyB0aGF0IHN0YXJ0IHdpdGggcG9zaXRpb24vdGltZSBzeW1ib2xzCiAgICAgICAgICAgICAgICAgICAgYXByc19saWtlID0gcy5zdGFydHN3aXRoKCchJykgb3Igcy5zdGFydHN3aXRoKCcvJykgb3Igcy5zdGFydHN3aXRoKCc9Jykgb3Igcy5zdGFydHN3aXRoKCdAJykKICAgICAgICAgICAgICAgICAgICBpZiBzLnN0YXJ0c3dpdGgoJ1tLSVNTXScpIG9yIHMuc3RhcnRzd2l0aCgnW0FQUlNdJykgb3IgaXNfbW9uaXRvciBvciBhcHJzX2xpa2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIG5vdCBzLnN0YXJ0c3dpdGgoJ1tLSVNTXScpIGFuZCAoaXNfbW9uaXRvciBvciBhcHJzX2xpa2UpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcyA9ICdbS0lTU10gJyArIHMKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fYXBwZW5kX3J4X3VpX29ubHkocykKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuICAjIGRvbid0IGxldCBpdCBmYWxsIGludG8gbm9ybWFsIGNoYXQvQUNLIGxvZ2ljCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgICMgTU9OSVRPUi1BTEwgQllQQVNTOiBzaG93IGFueSBub24tZW1wdHkgbGluZSBpbW1lZGlhdGVseQogICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIChsaW5lIG9yICcnKS5zdHJpcCgpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuX2FwcGVuZF9yeCgobGluZSBvciAnJykuc3RyaXAoKSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgIyBTdGVwIDQ6IGRyb3Agc2VsZi1SWCAoRlJPTSA9PSBNWUNBTEwpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBub3JtX3N0ZXA0ID0gcmUuc3ViKHIiW1xyXG5dKyIsICIiLCAobGluZSBvciAiIikpLnN0cmlwKCkKICAgICAgICAgICAgbTQgPSBfUkNfQ0hBVF9SRS5tYXRjaChub3JtX3N0ZXA0KQogICAgICAgICAgICBpZiBtNDoKICAgICAgICAgICAgICAgIGZybTQgPSAobTQuZ3JvdXAoMikgb3IgIiIpLnVwcGVyKCkKICAgICAgICAgICAgICAgIG15NCAgPSAoc2VsZi5teWNhbGxfZWRpdC50ZXh0KCkuc3RyaXAoKS51cHBlcigpIGlmIGhhc2F0dHIoc2VsZiwgIm15Y2FsbF9lZGl0IikgZWxzZSAiIikKICAgICAgICAgICAgICAgIGlmIGZybTQgYW5kIG15NCBhbmQgZnJtNCA9PSBteTQ6CiAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgICMgU3RlcCAzOiBzdHJpY3QgQUNLIGNoZWNrIChuZXZlciBhY2NlcHQgQUNLIGZyb20gTVlDQUxMOyBtdXN0IG1hdGNoIGV4cGVjdGVkIHRhcmdldCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIG5vcm1fc3RlcDMgPSByZS5zdWIociJbXHJcbl0rIiwgIiIsIChsaW5lIG9yICIiKSkuc3RyaXAoKQogICAgICAgICAgICBtY2hhdCA9IF9SQ19DSEFUX1JFLm1hdGNoKG5vcm1fc3RlcDMpCiAgICAgICAgICAgIHRvX2NzLCBmcm1fY3MsIG1zZyA9IChOb25lLCBOb25lLCBOb25lKQogICAgICAgICAgICBpZiBtY2hhdDoKICAgICAgICAgICAgICAgIHRvX2NzICA9IChtY2hhdC5ncm91cCgxKSBvciAiIikudXBwZXIoKQogICAgICAgICAgICAgICAgZnJtX2NzID0gKG1jaGF0Lmdyb3VwKDIpIG9yICIiKS51cHBlcigpCiAgICAgICAgICAgICAgICBtc2cgICAgPSAobWNoYXQuZ3JvdXAoMykgb3IgIiIpCiAgICAgICAgICAgIG15ID0gKHNlbGYubXljYWxsX2VkaXQudGV4dCgpLnN0cmlwKCkudXBwZXIoKSBpZiBoYXNhdHRyKHNlbGYsICJteWNhbGxfZWRpdCIpIGVsc2UgIiIpCiAgICAgICAgICAgIGlmIG1zZyBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGFtID0gX1JDX0FDS19SRS5zZWFyY2gobXNnKQogICAgICAgICAgICAgICAgaWYgYW06CiAgICAgICAgICAgICAgICAgICAgYWlkID0gYW0uZ3JvdXAoMSkudXBwZXIoKQogICAgICAgICAgICAgICAgICAgICMgUnVsZSAxOiBhbiBBQ0sgd2lsbCBuZXZlciBiZSBhbiBBQ0sgaWYgaXQgaXMgZnJvbSBNWUNBTEwKICAgICAgICAgICAgICAgICAgICBpZiBmcm1fY3MgYW5kIG15IGFuZCBmcm1fY3MgPT0gbXk6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICBleHAgPSBnZXRhdHRyKHNlbGYsICJfcGVuZGluZ19vdXRib3giLCB7fSkuZ2V0KGFpZCkKICAgICAgICAgICAgICAgICAgICAgICAgaWYgZXhwIGFuZCBmcm1fY3MgPT0gKGV4cC5nZXQoInRhcmdldCIsICIiKSBvciAiIikudXBwZXIoKSBhbmQgKG5vdCB0b19jcyBvciB0b19jcyA9PSBteSk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzdCA9IChnZXRhdHRyKHNlbGYsICJfYWNrX3N0YXRlcyIsIHt9KSBvciB7fSkuZ2V0KGFpZCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHN0OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0Lm9uX2Fja19yZWNlaXZlZCgpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fYXBwZW5kX3J4KG5vcm1fc3RlcDMpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICAjIFN0ZXAgMjogZHJvcCBleGFjdCBUWCBlY2hvZXMgc2VlbiB2ZXJ5IHJlY2VudGx5CiAgICAgICAgdHJ5OgogICAgICAgICAgICBub3JtID0gcmUuc3ViKHIiW1xyXG5dKyIsICIiLCAobGluZSBvciAiIikpLnN0cmlwKCkKICAgICAgICAgICAgaWYgX1JDX1JFQ0VOVF9UWC5zZWVuKG5vcm0pOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHR4dCA9IChsaW5lIG9yICIiKS5zdHJpcCgpCiAgICAgICAgbm9ybSA9IHJlLnN1YihyIltcclxuXSsiLCAiIiwgdHh0KS5zdHJpcCgpCiAgICAgICAgIyBTRUxGLUVDSE8gR1VBUkQKICAgICAgICB0cnk6CiAgICAgICAgICAgIG15Y3MgPSAoc2VsZi5teWNhbGxfZWRpdC50ZXh0KCkuc3RyaXAoKS51cHBlcigpIGlmIGhhc2F0dHIoc2VsZiwgJ215Y2FsbF9lZGl0JykgZWxzZSAnJykKICAgICAgICAgICAgaWYgbXljcyBhbmQgcmUuc2VhcmNoKHJmIlxiREVccyt7cmUuZXNjYXBlKG15Y3MpfVxiIiwgbm9ybSwgcmUuSSk6CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgIyAtLS0gU3VwcHJlc3MgbG9jYWwgZWNobyBvZiBvdXIgb3duIGNvbnRyb2wgbGluZXMgKEZJTEUqL0FDSykgLS0tCiAgICAgICAgdHJ5OgogICAgICAgICAgICBtID0gcmUubWF0Y2gocideKFtBLVowLTkvXSt8Q1EpXHMrREVccysoW0EtWjAtOS9dKylccyooLiopJCcsIG5vcm0sIHJlLkkpCiAgICAgICAgICAgIGlmIG06CiAgICAgICAgICAgICAgICBfdG8gPSAobS5ncm91cCgxKSBvciAiIikuc3RyaXAoKS51cHBlcigpCiAgICAgICAgICAgICAgICBfZnJtID0gKG0uZ3JvdXAoMikgb3IgIiIpLnN0cmlwKCkudXBwZXIoKQogICAgICAgICAgICAgICAgX21zZyA9IChtLmdyb3VwKDMpIG9yICIiKS5zdHJpcCgpCiAgICAgICAgICAgICAgICBtZSA9IChzZWxmLm15Y2FsbF9lZGl0LnRleHQoKS5zdHJpcCgpLnVwcGVyKCkgaWYgaGFzYXR0cihzZWxmLCAibXljYWxsX2VkaXQiKSBlbHNlICIiKQogICAgICAgICAgICAgICAgaWYgX2ZybSA9PSBtZSBhbmQgKF9tc2cuc3RhcnRzd2l0aCgiRklMRSAiKSBvciByZS5zZWFyY2gocidcW0FDSzonLCBfbXNnKSk6CiAgICAgICAgICAgICAgICAgICAgIyBzd2FsbG93OiBkb24ndCBhcHBlbmQgb3IgcHJvY2VzcwogICAgICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgIyAtLS0gQXV0by1SZWxheSAoYWx3YXlzIG9uLCBzaWxlbnQpIC0tLQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgIiBERSAiIGluIG5vcm06CiAgICAgICAgICAgICAgICBwYXJ0cyA9IG5vcm0uc3BsaXQoIiBERSAiLCAxKQogICAgICAgICAgICAgICAgaWYgbGVuKHBhcnRzKSA+PSAyOgogICAgICAgICAgICAgICAgICAgIHRhcmdldCA9IHBhcnRzWzBdLnN0cmlwKCkudXBwZXIoKQogICAgICAgICAgICAgICAgICAgIG15Y2FsbCA9IHNlbGYubXljYWxsX2VkaXQudGV4dCgpLnN0cmlwKCkudXBwZXIoKSBpZiBoYXNhdHRyKHNlbGYsICJteWNhbGxfZWRpdCIpIGVsc2UgIiIKICAgICAgICAgICAgICAgICAgICBpZiB0YXJnZXQgYW5kIHRhcmdldCAhPSBteWNhbGw6CiAgICAgICAgICAgICAgICAgICAgICAgIGhlYXJkID0gc2V0KCkKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAiX2dyYXBoX3BhcmVudHMiKSBhbmQgaXNpbnN0YW5jZShzZWxmLl9ncmFwaF9wYXJlbnRzLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBoZWFyZC51cGRhdGUoW3N0cihrKS51cHBlcigpIGZvciBrIGluIHNlbGYuX2dyYXBoX3BhcmVudHMua2V5cygpXSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3Iga2lkcyBpbiBzZWxmLl9ncmFwaF9wYXJlbnRzLnZhbHVlcygpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGtpZHMsIChsaXN0LCB0dXBsZSkpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaGVhcmQudXBkYXRlKFtzdHIoeCkudXBwZXIoKSBmb3IgeCBpbiBraWRzXSkKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICAgICAgaWYgdGFyZ2V0IGluIGhlYXJkOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgIl9yZWxheV9jYWNoZSIpOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3JlbGF5X2NhY2hlID0ge30KICAgICAgICAgICAgICAgICAgICAgICAgICAgIGltcG9ydCB0aW1lIGFzIF90aW1lCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBub3cgPSBfdGltZS50aW1lKCkKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgUHVyZ2UgY2FjaGUgZW50cmllcyBvbGRlciB0aGFuIDMwcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fcmVsYXlfY2FjaGUgPSB7azp2IGZvciBrLHYgaW4gc2VsZi5fcmVsYXlfY2FjaGUuaXRlbXMoKSBpZiBub3cgLSB2IDwgMzB9CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBub3JtIG5vdCBpbiBzZWxmLl9yZWxheV9jYWNoZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9yZWxheV9jYWNoZVtub3JtXSA9IG5vdwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5zZW5kX3VzZXJfdGV4dChub3JtKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgbSA9IHJlLnNlYXJjaChyIlxbQUNLOihbQS1aYS16MC05XXs0LDEwfSlcXSIsIG5vcm0pCiAgICAgICAgaWYgbToKICAgICAgICAgICAgYWlkID0gbS5ncm91cCgxKS51cHBlcigpCiAgICAgICAgICAgIG0yID0gcmUuc2VhcmNoKHIiKFtBLVowLTkvXSspXHMrREVccysoW0EtWjAtOS9dKykiLCBub3JtLCByZS5JKQogICAgICAgICAgICB0b19jcyAgPSAobTIuZ3JvdXAoMSkgaWYgbTIgZWxzZSAnJykuc3RyaXAoKS51cHBlcigpCiAgICAgICAgICAgIGZybV9jcyA9IChtMi5ncm91cCgyKSBpZiBtMiBlbHNlICcnKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICAgICAgbXkgPSAoc2VsZi5teWNhbGxfZWRpdC50ZXh0KCkuc3RyaXAoKS51cHBlcigpIGlmIGhhc2F0dHIoc2VsZiwgJ215Y2FsbF9lZGl0JykgZWxzZSAnJykKICAgICAgICAgICAgaWYgZnJtX2NzIGFuZCBteSBhbmQgZnJtX2NzID09IG15OgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHN0ID0gc2VsZi5fYWNrX3N0YXRlcy5nZXQoYWlkKSBpZiBoYXNhdHRyKHNlbGYsICdfYWNrX3N0YXRlcycpIGVsc2UgTm9uZQogICAgICAgICAgICBpZiBzdCBhbmQgKG5vcm0gaW4gZ2V0YXR0cihzdCwgJ2VjaG9fdGV4dHMnLCBzZXQoKSkpOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIGlmIHN0OgogICAgICAgICAgICAgICAgZXhwID0gZ2V0YXR0cihzZWxmLCAnX3BlbmRpbmdfb3V0Ym94Jywge30pLmdldChhaWQpIGlmIGhhc2F0dHIoc2VsZiwgJ19wZW5kaW5nX291dGJveCcpIGVsc2UgTm9uZQogICAgICAgICAgICAgICAgaWYgZXhwOgogICAgICAgICAgICAgICAgICAgIHdhbnQgPSAoZXhwLmdldCgndGFyZ2V0JywgJycpIG9yICcnKS51cHBlcigpCiAgICAgICAgICAgICAgICAgICAgaWYgZnJtX2NzIGFuZCB3YW50IGFuZCBmcm1fY3MgIT0gd2FudDoKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICAgICBzdC5vbl9hY2tfcmVjZWl2ZWQoKQogICAgICAgICAgICBpZiBzZWxmLl9tZXNzYWdlX3Nob3VsZF9kaXNwbGF5KG5vcm0pOgogICAgICAgICAgICAgICAgc2VsZi5fYXBwZW5kX3J4KG5vcm0pCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICBpZiAiIERFICIgaW4gbm9ybToKICAgICAgICAgICAgc2VsZi5fYXBwZW5kX3J4KG5vcm0pCiAgICAgICAgICAgIHJldHVybgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fc2Nhbl9mb3JfYmVhY29uX2xpbmUobm9ybSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHNlbGYuX2FwcGVuZF9yeChub3JtKQoKICAgIGRlZiBfbmV4dF9hY2tfaWQoc2VsZikgLT4gc3RyOgogICAgICAgIGltcG9ydCByYW5kb20KICAgICAgICByZXR1cm4gZiJ7cmFuZG9tLnJhbmRpbnQoMSwgOTk5OSk6MDRkfSIKCiAgICBkZWYgX3NlcmlhbF9pc19vcGVuKHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcmV0dXJuIGdldGF0dHIoc2VsZiwgJ3NlcicsIE5vbmUpIGlzIG5vdCBOb25lIGFuZCBzZWxmLnNlci5pc19vcGVuCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9vcGVuX3NlcmlhbChzZWxmLCBwb3J0OiBzdHIsIGJhdWQ6IGludCA9IDM4NDAwKToKICAgICAgICBpZiBub3QgU0VSSUFMX0FWQUlMQUJMRToKICAgICAgICAgICAgUU1lc3NhZ2VCb3gud2FybmluZyhzZWxmLCAnU2VyaWFsJywgJ3B5c2VyaWFsIGlzIG5vdCBpbnN0YWxsZWQuIEluc3RhbGwgd2l0aDogcGlwIGluc3RhbGwgcHlzZXJpYWwnKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHNlbGYuX3NlcmlhbF9pc19vcGVuKCk6CiAgICAgICAgICAgICAgICBzZWxmLnNlci5jbG9zZSgpCiAgICAgICAgICAgIHNlbGYuc2VyID0gc2VyaWFsLlNlcmlhbChwb3J0PXBvcnQsIGJhdWRyYXRlPWJhdWQsIHRpbWVvdXQ9MC4xLCB3cml0ZV90aW1lb3V0PTAuNSkKICAgICAgICAgICAgc2VsZi5fc3RhdHVzKGYnT3BlbmVkIHtwb3J0fSBAIHtiYXVkfSBicHMnKTsgZGlhZ19sb2coZiJbT1BFTl0gcG9ydD0ne3BvcnR9JyBiYXVkPXtiYXVkfSIpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBRTWVzc2FnZUJveC5jcml0aWNhbChzZWxmLCAnU2VyaWFsJywgZidGYWlsZWQgdG8gb3BlbiB7cG9ydH06IHtlfScpCiAgICAgICAgICAgIHNlbGYuc2VyID0gTm9uZQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2Nsb3NlX3NlcmlhbChzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHNlbGYuX3NlcmlhbF9pc19vcGVuKCk6CiAgICAgICAgICAgICAgICBwID0gc2VsZi5zZXIucG9ydAogICAgICAgICAgICAgICAgc2VsZi5zZXIuY2xvc2UoKQogICAgICAgICAgICAgICAgc2VsZi5fc3RhdHVzKGYnQ2xvc2VkIHtwfScpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHNlbGYuc2VyID0gTm9uZQoKICAgIGRlZiBfc2VyaWFsX3dyaXRlX2J5dGVzKHNlbGYsIGRhdGE6IGJ5dGVzKToKICAgICAgICBpZiBub3Qgc2VsZi5fc2VyaWFsX2lzX29wZW4oKToKICAgICAgICAgICAgcmFpc2UgUnVudGltZUVycm9yKCdTZXJpYWwgaXMgbm90IG9wZW4nKQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5zZXIud3JpdGUoZGF0YSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHRyeTogc2VsZi5fc3RhdHVzKGYnU2VyaWFsIHdyaXRlIGZhaWxlZDoge2V9JykKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICB0cnk6IHNlbGYuX2Nsb3NlX3NlcmlhbCgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgcmFpc2UKCgogICAgZGVmIF9zZXJpYWxfd3JpdGVfdGV4dChzZWxmLCB0ZXh0OiBzdHIpOgogICAgICAgIGlmIG5vdCBzZWxmLl9zZXJpYWxfaXNfb3BlbigpOgogICAgICAgICAgICByYWlzZSBSdW50aW1lRXJyb3IoJ1NlcmlhbCBpcyBub3Qgb3BlbicpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnNlci53cml0ZSh0ZXh0LmVuY29kZSgnYXNjaWknLCBlcnJvcnM9J2lnbm9yZScpKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgdHJ5OiBzZWxmLl9zdGF0dXMoZidTZXJpYWwgd3JpdGUgZmFpbGVkOiB7ZX0nKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgIHRyeTogc2VsZi5fY2xvc2Vfc2VyaWFsKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICByYWlzZQoKCiAgICBkZWYgc2VuZF91c2VyX3RleHQoc2VsZiwgdGV4dDogc3RyKSAtPiBib29sOgogICAgICAgICcnJwogICAgICAgIFdpcmUgU0VORCAtPiBQVFQgYnkgd3JpdGluZyBhIGZ1bGwgbGluZSB0byB0aGUgc2VyaWFsIGRldmljZSwKICAgICAgICB3aXRoIGEgc2hvcnQgZGVsYXkgdG8gbWltaWMgcmFkaW8gUFRUIGtleWluZy4KICAgICAgICBSZXR1cm5zIFRydWUgaWYgYWN0dWFsbHkgd3JpdHRlbi4KICAgICAgICAnJycKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG5vdCBzZWxmLl9zZXJpYWxfaXNfb3BlbigpOgogICAgICAgICAgICAgICAgc2VsZi5fc3RhdHVzKCdUWCBibG9ja2VkOiBvcGVuIGEgQ09NIHBvcnQgZmlyc3QuJykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9kaWFnKCdbVFhdIGJsb2NrZWQ6IHNlcmlhbCBub3Qgb3BlbicpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICAgICAgIyByZW1lbWJlciBUWCBmb3IgZWNobyBzdXBwcmVzc2lvbgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBfUkNfUkVDRU5UX1RYLm5vdGUodGV4dCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgIGltcG9ydCB0aW1lCiAgICAgICAgICAgICMgRW5nYWdlIFBUVDogd3JpdGUgdGhlIGxpbmUgd2l0aCBDUiB0ZXJtaW5hdG9yCiAgICAgICAgICAgIHNlbGYuX3NlcmlhbF93cml0ZV90ZXh0KHRleHQgKyAiXHIiKQogICAgICAgICAgICBzZWxmLl9zdGF0dXMoJ1BUVCBrZXllZCDihpIgVFggc2VuZGluZy4uLicpCiAgICAgICAgICAgIHRpbWUuc2xlZXAoMC4yKSAgIyBkZWxheSBiZWZvcmUgdW5rZXkgKGFkanVzdCBhcyBuZWVkZWQpCgogICAgICAgICAgICAjIFJlbGVhc2UgUFRUIChkZXZpY2UgdW5rZXlzIGF1dG9ub21vdXNseSBhZnRlciBUWCBpbiB0aGlzIHJpZykKICAgICAgICAgICAgc2VsZi5fc3RhdHVzKCdQVFQgcmVsZWFzZWQgYWZ0ZXIgVFgnKQogICAgICAgICAgICByZXR1cm4gVHJ1ZQoKICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgIHNlbGYuX3N0YXR1cyhmJ1RYIGVycm9yOiB7ZX0nKQogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAgICAgICAgICMgV3JpdGUgdXNlciBsaW5lIHdpdGggQ1IgdGVybWluYXRvcgogICAgICAgICAgICBzZWxmLl9zZXJpYWxfd3JpdGVfdGV4dCh0ZXh0ICsgIlxyIikKICAgICAgICAgICAgc2VsZi5fc3RhdHVzKCdQVFQga2V5ZWQg4oaSIFRYIHNlbnQg4oaSIFBUVCByZWxlYXNlZCcpCiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgICAgICBzZWxmLl9zdGF0dXMoZidUWCBlcnJvcjoge2V9JykKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgICAgICAgICAjIFdyaXRlIHVzZXIgbGluZSB3aXRoIENSIHRlcm1pbmF0b3IKICAgICAgICAgICAgc2VsZi5fc2VyaWFsX3dyaXRlX3RleHQodGV4dCArICJcciIpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX3N0YXR1cygnVFggc2VudC4nKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fc3RhdHVzKGYnVFggZXJyb3I6IHtlfScpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgICAgICBpZiBub3Qgc2VsZi5fc2VyaWFsX2lzX29wZW4oKToKICAgICAgICAgICAgcmFpc2UgUnVudGltZUVycm9yKCdTZXJpYWwgaXMgbm90IG9wZW4nKQogICAgICAgIHNlbGYuc2VyLndyaXRlKHRleHQuZW5jb2RlKCdhc2NpaScsIGVycm9ycz0naWdub3JlJykpCgogICAgZGlhZ19sb2coJ0NoYXRBcHAgaW5pdCBzdGFydGluZycpCiAgICBkZWYgX19pbml0X18oc2VsZik6CiAgICAgICAgc2VsZi5fc3RhcnRfbWF4aW1pemVkID0gVHJ1ZSAgIyBtYXhpbWl6ZSBvbiBmaXJzdCBzaG93CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygpCiAgICAgICAgc2VsZi5fZW5zdXJlX2NvbG9yX2F0dHJzKCkKICAgICAgICBfaW5zdGFsbF92dDMyM19mb250KCkKICAgICAgICBhcHAgPSBRQXBwbGljYXRpb24uaW5zdGFuY2UoKQogICAgICAgIGFwcC5zZXRGb250KFFGb250KCJWVDMyMyIsIDEyKSkKICAgICAgICBzZWxmLnNldEZvbnQoUUZvbnQoIlZUMzIzIiwgMTIpKQogICAgICAgIF9sb2dfZm9udF9zbmFwc2hvdCgiaW5pdF9hZnRlcl9hcHBfYW5kX3dpbmRvd19mb250Iiwgc2VsZikKICAgICAgICBfbG9nX2ZvbnRfc25hcHNob3QoImluaXRfYWZ0ZXJfc2V0Rm9udCIsIHNlbGYpCiAgICAgICAgc2VsZi5zZXRXaW5kb3dUaXRsZSgiUm9idXN0IENoYXQgdjEuNiIpCiAgICAgICAgc2VsZi5yZXNpemUoMTIwMCwgODAwKQoKICAgICAgICBzZWxmLmZsZWV0ID0gRmxlZXRNYW5hZ2VyKG9zLnBhdGguam9pbihhcHBfYmFzZV9kaXIoKSwgJ0ZsZWV0bGlzdC5qc29uJykpCiAgICAgICAgc2VsZi5iZWFjb25fbWludXRlcyA9IDE1CiAgICAgICAgc2VsZi5oYl9wYXJlbnRfc2VlbiA9IHt9OyBzZWxmLmhiX2NoaWxkcmVuID0ge307IHNlbGYuc2VudF9ieV9hY2sgPSB7fQogICAgICAgIHNlbGYuX21lc3NhZ2VzID0gW10KICAgICAgICBzZWxmLnNlciA9IE5vbmUKICAgICAgICAjIEJlYWNvbiBncmFwaCBsaXZlIHN0YXRlCiAgICAgICAgc2VsZi5fZ3JhcGhfcGFyZW50cyA9IHt9CiAgICAgICAgc2VsZi5fY3VycmVudF9wYXJlbnRfZm9yX2NoaWxkcmVuID0gTm9uZQogICAgICAgIHNlbGYuX2xhc3RfYmVhY29uX2hlYXJkX3RzID0gTm9uZQoKICAgICAgICBzZWxmLmNlbnRyYWxfd2lkZ2V0ID0gUVdpZGdldCgpOyBzZWxmLnNldENlbnRyYWxXaWRnZXQoc2VsZi5jZW50cmFsX3dpZGdldCkKICAgICAgICBzZWxmLm1haW5fbGF5b3V0ID0gUVZCb3hMYXlvdXQoc2VsZi5jZW50cmFsX3dpZGdldCkKCiAgICAgICAgIyBUb29sYmFyICsgdGFicwogICAgICAgIHNlbGYudG9vbGJhciA9IFFUb29sQmFyKCJNYWluIFRvb2xiYXIiKTsgc2VsZi5hZGRUb29sQmFyKFF0LlRvcFRvb2xCYXJBcmVhLCBzZWxmLnRvb2xiYXIpCiAgICAgICAgc2VsZi50YWJfd2lkZ2V0ID0gUVRhYldpZGdldCgpOyBzZWxmLnRvb2xiYXIuYWRkV2lkZ2V0KHNlbGYudGFiX3dpZGdldCkKICAgICAgICAjIE1haW4gdGFiIChob21lKQogICAgICAgIHNlbGYubWFpbl90YWIgPSBRV2lkZ2V0KCk7IHNlbGYudGFiX3dpZGdldC5hZGRUYWIoc2VsZi5tYWluX3RhYiwgIk1haW4iKQoKICAgICAgICAjIFRoZW1lIHNlbGVjdG9yCiAgICAgICAgc2VsZi50aGVtZV9tZ3IgPSBUaGVtZU1hbmFnZXIoKQogICAgICAgIHNlbGYudG9vbGJhci5hZGRTZXBhcmF0b3IoKTsgc2VsZi50b29sYmFyLmFkZFdpZGdldChRTGFiZWwoIiBUaGVtZTogIikpCiAgICAgICAgc2VsZi50aGVtZV9jb21ibyA9IFFDb21ib0JveCgpOyBzZWxmLnRoZW1lX2NvbWJvLmFkZEl0ZW1zKGxpc3Qoc2VsZi50aGVtZV9tZ3IudGhlbWVzLmtleXMoKSkpCiAgICAgICAgc2VsZi50b29sYmFyLmFkZFdpZGdldChzZWxmLnRoZW1lX2NvbWJvKQogICAgICAgIHNlbGYudGhlbWVfY29tYm8uY3VycmVudFRleHRDaGFuZ2VkLmNvbm5lY3Qoc2VsZi5hcHBseV90aGVtZSkKCiAgICAgICAgIyBNYW51YWwgQUNLIHRhYgogICAgICAgIHNlbGYuYWNrX3RhYiA9IFFXaWRnZXQoKTsgc2VsZi5hY2tfbGF5b3V0ID0gUUhCb3hMYXlvdXQoc2VsZi5hY2tfdGFiKTsgc2VsZi5hY2tfbGF5b3V0LnNldENvbnRlbnRzTWFyZ2lucyg4LDQsOCw0KQogICAgICAgIHNlbGYuYWNrX2xheW91dC5hZGRXaWRnZXQoUUxhYmVsKCJBQ0sgcGF1c2UgKHMpOiIpKQogICAgICAgIHNlbGYuYWNrX2J0bnMgPSBbXQogICAgICAgIGZvciB2YWwgaW4gKDksMTAsMTEsMTIsMTMpOgogICAgICAgICAgICBiID0gUVB1c2hCdXR0b24oc3RyKHZhbCkpOyBiLnNldENoZWNrYWJsZShUcnVlKQogICAgICAgICAgICBiLmNsaWNrZWQuY29ubmVjdChsYW1iZGEgXz1GYWxzZSwgdj12YWwsIGJ0bj1iOiBzZWxmLl9zZXRfYWNrX3BhdXNlKHYsIGJ0bikpCiAgICAgICAgICAgIHNlbGYuYWNrX2xheW91dC5hZGRXaWRnZXQoYik7IHNlbGYuYWNrX2J0bnMuYXBwZW5kKGIpCiAgICAgICAgc2VsZi5hY2tfbGF5b3V0LmFkZFN0cmV0Y2goKQogICAgICAgIHNlbGYudGFiX3dpZGdldC5hZGRUYWIoc2VsZi5hY2tfdGFiLCAiTWFudWFsIEFDSyIpCgogICAgICAgICMgQmVhY29uIHRhYgogICAgICAgIHNlbGYuYmVhY29uX3RhYiA9IFFXaWRnZXQoKTsgYmwgPSBRSEJveExheW91dChzZWxmLmJlYWNvbl90YWIpOyBibC5zZXRDb250ZW50c01hcmdpbnMoOCw0LDgsNCkKICAgICAgICBibC5hZGRXaWRnZXQoUUxhYmVsKCJCZWFjb24gaW50ZXJ2YWwgKG1pbik6IikpCiAgICAgICAgc2VsZi5iZWFjb25fNV9idG4gPSBRUHVzaEJ1dHRvbigiNSBtaW4iKTsgc2VsZi5iZWFjb25fMTBfYnRuID0gUVB1c2hCdXR0b24oIjEwIG1pbiIpOyBzZWxmLmJlYWNvbl8xNV9idG4gPSBRUHVzaEJ1dHRvbigiMTUgbWluIikKICAgICAgICBzZWxmLmJlYWNvbl81X2J0bi5jbGlja2VkLmNvbm5lY3QobGFtYmRhOiBzZWxmLnNldF9iZWFjb25faW50ZXJ2YWwoNSkpCiAgICAgICAgc2VsZi5iZWFjb25fMTBfYnRuLmNsaWNrZWQuY29ubmVjdChsYW1iZGE6IHNlbGYuc2V0X2JlYWNvbl9pbnRlcnZhbCgxMCkpCiAgICAgICAgc2VsZi5iZWFjb25fMTVfYnRuLmNsaWNrZWQuY29ubmVjdChsYW1iZGE6IHNlbGYuc2V0X2JlYWNvbl9pbnRlcnZhbCgxNSkpCiAgICAgICAgYmwuYWRkV2lkZ2V0KHNlbGYuYmVhY29uXzVfYnRuKTsgYmwuYWRkV2lkZ2V0KHNlbGYuYmVhY29uXzEwX2J0bik7IGJsLmFkZFdpZGdldChzZWxmLmJlYWNvbl8xNV9idG4pOyBibC5hZGRTdHJldGNoKCkKICAgICAgICBzZWxmLnRhYl93aWRnZXQuYWRkVGFiKHNlbGYuYmVhY29uX3RhYiwgIkJlYWNvbiIpCgogICAgICAgICMgTmV0d29yayBtYXAgdGFiCiAgICAgICAgc2VsZi5saW5rbWFwX3RhYiA9IFFXaWRnZXQoKQogICAgICAgIHNlbGYudGFiX3dpZGdldC5hZGRUYWIoc2VsZi5saW5rbWFwX3RhYiwgIk5ldHdvcmsgTWFwIikKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYudGFiX3dpZGdldC5jdXJyZW50Q2hhbmdlZC5jb25uZWN0KGxhbWJkYSBpZHg6IHNlbGYub25fdG9vbGJhcl90YWJfY2hhbmdlZChpZHgpIGlmIGhhc2F0dHIoc2VsZiwgJ29uX3Rvb2xiYXJfdGFiX2NoYW5nZWQnKSBlbHNlIE5vbmUpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHNlbGYudGFiX3dpZGdldC5zZXRDdXJyZW50SW5kZXgoMCkKCiAgICAgICAgIyBDb250ZW50IHNwbGl0CiAgICAgICAgc2VsZi5jb250ZW50X2xheW91dCA9IFFIQm94TGF5b3V0KCk7IHNlbGYubWFpbl9sYXlvdXQuYWRkTGF5b3V0KHNlbGYuY29udGVudF9sYXlvdXQpCiAgICAgICAgc2VsZi5sZWZ0X2NvbnRhaW5lciA9IFFXaWRnZXQoKTsgc2VsZi5sZWZ0X3N0YWNrID0gUVZCb3hMYXlvdXQoc2VsZi5sZWZ0X2NvbnRhaW5lcik7IHNlbGYuY29udGVudF9sYXlvdXQuYWRkV2lkZ2V0KHNlbGYubGVmdF9jb250YWluZXIsIDIpCiAgICAgICAgIyBTZWN1cmUgUGFkIHBhZGxvY2sgKGJldHdlZW4gbWFpbiBjb250ZW50IGFuZCBCZWFjb25zOyBib3R0b20tYWxpZ25lZCkKICAgICAgICBzZWxmLnNlY3VyZV9idG4gPSBRUHVzaEJ1dHRvbigi8J+UkiIpCiAgICAgICAgc2VsZi5zZWN1cmVfYnRuLnNldFRvb2xUaXAoIk9wZW4gU2VjdXJlIFBhZCIpCiAgICAgICAgc2VsZi5zZWN1cmVfYnRuLnNldEZsYXQoVHJ1ZSkKICAgICAgICBzZWxmLnNlY3VyZV9idG4uc2V0Rml4ZWRXaWR0aCg2NCkKICAgICAgICBzZWxmLnNlY3VyZV9idG4uY2xpY2tlZC5jb25uZWN0KHNlbGYub3Blbl9zZWN1cmVfcGFkKQogICAgICAgIHNlbGYuY29udGVudF9sYXlvdXQuYWRkV2lkZ2V0KHNlbGYuc2VjdXJlX2J0biwgYWxpZ25tZW50PVF0LkFsaWduQm90dG9tKQogICAgICAgIHNlbGYucmlnaHRfcGFuZWwgPSBRV2lkZ2V0KCk7IHNlbGYucmlnaHRfbGF5b3V0ID0gUVZCb3hMYXlvdXQoc2VsZi5yaWdodF9wYW5lbCk7IHNlbGYucmlnaHRfbGF5b3V0LnNldENvbnRlbnRzTWFyZ2lucygwLDAsMCwwKTsgc2VsZi5jb250ZW50X2xheW91dC5hZGRXaWRnZXQoc2VsZi5yaWdodF9wYW5lbCwgMCkKCiAgICAgICAgIyBSaWdodCBwYW5lbAogICAgICAgIHNlbGYuZGlhbF9ncm91cCA9IFFHcm91cEJveCgiRGlhbCBGcmVxdWVuY2llcyIpOyBkdiA9IFFWQm94TGF5b3V0KHNlbGYuZGlhbF9ncm91cCkKICAgICAgICBmb3IgdCBpbiAoIjcuMDkwLDMgTUh6IiwgIjEwLjE0OCwzIE1IeiIsICIxNC4xMDkgTUh6Iik6IGR2LmFkZFdpZGdldChRTGFiZWwodCkpCiAgICAgICAgc2VsZi5yaWdodF9sYXlvdXQuYWRkV2lkZ2V0KHNlbGYuZGlhbF9ncm91cCwgMCkKICAgICAgICBzZWxmLmJlYWNvbl9ncm91cCA9IFFHcm91cEJveCgiQmVhY29ucyBIZWFyZCIpOyBidiA9IFFWQm94TGF5b3V0KHNlbGYuYmVhY29uX2dyb3VwKQogICAgICAgIHNlbGYuYmVhY29uc19saXN0ID0gUUxpc3RXaWRnZXQoKTsgYnYuYWRkV2lkZ2V0KHNlbGYuYmVhY29uc19saXN0KQogICAgICAgIHNlbGYubGFzdF90eF9sYWJlbCA9IFFMYWJlbCgiTGFzdCBUWDog4oCUIikKCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBub3QgaGFzYXR0cihzZWxmLCAnbGFzdF90eF90aW1lcicpOgogICAgICAgICAgICAgICAgc2VsZi5sYXN0X3R4X3RpbWVyID0gUVRpbWVyKHNlbGYpCiAgICAgICAgICAgICAgICBzZWxmLmxhc3RfdHhfdGltZXIuc2V0SW50ZXJ2YWwoMTUwMDApICAjIDE1cwogICAgICAgICAgICAgICAgc2VsZi5sYXN0X3R4X3RpbWVyLnRpbWVvdXQuY29ubmVjdChzZWxmLl91cGRhdGVfbGFzdF90eF9sYWJlbCkKICAgICAgICAgICAgICAgIHNlbGYubGFzdF90eF90aW1lci5zdGFydCgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIGJ2LmFkZFdpZGdldChzZWxmLmxhc3RfdHhfbGFiZWwpCiAgICAgICAgc2VsZi5yaWdodF9sYXlvdXQuYWRkV2lkZ2V0KHNlbGYuYmVhY29uX2dyb3VwLCAxKQoKICAgICAgICAjIEJ1aWxkIGxlZnQgdmlld3MKICAgICAgICBkaWFnX2xvZygnQnVpbGRpbmcgbWFpbiBsZWZ0IHZpZXcnKTsgc2VsZi5fYnVpbGRfbWFpbl9sZWZ0X3ZpZXcoKQogICAgICAgIGRpYWdfbG9nKCdCdWlsZGluZyBsaW5rbWFwIGxlZnQgdmlldycpOyBzZWxmLl9idWlsZF9saW5rbWFwX2xlZnRfdmlldygpCiAgICAgICAgc2VsZi5fc2hvd19tYWluX3ZpZXcoKQoKICAgICAgICAjIFN0YXR1cyBiYXIKICAgICAgICAjIEF1dG8tYmVhY29uOiB0aW1lciArIHJlc3RvcmUgc2V0dGluZ3Mgb3IgZGVmYXVsdCBlbmFibGUgKDE1IG1pbikgYWZ0ZXIgfjMgbWludXRlcwogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5iZWFjb25fdGltZXIgPSBRVGltZXIoc2VsZikKICAgICAgICAgICAgc2VsZi5iZWFjb25fdGltZXIudGltZW91dC5jb25uZWN0KHNlbGYuX3NlbmRfYmVhY29uKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHNlbGYuYmVhY29uX3RpbWVyID0gTm9uZQogICAgICAgIHRyeToKICAgICAgICAgICAgZW5hYmxlZCwgbWlucyA9IHNlbGYuX2xvYWRfYmVhY29uX2Zyb21fc2V0dGluZ3MoKQogICAgICAgICAgICBpZiBlbmFibGVkOgogICAgICAgICAgICAgICAgIyBSZXN0b3JlIHVzZXIncyBsYXN0IHNldHRpbmcKICAgICAgICAgICAgICAgIHNlbGYuX2VuYWJsZV9iZWFjb24obWlucywgaW1tZWRpYXRlPUZhbHNlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBBdXRvLWVuYWJsZWQgYnkgZGVmYXVsdCBhZnRlciAzIG1pbnV0ZXMgb2YgaWRsZQogICAgICAgICAgICAgICAgc2VsZi5hdXRvX2JlYWNvbl90aW1lciA9IFFUaW1lcihzZWxmKQogICAgICAgICAgICAgICAgc2VsZi5hdXRvX2JlYWNvbl90aW1lci5zZXRTaW5nbGVTaG90KFRydWUpCiAgICAgICAgICAgICAgICBkZWYgX2F1dG9fYXJtKCk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAjIFNlbmQgb25lIG5vdyBhbmQgYXJtIGV2ZXJ5IDE1IG1pbnV0ZXMKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fZW5hYmxlX2JlYWNvbigxNSwgaW1tZWRpYXRlPVRydWUpCiAgICAgICAgICAgICAgICAgICAgICAgICMgUGVyc2lzdCBzbyBuZXh0IGxhdW5jaCBpcyBlbmFibGVkIGJ5IGRlZmF1bHQKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2F2ZV9iZWFjb25fdG9fc2V0dGluZ3MoVHJ1ZSwgMTUpCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX3N0YXR1cygnQXV0by1iZWFjb24gYXJtZWQ6IGV2ZXJ5IDE1IG1pbicsIDI1MDApCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgc2VsZi5hdXRvX2JlYWNvbl90aW1lci50aW1lb3V0LmNvbm5lY3QoX2F1dG9fYXJtKQogICAgICAgICAgICAgICAgc2VsZi5hdXRvX2JlYWNvbl90aW1lci5zdGFydCgxODBfMDAwKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuYXV0b19iZWFjb25fdGltZXIgPSBRVGltZXIoc2VsZikKICAgICAgICAgICAgICAgIHNlbGYuYXV0b19iZWFjb25fdGltZXIuc2V0U2luZ2xlU2hvdChUcnVlKQogICAgICAgICAgICAgICAgc2VsZi5hdXRvX2JlYWNvbl90aW1lci50aW1lb3V0LmNvbm5lY3QobGFtYmRhOiBzZWxmLl9lbmFibGVfYmVhY29uKDE1LCBpbW1lZGlhdGU9VHJ1ZSkpCiAgICAgICAgICAgICAgICBzZWxmLmF1dG9fYmVhY29uX3RpbWVyLnN0YXJ0KDE4MF8wMDApCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgIyBHbG9iYWwgY29sb3JzCiAgICAgICAgc2VsZi5DT0xPUl9TRU5UID0gUUNvbG9yKCIjMDg4RjhGIik7IHNlbGYuQ09MT1JfUlggPSBRQ29sb3IoMjU1LDE2NSwwKQoKICAgICAgICAjIExvYWQgc2V0dGluZ3MgKyBtZXNzYWdlcyArIGJlYWNvbnMKICAgICAgICBkaWFnX2xvZygnTG9hZGluZyBzZXR0aW5ncycpOyBzZWxmLmxvYWRfc2V0dGluZ3MoKQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fYXBwbHlfdHhfY29sb3JfZm9yX3RoZW1lKGdldGF0dHIoc2VsZiwgJ3RoZW1lX25hbWUnLCAnJykpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHNlbGYuX3JlZmxlY3RfYWNrX3BhdXNlX2J1dHRvbigpCiAgICAgICAgZGlhZ19sb2coJ1VwZGF0aW5nIGJlYWNvbnMgbGlzdCcpOyBzZWxmLl9sb2FkX2xpbmtfZ3JhcGgoKQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fcHVyZ2Vfc2VsZl9mcm9tX2dyYXBoKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgc2VsZi5fcmVmcmVzaF9iZWFjb25zX3VpKCk7IHNlbGYudXBkYXRlX2JlYWNvbnNfbGlzdCgpCgogICAgICAgIHNlbGYuX3NldHVwX3RpbWVycygpCgogICAgIyAtLS0tLS0tLS0tIFVJIEJVSUxERVJTIC0tLS0tLS0tLS0KICAgICAgICAjIE9wZW4gd2luZG93IG1heGltaXplZCBmb3IgdGFibGV0L1BDCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnNob3dNYXhpbWl6ZWQoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX2J1aWxkX21haW5fbGVmdF92aWV3KHNlbGYpOgogICAgICAgIHNlbGYubWFpbl9sZWZ0ID0gUVdpZGdldCgpOyBzZWxmLmxlZnRfc3RhY2suYWRkV2lkZ2V0KHNlbGYubWFpbl9sZWZ0KQogICAgICAgIHNlbGYubGVmdF9sYXlvdXQgPSBRVkJveExheW91dChzZWxmLm1haW5fbGVmdCkKCiAgICAgICAgc2VsZi50b3Bfcm93ID0gUVdpZGdldCgpOyBzZWxmLnRvcF9yb3dfbGF5b3V0ID0gUUhCb3hMYXlvdXQoc2VsZi50b3Bfcm93KTsgc2VsZi50b3Bfcm93X2xheW91dC5zZXRDb250ZW50c01hcmdpbnMoMCwwLDAsMCk7IHNlbGYudG9wX3Jvd19sYXlvdXQuc2V0U3BhY2luZygxMikKICAgICAgICBzZWxmLmxlZnRfbGF5b3V0LmFkZFdpZGdldChzZWxmLnRvcF9yb3cpCgogICAgICAgIHNlbGYuX3VpX3NlcmlhbF9zZWN0aW9uKCkKICAgICAgICBzZWxmLl91aV9mbGVldF9zZWN0aW9uKCkKICAgICAgICBzZWxmLnRvcF9yb3dfbGF5b3V0LmFkZFN0cmV0Y2goMSkKCiAgICAgICAgc2VsZi5fdWlfbXlfcm93X3NlY3Rpb24oKQogICAgICAgIHNlbGYuX3VpX21lc3NhZ2VzX3NlY3Rpb24oKQogICAgICAgIHNlbGYuX3VpX3NlbmRfc2VjdGlvbigpCiAgICAgICAgc2VsZi5fdWlfZml4ZWRfZ3BzX3NlY3Rpb24oKQogICAgICAgIHNlbGYuX3VpX2ZpbGVfdXBsb2FkX3NlY3Rpb24oKQoKICAgIGRlZiBfYnVpbGRfbGlua21hcF9sZWZ0X3ZpZXcoc2VsZik6CiAgICAgICAgZGlhZ19sb2coJ0VudGVyIF9idWlsZF9saW5rbWFwX2xlZnRfdmlldycpCiAgICAgICAgc2VsZi5tYXBfbGVmdCA9IFFXaWRnZXQoKTsgc2VsZi5sZWZ0X3N0YWNrLmFkZFdpZGdldChzZWxmLm1hcF9sZWZ0KQogICAgICAgIHYgPSBRVkJveExheW91dChzZWxmLm1hcF9sZWZ0KQogICAgICAgIGRlZiBfZ2V0X215Y2FsbCgpOiByZXR1cm4gYmFzZV9jYWxsc2lnbihzZWxmLm15Y2FsbF9lZGl0LnRleHQoKSkgaWYgaGFzYXR0cihzZWxmLCJteWNhbGxfZWRpdCIpIGVsc2UgIk1ZQ0FMTCIKICAgICAgICBkZWYgX2dldF9saXZlKCk6CiAgICAgICAgICAgIGRhdGEgPSBsb2FkX2pzb24oImxpbmtfZ3JhcGguanNvbiIpIG9yIHt9CiAgICAgICAgICAgIHBhcmVudHMgPSB7fQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGRhdGEsIGRpY3QpOgogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoZGF0YS5nZXQoInBhcmVudHMiKSwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudHMgPSBkYXRhWyJwYXJlbnRzIl0KICAgICAgICAgICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZGF0YS5nZXQoImdyYXBoIiksIGRpY3QpOgogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnRzID0gZGF0YVsiZ3JhcGgiXQogICAgICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShkYXRhLmdldCgiYmVhY29ucyIpLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICAgICAgcGFyZW50cyA9IGRhdGFbImJlYWNvbnMiXQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgICMgaWYgZmxhdCBsaXN0LCBtYWtlIHRoZW0gZGlyZWN0IHBhcmVudHMgd2l0aCBubyBjaGlsZHJlbgogICAgICAgICAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKGRhdGEuZ2V0KCJub2RlcyIpLCBsaXN0KToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhcmVudHMgPSB7c3RyKHgpOiBbXSBmb3IgeCBpbiBkYXRhWyJub2RlcyJdIGlmIGlzaW5zdGFuY2UoeCwoc3RyLCkpfQogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKGRhdGEsIGxpc3QpOgogICAgICAgICAgICAgICAgICAgIHBhcmVudHMgPSB7c3RyKHgpOiBbXSBmb3IgeCBpbiBkYXRhIGlmIGlzaW5zdGFuY2UoeCwoc3RyLCkpfQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFyZW50cyA9IHt9CiAgICAgICAgICAgICMgbm9ybWFsaXplIGNoaWxkcmVuIChhY2NlcHQgc2NoZW1hczogbGlzdCwgeyJjaGlsZHJlbiI6IHsuLi59fSwgeyJsYXN0Ijp0cywiY2hpbGRyZW4iOnsuLi59fSkKICAgICAgICAgICAgY2hpbGRyZW4gPSB7fQogICAgICAgICAgICBmb3IgcCwgdiBpbiAocGFyZW50cy5pdGVtcygpIGlmIGlzaW5zdGFuY2UocGFyZW50cywgZGljdCkgZWxzZSBbXSk6CiAgICAgICAgICAgICAgICBpZiBpc2luc3RhbmNlKHYsIChsaXN0LHR1cGxlKSk6CiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW5bcF0gPSBbc3RyKHgpIGZvciB4IGluIHYgaWYgaXNpbnN0YW5jZSh4LChzdHIsKSldCiAgICAgICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UodiwgZGljdCk6CiAgICAgICAgICAgICAgICAgICAgdmMgPSB2LmdldCgiY2hpbGRyZW4iKSBpZiBpc2luc3RhbmNlKHYuZ2V0KCJjaGlsZHJlbiIpLCBkaWN0KSBlbHNlIHt9CiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW5bcF0gPSBbc3RyKGspIGZvciBrIGluIHZjLmtleXMoKSBpZiBpc2luc3RhbmNlKGssKHN0ciwpKV0KICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgY2hpbGRyZW5bcF0gPSBbXQogICAgICAgICAgICBlZGdlcyA9IFtdCiAgICAgICAgICAgIGZvciBwLCBraWRzIGluIGNoaWxkcmVuLml0ZW1zKCk6CiAgICAgICAgICAgICAgICBmb3IgYyBpbiBraWRzOgogICAgICAgICAgICAgICAgICAgIGVkZ2VzLmFwcGVuZCgocCwgYykpCiAgICAgICAgICAgIHJldHVybiBwYXJlbnRzLCBjaGlsZHJlbiwgZWRnZXMKICAgICAgICBzZWxmLmxpbmttYXAgPSBMaW5rTWFwV2lkZ2V0KF9nZXRfbXljYWxsLCBfZ2V0X2xpdmUsIGxhbWJkYTogc2VsZi50aGVtZV9tZ3IuY3VycmVudCBpZiBoYXNhdHRyKHNlbGYsJ3RoZW1lX21ncicpIGVsc2Uge30pCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmxpbmttYXAuZ2V0X21ldHJpYyA9IHNlbGYuX21ldHJpY19mcm9tX215Y2FsbAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICBzZWxmLmxpbmttYXBfc2Nyb2xsID0gUVNjcm9sbEFyZWEoc2VsZikKICAgICAgICBzZWxmLmxpbmttYXBfc2Nyb2xsLnNldFdpZGdldChzZWxmLmxpbmttYXApCiAgICAgICAgc2VsZi5saW5rbWFwX3Njcm9sbC5zZXRXaWRnZXRSZXNpemFibGUoVHJ1ZSkKICAgICAgICBzZWxmLmxpbmttYXBfc2Nyb2xsLnNldEZyYW1lU2hhcGUoUUZyYW1lLk5vRnJhbWUpCiAgICAgICAgc2VsZi5saW5rbWFwX3Njcm9sbC5zZXRTaXplUG9saWN5KFFTaXplUG9saWN5LkV4cGFuZGluZywgUVNpemVQb2xpY3kuRXhwYW5kaW5nKQogICAgICAgIHYuYWRkV2lkZ2V0KHNlbGYubGlua21hcF9zY3JvbGwsIDEpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBjdHJsID0gUVdpZGdldChzZWxmKQogICAgICAgICAgICBobCA9IFFIQm94TGF5b3V0KGN0cmwpCiAgICAgICAgICAgIGN0cmwuc2V0TGF5b3V0KGhsKQogICAgICAgICAgICBzZWxmLmJ0bl9yZWxvYWRfcG9zID0gUVB1c2hCdXR0b24oJ1JlbG9hZCBQb3NpdGlvbnMnLCBjdHJsKQogICAgICAgICAgICBzZWxmLmJ0bl9yZWxvYWRfZ3JhcGggPSBRUHVzaEJ1dHRvbignUmVsb2FkIExpbmtzJywgY3RybCkKICAgICAgICAgICAgc2VsZi5idG5fcmVsb2FkX3Bvcy5zZXRGaXhlZFdpZHRoKDE0MCkKICAgICAgICAgICAgc2VsZi5idG5fcmVsb2FkX2dyYXBoLnNldEZpeGVkV2lkdGgoMTIwKQogICAgICAgICAgICBobC5hZGRXaWRnZXQoc2VsZi5idG5fcmVsb2FkX3BvcykKICAgICAgICAgICAgaGwuYWRkV2lkZ2V0KHNlbGYuYnRuX3JlbG9hZF9ncmFwaCkKICAgICAgICAgICAgaGwuYWRkU3RyZXRjaCgxKQogICAgICAgICAgICAjIFNpemUgYnV0dG9ucyB0byBmaXQgdGV4dCArIHBhZGRpbmcKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZm0gPSBzZWxmLmZvbnRNZXRyaWNzKCkKICAgICAgICAgICAgICAgIHcxID0gZm0uaG9yaXpvbnRhbEFkdmFuY2Uoc2VsZi5idG5fcmVsb2FkX3Bvcy50ZXh0KCkpICsgMjQKICAgICAgICAgICAgICAgIHcyID0gZm0uaG9yaXpvbnRhbEFkdmFuY2Uoc2VsZi5idG5fcmVsb2FkX2dyYXBoLnRleHQoKSkgKyAyNAogICAgICAgICAgICAgICAgc2VsZi5idG5fcmVsb2FkX3Bvcy5zZXRGaXhlZFdpZHRoKHcxKQogICAgICAgICAgICAgICAgc2VsZi5idG5fcmVsb2FkX2dyYXBoLnNldEZpeGVkV2lkdGgodzIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICB2LmFkZFdpZGdldChjdHJsLCAwKQogICAgICAgICAgICBkZWYgX2RvX3JlbG9hZF9wb3NpdGlvbnMoKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9sb2FkX3Bvc2l0aW9ucygpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLmxpbmttYXAuZHJhd19ncmFwaCgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgZGVmIF9kb19yZWxvYWRfZ3JhcGgoKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9sb2FkX2xpbmtfZ3JhcGgoKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5saW5rbWFwLmRyYXdfZ3JhcGgoKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHNlbGYuYnRuX3JlbG9hZF9wb3MuY2xpY2tlZC5jb25uZWN0KF9kb19yZWxvYWRfcG9zaXRpb25zKQogICAgICAgICAgICBzZWxmLmJ0bl9yZWxvYWRfZ3JhcGguY2xpY2tlZC5jb25uZWN0KF9kb19yZWxvYWRfZ3JhcGgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgZGVmIF9zaG93X21haW5fdmlldyhzZWxmKTogc2VsZi5tYWluX2xlZnQuc2hvdygpOyBzZWxmLm1hcF9sZWZ0LmhpZGUoKQogICAgZGVmIF9zaG93X21hcF92aWV3KHNlbGYpOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5saW5rbWFwLnJlc2V0X3ZpZXcoKSAgIyBhdm9pZCBoZWF2eSByZWZpdDsganVzdCByZXNldAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fc3RhdHVzKGYiTWFwIHJlbmRlciBzdXBwcmVzc2VkOiB7ZX0iLCA1MDAwKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIHNlbGYubWFwX2xlZnQuc2hvdygpOyBzZWxmLm1haW5fbGVmdC5oaWRlKCkKCiAgICAjIC0tLS0tLS0tLS0gU2VjdGlvbnMgLS0tLS0tLS0tLQogICAgZGVmIF91aV9zZXJpYWxfc2VjdGlvbihzZWxmKToKICAgICAgICBncm91cCA9IFFHcm91cEJveCgiU2VyaWFsIFBvcnQiKTsgdiA9IFFWQm94TGF5b3V0KGdyb3VwKQogICAgICAgIHJvdyA9IFFIQm94TGF5b3V0KCkKICAgICAgICByb3cuYWRkV2lkZ2V0KFFMYWJlbCgiQ29ubmVjdGlvbjoiKSkKICAgICAgICBzZWxmLnNlcmlhbF9jb21ibyA9IFFDb21ib0JveCgpOyByb3cuYWRkV2lkZ2V0KHNlbGYuc2VyaWFsX2NvbWJvLCAxKQogICAgICAgIHNlbGYuY29ubmVjdF9idXR0b24gPSBRUHVzaEJ1dHRvbigiQ29ubmVjdCIpOyBzZWxmLmNvbm5lY3RfYnV0dG9uLmNsaWNrZWQuY29ubmVjdChzZWxmLl9vbl9jb25uZWN0X2NsaWNrKTsgcm93LmFkZFdpZGdldChzZWxmLmNvbm5lY3RfYnV0dG9uKQogICAgICAgIHJlZnJlc2hfYnRuID0gUVB1c2hCdXR0b24oIkRpc2Nvbm5lY3QiKTsgcmVmcmVzaF9idG4uY2xpY2tlZC5jb25uZWN0KHNlbGYucmVmcmVzaF9zZXJpYWxfcG9ydHMpOyByb3cuYWRkV2lkZ2V0KHJlZnJlc2hfYnRuKQogICAgICAgIAogICAgICAgIHJlZnJlc2hfYnRuLmNsaWNrZWQuY29ubmVjdChsYW1iZGE6IHNlbGYuX3N0eWxlX2Nvbm5lY3RfYnV0dG9uKCdub3JtYWwnKSkKICAgICAgICBkaXNjX2J0biA9IFFQdXNoQnV0dG9uKCJFeGl0Iik7IGRpc2NfYnRuLmNsaWNrZWQuY29ubmVjdChsYW1iZGE6IF9faW1wb3J0X18oJ1B5UXQ1LlF0V2lkZ2V0cycpLlF0V2lkZ2V0cy5RQXBwbGljYXRpb24uaW5zdGFuY2UoKS5xdWl0KCkpOyByb3cuYWRkV2lkZ2V0KGRpc2NfYnRuKQogICAgICAgIHYuYWRkTGF5b3V0KHJvdykKICAgICAgICByb3cyID0gUUhCb3hMYXlvdXQoKQogICAgICAgIHNlbGYua2lzc19jaGVjayA9IFFDaGVja0JveCgnS0lTUyBNb2RlIChtdXN0IGJlIHVuY2hlY2tlZCBmb3IgQ2hhdCknKTsgcm93Mi5hZGRXaWRnZXQoc2VsZi5raXNzX2NoZWNrKQogICAgICAgIHNlbGYua2lzc19jaGVjay5zZXRDaGVja2VkKFRydWUpCiAgICAgICAgZGVmIF9raXNzX3RvZ2dsZWQob246IGJvb2wpOgogICAgICAgICAgICBpZiBub3Qgc2VsZi5fc2VyaWFsX2lzX29wZW4oKToKICAgICAgICAgICAgICAgIFFNZXNzYWdlQm94Lndhcm5pbmcoc2VsZiwgJ0tJU1MgTW9kZScsICdTZWxlY3QgYW5kIGNvbm5lY3QgYSBDT00gcG9ydCBiZWZvcmUgdG9nZ2xpbmcgS0lTUyBtb2RlLicpCiAgICAgICAgICAgICAgICBzZWxmLmtpc3NfY2hlY2suYmxvY2tTaWduYWxzKFRydWUpCiAgICAgICAgICAgICAgICBzZWxmLmtpc3NfY2hlY2suc2V0Q2hlY2tlZChGYWxzZSkKICAgICAgICAgICAgICAgIHNlbGYua2lzc19jaGVjay5ibG9ja1NpZ25hbHMoRmFsc2UpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgb246CiAgICAgICAgICAgICAgICAgICAgIyBFTlRFUiBLSVNTOiBFU0MgKDI3KSwgdGhlbiAnQEsnCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc2VyaWFsX3dyaXRlX2J5dGVzKGJ5dGVzKFsyN10pKQogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NlcmlhbF93cml0ZV90ZXh0KCdASycpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3RhdHVzKCdTZW50IEVOVEVSIEtJU1MgKEVTQyBASyknKQogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAjIEVYSVQgS0lTUzogMTkyLDI1NSwxOTIsMTMKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXJpYWxfd3JpdGVfYnl0ZXMoYnl0ZXMoWzE5MiwyNTUsMTkyLDEzXSkpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5fc3RhdHVzKCdTZW50IEtJU1MgT0ZGICgxOTIsMjU1LDE5MiwxMyknKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICBRTWVzc2FnZUJveC5jcml0aWNhbChzZWxmLCAnS0lTUyBNb2RlJywgZidTZXJpYWwgd3JpdGUgZmFpbGVkOiB7ZX0nKQogICAgICAgICAgICAgICAgIyByZXZlcnQKICAgICAgICAgICAgICAgIHNlbGYua2lzc19jaGVjay5ibG9ja1NpZ25hbHMoVHJ1ZSkKICAgICAgICAgICAgICAgIHNlbGYua2lzc19jaGVjay5zZXRDaGVja2VkKG5vdCBvbikKICAgICAgICAgICAgICAgIHNlbGYua2lzc19jaGVjay5ibG9ja1NpZ25hbHMoRmFsc2UpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmtpc3NfY2hlY2sudG9nZ2xlZC5jb25uZWN0KF9raXNzX3RvZ2dsZWQpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJvdzIuYWRkU3RyZXRjaCgxKQogICAgICAgIHYuYWRkTGF5b3V0KHJvdzIpCiAgICAgICAgc2VsZi50b3Bfcm93X2xheW91dC5hZGRXaWRnZXQoZ3JvdXAsIDApCiAgICAgICAgc2VsZi5yZWZyZXNoX3NlcmlhbF9wb3J0cygpCgogICAgZGVmIF91aV9mbGVldF9zZWN0aW9uKHNlbGYpOgogICAgICAgIGcgPSBRR3JvdXBCb3goIkZsZWV0IE1hbmFnZXIiKTsgdiA9IFFWQm94TGF5b3V0KGcpCiAgICAgICAgcjAgPSBRSEJveExheW91dCgpOyBzZWxmLmZsZWV0X2VuYWJsZV9jaGVjayA9IFFDaGVja0JveCgiRW5hYmxlICh3aGl0ZWxpc3QpIik7IHIwLmFkZFdpZGdldChzZWxmLmZsZWV0X2VuYWJsZV9jaGVjayk7IHIwLmFkZFN0cmV0Y2goMSk7IHYuYWRkTGF5b3V0KHIwKQogICAgICAgIHNlbGYuYWN0aXZlX2ZsZWV0X2NvbWJvID0gUUNvbWJvQm94KCk7IHNlbGYuYWN0aXZlX2ZsZWV0X2NvbWJvLmFkZEl0ZW1zKHNlbGYuZmxlZXQubGlzdF9mbGVldF9uYW1lcygpKQogICAgICAgIHYuYWRkV2lkZ2V0KHNlbGYuYWN0aXZlX2ZsZWV0X2NvbWJvKQogICAgICAgICMgU2V0IGluaXRpYWwgdmFsdWUgd2l0aCBzaWduYWxzIGJsb2NrZWQKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuYWN0aXZlX2ZsZWV0X2NvbWJvLmJsb2NrU2lnbmFscyhUcnVlKQogICAgICAgICAgICBzZWxmLmFjdGl2ZV9mbGVldF9jb21iby5zZXRDdXJyZW50VGV4dChzZWxmLmZsZWV0LmFjdGl2ZV9mbGVldHNbMF0pCiAgICAgICAgICAgIHNlbGYuYWN0aXZlX2ZsZWV0X2NvbWJvLmJsb2NrU2lnbmFscyhGYWxzZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgIyBNZW1iZXIgbGlzdCBiZWZvcmUgY29ubmVjdGluZyBzaWduYWwgdG8gYXZvaWQgZWFybHkgY2FsbGJhY2sKICAgICAgICBzZWxmLm1lbWJlcl9saXN0ID0gUUxpc3RXaWRnZXQoKTsgdi5hZGRXaWRnZXQoc2VsZi5tZW1iZXJfbGlzdCk7IHNlbGYuX3BvcHVsYXRlX21lbWJlcl9saXN0KCkKICAgICAgICAjIE5vdyBjb25uZWN0IGNoYW5nZSBoYW5kbGVyCiAgICAgICAgc2VsZi5hY3RpdmVfZmxlZXRfY29tYm8uY3VycmVudFRleHRDaGFuZ2VkLmNvbm5lY3Qoc2VsZi5fb25fYWN0aXZlX2ZsZWV0X2NoYW5nZWQpCiAgICAgICAgcjEgPSBRSEJveExheW91dCgpCiAgICAgICAgYWRkX2dyb3VwX2J0biA9IFFQdXNoQnV0dG9uKCJBZGQgR3JvdXAiKTsgYWRkX2dyb3VwX2J0bi5jbGlja2VkLmNvbm5lY3Qoc2VsZi5hZGRfZmxlZXRfZ3JvdXApOyByMS5hZGRXaWRnZXQoYWRkX2dyb3VwX2J0bikKICAgICAgICBhZGRfbWVtYmVyX2J0biA9IFFQdXNoQnV0dG9uKCJBZGQgQ2FsbHNpZ24iKTsgYWRkX21lbWJlcl9idG4uY2xpY2tlZC5jb25uZWN0KHNlbGYuYWRkX2ZsZWV0X21lbWJlcik7IHIxLmFkZFdpZGdldChhZGRfbWVtYmVyX2J0bikKICAgICAgICBybV9tZW1iZXJfYnRuID0gUVB1c2hCdXR0b24oIlJlbW92ZSBDYWxsc2lnbiIpOyBybV9tZW1iZXJfYnRuLmNsaWNrZWQuY29ubmVjdChzZWxmLnJlbW92ZV9mbGVldF9tZW1iZXJfYnRuKTsgcjEuYWRkV2lkZ2V0KHJtX21lbWJlcl9idG4pOyByMS5hZGRTdHJldGNoKDEpCiAgICAgICAgdi5hZGRMYXlvdXQocjEpCiAgICAgICAgc2VsZi50b3Bfcm93X2xheW91dC5hZGRXaWRnZXQoZywgMSkKCiAgICAgICAgaW5jID0gUUdyb3VwQm94KCJJbmNvbWluZyBGaWxlcyIpOyBpbmN2ID0gUVZCb3hMYXlvdXQoaW5jKQogICAgICAgIHNlbGYuYXV0b19hY2NlcHRfZmlsZXMgPSBRQ2hlY2tCb3goIkF1dG8tYWNjZXB0IGZpbGVzIik7IGluY3YuYWRkV2lkZ2V0KHNlbGYuYXV0b19hY2NlcHRfZmlsZXMpCiAgICAgICAgIyBsb2FkIHBlcnNpc3RlZCBhdXRvLWFjY2VwdAogICAgICAgIHRyeToKICAgICAgICAgICAgc3QgPSBsb2FkX2pzb24oInNldHRpbmdzLmpzb24iKSBvciB7fQogICAgICAgICAgICBzZWxmLmF1dG9fYWNjZXB0X2ZpbGVzLnNldENoZWNrZWQoYm9vbChzdC5nZXQoImF1dG9fYWNjZXB0X2ZpbGVzIiwgRmFsc2UpKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgZGVmIF9wZXJzaXN0X2F1dG9fYWNjZXB0KG9uKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc3QyID0gbG9hZF9qc29uKCJzZXR0aW5ncy5qc29uIikgb3Ige30KICAgICAgICAgICAgICAgIHN0MlsiYXV0b19hY2NlcHRfZmlsZXMiXSA9IGJvb2wob24pCiAgICAgICAgICAgICAgICBzYXZlX2pzb24oInNldHRpbmdzLmpzb24iLCBzdDIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICB0cnk6IHNlbGYuYXV0b19hY2NlcHRfZmlsZXMudG9nZ2xlZC5jb25uZWN0KF9wZXJzaXN0X2F1dG9fYWNjZXB0KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKCiAgICAgICAgc2VsZi5pbmNvbWluZ19saXN0ID0gUUxpc3RXaWRnZXQoKTsgaW5jdi5hZGRXaWRnZXQoc2VsZi5pbmNvbWluZ19saXN0KQogICAgICAgIGJyID0gUUhCb3hMYXlvdXQoKTsgYWNjID0gUVB1c2hCdXR0b24oIkFjY2VwdCIpOyBkZWMgPSBRUHVzaEJ1dHRvbigiRGVjbGluZSIpOyByc3QgPSBRUHVzaEJ1dHRvbigiUmVzZXQgV2luZG93IikKICAgICAgICBhY2MuY2xpY2tlZC5jb25uZWN0KHNlbGYuX2luY29taW5nX2FjY2VwdF9zZWxlY3RlZCk7IGRlYy5jbGlja2VkLmNvbm5lY3Qoc2VsZi5faW5jb21pbmdfZGVjbGluZV9zZWxlY3RlZCk7IHJzdC5jbGlja2VkLmNvbm5lY3Qoc2VsZi5faW5jb21pbmdfcmVzZXRfd2luZG93KQogICAgICAgIGJyLmFkZFdpZGdldChhY2MpOyBici5hZGRXaWRnZXQoZGVjKTsgYnIuYWRkU3RyZXRjaCgxKTsgYnIuYWRkV2lkZ2V0KHJzdCk7IGluY3YuYWRkTGF5b3V0KGJyKQogICAgICAgIHNlbGYudG9wX3Jvd19sYXlvdXQuYWRkV2lkZ2V0KGluYywgMikKCiAgICBkZWYgX3VpX215X3Jvd19zZWN0aW9uKHNlbGYpOgogICAgICAgIHJvdyA9IFFXaWRnZXQoKTsgaCA9IFFIQm94TGF5b3V0KHJvdyk7IGguc2V0Q29udGVudHNNYXJnaW5zKDAsMCwwLDApCiAgICAgICAgaC5hZGRXaWRnZXQoUUxhYmVsKCJUYXJnZXQiKSkKICAgICAgICBzZWxmLnRvX2VkaXQgPSBRTGluZUVkaXQoKTsgc2VsZi5fZm9yY2VfY2FsbHNpZ25fbGluZWVkaXQoc2VsZi50b19lZGl0KTsgaC5hZGRXaWRnZXQoc2VsZi50b19lZGl0KQojIChyZW1vdmVkIGR1cGxpY2F0ZSBNb25pdG9yIEFsbCBjaGVja2JveCBjcmVhdGlvbikKCgogICAgICAgIGguYWRkU3BhY2luZygxMik7IGguYWRkV2lkZ2V0KFFMYWJlbCgiRnJvbSIpKQogICAgICAgIHNlbGYubXljYWxsX2VkaXQgPSBRTGluZUVkaXQoKTsgc2VsZi5fZm9yY2VfY2FsbHNpZ25fbGluZWVkaXQoc2VsZi5teWNhbGxfZWRpdCk7IGguYWRkV2lkZ2V0KHNlbGYubXljYWxsX2VkaXQpCiAgICAgICAgaC5hZGRTdHJldGNoKDEpCiAgICAgICAgc2VsZi5sZWZ0X2xheW91dC5hZGRXaWRnZXQocm93KQoKICAgIGRlZiBfdWlfbWVzc2FnZXNfc2VjdGlvbihzZWxmKToKICAgICAgICBnID0gUUdyb3VwQm94KCJNZXNzYWdlcyIpOyB2ID0gUVZCb3hMYXlvdXQoZykKICAgICAgICBzZWxmLm1lc3NhZ2VzX2xpc3QgPSBRTGlzdFdpZGdldCgpOyB2LmFkZFdpZGdldChzZWxmLm1lc3NhZ2VzX2xpc3QsIDEwKQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fZW5zdXJlX3N0b3JlX3BhdGhzKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgc2VsZi5fbGFzdF9oZWFkZXJfZGF0ZV90b3AgPSBOb25lCiAgICAgICAgY2xlYXJfYnRuID0gUVB1c2hCdXR0b24oIiAgQ2xlYXIgTWVzc2FnZXMgICIpOyBjbGVhcl9idG4uY2xpY2tlZC5jb25uZWN0KHNlbGYuY2xlYXJfcmVjZWl2ZV93aW5kb3cpOyB2LmFkZFdpZGdldChjbGVhcl9idG4pCiAgICAgICAgc2VsZi5sZWZ0X2xheW91dC5hZGRXaWRnZXQoZywgMTApCgogICAgZGVmIF91aV9zZW5kX3NlY3Rpb24oc2VsZik6CiAgICAgICAgZyA9IFFHcm91cEJveCgiU2VuZCBNZXNzYWdlIik7IGggPSBRSEJveExheW91dChnKQogICAgICAgIHNlbGYuc2VuZF9lZGl0ID0gUVRleHRFZGl0KCk7IGZtID0gUUZvbnRNZXRyaWNzKHNlbGYuc2VuZF9lZGl0LmZvbnQoKSk7IHNlbGYuc2VuZF9lZGl0LnNldE1pbmltdW1IZWlnaHQoZm0ubGluZVNwYWNpbmcoKSo0KzIwKTsgc2VsZi5zZW5kX2VkaXQuc2V0U2l6ZVBvbGljeShRU2l6ZVBvbGljeS5FeHBhbmRpbmcsIFFTaXplUG9saWN5LkZpeGVkKTsgaC5hZGRXaWRnZXQoc2VsZi5zZW5kX2VkaXQsIDEpCiAgICAgICAgCiAgICAgICAgIyAtLS0gY29tcGFjdCBzZW5kIGZpZWxkICh+MS41IGxpbmVzKSAtLS0KICAgICAgICB0cnk6CiAgICAgICAgICAgIF9mbSA9IFFGb250TWV0cmljcyhzZWxmLnNlbmRfZWRpdC5mb250KCkpCiAgICAgICAgICAgIF9saW5lID0gX2ZtLmxpbmVTcGFjaW5nKCkKICAgICAgICAgICAgX3BhZCA9IHNlbGYuc2VuZF9lZGl0LmNvbnRlbnRzTWFyZ2lucygpLnRvcCgpICsgc2VsZi5zZW5kX2VkaXQuY29udGVudHNNYXJnaW5zKCkuYm90dG9tKCkKICAgICAgICAgICAgX2ZyYW1lID0gaW50KGdldGF0dHIoc2VsZi5zZW5kX2VkaXQsICdmcmFtZVdpZHRoJywgbGFtYmRhOiAwKSgpKSAqIDIKICAgICAgICAgICAgX2ggPSBtYXgoMjQsIGludChfbGluZSAqIDEuNSArIF9wYWQgKyBfZnJhbWUpKQogICAgICAgICAgICBzZWxmLnNlbmRfZWRpdC5zZXRGaXhlZEhlaWdodChfaCkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5zZW5kX2VkaXQuc2V0VmVydGljYWxTY3JvbGxCYXJQb2xpY3koUXQuU2Nyb2xsQmFyQWx3YXlzT2ZmKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBzZWxmLnNlbmRfZWRpdC5zZXRTaXplUG9saWN5KFFTaXplUG9saWN5LkV4cGFuZGluZywgUVNpemVQb2xpY3kuRml4ZWQpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIGNvbCA9IFFWQm94TGF5b3V0KCk7IHNlbmRfYnRuID0gUVB1c2hCdXR0b24oIlNFTkQiKTsgc2VuZF9idG4uY2xpY2tlZC5jb25uZWN0KHNlbGYuc2VuZF9tZXNzYWdlKTsgY29sLmFkZFdpZGdldChzZW5kX2J0biwgYWxpZ25tZW50PVF0LkFsaWduUmlnaHQpCiAgICAgICAgY29sLmFkZFN0cmV0Y2goMSk7IGNvbC5hZGRTdHJldGNoKDEpOyBoLmFkZExheW91dChjb2wsIDApCiAgICAgICAgc2VsZi5sZWZ0X2xheW91dC5hZGRXaWRnZXQoZywgMSkKCiAgICBkZWYgX3VpX2ZpeGVkX2dwc19zZWN0aW9uKHNlbGYpOgogICAgICAgIGcgPSBRR3JvdXBCb3goIkdQUyAoZGVjaW1hbCBkZWdyZWVzKSIpOyBoID0gUUhCb3hMYXlvdXQoZykKICAgICAgICBzZWxmLmZpeGVkX2xhdF9lZGl0ID0gUUxpbmVFZGl0KCk7IHNlbGYuZml4ZWRfbG9uX2VkaXQgPSBRTGluZUVkaXQoKQogICAgICAgIGguYWRkV2lkZ2V0KFFMYWJlbCgiTGF0OiIpKTsgaC5hZGRXaWRnZXQoc2VsZi5maXhlZF9sYXRfZWRpdCk7IGguYWRkV2lkZ2V0KFFMYWJlbCgiTG9uOiIpKTsgaC5hZGRXaWRnZXQoc2VsZi5maXhlZF9sb25fZWRpdCkKICAgICAgICAjIHdpZHRocyB+MzBjaAogICAgICAgIHRyeToKICAgICAgICAgICAgZm0gPSBRRm9udE1ldHJpY3Moc2VsZi5maXhlZF9sYXRfZWRpdC5mb250KCkpCiAgICAgICAgICAgIHczMCA9IGludChmbS5hdmVyYWdlQ2hhcldpZHRoKCkqMzAgKyA4KQogICAgICAgICAgICBmb3IgX2xlIGluIChzZWxmLmZpeGVkX2xhdF9lZGl0LCBzZWxmLmZpeGVkX2xvbl9lZGl0KToKICAgICAgICAgICAgICAgIF9sZS5zZXRNYXhMZW5ndGgoMTApOyBfbGUuc2V0Rml4ZWRXaWR0aCh3MzApOyBfbGUuc2V0U2l6ZVBvbGljeShRU2l6ZVBvbGljeS5GaXhlZCwgUVNpemVQb2xpY3kuUHJlZmVycmVkKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICBzZWxmLnNlbmRfZml4X2J0biA9IFFQdXNoQnV0dG9uKCIgIFNFTkQgUE9TICAiKTsgc2VsZi5zZW5kX2ZpeF9idG4uc2V0U2l6ZVBvbGljeShRU2l6ZVBvbGljeS5GaXhlZCwgUVNpemVQb2xpY3kuUHJlZmVycmVkKQogICAgICAgIHNlbGYuc2VuZF9maXhfYnRuLmNsaWNrZWQuY29ubmVjdChzZWxmLnNhdmVfZml4ZWRfZ3BzKQogICAgICAgIGguYWRkV2lkZ2V0KHNlbGYuc2VuZF9maXhfYnRuKQogICAgICAgICMgbGVmdC1qdXN0aWZ5IGdyb3VwCiAgICAgICAgd3JhcCA9IFFXaWRnZXQoKTsgaGIgPSBRSEJveExheW91dCh3cmFwKTsgaGIuc2V0Q29udGVudHNNYXJnaW5zKDAsMCwwLDApOyBoYi5hZGRXaWRnZXQoZyk7IGhiLmFkZFN0cmV0Y2goMSkKICAgICAgICBzZWxmLmxlZnRfbGF5b3V0LmFkZFdpZGdldCh3cmFwKQoKICAgIGRlZiBfdWlfZmlsZV91cGxvYWRfc2VjdGlvbihzZWxmKToKICAgICAgICBnID0gUUdyb3VwQm94KCJGaWxlIFVwbG9hZCIpCiAgICAgICAgaCA9IFFIQm94TGF5b3V0KGcpCiAgICAgICAgc2VsZi51cGxvYWRfYnRuID0gUVB1c2hCdXR0b24oIiAgVXBsb2FkICAiKTsgc2VsZi51cGxvYWRfYnRuLnNldFNpemVQb2xpY3koUVNpemVQb2xpY3kuRml4ZWQsIFFTaXplUG9saWN5LlByZWZlcnJlZCkKICAgICAgICBzZWxmLnVwbG9hZF9idG4uY2xpY2tlZC5jb25uZWN0KHNlbGYuY2hvb3NlX2ZpbGVfdG9fc2VuZCk7IGguYWRkV2lkZ2V0KHNlbGYudXBsb2FkX2J0bikKICAgICAgICBzZWxmLmZpbGVfcGF0aF9lZGl0ID0gUUxpbmVFZGl0KCk7IHNlbGYuZmlsZV9wYXRoX2VkaXQuc2V0UmVhZE9ubHkoVHJ1ZSk7IGguYWRkV2lkZ2V0KHNlbGYuZmlsZV9wYXRoX2VkaXQpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmbSA9IFFGb250TWV0cmljcyhzZWxmLmZpbGVfcGF0aF9lZGl0LmZvbnQoKSk7IHc2MCA9IGludChmbS5hdmVyYWdlQ2hhcldpZHRoKCkqNjAgKyAxMikKICAgICAgICAgICAgc2VsZi5maWxlX3BhdGhfZWRpdC5zZXRGaXhlZFdpZHRoKHc2MCk7IHNlbGYuZmlsZV9wYXRoX2VkaXQuc2V0U2l6ZVBvbGljeShRU2l6ZVBvbGljeS5GaXhlZCwgUVNpemVQb2xpY3kuUHJlZmVycmVkKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICBzZWxmLnNlbmRfZmlsZV9idG4gPSBRUHVzaEJ1dHRvbigiICBTZW5kIEZpbGUgICIpOyBzZWxmLnNlbmRfZmlsZV9idG4uc2V0U2l6ZVBvbGljeShRU2l6ZVBvbGljeS5GaXhlZCwgUVNpemVQb2xpY3kuUHJlZmVycmVkKQogICAgICAgIHNlbGYuc2VuZF9maWxlX2J0bi5jbGlja2VkLmNvbm5lY3Qoc2VsZi5zZW5kX3NlbGVjdGVkX2ZpbGUpOyBoLmFkZFdpZGdldChzZWxmLnNlbmRfZmlsZV9idG4pCiAgICAgICAgc2VsZi5yZW1vdGVfbGFiZWwgPSBRTGFiZWwoIlJlbW90ZTog4oCUIik7IGguYWRkV2lkZ2V0KHNlbGYucmVtb3RlX2xhYmVsKQogICAgICAgICMgbGVmdC1qdXN0aWZ5CiAgICAgICAgd3JhcDIgPSBRV2lkZ2V0KCk7IGhiMiA9IFFIQm94TGF5b3V0KHdyYXAyKTsgaGIyLnNldENvbnRlbnRzTWFyZ2lucygwLDAsMCwwKTsgaGIyLmFkZFdpZGdldChnKTsgaGIyLmFkZFN0cmV0Y2goMSkKICAgICAgICBzZWxmLmxlZnRfbGF5b3V0LmFkZFdpZGdldCh3cmFwMikKCiAgICAjIC0tLS0tLS0tLS0gSGVscGVycyAvIHBlcnNpc3RlbmNlIC0tLS0tLS0tLS0KICAgIGRlZiBfZm9yY2VfY2FsbHNpZ25fbGluZWVkaXQoc2VsZiwgbGUpOgogICAgICAgIGxlLnNldEFsaWdubWVudChRdC5BbGlnbkxlZnQgfCBRdC5BbGlnblZDZW50ZXIpCiAgICAgICAgIyBBY2NlcHQgbG93ZXJjYXNlIHRvbywgZGlnaXRzLCAvIGFuZCAtIDsga2VlcCBtYXggMTAgY2hhcnMKICAgICAgICByeCA9IFFSZWd1bGFyRXhwcmVzc2lvbihyIl5bQS1aYS16MC05Ly1dezAsMTB9JCIpCiAgICAgICAgbGUuc2V0VmFsaWRhdG9yKFFSZWd1bGFyRXhwcmVzc2lvblZhbGlkYXRvcihyeCwgbGUpKQogICAgICAgIGxlLnNldE1heExlbmd0aCgxMCkKICAgICAgICAjIEF1dG8tdXBwZXJjYXNlIG9uIHVzZXIgZWRpdHMKICAgICAgICBkZWYgX3RvX3VwcGVyKF8pOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBjdXIgPSBsZS5jdXJzb3JQb3NpdGlvbigpCiAgICAgICAgICAgICAgICB0eHQgPSBsZS50ZXh0KCkKICAgICAgICAgICAgICAgIHVwID0gdHh0LnVwcGVyKCkKICAgICAgICAgICAgICAgIGlmIHVwICE9IHR4dDoKICAgICAgICAgICAgICAgICAgICBsZS5ibG9ja1NpZ25hbHMoVHJ1ZSkKICAgICAgICAgICAgICAgICAgICBsZS5zZXRUZXh0KHVwKQogICAgICAgICAgICAgICAgICAgIGxlLmJsb2NrU2lnbmFscyhGYWxzZSkKICAgICAgICAgICAgICAgICAgICBsZS5zZXRDdXJzb3JQb3NpdGlvbihjdXIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBsZS50ZXh0RWRpdGVkLmNvbm5lY3QoX3RvX3VwcGVyKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgcmVmcmVzaF9zZXJpYWxfcG9ydHMoc2VsZik6CiAgICAgICAgcG9ydHMgPSBbZiJDT017aX0iIGZvciBpIGluIHJhbmdlKDEsIDE3KV0gaWYgb3MubmFtZSA9PSAibnQiIGVsc2UgWyIvZGV2L3R0eVMwIiwiL2Rldi90dHlVU0IwIl0KICAgICAgICBzZWxmLnNlcmlhbF9jb21iby5jbGVhcigpOyBzZWxmLnNlcmlhbF9jb21iby5hZGRJdGVtcyhwb3J0cykKCiAgICBkZWYgdG9nZ2xlX3NlcmlhbChzZWxmKToKICAgICAgICAKICAgICAgICBpZiBzZWxmLmNvbm5lY3RfYnV0dG9uLnRleHQoKSA9PSAnQ29ubmVjdCc6CiAgICAgICAgICAgIHBvcnQgPSBzZWxmLnNlcmlhbF9jb21iby5jdXJyZW50VGV4dCgpLnN0cmlwKCkKICAgICAgICAgICAgaWYgbm90IHBvcnQ6CiAgICAgICAgICAgICAgICBRTWVzc2FnZUJveC53YXJuaW5nKHNlbGYsICdTZXJpYWwnLCAnUGxlYXNlIHNlbGVjdCBhIENPTSBwb3J0IGZpcnN0LicpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgaWYgc2VsZi5fb3Blbl9zZXJpYWwocG9ydCwgZ2V0YXR0cihzZWxmLCAnX3NlcmlhbF9iYXVkX2RlZmF1bHQnLCAzODQwMCkpOgogICAgICAgICAgICAgICAgc2VsZi5jb25uZWN0X2J1dHRvbi5zZXRUZXh0KCJDb25uZWN0IikKICAgICAgICAgICAgICAgIHNlbGYuX3N0YXR1cygnQ29ubmVjdGVkJykKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zYXZlX3NlcmlhbF90b19zZXR0aW5ncyhwb3J0LCBnZXRhdHRyKHNlbGYsICdfc2VyaWFsX2JhdWRfZGVmYXVsdCcsIDM4NDAwKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYucmVhZGVyX3RocmVhZCA9IFNlcmlhbFJlYWRlclRocmVhZChzZWxmKQogICAgICAgICAgICAgICAgICAgIHNlbGYucmVhZGVyX3RocmVhZC5saW5lX3JlY2VpdmVkLmNvbm5lY3Qoc2VsZi5fb25fc2VyaWFsX3RocmVhZF9saW5lKQogICAgICAgICAgICAgICAgICAgIHNlbGYucmVhZGVyX3RocmVhZC5zdGFydCgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLmRpc2Nvbm5lY3Rfc2VyaWFsKCkKCiAgICBkZWYgZGlzY29ubmVjdF9zZXJpYWwoc2VsZik6CiAgICAgICAgCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdyZWFkZXJfdGhyZWFkJykgYW5kIHNlbGYucmVhZGVyX3RocmVhZCBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYucmVhZGVyX3RocmVhZC5zdG9wKCkKICAgICAgICAgICAgICAgIHNlbGYucmVhZGVyX3RocmVhZC53YWl0KDUwMCkKICAgICAgICAgICAgICAgIHNlbGYucmVhZGVyX3RocmVhZCA9IE5vbmUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgc2VsZi5fY2xvc2Vfc2VyaWFsKCkKICAgICAgICBzZWxmLmNvbm5lY3RfYnV0dG9uLnNldFRleHQoJ0Nvbm5lY3QnKQogICAgICAgIHNlbGYuX3N0YXR1cygnRGlzY29ubmVjdGVkJykKCiAgICBkZWYgX3N5bmNfcmVtb3RlX2xhYmVsKHNlbGYsICpfKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRndCA9IGJhc2VfY2FsbHNpZ24oc2VsZi50b19lZGl0LnRleHQoKS5zdHJpcCgpLnVwcGVyKCkpIGlmIGhhc2F0dHIoc2VsZiwidG9fZWRpdCIpIGVsc2UgIiIKICAgICAgICAgICAgc2VsZi5yZW1vdGVfbGFiZWwuc2V0VGV4dChmIlJlbW90ZToge3RndCBvciAn4oCUJ30iKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKCiAgICBkZWYgbG9hZF9zZXR0aW5ncyhzZWxmKToKICAgICAgICBkaWFnX2xvZygnRW50ZXIgbG9hZF9zZXR0aW5ncycpCiAgICAgICAgc3QgPSBsb2FkX2pzb24oInNldHRpbmdzLmpzb24iKSBvciB7fQogICAgICAgIHNlbGYubXljYWxsX2VkaXQuc2V0VGV4dChzdC5nZXQoIm15Y2FsbCIsIiIpKQogICAgICAgIHNlbGYudG9fZWRpdC5zZXRUZXh0KCIiKQogICAgICAgICMgc2NydWIgbGVnYWN5IHRhcmdldCBrZXkgaWYgcHJlc2VudAogICAgICAgIGlmICJ0YXJnZXQiIGluIHN0OgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkZWwgc3RbInRhcmdldCJdCiAgICAgICAgICAgICAgICBzYXZlX2pzb24oInNldHRpbmdzLmpzb24iLCBzdCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAjIFRoZW1lIGxvYWQKICAgICAgICB0biA9IHN0LmdldCgidGhlbWUiLCAiTGlnaHQiKQogICAgICAgICMgS0lTUyBtb2RlOiBubyBwZXJzaXN0ZW5jZSAocmVxdWlyZXMgbGl2ZSBzZXJpYWwpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZHggPSBzZWxmLnRoZW1lX2NvbWJvLmZpbmRUZXh0KHRuKTsgCiAgICAgICAgICAgIGlmIGlkeCA+PSAwOiBzZWxmLnRoZW1lX2NvbWJvLnNldEN1cnJlbnRJbmRleChpZHgpCiAgICAgICAgICAgIHNlbGYuYXBwbHlfdGhlbWUodG4pCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICMgUmVtb3RlIGxhYmVsCiAgICAgICAgc2VsZi5fc3luY19yZW1vdGVfbGFiZWwoKQogICAgICAgIHRyeTogc2VsZi50b19lZGl0LnRleHRDaGFuZ2VkLmNvbm5lY3Qoc2VsZi5fc3luY19yZW1vdGVfbGFiZWwpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICMgUGVyc2lzdCBGcm9tIChteWNhbGwpIGltbWVkaWF0ZWx5IHdoZW4gY2hhbmdlZAogICAgICAgIGRlZiBfcGVyc2lzdF9teWNhbGxfY2hhbmdlKF90eHQ6c3RyKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc3QyID0gbG9hZF9qc29uKCJzZXR0aW5ncy5qc29uIikgb3Ige30KICAgICAgICAgICAgICAgIHN0MlsibXljYWxsIl0gPSBzZWxmLm15Y2FsbF9lZGl0LnRleHQoKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICAgICAgICAgIHNhdmVfanNvbigic2V0dGluZ3MuanNvbiIsIHN0MikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYubXljYWxsX2VkaXQudGV4dENoYW5nZWQuY29ubmVjdChfcGVyc2lzdF9teWNhbGxfY2hhbmdlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICAjIEZpeGVkIEdQUyBsb2FkCiAgICAgICAgZ3BzID0gbG9hZF9qc29uKCJmaXhlZF9ncHMuanNvbiIpIG9yIHt9CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmZpeGVkX2xhdF9lZGl0LnNldFRleHQoc3RyKGdwcy5nZXQoImxhdCIsIiIpKSkKICAgICAgICAgICAgc2VsZi5maXhlZF9sb25fZWRpdC5zZXRUZXh0KHN0cihncHMuZ2V0KCJsb24iLCIiKSkpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICMgTG9hZCBtZXNzYWdlcwogICAgICAgIHNlbGYuX2xvYWRfbWVzc2FnZXNfZnJvbV9zdG9yZSgpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBhcHAgPSBRQXBwbGljYXRpb24uaW5zdGFuY2UoKQogICAgICAgICAgICBmcm9tIFB5UXQ1LlF0R3VpIGltcG9ydCBRRm9udAogICAgICAgICAgICBhcHAuc2V0Rm9udChRRm9udCgnVlQzMjMnLCBnZXRhdHRyKHNlbGYsJ19mb250X3B0JywxMikpKQogICAgICAgICAgICBzZWxmLnNldEZvbnQoUUZvbnQoJ1ZUMzIzJywgZ2V0YXR0cihzZWxmLCdfZm9udF9wdCcsMTIpKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgIyBMb2FkL3BlcnNpc3Qgc2VyaWFsIGRlZmF1bHQgYmF1ZD0zODQwMCBpZiBub25lIHNldAogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fbG9hZF9zZXJpYWxfZnJvbV9zZXR0aW5ncygpCiAgICAgICAgICAgIGlmIG5vdCBnZXRhdHRyKHNlbGYsICdfc2VyaWFsX2JhdWRfZGVmYXVsdCcsIE5vbmUpOgogICAgICAgICAgICAgICAgc2VsZi5fc2VyaWFsX2JhdWRfZGVmYXVsdCA9IDM4NDAwCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgc2VsZi5fc2VyaWFsX2JhdWRfZGVmYXVsdCA9IDM4NDAwCgogICAgZGVmIHNhdmVfc2V0dGluZ3Moc2VsZik6CiAgICAgICAgc3QgPSB7CiAgICAgICAgICAgICJteWNhbGwiOiBzZWxmLm15Y2FsbF9lZGl0LnRleHQoKS5zdHJpcCgpLnVwcGVyKCksCiAgICAgICAgICAgICJiZWFjb25fbWludXRlcyI6IHNlbGYuYmVhY29uX21pbnV0ZXMKICAgICAgICB9CiAgICAgICAgc3RbImF1dG9fYWNjZXB0X2ZpbGVzIl0gPSBib29sKHNlbGYuYXV0b19hY2NlcHRfZmlsZXMuaXNDaGVja2VkKCkpIGlmIGhhc2F0dHIoc2VsZiwiYXV0b19hY2NlcHRfZmlsZXMiKSBlbHNlIEZhbHNlCiAgICAgICAgc3RbInRoZW1lIl0gPSBzZWxmLnRoZW1lX2NvbWJvLmN1cnJlbnRUZXh0KCkgaWYgaGFzYXR0cihzZWxmLCJ0aGVtZV9jb21ibyIpIGVsc2UgIkxpZ2h0IgogICAgICAgICMgS0lTUyBub3QgcGVyc2lzdGVkCiAgICAgICAgc2F2ZV9qc29uKCJzZXR0aW5ncy5qc29uIiwgc3QpCgogICAgZGVmIGFwcGx5X3RoZW1lKHNlbGYsIG5hbWU6IHN0cik6CiAgICAgICAgc2VsZi50aGVtZV9tZ3IuYXBwbHkoc2VsZiwgbmFtZSkKCiAgICAgICAgIyAtLS0gSFVEIChzdGF0dXMgYmFyKSB0ZXh0IGNvbG9yIHBlciB0aGVtZSAtLS0KICAgICAgICB0cnk6CiAgICAgICAgICAgIHNiID0gTm9uZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzYiA9IHNlbGYuc3RhdHVzX2JhciBpZiBoYXNhdHRyKHNlbGYsICJzdGF0dXNfYmFyIikgZWxzZSBzZWxmLnN0YXR1c0JhcigpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBzYiA9IGdldGF0dHIoc2VsZiwgInN0YXR1c19iYXIiLCBOb25lKQogICAgICAgICAgICBpZiBzYjoKICAgICAgICAgICAgICAgIHRoZW1lX25hbWUgPSAobmFtZSBvciAiIikubG93ZXIoKQogICAgICAgICAgICAgICAgaWYgImRhcmsgZ3JlZW4iIGluIHRoZW1lX25hbWU6CiAgICAgICAgICAgICAgICAgICAgc2Iuc2V0U3R5bGVTaGVldCgiY29sb3I6IGxpbWU7IikKICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgIyBmYWxsIGJhY2sgdG8gdGhlbWUgY29sb3Igb3IgZGVmYXVsdCBibGFjawogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgYyA9IGdldGF0dHIoc2VsZiwgInRoZW1lX21nciIsIE5vbmUpLmNvbG9yKCJzdGF0dXNfdGV4dCIsICIjMDAwMDAwIikKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICBjID0gIiMwMDAwMDAiCiAgICAgICAgICAgICAgICAgICAgc2Iuc2V0U3R5bGVTaGVldChmImNvbG9yOiB7Y307IikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgIyAtLS0gZW5kIEhVRCB0aGVtZSAtLS0KICAgIAogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnbGlua21hcCcpIGFuZCBoYXNhdHRyKHNlbGYubGlua21hcCwgJ3ZpZXcnKToKICAgICAgICAgICAgICAgIGJnID0gUUNvbG9yKHNlbGYudGhlbWVfbWdyLmNvbG9yKCdwYW5lbF9iZycsICcjZjVmNWY1JykpCiAgICAgICAgICAgICAgICBzZWxmLmxpbmttYXAudmlldy5zZXRCYWNrZ3JvdW5kQnJ1c2goUUJydXNoKGJnKSkKICAgICAgICAgICAgICAgIHNlbGYubGlua21hcC5kcmF3X2dyYXBoKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgIyBwZXJzaXN0IGltbWVkaWF0ZWx5CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdCA9IGxvYWRfanNvbigic2V0dGluZ3MuanNvbiIpIG9yIHt9CiAgICAgICAgICAgIHN0WyJ0aGVtZSJdID0gbmFtZQogICAgICAgICAgICBzYXZlX2pzb24oInNldHRpbmdzLmpzb24iLCBzdCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCgogICAgZGVmIF9zZXRfYWNrX3BhdXNlKHNlbGYsIHNlY29uZHMsIGJ0bik6CiAgICAgICAgc2VsZi5tYW51YWxfYWNrX3BhdXNlID0gaW50KHNlY29uZHMpCiAgICAgICAgc2VsZi5fcmVmbGVjdF9hY2tfcGF1c2VfYnV0dG9uKCkKCiAgICBkZWYgX3JlZmxlY3RfYWNrX3BhdXNlX2J1dHRvbihzZWxmKToKICAgICAgICB2ID0gaW50KGdldGF0dHIoc2VsZiwgIm1hbnVhbF9hY2tfcGF1c2UiLCAxMCkpCiAgICAgICAgZm9yIGIgaW4gc2VsZi5hY2tfYnRuczoKICAgICAgICAgICAgYi5zZXRTdHlsZVNoZWV0KCJiYWNrZ3JvdW5kLWNvbG9yOiBsaW1lOyBjb2xvcjogYmxhY2s7IGJvcmRlcjogMXB4IHNvbGlkIGxpbWU7IiBpZiBiLnRleHQoKS5zdHJpcCgpPT1zdHIodikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2UgImJhY2tncm91bmQtY29sb3I6ICMwMDA7IGNvbG9yOiBsaW1lOyBib3JkZXI6IDFweCBzb2xpZCBsaW1lOyIpCiAgICBkZWYgc2V0X2JlYWNvbl9pbnRlcnZhbChzZWxmLCBtaW5zKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIG0gPSBpbnQobWlucykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBtID0gMTUKICAgICAgICBzZWxmLmJlYWNvbl9taW51dGVzID0gbQogICAgICAgIHRyeToKICAgICAgICAgICAgc3QgPSBzZWxmLl9zZXR0aW5nc19nZXQoKQogICAgICAgICAgICBzdFsnYmVhY29uJ10gPSB7J2VuYWJsZWQnOiBUcnVlLCAnbWludXRlcyc6IG19CiAgICAgICAgICAgIHNlbGYuX3NldHRpbmdzX3NldChzdCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgc2VsZi5fZW5hYmxlX2JlYWNvbihtLCBpbW1lZGlhdGU9VHJ1ZSkKCiAgICBkZWYgdXBkYXRlX2JlYWNvbnNfbGlzdChzZWxmKToKICAgICAgICAjIHByZWZlciBpbi1tZW1vcnkgZ3JhcGggYnV0IGFsc28gYWNjZXB0IGZpbGUtb25seQogICAgICAgIGlmIGdldGF0dHIoc2VsZiwgJ19ncmFwaF9wYXJlbnRzJywgTm9uZSk6CiAgICAgICAgICAgIHNlbGYuX3JlZnJlc2hfYmVhY29uc191aSgpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIGRhdGEgPSBsb2FkX2pzb24oImxpbmtfZ3JhcGguanNvbiIpIG9yIHt9CiAgICAgICAgc2VsZi5iZWFjb25zX2xpc3QuY2xlYXIoKQogICAgICAgIHBhcmVudHMgPSBkYXRhLmdldCgicGFyZW50cyIpIGlmIGlzaW5zdGFuY2UoZGF0YSwgZGljdCkgZWxzZSB7fQogICAgICAgIGlmIGlzaW5zdGFuY2UocGFyZW50cywgZGljdCk6CiAgICAgICAgICAgIGZvciBwLCBraWRzIGluIHNvcnRlZChwYXJlbnRzLml0ZW1zKCkpOgogICAgICAgICAgICAgICAgc2VsZi5iZWFjb25zX2xpc3QuYWRkSXRlbShmIi4ue3B9IikKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uoa2lkcywgKGxpc3QsdHVwbGUpKToKICAgICAgICAgICAgICAgICAgICBmb3IgayBpbiBraWRzOiBzZWxmLmJlYWNvbnNfbGlzdC5hZGRJdGVtKGYiICAve2t9IikKCiAgICAKICAgICMgLS0tLSBCZWFjb24gZ3JhcGggcGVyc2lzdGVuY2UvdXBkYXRlIC0tLS0KICAgIGRlZiBfbG9hZF9saW5rX2dyYXBoKHNlbGYpOgogICAgICAgICcnJ0xvYWQgZ3JhcGggZnJvbSBzdG9yZS9saW5rX2dyYXBoLmpzb247IHByZXNlcnZlIGRpY3Qgc2NoZW1hIChwYXJlbnRzIC0+IHtsYXN0LCBjaGlsZHJlbnsuLi59fSkuJycnCiAgICAgICAgdHJ5OgogICAgICAgICAgICBkYXRhID0gbG9hZF9qc29uKG9zLnBhdGguam9pbignc3RvcmUnLCdsaW5rX2dyYXBoLmpzb24nKSkgb3Ige30KICAgICAgICAgICAgcGFyZW50cyA9IGRhdGEuZ2V0KCdwYXJlbnRzJykgaWYgaXNpbnN0YW5jZShkYXRhLCBkaWN0KSBlbHNlIHt9CiAgICAgICAgICAgIGZpeGVkID0ge30KICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShwYXJlbnRzLCBkaWN0KToKICAgICAgICAgICAgICAgIGZvciBwaywgcHYgaW4gcGFyZW50cy5pdGVtcygpOgogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UocHYsIGRpY3QpOgogICAgICAgICAgICAgICAgICAgICAgICBmaXhlZFtzdHIocGspXSA9IHsKICAgICAgICAgICAgICAgICAgICAgICAgICAgICdsYXN0JzogaW50KHB2LmdldCgnbGFzdCcsIDApKSBpZiBpc2luc3RhbmNlKHB2LmdldCgnbGFzdCcsIDApLCBpbnQpIGVsc2UgcHYuZ2V0KCdsYXN0JywgMCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAnY2hpbGRyZW4nOiBkaWN0KHB2LmdldCgnY2hpbGRyZW4nKSBvciB7fSkKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIGVsaWYgaXNpbnN0YW5jZShwdiwgKGxpc3QsIHR1cGxlKSk6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpeGVkW3N0cihwayldID0geydsYXN0JzogMCwgJ2NoaWxkcmVuJzoge3N0cih4KTogeydsYXN0JzogMH0gZm9yIHggaW4gcHYgaWYgaXNpbnN0YW5jZSh4LChzdHIsKSl9fQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIGZpeGVkW3N0cihwayldID0geydsYXN0JzogMCwgJ2NoaWxkcmVuJzoge319CiAgICAgICAgICAgICAgICBzZWxmLl9ncmFwaF9wYXJlbnRzID0gZml4ZWQKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGYuX2dyYXBoX3BhcmVudHMgPSB7fQogICAgICAgICAgICB0cyA9IGRhdGEuZ2V0KCdsYXN0X2JlYWNvbl90cycpCiAgICAgICAgICAgIGlmIHRzOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuX2xhc3RfYmVhY29uX2hlYXJkX3RzID0gZGF0ZXRpbWUuZGF0ZXRpbWUuZnJvbWlzb2Zvcm1hdCh0cykKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fbGFzdF9iZWFjb25faGVhcmRfdHMgPSBOb25lCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgc2VsZi5fZ3JhcGhfcGFyZW50cyA9IHt9CiAgICAgICAgICAgIHNlbGYuX2xhc3RfYmVhY29uX2hlYXJkX3RzID0gTm9uZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHNlbGYuX2dyYXBoX3BhcmVudHMgPSB7fQogICAgICAgICAgICBzZWxmLl9sYXN0X2JlYWNvbl9oZWFyZF90cyA9IE5vbmUKCiAgICBkZWYgX3NhdmVfbGlua19ncmFwaChzZWxmKToKICAgICAgICAnJydQZXJzaXN0IGN1cnJlbnQgZ3JhcGggdG8gc3RvcmUvbGlua19ncmFwaC5qc29uICh3aXRoIGxhc3RfYmVhY29uX3RzKS4nJycKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRlZiBfdmFsaWRfZ3JhcGgoZyk6CiAgICAgICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShnLCBkaWN0KTogcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICBmb3IgcHYgaW4gZy52YWx1ZXMoKToKICAgICAgICAgICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShwdiwgZGljdCk6IHJldHVybiBGYWxzZQogICAgICAgICAgICAgICAgICAgIGNoID0gcHYuZ2V0KCdjaGlsZHJlbicsIHt9KQogICAgICAgICAgICAgICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKGNoLCBkaWN0KTogcmV0dXJuIEZhbHNlCiAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgICAgICBncmFwaCA9IHNlbGYuX2dyYXBoX3BhcmVudHMgaWYgX3ZhbGlkX2dyYXBoKGdldGF0dHIoc2VsZiwgJ19ncmFwaF9wYXJlbnRzJywge30pKSBlbHNlIHt9CiAgICAgICAgICAgIHBheWxvYWQgPSB7InBhcmVudHMiOiBncmFwaH0KICAgICAgICAgICAgaWYgZ2V0YXR0cihzZWxmLCAnX2xhc3RfYmVhY29uX2hlYXJkX3RzJywgTm9uZSk6CiAgICAgICAgICAgICAgICBwYXlsb2FkWyJsYXN0X2JlYWNvbl90cyJdID0gc2VsZi5fbGFzdF9iZWFjb25faGVhcmRfdHMuaXNvZm9ybWF0KHRpbWVzcGVjPSJzZWNvbmRzIikKICAgICAgICAgICAgc2F2ZV9qc29uKG9zLnBhdGguam9pbignc3RvcmUnLCdsaW5rX2dyYXBoLmpzb24nKSwgcGF5bG9hZCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgoKICAgIGRlZiBfcmVmcmVzaF9iZWFjb25zX3VpKHNlbGYpOgogICAgICAgICcnJ1JlZnJlc2ggdGhlIEJlYWNvbnMgSGVhcmQgVUkgZnJvbSB0aGUgaW4tbWVtb3J5IGdyYXBoLgogICAgICAgIFBhcmVudCBlbnRyaWVzIChsaW1lKSwgY2hpbGRyZW4gKG9yYW5nZSksIGNoaWxkcmVuIGluZGVudGVkIGJ5IDIgc3BhY2VzLgogICAgICAgICcnJwogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBQeVF0NS5RdFdpZGdldHMgaW1wb3J0IFFMaXN0V2lkZ2V0SXRlbQogICAgICAgICAgICBmcm9tIFB5UXQ1LlF0R3VpIGltcG9ydCBRQnJ1c2gsIFFDb2xvcgogICAgICAgICAgICBzZWxmLmJlYWNvbnNfbGlzdC5jbGVhcigpCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG15YyA9IHNlbGYubXljYWxsX2VkaXQudGV4dCgpLnN0cmlwKCkudXBwZXIoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgbXljID0gIiIKICAgICAgICAgICAgcGFyZW50X2JydXNoID0gUUJydXNoKFFDb2xvcig1MCwgMjA1LCA1MCkpICAgIyBsaW1lIGdyZWVuCiAgICAgICAgICAgIGNoaWxkX2JydXNoICA9IFFCcnVzaChRQ29sb3IoMjU1LCAxNjUsIDApKSAgICMgb3JhbmdlCiAgICAgICAgICAgIGZvciBwLCBraWRzIGluIHNvcnRlZChzZWxmLl9ncmFwaF9wYXJlbnRzLml0ZW1zKCkpOgogICAgICAgICAgICAgICAgaWYgcC51cHBlcigpID09IG15YzoKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgaXRwID0gUUxpc3RXaWRnZXRJdGVtKHApCiAgICAgICAgICAgICAgICBpdHAuc2V0Rm9yZWdyb3VuZChwYXJlbnRfYnJ1c2gpCiAgICAgICAgICAgICAgICBzZWxmLmJlYWNvbnNfbGlzdC5hZGRJdGVtKGl0cCkKICAgICAgICAgICAgICAgIGZvciBjIGluIFtjIGZvciBjIGluIGtpZHMgaWYgKGMgb3IgJycpLnVwcGVyKCkgIT0gbXljXToKICAgICAgICAgICAgICAgICAgICBpdGMgPSBRTGlzdFdpZGdldEl0ZW0oIiAgIiArIGMpCiAgICAgICAgICAgICAgICAgICAgaXRjLnNldEZvcmVncm91bmQoY2hpbGRfYnJ1c2gpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5iZWFjb25zX2xpc3QuYWRkSXRlbShpdGMpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgZGVmIF9yZWNvcmRfcGFyZW50X2JlYWNvbihzZWxmLCBwYXJlbnRfY3M6IHN0cik6CiAgICAgICAgIyBJZ25vcmUgb3VyIG93biBwYXJlbnQgYmVhY29ucwogICAgICAgIHRyeToKICAgICAgICAgICAgbXljID0gc2VsZi5teWNhbGxfZWRpdC50ZXh0KCkuc3RyaXAoKS51cHBlcigpCiAgICAgICAgICAgIGlmIGJhc2VfY2FsbHNpZ24ocGFyZW50X2NzKS51cHBlcigpID09IG15YzoKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICBwID0gYmFzZV9jYWxsc2lnbihwYXJlbnRfY3MpCiAgICAgICAgaWYgbm90IHA6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIHAgbm90IGluIHNlbGYuX2dyYXBoX3BhcmVudHM6CiAgICAgICAgICAgIHNlbGYuX2dyYXBoX3BhcmVudHNbcF0gPSBbXQogICAgICAgIHNlbGYuX2N1cnJlbnRfcGFyZW50X2Zvcl9jaGlsZHJlbiA9IHAKICAgICAgICBzZWxmLl9sYXN0X2JlYWNvbl9oZWFyZF90cyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgc2VsZi5fc2F2ZV9saW5rX2dyYXBoKCkKICAgICAgICBzZWxmLl9yZWZyZXNoX2JlYWNvbnNfdWkoKQoKICAgIGRlZiBfcmVjb3JkX2NoaWxkX2JlYWNvbihzZWxmLCBjaGlsZF9jczogc3RyKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIG15YyA9IHNlbGYubXljYWxsX2VkaXQudGV4dCgpLnN0cmlwKCkudXBwZXIoKQogICAgICAgICAgICBpZiBiYXNlX2NhbGxzaWduKGNoaWxkX2NzKS51cHBlcigpID09IG15YzoKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICBpZiBub3Qgc2VsZi5fY3VycmVudF9wYXJlbnRfZm9yX2NoaWxkcmVuOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBwID0gc2VsZi5fY3VycmVudF9wYXJlbnRfZm9yX2NoaWxkcmVuCiAgICAgICAgYyA9IGJhc2VfY2FsbHNpZ24oY2hpbGRfY3MpCiAgICAgICAgaWYgbm90IGM6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGlmIGMgbm90IGluIHNlbGYuX2dyYXBoX3BhcmVudHMuZ2V0KHAsIFtdKToKICAgICAgICAgICAgc2VsZi5fZ3JhcGhfcGFyZW50cy5zZXRkZWZhdWx0KHAsIFtdKS5hcHBlbmQoYykKICAgICAgICBzZWxmLl9sYXN0X2JlYWNvbl9oZWFyZF90cyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgc2VsZi5fc2F2ZV9saW5rX2dyYXBoKCkKICAgICAgICBzZWxmLl9yZWZyZXNoX2JlYWNvbnNfdWkoKQoKICAgIGRlZiBfc2Nhbl9mb3JfYmVhY29uX2xpbmUoc2VsZiwgbGluZTogc3RyKToKICAgICAgICAnJydQYXJzZSBvbmUtbGluZSBiZWFjb25zOiAnLi5QQVJFTlQgW0xhdCB4eC54eHh4eCBMb24geXkueXl5eXl8UE9TOmxhdCxsb25dIFsvQ0hJTEQxIFsvQ0hJTEQyIC4uLl1dJy4KICAgICAgICBVcGRhdGVzIGxpbmtfZ3JhcGggKHBhcmVudC0+Y2hpbGRyZW4pLCBwb3NpdGlvbnMuanNvbiwgYW5kIHJlZnJlc2hlcyBVSS9tYXAgaW4gb25lIHBhc3MuCiAgICAgICAgJycnCiAgICAgICAgdHJ5OgogICAgICAgICAgICByYXcgPSAobGluZSBvciAiIikuc3RyaXAoKQogICAgICAgICAgICBpZiBub3QgcmF3OgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHR4dCA9IHJhdy51cHBlcigpCiAgICAgICAgICAgICMgUGFyZW50IG11c3QgYmUgYXQgdGhlIHN0YXJ0CiAgICAgICAgICAgIG1fcGFyZW50ID0gcmUubWF0Y2gocideXC57Mn1ccyooW0EtWjAtOS9dKyknLCB0eHQpCiAgICAgICAgICAgIGlmIG5vdCBtX3BhcmVudDoKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICBwYXJlbnQgPSBtX3BhcmVudC5ncm91cCgxKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICAgICAgc2VsZi5fcmVjb3JkX3BhcmVudF9iZWFjb24ocGFyZW50KQoKICAgICAgICAgICAgIyBQb3NpdGlvbjogdHJ5IFBPUzo8bGF0Piw8bG9uPiBmaXJzdDsgZWxzZSBMQVQvTE9OIHRva2VucyBhbnl3aGVyZQogICAgICAgICAgICBsYXQgPSBsb24gPSBOb25lCiAgICAgICAgICAgIG1fcG9zID0gcmUuc2VhcmNoKHInUE9TXHMqWzo9XT9ccyooWystXT9cZCsoPzpcLlxkKyk/KVssO1xzXSsoWystXT9cZCsoPzpcLlxkKyk/KScsIHJhdywgZmxhZ3M9cmUuSSkKICAgICAgICAgICAgaWYgbm90IG1fcG9zOgogICAgICAgICAgICAgICAgbV9sYXQgPSByZS5zZWFyY2gocidMQVRccypbOj1dP1xzKihbKy1dP1xkKyg/OlwuXGQrKT8pJywgcmF3LCBmbGFncz1yZS5JKQogICAgICAgICAgICAgICAgbV9sb24gPSByZS5zZWFyY2gocidMT05ccypbOj1dP1xzKihbKy1dP1xkKyg/OlwuXGQrKT8pJywgcmF3LCBmbGFncz1yZS5JKQogICAgICAgICAgICAgICAgaWYgbV9sYXQgYW5kIG1fbG9uOgogICAgICAgICAgICAgICAgICAgIGxhdCwgbG9uID0gbV9sYXQuZ3JvdXAoMSksIG1fbG9uLmdyb3VwKDEpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBsYXQsIGxvbiA9IG1fcG9zLmdyb3VwKDEpLCBtX3Bvcy5ncm91cCgyKQoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgbGF0IGlzIG5vdCBOb25lIGFuZCBsb24gaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5fcG9zaXRpb25zX3Vwc2VydChwYXJlbnQsIGZsb2F0KGxhdCksIGZsb2F0KGxvbiksIHNvdXJjZT0nYmVhY29uLXJ4JykKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zYXZlX3Bvc2l0aW9ucygpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICAjIENoaWxkcmVuOiBjb2xsZWN0IGFsbCAnL0NISUxEJyB0b2tlbnMgYW55d2hlcmUgb24gdGhlIGxpbmUKICAgICAgICAgICAga2lkcyA9IHJlLmZpbmRhbGwocicvXHMqKFtBLVowLTkvXSspJywgdHh0KQogICAgICAgICAgICBmb3IgY2ggaW4ga2lkczoKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9yZWNvcmRfY2hpbGRfYmVhY29uKGNoLnN0cmlwKCkudXBwZXIoKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgIyBSZWZyZXNoIFVJIGFuZCBtYXAgKyBwZXJzaXN0CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX3NhdmVfbGlua19ncmFwaCgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX3JlZnJlc2hfYmVhY29uc191aSgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ2xpbmttYXAnKSBhbmQgaGFzYXR0cihzZWxmLmxpbmttYXAsICdkcmF3X2dyYXBoJyk6CiAgICAgICAgICAgICAgICAgICAgc2VsZi5saW5rbWFwLmRyYXdfZ3JhcGgoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX2NsZWFyX2dyYXBoX2lmX3N0YWxlKHNlbGYsIG1pbnV0ZXM9MjApOgogICAgICAgICcnJ0lmIG5vIGJlYWNvbnMgaGVhcmQgZm9yIE4gbWludXRlcywgY2xlYXIgbGlua19ncmFwaC5qc29uIGFuZCBVSS4nJycKICAgICAgICB0cnk6CiAgICAgICAgICAgIG5vdyA9IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpCiAgICAgICAgICAgIGxhc3QgPSBzZWxmLl9sYXN0X2JlYWNvbl9oZWFyZF90cwogICAgICAgICAgICBpZiBsYXN0IGlzIE5vbmU6CiAgICAgICAgICAgICAgICAjIGRlcml2ZSBmcm9tIGZpbGUgdGltZXN0YW1wIGlmIHByZXNlbnQKICAgICAgICAgICAgICAgIGRhdGEgPSBsb2FkX2pzb24oImxpbmtfZ3JhcGguanNvbiIpIG9yIHt9CiAgICAgICAgICAgICAgICB0cyA9IGRhdGEuZ2V0KCJsYXN0X2JlYWNvbl90cyIpCiAgICAgICAgICAgICAgICBpZiB0czoKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIGxhc3QgPSBkYXRldGltZS5kYXRldGltZS5mcm9taXNvZm9ybWF0KHRzKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9sYXN0X2JlYWNvbl9oZWFyZF90cyA9IGxhc3QKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICBsYXN0ID0gTm9uZQogICAgICAgICAgICBpZiBsYXN0IGlzIE5vbmU6CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgZGVsdGEgPSAobm93IC0gbGFzdCkudG90YWxfc2Vjb25kcygpIC8gNjAuMAogICAgICAgICAgICBpZiBkZWx0YSA+IG1pbnV0ZXMgYW5kIHNlbGYuX2dyYXBoX3BhcmVudHM6CiAgICAgICAgICAgICAgICBzZWxmLl9ncmFwaF9wYXJlbnRzID0ge30KICAgICAgICAgICAgICAgIHNlbGYuX2N1cnJlbnRfcGFyZW50X2Zvcl9jaGlsZHJlbiA9IE5vbmUKICAgICAgICAgICAgICAgICMgZG8gbm90IHJlc2V0IGxhc3QgdGltZXN0YW1wOyBsZWF2ZSBpdCB0byBpbmRpY2F0ZSBsYXN0IGFjdGl2aXR5CiAgICAgICAgICAgICAgICBzZWxmLl9zYXZlX2xpbmtfZ3JhcGgoKQogICAgICAgICAgICAgICAgc2VsZi5fcmVmcmVzaF9iZWFjb25zX3VpKCkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsJ2xpbmttYXAnKTogc2VsZi5saW5rbWFwLmRyYXdfZ3JhcGgoKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwojIC0tLS0gTWVzc2FnZXMgc3RvcmFnZSAoc3RvcmUvbWVzc2FnZXNfdjEuanNvbikgLS0tLQogICAgZGVmIF9tZXNzYWdlc19zdG9yZV9wYXRoKHNlbGYpOgogICAgICAgIHJldHVybiBzdG9yZV9wYXRoKCdtZXNzYWdlc192MS5qc29uJykKCiAgICBkZWYgX3NhdmVfbWVzc2FnZXNfdG9fc3RvcmUoc2VsZik6CiAgICAgICAgZGF0YSA9IHsndmVyc2lvbic6IDEsICdtZXNzYWdlcyc6IGdldGF0dHIoc2VsZiwgJ19tZXNzYWdlcycsIFtdKX0KICAgICAgICBzYXZlX2pzb24oJ21lc3NhZ2VzX3YxLmpzb24nLCBkYXRhKQoKICAgIAogICAgZGVmIF9sb2FkX21lc3NhZ2VzX2Zyb21fc3RvcmUoc2VsZik6CiAgICAgICAgZGlhZ19sb2coJ0VudGVyIF9sb2FkX21lc3NhZ2VzX2Zyb21fc3RvcmUnKQogICAgICAgIGRhdGEgPSBsb2FkX2pzb24oJ21lc3NhZ2VzX3YxLmpzb24nKSBvciB7fQogICAgICAgIHJhdyA9IGRhdGEuZ2V0KCdtZXNzYWdlcycsIFtdKQogICAgICAgIG5vcm1hbGl6ZWQgPSBbXQogICAgICAgIGNoYW5nZWQgPSBGYWxzZQogICAgICAgIG5vd3RzID0gc2VsZi5fdXRjX25vd19pc28oKSBpZiBoYXNhdHRyKHNlbGYsICdfdXRjX25vd19pc28nKSBlbHNlIE5vbmUKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZvciBtIGluIHJhdzoKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UobSwgc3RyKToKICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVkLmFwcGVuZCh7J2xpbmUnOiBtLCAncm9sZSc6ICdyeCcsICd0cyc6IG5vd3RzfSkKICAgICAgICAgICAgICAgICAgICBjaGFuZ2VkID0gVHJ1ZQogICAgICAgICAgICAgICAgZWxpZiBpc2luc3RhbmNlKG0sIGRpY3QpOgogICAgICAgICAgICAgICAgICAgIGxpbmUgPSBzdHIobS5nZXQoJ2xpbmUnLCAnJykpCiAgICAgICAgICAgICAgICAgICAgcm9sZSA9IHN0cihtLmdldCgncm9sZScsICdzZW50JykpLmxvd2VyKCkKICAgICAgICAgICAgICAgICAgICBpZiByb2xlIG5vdCBpbiAoJ3NlbnQnLCAncngnLCAnYWNrZWQnLCAndHgnKToKICAgICAgICAgICAgICAgICAgICAgICAgcm9sZSA9ICdzZW50JzsgY2hhbmdlZCA9IFRydWUKICAgICAgICAgICAgICAgICAgICB0cyA9IG0uZ2V0KCd0cycpIG9yIG5vd3RzCiAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZSh0cywgc3RyKSBhbmQgdHMuZW5kc3dpdGgoJyswMDowMCcpOgogICAgICAgICAgICAgICAgICAgICAgICB0cyA9IHRzLnJlcGxhY2UoJyswMDowMCcsICdaJyk7IGNoYW5nZWQgPSBUcnVlCiAgICAgICAgICAgICAgICAgICAgb2JqID0geydsaW5lJzogbGluZSwgJ3JvbGUnOiByb2xlLCAndHMnOiB0c30KICAgICAgICAgICAgICAgICAgICAjIGNhcnJ5IG92ZXIgc3RhdHVzL2Fja19pZCBpZiBwcmVzZW50CiAgICAgICAgICAgICAgICAgICAgaWYgJ3N0YXR1cycgaW4gbTogb2JqWydzdGF0dXMnXSA9IG0uZ2V0KCdzdGF0dXMnKQogICAgICAgICAgICAgICAgICAgIGlmICdhY2tfaWQnIGluIG06IG9ialsnYWNrX2lkJ10gPSBtLmdldCgnYWNrX2lkJykKICAgICAgICAgICAgICAgICAgICBub3JtYWxpemVkLmFwcGVuZChvYmopCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgIGNoYW5nZWQgPSBUcnVlCiAgICAgICAgICAgICMgLS0tLSBDT01QQUNUOiBrZWVwIG9ubHkgbGF0ZXN0IHJlY29yZCBwZXIgYWNrX2lkIC0tLS0KICAgICAgICAgICAgY29tcGFjdGVkID0gW10KICAgICAgICAgICAgc2VlbiA9IHNldCgpCiAgICAgICAgICAgIGZvciBtIGluIHJldmVyc2VkKG5vcm1hbGl6ZWQpOgogICAgICAgICAgICAgICAgYWlkID0gc3RyKG0uZ2V0KCdhY2tfaWQnKSBvciAnJykuc3RyaXAoKQogICAgICAgICAgICAgICAgaWYgYWlkOgogICAgICAgICAgICAgICAgICAgIGlmIGFpZCBpbiBzZWVuOgogICAgICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgICAgIHNlZW4uYWRkKGFpZCkKICAgICAgICAgICAgICAgIGNvbXBhY3RlZC5hcHBlbmQobSkKICAgICAgICAgICAgY29tcGFjdGVkLnJldmVyc2UoKQogICAgICAgICAgICBzZWxmLl9tZXNzYWdlcyA9IGNvbXBhY3RlZAogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHNlbGYuX21lc3NhZ2VzID0gW10KICAgICAgICBzZWxmLm1lc3NhZ2VzX2xpc3QuY2xlYXIoKQogICAgICAgIGZvciBtc2cgaW4gc2VsZi5fbWVzc2FnZXM6CgogICAgICAgICAgICBsaW5lID0gbXNnLmdldCgnbGluZScsJycpOyByb2xlID0gKG1zZy5nZXQoJ3JvbGUnKSBvciAnJykubG93ZXIoKQogICAgICAgICAgICBwcmVmaXggPSBzZWxmLl9mbXRfZGlzcF9wcmVmaXgobXNnLmdldCgndHMnKSBvciBtc2cuZ2V0KCd0aW1lJykgb3IgJycpCiAgICAgICAgICAgIGl0ZW0gPSBRTGlzdFdpZGdldEl0ZW0ocHJlZml4ICsgbGluZSkKICAgICAgICAgICAgaWYgcm9sZSA9PSAnYWNrZWQnOgogICAgICAgICAgICAgICAgaXRlbS5zZXRGb3JlZ3JvdW5kKFFCcnVzaChzZWxmLkNPTE9SX0FDSykpOyBpdGVtLnNldERhdGEoUXQuVXNlclJvbGUsICdhY2tlZCcpCiAgICAgICAgICAgIGVsaWYgcm9sZSA9PSAncngnOgogICAgICAgICAgICAgICAgaXRlbS5zZXRGb3JlZ3JvdW5kKFFCcnVzaChzZWxmLkNPTE9SX1JYKSk7IGl0ZW0uc2V0RGF0YShRdC5Vc2VyUm9sZSwgJ3J4JykKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGl0ZW0uc2V0Rm9yZWdyb3VuZChRQnJ1c2goc2VsZi5DT0xPUl9TRU5UKSk7IGl0ZW0uc2V0RGF0YShRdC5Vc2VyUm9sZSwgJ3NlbnQnKQogICAgICAgICAgICBzZWxmLm1lc3NhZ2VzX2xpc3QuaW5zZXJ0SXRlbSgwLCBpdGVtKQogICAgICAgIHNlbGYubWVzc2FnZXNfbGlzdC5zY3JvbGxUb1RvcCgpCiAgICAgICAgaWYgY2hhbmdlZDoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2F2ZV9qc29uKCdtZXNzYWdlc192MS5qc29uJywgeyd2ZXJzaW9uJzogMSwgJ21lc3NhZ2VzJzogc2VsZi5fbWVzc2FnZXN9KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgZGVmIHNlbmRfbWVzc2FnZShzZWxmKToKICAgICAgICAKICAgICAgICAKICAgICAgICAjIFJvYnVzdCBTRU5EIHBhdGggd2l0aCBBQ0sgTWFuYWdlciBpbnRlZ3JhdGlvbiBhbmQgVUkgc2FmZXR5CiAgICAgICAgdG8gPSAoc2VsZi50b19lZGl0LnRleHQoKSBpZiBoYXNhdHRyKHNlbGYsICd0b19lZGl0JykgZWxzZSAnJykuc3RyaXAoKS51cHBlcigpCiAgICAgICAgbWUgPSAoc2VsZi5teWNhbGxfZWRpdC50ZXh0KCkgaWYgaGFzYXR0cihzZWxmLCAnbXljYWxsX2VkaXQnKSBlbHNlICcnKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICBtc2cgPSAoc2VsZi5zZW5kX2VkaXQudG9QbGFpblRleHQoKSBpZiBoYXNhdHRyKHNlbGYsICdzZW5kX2VkaXQnKSBlbHNlICcnKS5zdHJpcCgpCiAgICAgICAgaWYgbm90IHRvIG9yIG5vdCBtZSBvciBub3QgbXNnOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBRTWVzc2FnZUJveC5pbmZvcm1hdGlvbihzZWxmLCAnU2VuZCcsICdQbGVhc2UgZmlsbCBUYXJnZXQsIEZyb20sIGFuZCBNZXNzYWdlLicpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB0cnk6CiAgICAgICAgICAgIGFja19pZCA9IHNlbGYuX25leHRfYWNrX2lkKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAjIGZhbGxiYWNrIGlkCiAgICAgICAgICAgIGFja19pZCA9ICIwMDAwIgoKICAgICAgICBiYXNlX2xpbmUgPSBmInt0b30gREUge21lfSB7bXNnfSBbQUNLOnthY2tfaWR9XSIKICAgICAgICBmaXJzdCA9IGYie2Jhc2VfbGluZX0gKGF0dGVtcHQgMS8zKSIKCiAgICAgICAgIyBDcmVhdGUvYXBwZW5kIFRYIGxpc3QgaXRlbSBzYWZlbHkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCBkYXRldGltZSBhcyBfZHQKICAgICAgICAgICAgbm93X2lzbyA9IF9kdC5kYXRldGltZS5ub3coKS5pc29mb3JtYXQodGltZXNwZWM9J3NlY29uZHMnKQogICAgICAgICAgICBpdCA9IFFMaXN0V2lkZ2V0SXRlbShzZWxmLl9mbXRfZGlzcF9wcmVmaXgobm93X2lzbykgKyBzZWxmLl9zdHJpcF9hY2tfaWQoZmlyc3QpICsgc2VsZi5fdGlja3NfZm9yX3N0YXR1cygnYXR0ZW1wdCAxLzMnKSkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZnJvbSBQeVF0NS5RdEd1aSBpbXBvcnQgUUJydXNoCiAgICAgICAgICAgICAgICBpdC5zZXRGb3JlZ3JvdW5kKFFCcnVzaChzZWxmLkNPTE9SX1NFTlQpKTsgaXQuc2V0Rm9yZWdyb3VuZChRQnJ1c2goZmcpKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBpdC5zZXREYXRhKFF0LlVzZXJSb2xlLCdzZW50JykKICAgICAgICAgICAgdHJ5OgoKICAgICAgICAgICAgICAgIF9lbmNfZ3VhcmQgPSAobGluZSBpZiAibGluZSIgaW4gbG9jYWxzKCkgZWxzZSB0ZXh0IGlmICJ0ZXh0IiBpbiBsb2NhbHMoKSBlbHNlIG1zZyBpZiAibXNnIiBpbiBsb2NhbHMoKSBlbHNlICIiKQoKICAgICAgICAgICAgICAgIGlmIHNlbGYuX2lzX2VuY3J5cHRlZF9saW5lKF9lbmNfZ3VhcmQpOgoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICAgICAgZWxzZToKCiAgICAgICAgICAgICAgICAgICAgc2VsZi5tZXNzYWdlc19saXN0Lmluc2VydEl0ZW0oMCwgaXQpCgogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgoKICAgICAgICAgICAgICAgIHNlbGYubWVzc2FnZXNfbGlzdC5pbnNlcnRJdGVtKDAsIGl0KQoKICAgICAgICAgICAgc2VsZi5tZXNzYWdlc19saXN0LnNjcm9sbFRvVG9wKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBpdCA9IE5vbmUKCiAgICAgICAgIyBFbnN1cmUgZGljdCBob2xkZXJzCiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgJ19hY2tfaXRlbXMnKSBvciBub3QgaXNpbnN0YW5jZShnZXRhdHRyKHNlbGYsICdfYWNrX2l0ZW1zJyksIGRpY3QpOgogICAgICAgICAgICBzZWxmLl9hY2tfaXRlbXMgPSB7fQogICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYsICdfYWNrX3N0YXRlcycpIG9yIG5vdCBpc2luc3RhbmNlKGdldGF0dHIoc2VsZiwgJ19hY2tfc3RhdGVzJyksIGRpY3QpOgogICAgICAgICAgICBzZWxmLl9hY2tfc3RhdGVzID0ge30KCiAgICAgICAgc2VsZi5fYWNrX2l0ZW1zW2Fja19pZF0gPSBpdAoKICAgICAgICAjIFBlcnNpc3QgZmlyc3QgYXR0ZW1wdAogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fbWVzc2FnZXMuYXBwZW5kKHsnbGluZSc6IGZpcnN0LCAncm9sZSc6ICd0eCcsICd0cyc6IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCh0aW1lc3BlYz0nc2Vjb25kcycpLCAnYWNrX2lkJzogYWNrX2lkLCAnc3RhdHVzJzonYXR0ZW1wdCAxLzMnfSkKICAgICAgICAgICAgc2VsZi5fc2F2ZV9tZXNzYWdlc190b19zdG9yZSgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICAjIFN0YXJ0IEFDSyBzdGF0ZQogICAgICAgIHRyeToKICAgICAgICAgICAgcGF1c2UgPSBpbnQoZ2V0YXR0cihzZWxmLCAnbWFudWFsX2Fja19wYXVzZScsIDEyKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXVzZSA9IDEyCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdCA9IEFja1N0YXRlKHNlbGYsIGFja19pZCwgYmFzZV9saW5lLCBwYXVzZSkKICAgICAgICAgICAgc2VsZi5fYWNrX3N0YXRlc1thY2tfaWRdID0gc3QKICAgICAgICAgICAgc3Quc3RhcnQoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgZGlhZ19sb2coZiJbRVJST1JdIHN0YXJ0aW5nIEFja1N0YXRlOiB7dHlwZShlKS5fX25hbWVfX306IHtlfSIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgIyBDbGVhciB0aGUgbWVzc2FnZSBpbnB1dCBhZnRlciBzZW5kaW5nCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLnNlbmRfZWRpdC5jbGVhcigpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgIyAtLS0gU2VjdXJlIFBhZCBpbnRlZ3JhdGlvbiAtLS0KICAgIGRlZiBvcGVuX3NlY3VyZV9wYWQoc2VsZiwgaW5pdGlhbF90ZXh0OiBzdHIgPSAiIiwgZnJvbV9jYWxsOiBzdHIgPSBOb25lLCBzaG93X3RvOiBib29sID0gVHJ1ZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBkbGcgPSBTZWN1cmVQYWREaWFsb2coc2VsZiwgaW5pdGlhbF90ZXh0PWluaXRpYWxfdGV4dCwgZnJvbV9jYWxsPWZyb21fY2FsbCwgc2hvd190bz1zaG93X3RvKQogICAgICAgICAgICBkbGcuc2V0TW9kYWwoVHJ1ZSkKICAgICAgICAgICAgZGxnLnJlc2l6ZSgxMDAwLCA3MDApCiAgICAgICAgICAgIHJldHVybiBkbGcuZXhlY18oKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgdHJ5OiBzZWxmLl9zdGF0dXMoZiJTZWN1cmUgUGFkIGZhaWxlZDoge2V9IikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICByZXR1cm4gMAoKICAgIGRlZiBfc2VuZF9zZWN1cmVwYWQoc2VsZiwgdG86IHN0ciwgbXNnOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBtZSA9IChzZWxmLm15Y2FsbF9lZGl0LnRleHQoKSBpZiBoYXNhdHRyKHNlbGYsICdteWNhbGxfZWRpdCcpIGVsc2UgJycpLnN0cmlwKCkudXBwZXIoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIG1lID0gJycKICAgICAgICBpZiBub3QgbWU6CiAgICAgICAgICAgIHRyeTogUU1lc3NhZ2VCb3guaW5mb3JtYXRpb24oc2VsZiwgJ1NlbmQnLCAnUGxlYXNlIGZpbGwgeW91ciBGcm9tL01ZQ0FMTCBmaXJzdC4nKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHRyeToKICAgICAgICAgICAgYWNrX2lkID0gc2VsZi5fbmV4dF9hY2tfaWQoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGFja19pZCA9ICIwMDAwIgogICAgICAgIGJhc2VfbGluZSA9IGYie3RvfSBERSB7bWV9IHttc2d9IFtBQ0s6e2Fja19pZH1dIgogICAgICAgIGZpcnN0ID0gZiJ7YmFzZV9saW5lfSAoYXR0ZW1wdCAxLzMpIgogICAgICAgIGl0ID0gTm9uZQogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IGRhdGV0aW1lIGFzIF9kdAogICAgICAgICAgICBub3dfaXNvID0gX2R0LmRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCh0aW1lc3BlYz0nc2Vjb25kcycpCiAgICAgICAgICAgIGl0ID0gUUxpc3RXaWRnZXRJdGVtKHNlbGYuX2ZtdF9kaXNwX3ByZWZpeChub3dfaXNvKSArIHNlbGYuX3N0cmlwX2Fja19pZChmaXJzdCkgKyBzZWxmLl90aWNrc19mb3Jfc3RhdHVzKCdhdHRlbXB0IDEvMycpKQogICAgICAgICAgICBmcm9tIFB5UXQ1LlF0R3VpIGltcG9ydCBRQnJ1c2gKICAgICAgICAgICAgaXQuc2V0Rm9yZWdyb3VuZChRQnJ1c2goc2VsZi5DT0xPUl9TRU5UKSkKICAgICAgICAgICAgaXQuc2V0RGF0YShRdC5Vc2VyUm9sZSwnc2VudCcpCiAgICAgICAgICAgIHRyeToKCiAgICAgICAgICAgICAgICBfZW5jX2d1YXJkID0gKGxpbmUgaWYgImxpbmUiIGluIGxvY2FscygpIGVsc2UgdGV4dCBpZiAidGV4dCIgaW4gbG9jYWxzKCkgZWxzZSBtc2cgaWYgIm1zZyIgaW4gbG9jYWxzKCkgZWxzZSAiIikKCiAgICAgICAgICAgICAgICBpZiBzZWxmLl9pc19lbmNyeXB0ZWRfbGluZShfZW5jX2d1YXJkKToKCiAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgICAgIGVsc2U6CgogICAgICAgICAgICAgICAgICAgIHNlbGYubWVzc2FnZXNfbGlzdC5pbnNlcnRJdGVtKDAsIGl0KQoKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKCiAgICAgICAgICAgICAgICBzZWxmLm1lc3NhZ2VzX2xpc3QuaW5zZXJ0SXRlbSgwLCBpdCkKICAgICAgICAgICAgc2VsZi5tZXNzYWdlc19saXN0LnNjcm9sbFRvVG9wKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgJ19hY2tfaXRlbXMnKSBvciBub3QgaXNpbnN0YW5jZShnZXRhdHRyKHNlbGYsICdfYWNrX2l0ZW1zJyksIGRpY3QpOgogICAgICAgICAgICBzZWxmLl9hY2tfaXRlbXMgPSB7fQogICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYsICdfYWNrX3N0YXRlcycpIG9yIG5vdCBpc2luc3RhbmNlKGdldGF0dHIoc2VsZiwgJ19hY2tfc3RhdGVzJyksIGRpY3QpOgogICAgICAgICAgICBzZWxmLl9hY2tfc3RhdGVzID0ge30KICAgICAgICBzZWxmLl9hY2tfaXRlbXNbYWNrX2lkXSA9IGl0CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpbXBvcnQgZGF0ZXRpbWUKICAgICAgICAgICAgc2VsZi5fbWVzc2FnZXMuYXBwZW5kKHsnbGluZSc6IGZpcnN0LCAncm9sZSc6ICd0eCcsICd0cyc6IGRhdGV0aW1lLmRhdGV0aW1lLm5vdygpLmlzb2Zvcm1hdCh0aW1lc3BlYz0nc2Vjb25kcycpLCAnYWNrX2lkJzogYWNrX2lkLCAnc3RhdHVzJzonYXR0ZW1wdCAxLzMnfSkKICAgICAgICAgICAgc2VsZi5fc2F2ZV9tZXNzYWdlc190b19zdG9yZSgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHRyeToKICAgICAgICAgICAgcGF1c2UgPSBpbnQoZ2V0YXR0cihzZWxmLCAnbWFudWFsX2Fja19wYXVzZScsIDEyKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXVzZSA9IDEyCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdCA9IEFja1N0YXRlKHNlbGYsIGFja19pZCwgYmFzZV9saW5lLCBwYXVzZSkKICAgICAgICAgICAgc2VsZi5fYWNrX3N0YXRlc1thY2tfaWRdID0gc3Q7IHN0LnN0YXJ0KCk7IG9rID0gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIG9rID0gYm9vbChzZWxmLnNlbmRfdXNlcl90ZXh0KGJhc2VfbGluZSkpCiAgICAgICAgdHJ5OiBzZWxmLl90b3VjaF9sYXN0X3R4KCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgcmV0dXJuIG9rCgoKCiAgICBkZWYgYWRkX3JlY2VpdmVkX21lc3NhZ2Uoc2VsZiwgbGluZTogc3RyKToKCiAgICAgICAgIyBJbnRlcmNlcHQgZW5jcnlwdGVkIG1lc3NhZ2VzIGFuZCBkaXZlcnQgdG8gU2VjdXJlIFBhZCAobm8gbGlzdCwgbm8gSlNPTikKICAgICAgICB0cnk6CiAgICAgICAgICAgIHMgPSBzdHIobGluZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBzID0gIiIKICAgICAgICBpZiAoIltFTkMyXSIgaW4gcykgb3IgKCJbRU5DMV0iIGluIHMpIG9yICgiW0VOQ10iIGluIHMpOgogICAgICAgICAgICBmcm9tX2NhbGwgPSBOb25lCiAgICAgICAgICAgIGVuY190ZXh0ID0gcwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpbXBvcnQgcmUgYXMgX3JlCiAgICAgICAgICAgICAgICBtID0gX3JlLnNlYXJjaChyJ15ccyooXFMrKVxzK0RFXHMrKFxTKylccysoLiopJCcsIHMpCiAgICAgICAgICAgICAgICBpZiBtOgogICAgICAgICAgICAgICAgICAgIGZyb21fY2FsbCA9IChtLmdyb3VwKDIpIG9yICIiKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICAgICAgICAgICAgICByZXN0ID0gbS5ncm91cCgzKSBvciAiIgogICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICByZXN0ID0gcwogICAgICAgICAgICAgICAgcCA9IG1pbihbcSBmb3IgcSBpbiBbcmVzdC5maW5kKCJbRU5DMl0iKSwgcmVzdC5maW5kKCJbRU5DMV0iKSwgcmVzdC5maW5kKCJbRU5DXSIpXSBpZiBxICE9IC0xXSBvciBbLTFdKQogICAgICAgICAgICAgICAgZW5jX3RleHQgPSByZXN0W3A6XSBpZiBwID49IDAgZWxzZSByZXN0CiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYub3Blbl9zZWN1cmVfcGFkKGluaXRpYWxfdGV4dD1lbmNfdGV4dCwgZnJvbV9jYWxsPWZyb21fY2FsbCwgc2hvd190bz1GYWxzZSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgaXRlbSA9IFFMaXN0V2lkZ2V0SXRlbShsaW5lKQogICAgICAgIHRyeTogaXRlbS5zZXRGb3JlZ3JvdW5kKFFCcnVzaChzZWxmLkNPTE9SX1JYKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgdHJ5OiBpdGVtLnNldERhdGEoUXQuVXNlclJvbGUsICJyeCIpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgIHNlbGYubWVzc2FnZXNfbGlzdC5pbnNlcnRJdGVtKDAsIGl0ZW0pCiAgICAgICAgc2VsZi5tZXNzYWdlc19saXN0LnNjcm9sbFRvVG9wKCkKICAgICAgICAjIFRyeSBhdXRvLUFDSyB0byBzZW5kZXIgaWYgbWVzc2FnZSBhZGRyZXNzZWQgdG8gbWUgY29udGFpbnMgYW4gQUNLIHJlcXVlc3QKICAgICAgICB0cnk6CiAgICAgICAgICAgIGltcG9ydCByZSBhcyBfcmUKICAgICAgICAgICAgbSA9IF9yZS5tYXRjaChyJ15ccyooW0EtWjAtOVwtXSspXHMrREVccysoW0EtWjAtOVwtXSspXHMqKC4qKSQnLCBsaW5lLnN0cmlwKCksIGZsYWdzPV9yZS5JKQogICAgICAgICAgICBpZiBtOgogICAgICAgICAgICAgICAgdG9fY2FsbCwgZnJtX2NhbGwsIHJlc3QgPSBtLmdyb3VwKDEpLnVwcGVyKCksIG0uZ3JvdXAoMikudXBwZXIoKSwgKG0uZ3JvdXAoMykgb3IgJycpLnN0cmlwKCkKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9hdXRvX2Fja19pZl9uZWVkZWQoZnJtX2NhbGwsIHRvX2NhbGwsIHJlc3QpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgICAgICMgQmVhY29uIHBhcnNlL3VwZGF0ZQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fc2Nhbl9mb3JfYmVhY29uX2xpbmUobGluZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLl9tZXNzYWdlcy5hcHBlbmQoeydsaW5lJzogbGluZSwgJ3JvbGUnOiAncngnLCAndHMnOiBkYXRldGltZS5kYXRldGltZS5ub3coKS5pc29mb3JtYXQodGltZXNwZWM9J3NlY29uZHMnKX0pCiAgICAgICAgICAgIHNlbGYuX3NhdmVfbWVzc2FnZXNfdG9fc3RvcmUoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKCiAgICBkZWYgbWFya19zZWxlY3RlZF9hY2tlZChzZWxmKToKICAgICAgICBpdCA9IHNlbGYubWVzc2FnZXNfbGlzdC5jdXJyZW50SXRlbSgpCiAgICAgICAgaWYgaXQgaXMgTm9uZToKICAgICAgICAgICAgZm9yIGkgaW4gcmFuZ2Uoc2VsZi5tZXNzYWdlc19saXN0LmNvdW50KCktMSwgLTEsIC0xKToKICAgICAgICAgICAgICAgIGNhbmQgPSBzZWxmLm1lc3NhZ2VzX2xpc3QuaXRlbShpKQogICAgICAgICAgICAgICAgaWYgKGNhbmQuZGF0YShRdC5Vc2VyUm9sZSkgb3IgIiIpLmxvd2VyKCkgPT0gInNlbnQiOgogICAgICAgICAgICAgICAgICAgIGl0ID0gY2FuZDsgYnJlYWsKICAgICAgICBpZiBpdCBpcyBOb25lOiByZXR1cm4KICAgICAgICB0cnk6CiAgICAgICAgICAgIGl0LnNldEZvcmVncm91bmQoUUJydXNoKHNlbGYuQ09MT1JfQUNLKSkKICAgICAgICAgICAgaXQuc2V0RGF0YShRdC5Vc2VyUm9sZSwgImFja2VkIikKICAgICAgICAgICAgIyBwZXJzaXN0CiAgICAgICAgICAgIHJvdyA9IHNlbGYubWVzc2FnZXNfbGlzdC5yb3coaXQpCiAgICAgICAgICAgIGlmIDAgPD0gcm93IDwgbGVuKHNlbGYuX21lc3NhZ2VzKToKICAgICAgICAgICAgICAgIHNlbGYuX21lc3NhZ2VzW3Jvd11bJ3JvbGUnXSA9ICdhY2tlZCcKICAgICAgICAgICAgICAgIHNlbGYuX3NhdmVfbWVzc2FnZXNfdG9fc3RvcmUoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKCiAgICBkZWYgY2xlYXJfcmVjZWl2ZV93aW5kb3coc2VsZik6CiAgICAgICAgIyBDbGVhciB0aGUgVUkgbGlzdAogICAgICAgIHNlbGYubWVzc2FnZXNfbGlzdC5jbGVhcigpCiAgICAgICAgIyBDbGVhciBpbi1tZW1vcnkgaGlzdG9yeQogICAgICAgIHNlbGYuX21lc3NhZ2VzID0gW10KICAgICAgICAjIFBlcnNpc3QgZW1wdHkgaGlzdG9yeSB0byBzdG9yZS9tZXNzYWdlc192MS5qc29uCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLl9zYXZlX21lc3NhZ2VzX3RvX3N0b3JlKCkKICAgICAgICAgICAgc2VsZi5fc3RhdHVzKCJNZXNzYWdlcyBjbGVhcmVkIGFuZCBoaXN0b3J5IHJlc2V0LiIsIDMwMDApCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICMgLS0tLSBJbmNvbWluZyBGaWxlcyAoc3R1YnMpIC0tLS0KICAgIGRlZiBfaW5jb21pbmdfc2VsZWN0ZWRfc2lkKHNlbGYpOgogICAgICAgIGl0ID0gc2VsZi5pbmNvbWluZ19saXN0LmN1cnJlbnRJdGVtKCkKICAgICAgICByZXR1cm4gaXQudGV4dCgpIGlmIGl0IGVsc2UgTm9uZQogICAgZGVmIF9pbmNvbWluZ19hY2NlcHRfc2VsZWN0ZWQoc2VsZik6IHNlbGYuX3N0YXR1cygiQWNjZXB0IChzdHViKSIpCiAgICBkZWYgX2luY29taW5nX2RlY2xpbmVfc2VsZWN0ZWQoc2VsZik6IHNlbGYuX3N0YXR1cygiRGVjbGluZSAoc3R1YikiKQogICAgZGVmIF9pbmNvbWluZ19yZXNldF93aW5kb3coc2VsZik6IHNlbGYuaW5jb21pbmdfbGlzdC5jbGVhcigpOyBzZWxmLl9zdGF0dXMoIlJlc2V0IHdpbmRvdyIpCgogICAgIyAtLS0tIEZsZWV0IGFjdGlvbnMgLS0tLQogICAgZGVmIF9vbl9hY3RpdmVfZmxlZXRfY2hhbmdlZChzZWxmLCBuYW1lKToKICAgICAgICAjIEd1YXJkIGFnYWluc3QgZWFybHkgc2lnbmFsIGJlZm9yZSBtZW1iZXJfbGlzdCBleGlzdHMKICAgICAgICBpZiBub3QgaGFzYXR0cihzZWxmLCAnbWVtYmVyX2xpc3QnKToKICAgICAgICAgICAgc2VsZi5mbGVldC5zZXRfYWN0aXZlKG5hbWUpCiAgICAgICAgICAgIHJldHVybgogICAgICAgIHNlbGYuZmxlZXQuc2V0X2FjdGl2ZShuYW1lKTsgc2VsZi5fcG9wdWxhdGVfbWVtYmVyX2xpc3QoKQogICAgZGVmIF9wb3B1bGF0ZV9tZW1iZXJfbGlzdChzZWxmKToKICAgICAgICBzZWxmLm1lbWJlcl9saXN0LmNsZWFyKCkKICAgICAgICBuYW1lID0gc2VsZi5hY3RpdmVfZmxlZXRfY29tYm8uY3VycmVudFRleHQoKSBvciAiRGVmYXVsdCIKICAgICAgICBzZWxmLm1lbWJlcl9saXN0LmFkZEl0ZW1zKHNlbGYuZmxlZXQubGlzdF9tZW1iZXJzKG5hbWUpKQoKICAgIGRlZiBhZGRfZmxlZXRfZ3JvdXAoc2VsZik6CiAgICAgICAgbmFtZSwgb2sgPSBRSW5wdXREaWFsb2cuZ2V0VGV4dChzZWxmLCAiQWRkIEdyb3VwIiwgIkdyb3VwIG5hbWU6IikKICAgICAgICBpZiBvayBhbmQgbmFtZS5zdHJpcCgpOgogICAgICAgICAgICBpZiBzZWxmLmZsZWV0LmFkZF9ncm91cChuYW1lLnN0cmlwKCkpOgogICAgICAgICAgICAgICAgc2VsZi5hY3RpdmVfZmxlZXRfY29tYm8uY2xlYXIoKTsgc2VsZi5hY3RpdmVfZmxlZXRfY29tYm8uYWRkSXRlbXMoc2VsZi5mbGVldC5saXN0X2ZsZWV0X25hbWVzKCkpCiAgICAgICAgICAgICAgICBzZWxmLmFjdGl2ZV9mbGVldF9jb21iby5zZXRDdXJyZW50VGV4dChuYW1lLnN0cmlwKCkpCgogICAgZGVmIGFkZF9mbGVldF9tZW1iZXIoc2VsZik6CiAgICAgICAgY3MsIG9rID0gUUlucHV0RGlhbG9nLmdldFRleHQoc2VsZiwgIkFkZCBDYWxsc2lnbiIsICJDYWxsc2lnbjoiKQogICAgICAgIGlmIG9rIGFuZCBjcy5zdHJpcCgpOgogICAgICAgICAgICBuYW1lID0gc2VsZi5hY3RpdmVfZmxlZXRfY29tYm8uY3VycmVudFRleHQoKSBvciAiRGVmYXVsdCIKICAgICAgICAgICAgaWYgc2VsZi5mbGVldC5hZGRfbWVtYmVyKG5hbWUsIGNzKToKICAgICAgICAgICAgICAgIHNlbGYuX3BvcHVsYXRlX21lbWJlcl9saXN0KCkKCiAgICBkZWYgcmVtb3ZlX2ZsZWV0X21lbWJlcl9idG4oc2VsZik6CiAgICAgICAgaXQgPSBzZWxmLm1lbWJlcl9saXN0LmN1cnJlbnRJdGVtKCkKICAgICAgICBpZiBub3QgaXQ6IHJldHVybgogICAgICAgIG5hbWUgPSBzZWxmLmFjdGl2ZV9mbGVldF9jb21iby5jdXJyZW50VGV4dCgpIG9yICJEZWZhdWx0IgogICAgICAgIGlmIHNlbGYuZmxlZXQucmVtb3ZlX21lbWJlcihuYW1lLCBpdC50ZXh0KCkpOgogICAgICAgICAgICBzZWxmLl9wb3B1bGF0ZV9tZW1iZXJfbGlzdCgpCgogICAgIyAtLS0tIEZpbGUgdXBsb2FkIHN0dWJzIC0tLS0KICAgIGRlZiBjaG9vc2VfZmlsZV90b19zZW5kKHNlbGYpOgogICAgICAgIHBhdGgsIF8gPSBRRmlsZURpYWxvZy5nZXRPcGVuRmlsZU5hbWUoc2VsZiwgIlNlbGVjdCBmaWxlIHRvIHNlbmQiLCBhcHBfYmFzZV9kaXIoKSwgIkFsbCBGaWxlcyAoKi4qKSIpCiAgICAgICAgaWYgcGF0aDoKICAgICAgICAgICAgc2VsZi5zZWxlY3RlZF9maWxlX3BhdGggPSBwYXRoCiAgICAgICAgICAgIHRyeTogc2VsZi5maWxlX3BhdGhfZWRpdC5zZXRUZXh0KHBhdGgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgdHJ5OiBzZWxmLl9zdGF0dXMoZiJTZWxlY3RlZCBmaWxlOiB7b3MucGF0aC5iYXNlbmFtZShwYXRoKX0iLCAzMDAwKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCgogICAgZGVmIHNlbmRfc2VsZWN0ZWRfZmlsZShzZWxmKToKICAgICAgICBwYXRoID0gZ2V0YXR0cihzZWxmLCAic2VsZWN0ZWRfZmlsZV9wYXRoIiwgIiIpCiAgICAgICAgaWYgbm90IHBhdGg6CiAgICAgICAgICAgIFFNZXNzYWdlQm94LmluZm9ybWF0aW9uKHNlbGYsICJTZW5kIEZpbGUiLCAiUGxlYXNlIGNob29zZSBhIGZpbGUgZmlyc3QuIikKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgb2sgPSBzZWxmLnNlbmRfZmlsZV9wYXRoKHBhdGgpCiAgICAgICAgcmV0dXJuIGJvb2wob2spCgogICAgIyAtLS0tIEZpeGVkIEdQUyBzYXZlIC0tLS0KICAgIGRlZiBzYXZlX2ZpeGVkX2dwcyhzZWxmKToKICAgICAgICAjIEVuYWJsZSAzMC1taW51dGUgY29vcmRpbmF0ZSBiZWFjb25zIGJhc2VkIG9uIGN1cnJlbnQgZml4ZWQgbGF0L2xvbgogICAgICAgIHRyeToKICAgICAgICAgICAgbGF0X3R4dCA9IHNlbGYuZml4ZWRfbGF0X2VkaXQudGV4dCgpLnN0cmlwKCkgaWYgaGFzYXR0cihzZWxmLCAnZml4ZWRfbGF0X2VkaXQnKSBlbHNlICcnCiAgICAgICAgICAgIGxvbl90eHQgPSBzZWxmLmZpeGVkX2xvbl9lZGl0LnRleHQoKS5zdHJpcCgpIGlmIGhhc2F0dHIoc2VsZiwgJ2ZpeGVkX2xvbl9lZGl0JykgZWxzZSAnJwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGxhdF90eHQgPSAnJzsgbG9uX3R4dCA9ICcnCiAgICAgICAgbGF0X3R4dCA9IChzZWxmLmZpeGVkX2xhdF9lZGl0LnRleHQoKS5zdHJpcCgpIGlmIGhhc2F0dHIoc2VsZiwnZml4ZWRfbGF0X2VkaXQnKSBlbHNlICcnKQogICAgICAgIGxvbl90eHQgPSAoc2VsZi5maXhlZF9sb25fZWRpdC50ZXh0KCkuc3RyaXAoKSBpZiBoYXNhdHRyKHNlbGYsJ2ZpeGVkX2xvbl9lZGl0JykgZWxzZSAnJykKICAgICAgICAjIFBlcnNpc3QgdG8gSlNPTgogICAgICAgIHRyeToKICAgICAgICAgICAgbGF0X3ZhbCA9IGZsb2F0KGxhdF90eHQpIGlmIGxhdF90eHQgZWxzZSBOb25lCiAgICAgICAgICAgIGxvbl92YWwgPSBmbG9hdChsb25fdHh0KSBpZiBsb25fdHh0IGVsc2UgTm9uZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGxhdF92YWwgPSBOb25lOyBsb25fdmFsID0gTm9uZQogICAgICAgIHNhdmVfanNvbignZml4ZWRfZ3BzLmpzb24nLCB7J2xhdCc6IGxhdF90eHQsICdsb24nOiBsb25fdHh0fSkKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxhdF92YWxfZiA9IGZsb2F0KGxhdF90eHQpOyBsb25fdmFsX2YgPSBmbG9hdChsb25fdHh0KQogICAgICAgICAgICBzZWxmLl9iZWFjb25fY29vcmRzX2VuYWJsZWQgPSBUcnVlCiAgICAgICAgICAgIHNlbGYuX2JlYWNvbl9jb29yZHNfbGF0ID0gcm91bmQobGF0X3ZhbF9mLCA1KQogICAgICAgICAgICBzZWxmLl9iZWFjb25fY29vcmRzX2xvbiA9IHJvdW5kKGxvbl92YWxfZiwgNSkKICAgICAgICAgICAgaW1wb3J0IHRpbWUgYXMgX3QKICAgICAgICAgICAgc2VsZi5fYmVhY29uX2Nvb3Jkc19sYXN0X3RzID0gaW50KF90LnRpbWUoKSkKICAgICAgICAgICAgc2VsZi5fc2F2ZV9iZWFjb25fY29vcmRzX3RvX3NldHRpbmdzKFRydWUsIHNlbGYuX2JlYWNvbl9jb29yZHNfbGF0LCBzZWxmLl9iZWFjb25fY29vcmRzX2xvbiwgc2VsZi5fYmVhY29uX2Nvb3Jkc19sYXN0X3RzKQogICAgICAgICAgICAjIEZvcmNlIGltbWVkaWF0ZSBiZWFjb24gd2l0aCBjb29yZGluYXRlcyBub3c7IG5leHQgY29vcmRzIGluIDMwIG1pbnV0ZXMKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fYmVhY29uX2Nvb3Jkc19mb3JjZV9vbmNlID0gVHJ1ZQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NlbmRfYmVhY29uKCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3RvdWNoX2xhc3RfdHgoKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgICMgUG9wdWxhdGUgU2VuZCBib3ggaWYgdmFsaWQgbnVtYmVycwogICAgICAgIGlmIGxhdF92YWwgaXMgbm90IE5vbmUgYW5kIGxvbl92YWwgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIG1zZyA9IGYiR1AgUE9TIGxhdCB7bGF0X3ZhbDouNWZ9IGxvbiB7bG9uX3ZhbDouNWZ9IgogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnc2VuZF9lZGl0JykgYW5kIHNlbGYuc2VuZF9lZGl0IGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgIHNlbGYuc2VuZF9lZGl0LnNldFBsYWluVGV4dChtc2cpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLl9zdGF0dXMoZiJTYXZlZCBmaXhlZCBwb3NpdGlvbjogbGF0PXtsYXRfdHh0fSBsb249e2xvbl90eHR9IiwgMzAwMCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICBkZWYgb25fc2VuZF9ncHMoc2VsZik6CiAgICAgICAgJycnUHJlLWZsaWdodDogcmVhZCBhIHNob3J0IGJ1cnN0IGZyb20gc2VyaWFsLCBwYXJzZSBBUFJTL05NRUEsIGFuZCBwb3B1bGF0ZSBTZW5kIGJveDoKICAgICAgICAnR1AgUE9TIGxhdCBubi5ubm5ubiBsb24gbm4ubm5ubm4nLicnJwogICAgICAgICMgSGVscGVycyBsb2NhbCB0byB0aGlzIG1ldGhvZCB0byBhdm9pZCB3aWRlIHBhdGNoZXMKICAgICAgICBpbXBvcnQgcmUsIHRpbWUsIG1hdGgKICAgICAgICBkZWYgX25tZWFfZGVnKHZhbDogc3RyLCBoZW1pOiBzdHIpIC0+IGZsb2F0OgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBub3QgdmFsIG9yIG5vdCBoZW1pIG9yICcuJyBub3QgaW4gdmFsOiByZXR1cm4gZmxvYXQoJ25hbicpCiAgICAgICAgICAgICAgICBkZWdfbGVuID0gMiBpZiBoZW1pLnVwcGVyKCkgaW4gKCdOJywnUycpIGVsc2UgMwogICAgICAgICAgICAgICAgZCA9IGludCh2YWxbOmRlZ19sZW5dKTsgbSA9IGZsb2F0KHZhbFtkZWdfbGVuOl0pCiAgICAgICAgICAgICAgICBkZWMgPSBkICsgbS82MC4wCiAgICAgICAgICAgICAgICBpZiBoZW1pLnVwcGVyKCkgaW4gKCdTJywnVycpOiBkZWMgPSAtZGVjCiAgICAgICAgICAgICAgICByZXR1cm4gZGVjCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICByZXR1cm4gZmxvYXQoJ25hbicpCgogICAgICAgIE5NRUFfUk1DID0gcmUuY29tcGlsZShyJ15cJCg/OkdQfEdOfEdMfEdBKVJNQywnLCByZS5JKQogICAgICAgIE5NRUFfR0dBID0gcmUuY29tcGlsZShyJ15cJCg/OkdQfEdOfEdMfEdBKUdHQSwnLCByZS5JKQogICAgICAgIEFQUlNfQkFOR19SRSA9IHJlLmNvbXBpbGUocidbIT1AXT8oP1A8bGF0PlxkezQsNX1cLlxkKylccyooP1A8bGF0aGVtaT5bTlNdKVtcL1xcXSg/UDxsb24+XGR7NSw2fVwuXGQrKVxzKig/UDxsb25oZW1pPltFV10pJywgcmUuSSkKICAgICAgICBQT1NfRERNTV9SRSA9IHJlLmNvbXBpbGUocicoP1A8bGF0PlxkezQsNX1cLlxkKylccyooW05TXSlbLC9cc10rKD9QPGxvbj5cZHs1LDZ9XC5cZCspXHMqKFtFV10pJywgcmUuSSkKICAgICAgICBQT1NfREVDX1JFID0gcmUuY29tcGlsZShyJyg/UDxsYXQ+Wy0rXT9cZHsxLDJ9XC5cZHszLH0pWywvXHNdKyg/UDxsb24+Wy0rXT9cZHsxLDN9XC5cZHszLH0pJykKCiAgICAgICAgZGVmIF9wYXJzZV9ubWVhX2xhdGxvbihsaW5lOiBzdHIpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBOTUVBX1JNQy5tYXRjaChsaW5lKToKICAgICAgICAgICAgICAgICAgICBwID0gbGluZS5zcGxpdCgnLCcpCiAgICAgICAgICAgICAgICAgICAgaWYgbGVuKHApID49IDc6CiAgICAgICAgICAgICAgICAgICAgICAgIGxhdCA9IF9ubWVhX2RlZyhwWzNdLCBwWzRdKSBpZiBwWzNdIGFuZCBwWzRdIGVsc2UgZmxvYXQoJ25hbicpCiAgICAgICAgICAgICAgICAgICAgICAgIGxvbiA9IF9ubWVhX2RlZyhwWzVdLCBwWzZdKSBpZiBwWzVdIGFuZCBwWzZdIGVsc2UgZmxvYXQoJ25hbicpCiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBsYXQsIGxvbgogICAgICAgICAgICAgICAgaWYgTk1FQV9HR0EubWF0Y2gobGluZSk6CiAgICAgICAgICAgICAgICAgICAgcCA9IGxpbmUuc3BsaXQoJywnKQogICAgICAgICAgICAgICAgICAgIGlmIGxlbihwKSA+PSA2OgogICAgICAgICAgICAgICAgICAgICAgICBsYXQgPSBfbm1lYV9kZWcocFsyXSwgcFszXSkgaWYgcFsyXSBhbmQgcFszXSBlbHNlIGZsb2F0KCduYW4nKQogICAgICAgICAgICAgICAgICAgICAgICBsb24gPSBfbm1lYV9kZWcocFs0XSwgcFs1XSkgaWYgcFs0XSBhbmQgcFs1XSBlbHNlIGZsb2F0KCduYW4nKQogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGF0LCBsb24KICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuIGZsb2F0KCduYW4nKSwgZmxvYXQoJ25hbicpCgogICAgICAgIGRlZiBfZXh0cmFjdF9hbnlfbGF0bG9uKHRleHQ6IHN0cik6CiAgICAgICAgICAgIGlmIG5vdCB0ZXh0OgogICAgICAgICAgICAgICAgcmV0dXJuIGZsb2F0KCduYW4nKSwgZmxvYXQoJ25hbicpCiAgICAgICAgICAgIG0gPSBBUFJTX0JBTkdfUkUuc2VhcmNoKHRleHQpCiAgICAgICAgICAgIGlmIG06CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgbGF0ID0gX25tZWFfZGVnKG0uZ3JvdXAoJ2xhdCcpLCBtLmdyb3VwKCdsYXRoZW1pJykpCiAgICAgICAgICAgICAgICAgICAgbG9uID0gX25tZWFfZGVnKG0uZ3JvdXAoJ2xvbicpLCBtLmdyb3VwKCdsb25oZW1pJykpCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGxhdCwgbG9uCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgbSA9IFBPU19ERE1NX1JFLnNlYXJjaCh0ZXh0KQogICAgICAgICAgICBpZiBtOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGxhdGRtID0gbS5ncm91cCgnbGF0Jyk7IGxvbmRtID0gbS5ncm91cCgnbG9uJykKICAgICAgICAgICAgICAgICAgICBsYXRoZW1pID0gbS5ncm91cCgyKTsgICBsb25oZW1pID0gbS5ncm91cCg0KQogICAgICAgICAgICAgICAgICAgIGxhdCA9IF9ubWVhX2RlZyhsYXRkbSwgbGF0aGVtaSk7IGxvbiA9IF9ubWVhX2RlZyhsb25kbSwgbG9uaGVtaSkKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGF0LCBsb24KICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBtMiA9IFBPU19ERUNfUkUuc2VhcmNoKHRleHQpCiAgICAgICAgICAgIGlmIG0yOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGxhdCA9IGZsb2F0KG0yLmdyb3VwKCdsYXQnKSk7IGxvbiA9IGZsb2F0KG0yLmdyb3VwKCdsb24nKSkKICAgICAgICAgICAgICAgICAgICBpZiBhYnMobGF0KSA8PSA5MCBhbmQgYWJzKGxvbikgPD0gMTgwOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gbGF0LCBsb24KICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAjIFNjYW4gbGluZS1ieS1saW5lIGZvciBOTUVBCiAgICAgICAgICAgIGZvciByYXcgaW4gKHRleHQgb3IgJycpLnNwbGl0bGluZXMoKToKICAgICAgICAgICAgICAgIHMgPSByYXcuc3RyaXAoKQogICAgICAgICAgICAgICAgbHQsIGxuID0gX3BhcnNlX25tZWFfbGF0bG9uKHMpCiAgICAgICAgICAgICAgICBpZiBub3QgKG1hdGguaXNuYW4obHQpIG9yIG1hdGguaXNuYW4obG4pKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gbHQsIGxuCiAgICAgICAgICAgIHJldHVybiBmbG9hdCgnbmFuJyksIGZsb2F0KCduYW4nKQoKICAgICAgICAjIFJlcXVpcmUgc2VyaWFsIGNvbm5lY3Rpb24KICAgICAgICBpZiBub3Qgc2VsZi5fc2VyaWFsX2lzX29wZW4oKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgUU1lc3NhZ2VCb3guaW5mb3JtYXRpb24oc2VsZiwgJ0dQUycsICdDb25uZWN0IGEgQ09NIHBvcnQgZmlyc3QuJykKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgICMgRmx1c2ggYW55IG9sZCBpbnB1dCwgdGhlbiByZWFkIGJyaWVmbHkKICAgICAgICB0cnk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuc2VyLnJlc2V0X2lucHV0X2J1ZmZlcigpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGJ1ZiA9IGInJwogICAgICAgICAgICBzdGFydCA9IHRpbWUudGltZSgpCiAgICAgICAgICAgIHdoaWxlICh0aW1lLnRpbWUoKSAtIHN0YXJ0KSA8IDIuMDogICMgMnMgc25pZmYKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLnNlci5pbl93YWl0aW5nOgogICAgICAgICAgICAgICAgICAgICAgICBidWYgKz0gc2VsZi5zZXIucmVhZChzZWxmLnNlci5pbl93YWl0aW5nKQogICAgICAgICAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICAgICAgICAgIHRpbWUuc2xlZXAoMC4wNSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgdGltZS5zbGVlcCgwLjA1KQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB0ZXh0ID0gYnVmLmRlY29kZSgndXRmLTgnLCBlcnJvcnM9J3JlcGxhY2UnKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgdGV4dCA9IGJ1Zi5kZWNvZGUoJ2xhdGluMScsIGVycm9ycz0ncmVwbGFjZScpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgdGV4dCA9ICcnCgogICAgICAgIGxhdCwgbG9uID0gX2V4dHJhY3RfYW55X2xhdGxvbih0ZXh0KQogICAgICAgIGlmIG5vdCAoaXNpbnN0YW5jZShsYXQsIGZsb2F0KSBhbmQgaXNpbnN0YW5jZShsb24sIGZsb2F0KSkgb3IgKG1hdGguaXNuYW4obGF0KSBvciBtYXRoLmlzbmFuKGxvbikpOgogICAgICAgICAgICAjIEZhbGxiYWNrOiBpZiBmaXhlZCBmaWVsZHMgYXJlIHZhbGlkLCB1c2UgdGhlbQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBsYXQgPSBmbG9hdChzZWxmLmZpeGVkX2xhdF9lZGl0LnRleHQoKS5zdHJpcCgpKQogICAgICAgICAgICAgICAgbG9uID0gZmxvYXQoc2VsZi5maXhlZF9sb25fZWRpdC50ZXh0KCkuc3RyaXAoKSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIGxhdCwgbG9uID0gZmxvYXQoJ25hbicpLCBmbG9hdCgnbmFuJykKCiAgICAgICAgaWYgbWF0aC5pc25hbihsYXQpIG9yIG1hdGguaXNuYW4obG9uKSBvciBhYnMobGF0KSA+IDkwIG9yIGFicyhsb24pID4gMTgwOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLl9zdGF0dXMoJ0dQUyBwYXJzZSBmYWlsZWQuIEVudGVyIEZpeGVkIEdQUyBvciB0cnkgYWdhaW4uJywgNDAwMCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuCgogICAgICAgIG1zZyA9IGYiR1AgUE9TIGxhdCB7bGF0Oi41Zn0gbG9uIHtsb246LjVmfSIKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuc2VuZF9lZGl0LnNldFBsYWluVGV4dChtc2cpCiAgICAgICAgICAgIHNlbGYuX3N0YXR1cygnR1BTIHBvc2l0aW9uIGluc2VydGVkIGludG8gU2VuZCBib3guJywgMzAwMCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgZGVmIG9uX3Rvb2xiYXJfdGFiX2NoYW5nZWQoc2VsZiwgaWR4KToKICAgICAgICB0aXRsZSA9IHNlbGYudGFiX3dpZGdldC50YWJUZXh0KGlkeCkKICAgICAgICBpZiB0aXRsZSA9PSAiTmV0d29yayBNYXAiOgogICAgICAgICAgICBzZWxmLl9zaG93X21hcF92aWV3KCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmLl9zaG93X21haW5fdmlldygpCgogICAgZGVmIG9uX3Rvb2xiYXJfdGFiX2NoYW5nZWQoc2VsZiwgaWR4KToKICAgICAgICB0aXRsZSA9IHNlbGYudGFiX3dpZGdldC50YWJUZXh0KGlkeCkKICAgICAgICBpZiB0aXRsZSA9PSAiTmV0d29yayBNYXAiOiBzZWxmLl9zaG93X21hcF92aWV3KCkKICAgICAgICBlbHNlOiBzZWxmLl9zaG93X21haW5fdmlldygpCgogICAgIyAtLS0tIFRpbWVycyAtLS0tCiAgICAjIC0tLS0gVGltZXJzIC0tLS0KICAgIGRlZiBfc2V0dXBfdGltZXJzKHNlbGYpOgogICAgICAgIHNlbGYuYXV0b3NhdmUgPSBRVGltZXIoc2VsZik7IHNlbGYuYXV0b3NhdmUuc2V0SW50ZXJ2YWwoNjBfMDAwKTsgc2VsZi5hdXRvc2F2ZS50aW1lb3V0LmNvbm5lY3Qoc2VsZi5zYXZlX3NldHRpbmdzKTsgc2VsZi5hdXRvc2F2ZS5zdGFydCgpCiAgICAgICAgc2VsZi5iZWFjb25zX3JlZnJlc2ggPSBRVGltZXIoc2VsZik7IHNlbGYuYmVhY29uc19yZWZyZXNoLnNldEludGVydmFsKDYwXzAwMCk7IHNlbGYuYmVhY29uc19yZWZyZXNoLnRpbWVvdXQuY29ubmVjdChzZWxmLnVwZGF0ZV9iZWFjb25zX2xpc3QpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmJlYWNvbnNfcmVmcmVzaC50aW1lb3V0LmNvbm5lY3QobGFtYmRhOiBzZWxmLl9wb3NpdGlvbnNfcHJ1bmUoMzYwMCkpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHNlbGYuYmVhY29uc19yZWZyZXNoLnN0YXJ0KCkKICAgICAgICBzZWxmLmJlYWNvbl9zdGFsZV90aW1lciA9IFFUaW1lcihzZWxmKTsgc2VsZi5iZWFjb25fc3RhbGVfdGltZXIuc2V0SW50ZXJ2YWwoNjBfMDAwKTsgc2VsZi5iZWFjb25fc3RhbGVfdGltZXIudGltZW91dC5jb25uZWN0KGxhbWJkYTogc2VsZi5fY2xlYXJfZ3JhcGhfaWZfc3RhbGUoMjApKTsgc2VsZi5iZWFjb25fc3RhbGVfdGltZXIuc3RhcnQoKQogICAgZGVmIF9teWNhbGxfYmFzZShzZWxmKSAtPiBzdHI6CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gKHNlbGYubXljYWxsX2VkaXQudGV4dCgpIG9yICIiKS5zdHJpcCgpLnVwcGVyKCkuc3BsaXQoIi0iLCAxKVswXQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHJldHVybiAiIgoKICAgIGRlZiBfc2hvdWxkX2F1dG9fYWNrKHNlbGYsIHRvX2NhbGw6IHN0cikgLT4gYm9vbDoKICAgICAgICB0cnk6CiAgICAgICAgICAgIG15ID0gc2VsZi5fbXljYWxsX2Jhc2UoKQogICAgICAgICAgICBiYXNlX3RvID0gKHRvX2NhbGwgb3IgIiIpLnN0cmlwKCkudXBwZXIoKS5zcGxpdCgiLSIsIDEpWzBdCiAgICAgICAgICAgIHJldHVybiBib29sKG15IGFuZCBiYXNlX3RvID09IG15KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHJldHVybiBGYWxzZQoKICAgIGRlZiBfZGVkdXBlX2FjayhzZWxmLCBhY2tfaWQ6IHN0cikgLT4gYm9vbDoKICAgICAgICBpbXBvcnQgdGltZQogICAgICAgIG5vdyA9IHRpbWUudGltZSgpCiAgICAgICAgdHRsID0gZmxvYXQoZ2V0YXR0cihzZWxmLCAiX2Fja19zZW50X3R0bCIsIDYwMC4wKSkKICAgICAgICBsYXN0ID0gKHNlbGYuX2Fja19zZW50IG9yIHt9KS5nZXQoYWNrX2lkKQogICAgICAgIGlmIGxhc3QgYW5kIChub3cgLSBmbG9hdChsYXN0KSkgPCB0dGw6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIChzZWxmLl9hY2tfc2VudCBvciB7fSkuX19zZXRpdGVtX18oYWNrX2lkLCBub3cpCiAgICAgICAgcmV0dXJuIFRydWUKICAgIGRlZiBjaGFuZ2VFdmVudChzZWxmLCBlKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZyb20gUHlRdDUuUXRDb3JlIGltcG9ydCBRRXZlbnQsIFFUaW1lcgogICAgICAgICAgICBpZiBlLnR5cGUoKSA9PSBRRXZlbnQuV2luZG93U3RhdGVDaGFuZ2U6CiAgICAgICAgICAgICAgICAjIEFmdGVyIGFueSBzdGF0ZSBjaGFuZ2UsIHJlbG9jayBoZWlnaHQgdG8gY3VycmVudCB2YWx1ZQogICAgICAgICAgICAgICAgUVRpbWVyLnNpbmdsZVNob3QoMCwgc2VsZi5fbnVrZV9sb2NrX3NpemUpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiBzdXBlcigpLmNoYW5nZUV2ZW50KGUpCgogICAgZGVmIF9hdXRvX2Fja19pZl9uZWVkZWQoc2VsZiwgZnJtOiBzdHIsIHRvOiBzdHIsIG1zZzogc3RyKSAtPiBib29sOgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHJlIGFzIF9yZSwgemxpYgogICAgICAgICAgICBpZiBub3Qgc2VsZi5fc2hvdWxkX2F1dG9fYWNrKHRvKToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBtID0gX3JlLnNlYXJjaChyJ1xbQUNLOihbMC05QS1aXXs0LDh9KVxdJywgbXNnIG9yICIiLCBmbGFncz1fcmUuSSkKICAgICAgICAgICAgYWNrX2lkID0gKG0uZ3JvdXAoMSkudXBwZXIoKSBpZiBtIGVsc2UgTm9uZSkKICAgICAgICAgICAgaWYgbm90IGFja19pZDoKICAgICAgICAgICAgICAgIGlmIF9yZS5zZWFyY2gocicoXHNcKkFDS1xifFxzXCpBXGJ8XHNcKkFZXGIpJywgbXNnIG9yICIiLCBmbGFncz1fcmUuSSk6CiAgICAgICAgICAgICAgICAgICAgaCA9IHpsaWIuYWRsZXIzMigobXNnIG9yICIiKS5lbmNvZGUoInV0Zi04IiwgImlnbm9yZSIpKSAmIDB4RkZGRkZGRkYKICAgICAgICAgICAgICAgICAgICBhY2tfaWQgPSBmIntoOjA4WH0iWy00Ol0KICAgICAgICAgICAgaWYgbm90IGFja19pZDoKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICBpZiBub3Qgc2VsZi5fZGVkdXBlX2FjayhhY2tfaWQpOgogICAgICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgICAgIG15ID0gc2VsZi5fbXljYWxsX2Jhc2UoKQogICAgICAgICAgICBpZiBub3QgbXkgb3Igbm90IGZybToKICAgICAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICAgICByZXBseSA9IGYie2ZybX0gREUge215fSBBQ0sge2Fja19pZH0iCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIF8gPSBzZWxmLnNlbmRfdXNlcl90ZXh0KHJlcGx5KQogICAgICAgICAgICAgICAgc2VsZi5fc3RhdHVzKGYiQXV0by1BQ0sgc2VudCB0byB7ZnJtfSAoe2Fja19pZH0pIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCmRlZiBiYXNlMzYobnVtOiBpbnQpIC0+IHN0cjoKICAgIGRpZ2l0cyA9ICIwMTIzNDU2Nzg5QUJDREVGR0hJSktMTU5PUFFSU1RVVldYWVoiCiAgICBpZiBudW0gPT0gMDogcmV0dXJuICIwIgogICAgcz0iIjsgbj1hYnMoaW50KG51bSkpCiAgICB3aGlsZSBuOiBuLCByID0gZGl2bW9kKG4sMzYpOyBzID0gZGlnaXRzW3JdICsgcwogICAgcmV0dXJuIHMKCiMgPT09PT09PT0gTGlua2VkL1VubGlua2VkIEJlYWNvbiBQYW5lICsgTGluayBHcmFwaCBIZWxwZXJzID09PT09PT09CnRyeToKICAgIGZyb20gUHlRdDUuUXRXaWRnZXRzIGltcG9ydCBRV2lkZ2V0LCBRVkJveExheW91dCwgUUxhYmVsLCBRTGlzdFdpZGdldCwgUUxpc3RXaWRnZXRJdGVtCiAgICBmcm9tIFB5UXQ1LlF0Q29yZSBpbXBvcnQgUXQsIFFUaW1lcgogICAgZnJvbSBQeVF0NS5RdEd1aSBpbXBvcnQgUUJydXNoLCBRQ29sb3IKZXhjZXB0IEV4Y2VwdGlvbjoKICAgIFFXaWRnZXQgPSBvYmplY3QKCiMgV2luZG93cyBmb3IgbGluayBzdGF0dXMKTElOS19XSU5ET1dfU0VDID0gMTcgKiA2MCAgICAgICAgICAjIDE3IG1pbnV0ZXMgZm9yIExpbmtlZC9VbmxpbmtlZCBzdGF0dXMKTUFJTl9CRUFDT05fV0lORE9XX1NFQyA9IDYwICogNjAgICAjIFZpc2liaWxpdHkgd2luZG93IGZvciBiZWFjb24gcGFuZQoKZGVmIF9yY19iYXNlX2NhbGxzaWduKGNzOiBzdHIpIC0+IHN0cjoKICAgIHRyeToKICAgICAgICByZXR1cm4gYmFzZV9jYWxsc2lnbihjcykKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuIChjcyBvciAiIikuc3RyaXAoKS51cHBlcigpCgojIEJlYWNvblBhbmUgd2lkZ2V0OiBmaXhlZCB0b3AvYm90dG9tIHNwbGl0IChMaW5rZWQgdG9wIDEvMywgVW5saW5rZWQgYm90dG9tIDIvMykKY2xhc3MgQmVhY29uUGFuZShRV2lkZ2V0KToKICAgIGRlZiBfX2luaXRfXyhzZWxmLCBvd25lcik6CiAgICAgICAgc3VwZXIoKS5fX2luaXRfXygpCiAgICAgICAgc2VsZi5vd25lciA9IG93bmVyCiAgICAgICAgc2VsZi52ID0gUVZCb3hMYXlvdXQoc2VsZikKICAgICAgICBzZWxmLnYuc2V0Q29udGVudHNNYXJnaW5zKDYsNiw2LDYpCiAgICAgICAgc2VsZi52LnNldFNwYWNpbmcoNikKCiAgICAgICAgc2VsZi5sYmxfbGlua2VkID0gUUxhYmVsKCJMaW5rZWQiKQogICAgICAgIGYgPSBzZWxmLmxibF9saW5rZWQuZm9udCgpOyBmLnNldEJvbGQoVHJ1ZSk7IHNlbGYubGJsX2xpbmtlZC5zZXRGb250KGYpCiAgICAgICAgc2VsZi52LmFkZFdpZGdldChzZWxmLmxibF9saW5rZWQpCgogICAgICAgIHNlbGYubGlzdF9saW5rZWQgPSBRTGlzdFdpZGdldCgpCiAgICAgICAgc2VsZi5saXN0X2xpbmtlZC5zZXRTZWxlY3Rpb25Nb2RlKFFMaXN0V2lkZ2V0Lk5vU2VsZWN0aW9uKQogICAgICAgIHNlbGYudi5hZGRXaWRnZXQoc2VsZi5saXN0X2xpbmtlZCwgMSkgICMgdG9wIHRoaXJkCgogICAgICAgIHNlbGYubGJsX3VubGlua2VkID0gUUxhYmVsKCJVbmxpbmtlZCIpCiAgICAgICAgZnUgPSBzZWxmLmxibF91bmxpbmtlZC5mb250KCk7IGZ1LnNldEJvbGQoVHJ1ZSk7IHNlbGYubGJsX3VubGlua2VkLnNldEZvbnQoZnUpCiAgICAgICAgc2VsZi52LmFkZFdpZGdldChzZWxmLmxibF91bmxpbmtlZCkKCiAgICAgICAgc2VsZi5saXN0X3VubGlua2VkID0gUUxpc3RXaWRnZXQoKQogICAgICAgIHNlbGYubGlzdF91bmxpbmtlZC5zZXRTZWxlY3Rpb25Nb2RlKFFMaXN0V2lkZ2V0Lk5vU2VsZWN0aW9uKQogICAgICAgIHNlbGYudi5hZGRXaWRnZXQoc2VsZi5saXN0X3VubGlua2VkLCAyKSAgIyBib3R0b20gdHdvLXRoaXJkcwoKICAgICAgICBzZWxmLl9zZXRfcGxhY2Vob2xkZXJzKCkKCiAgICBkZWYgX3NldF9wbGFjZWhvbGRlcnMoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzZWxmLmxpc3RfbGlua2VkLmNsZWFyKCk7IHNlbGYubGlzdF91bmxpbmtlZC5jbGVhcigpCiAgICAgICAgICAgIGRpbSA9IFFCcnVzaChnZXRhdHRyKHNlbGYub3duZXIsICJDT0xPUl9TWVMiLCBRQ29sb3IoMTYwLDE2MCwxNjApKSkKICAgICAgICAgICAgaXQxID0gUUxpc3RXaWRnZXRJdGVtKCIiKQogICAgICAgICAgICBpdDEuc2V0Rm9yZWdyb3VuZChkaW0pOyBpdDEuc2V0RmxhZ3MoaXQxLmZsYWdzKCkgJiB+UXQuSXRlbUlzU2VsZWN0YWJsZSkKICAgICAgICAgICAgc2VsZi5saXN0X2xpbmtlZC5hZGRJdGVtKGl0MSkKICAgICAgICAgICAgaXQyID0gUUxpc3RXaWRnZXRJdGVtKCIiKQogICAgICAgICAgICBpdDIuc2V0Rm9yZWdyb3VuZChkaW0pOyBpdDIuc2V0RmxhZ3MoaXQyLmZsYWdzKCkgJiB+UXQuSXRlbUlzU2VsZWN0YWJsZSkKICAgICAgICAgICAgc2VsZi5saXN0X3VubGlua2VkLmFkZEl0ZW0oaXQyKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX2xpbmtlZF9jb2xvcihzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHJldHVybiBzZWxmLm93bmVyLl9saW5rZWRfaWNvbl9jb2xvcigpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcmV0dXJuIFFDb2xvcigwLCAyMDAsIDI1NSkKCiAgICBkZWYgcmVmcmVzaChzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZi5vd25lciwgIl9sb2FkX2xpbmtfZ3JhcGgiKToKICAgICAgICAgICAgICAgIHNlbGYub3duZXIuX2xvYWRfbGlua19ncmFwaCgpCiAgICAgICAgICAgIGdwID0gZ2V0YXR0cihzZWxmLm93bmVyLCAiX2dyYXBoX3BhcmVudHMiLCB7fSkgb3Ige30KICAgICAgICAgICAgbXkgPSBzZWxmLm93bmVyLl9teV9iYXNlKCkgaWYgaGFzYXR0cihzZWxmLm93bmVyLCAiX215X2Jhc2UiKSBlbHNlICJNWUNBTEwiCgogICAgICAgICAgICBsaW5rZWQsIHVubGlua2VkID0gW10sIFtdCiAgICAgICAgICAgIG5vdyA9IGludCh0aW1lLnRpbWUoKSkKICAgICAgICAgICAgZm9yIHAsIGVudCBpbiBncC5pdGVtcygpOgogICAgICAgICAgICAgICAgbGFzdCA9IGludChlbnQuZ2V0KCJsYXN0Iikgb3IgMCkKICAgICAgICAgICAgICAgICMgT25seSBzaG93IHBhcmVudHMgaW5zaWRlIG1haW4gd2luZG93CiAgICAgICAgICAgICAgICBpZiAobm93IC0gbGFzdCkgPiBNQUlOX0JFQUNPTl9XSU5ET1dfU0VDOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBpc19saW5rID0gRmFsc2UKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpc19saW5rID0gc2VsZi5vd25lci5faXNfcGFyZW50X2xpbmtlZChwKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAobGlua2VkIGlmIGlzX2xpbmsgZWxzZSB1bmxpbmtlZCkuYXBwZW5kKChwLCBlbnQpKQoKICAgICAgICAgICAga2V5X2xhc3QgPSBsYW1iZGEgZTogaW50KGVbMV0uZ2V0KCJsYXN0Iikgb3IgMCkKICAgICAgICAgICAgbGlua2VkLnNvcnQoa2V5PWtleV9sYXN0LCByZXZlcnNlPVRydWUpCiAgICAgICAgICAgIHVubGlua2VkLnNvcnQoa2V5PWtleV9sYXN0LCByZXZlcnNlPVRydWUpCgogICAgICAgICAgICBzZWxmLmxpc3RfbGlua2VkLmNsZWFyKCk7IHNlbGYubGlzdF91bmxpbmtlZC5jbGVhcigpCiAgICAgICAgICAgIGNvbF9saW5rID0gc2VsZi5fbGlua2VkX2NvbG9yKCkKICAgICAgICAgICAgY29sX3VubGsgPSBRQ29sb3IoMTI4LDEyOCwxMjgpCgogICAgICAgICAgICBkZWYgX2ZtdF9hZ2UodHMpOgogICAgICAgICAgICAgICAgZCA9IG1heCgwLCBpbnQodGltZS50aW1lKCkpIC0gaW50KHRzIG9yIDApKQogICAgICAgICAgICAgICAgbSwgcyA9IGRpdm1vZChkLCA2MCk7IGgsIG0gPSBkaXZtb2QobSwgNjApCiAgICAgICAgICAgICAgICBpZiBoOiByZXR1cm4gZiJ7aH1oIHttfW0iCiAgICAgICAgICAgICAgICBpZiBtOiByZXR1cm4gZiJ7bX1tIHtzfXMiCiAgICAgICAgICAgICAgICByZXR1cm4gZiJ7c31zIgoKICAgICAgICAgICAgIyBMaW5rZWQgc2VjdGlvbgogICAgICAgICAgICBpZiBsaW5rZWQ6CiAgICAgICAgICAgICAgICBmb3IgcCwgZW50IGluIGxpbmtlZDoKICAgICAgICAgICAgICAgICAgICBpdCA9IFFMaXN0V2lkZ2V0SXRlbShmIvCflJcge3B9ICAgwrcge19mbXRfYWdlKGVudC5nZXQoJ2xhc3QnKSl9IGFnbyIpCiAgICAgICAgICAgICAgICAgICAgaXQuc2V0Rm9yZWdyb3VuZChRQnJ1c2goY29sX2xpbmspKQogICAgICAgICAgICAgICAgICAgIHNlbGYubGlzdF9saW5rZWQuYWRkSXRlbShpdCkKICAgICAgICAgICAgICAgICAgICBraWRzID0gc29ydGVkKChlbnQuZ2V0KCJjaGlsZHJlbiIpIG9yIHt9KS5pdGVtcygpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAga2V5PWxhbWJkYSBrdjogaW50KGt2WzFdLmdldCgibGFzdCIpIG9yIDApLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcmV2ZXJzZT1UcnVlKQogICAgICAgICAgICAgICAgICAgIGZvciBrLCBtZXRhIGluIGtpZHM6CiAgICAgICAgICAgICAgICAgICAgICAgIGlmIF9yY19iYXNlX2NhbGxzaWduKGspID09IG15OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRfbGlua2VkID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRfbGlua2VkID0gc2VsZi5vd25lci5faXNfc3RhdGlvbl9saW5rZWQoaykKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICAgICAgcHJlZml4ID0gIiAg8J+UlyAiIGlmIGNoaWxkX2xpbmtlZCBlbHNlICIgICAgIgogICAgICAgICAgICAgICAgICAgICAgICBraXQgPSBRTGlzdFdpZGdldEl0ZW0oZiJ7cHJlZml4fXtrfSAgIMK3IHtfZm10X2FnZShtZXRhLmdldCgnbGFzdCcpKX0gYWdvIikKICAgICAgICAgICAgICAgICAgICAgICAga2l0LnNldEZvcmVncm91bmQoUUJydXNoKGNvbF9saW5rIGlmIGNoaWxkX2xpbmtlZCBlbHNlIGNvbF91bmxrKSkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5saXN0X2xpbmtlZC5hZGRJdGVtKGtpdCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGl0ID0gUUxpc3RXaWRnZXRJdGVtKCIiKQogICAgICAgICAgICAgICAgaXQuc2V0Rm9yZWdyb3VuZChRQnJ1c2goY29sX3VubGspKQogICAgICAgICAgICAgICAgaXQuc2V0RmxhZ3MoaXQuZmxhZ3MoKSAmIH5RdC5JdGVtSXNTZWxlY3RhYmxlKQogICAgICAgICAgICAgICAgc2VsZi5saXN0X2xpbmtlZC5hZGRJdGVtKGl0KQoKICAgICAgICAgICAgIyBVbmxpbmtlZCBzZWN0aW9uCiAgICAgICAgICAgIGlmIHVubGlua2VkOgogICAgICAgICAgICAgICAgZm9yIHAsIGVudCBpbiB1bmxpbmtlZDoKICAgICAgICAgICAgICAgICAgICBpdCA9IFFMaXN0V2lkZ2V0SXRlbShmIuKXiyB7cH0gICDCtyB7X2ZtdF9hZ2UoZW50LmdldCgnbGFzdCcpKX0gYWdvIikKICAgICAgICAgICAgICAgICAgICBpdC5zZXRGb3JlZ3JvdW5kKFFCcnVzaChjb2xfdW5saykpCiAgICAgICAgICAgICAgICAgICAgc2VsZi5saXN0X3VubGlua2VkLmFkZEl0ZW0oaXQpCiAgICAgICAgICAgICAgICAgICAga2lkcyA9IHNvcnRlZCgoZW50LmdldCgiY2hpbGRyZW4iKSBvciB7fSkuaXRlbXMoKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGtleT1sYW1iZGEga3Y6IGludChrdlsxXS5nZXQoImxhc3QiKSBvciAwKSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHJldmVyc2U9VHJ1ZSkKICAgICAgICAgICAgICAgICAgICBmb3IgaywgbWV0YSBpbiBraWRzOgogICAgICAgICAgICAgICAgICAgICAgICBpZiBfcmNfYmFzZV9jYWxsc2lnbihrKSA9PSBteToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkX2xpbmtlZCA9IEZhbHNlCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkX2xpbmtlZCA9IHNlbGYub3duZXIuX2lzX3N0YXRpb25fbGlua2VkKGspCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgICAgIHByZWZpeCA9ICIgICAg8J+UlyAiIGlmIGNoaWxkX2xpbmtlZCBlbHNlICIgICAgICAgIgogICAgICAgICAgICAgICAgICAgICAgICBraXQgPSBRTGlzdFdpZGdldEl0ZW0oZiJ7cHJlZml4fXtrfSAgIMK3IHtfZm10X2FnZShtZXRhLmdldCgnbGFzdCcpKX0gYWdvIikKICAgICAgICAgICAgICAgICAgICAgICAga2l0LnNldEZvcmVncm91bmQoUUJydXNoKGNvbF9saW5rIGlmIGNoaWxkX2xpbmtlZCBlbHNlIGNvbF91bmxrKSkKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5saXN0X3VubGlua2VkLmFkZEl0ZW0oa2l0KQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgaXQgPSBRTGlzdFdpZGdldEl0ZW0oIiIpCiAgICAgICAgICAgICAgICBpdC5zZXRGb3JlZ3JvdW5kKFFCcnVzaChjb2xfdW5saykpCiAgICAgICAgICAgICAgICBpdC5zZXRGbGFncyhpdC5mbGFncygpICYgflF0Lkl0ZW1Jc1NlbGVjdGFibGUpCiAgICAgICAgICAgICAgICBzZWxmLmxpc3RfdW5saW5rZWQuYWRkSXRlbShpdCkKCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgc2VsZi5fc2V0X3BsYWNlaG9sZGVycygpCgojIE1vbmtleS1wYXRjaGVkIGhlbHBlcnMgYm91bmQgdG8gQ2hhdEFwcCBhdCBydW50aW1lIChhdm9pZCBlZGl0aW5nIGNsYXNzIGJvZHkpCmRlZiBfcmNfbGlua19ncmFwaF9sb2FkKHNlbGYpOgogICAgZCA9IGxvYWRfanNvbignbGlua19ncmFwaC5qc29uJykgb3Ige30KICAgIGcgPSBkLmdldCgncGFyZW50cycpIG9yIHt9CiAgICBzZWxmLl9ncmFwaF9wYXJlbnRzID0gZyBpZiBpc2luc3RhbmNlKGcsIGRpY3QpIGVsc2Uge30KCmRlZiBfcmNfbGlua19ncmFwaF9zYXZlKHNlbGYpOgogICAgZCA9IGdldGF0dHIoc2VsZiwgIl9ncmFwaF9wYXJlbnRzIiwge30pIG9yIHt9CiAgICB0cnk6CiAgICAgICAgIyBHdWFyZDogbmV2ZXIgd2lwZSBhbiBleGlzdGluZyBmaWxlIHdpdGggZW1wdHkgY29udGVudAogICAgICAgIGlmIG5vdCBkOgogICAgICAgICAgICBwID0gb3MucGF0aC5qb2luKCdzdG9yZScsICdsaW5rX2dyYXBoLmpzb24nKSBpZiBvcy5wYXRoLmlzZGlyKCdzdG9yZScpIGVsc2UgJ2xpbmtfZ3JhcGguanNvbicKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocCk6CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICBzYXZlX2pzb24oJ2xpbmtfZ3JhcGguanNvbicsIHsicGFyZW50cyI6IGR9KQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgpkZWYgX3JjX2xpbmtfZ3JhcGhfdXBkYXRlKHNlbGYsIHBhcmVudDogc3RyLCBjaGlsZHJlbjogbGlzdCwgdHM6IGludCA9IE5vbmUpOgogICAgdHJ5OgogICAgICAgIGltcG9ydCB0aW1lIGFzIF90CiAgICAgICAgcCA9IF9yY19iYXNlX2NhbGxzaWduKHBhcmVudCkKICAgICAgICBpZiBub3QgcDogcmV0dXJuCiAgICAgICAgdHMgPSBpbnQodHMgb3IgX3QudGltZSgpKQogICAgICAgIGdwID0gZ2V0YXR0cihzZWxmLCAiX2dyYXBoX3BhcmVudHMiLCB7fSkKICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShncCwgZGljdCk6IGdwID0ge30KICAgICAgICBlbnQgPSBncC5nZXQocCkgb3IgeyJsYXN0IjogMCwgImNoaWxkcmVuIjoge319CiAgICAgICAgZW50WyJsYXN0Il0gPSB0cwogICAgICAgIGNoID0gZW50LmdldCgiY2hpbGRyZW4iKSBvciB7fQogICAgICAgIGZvciBjIGluIChjaGlsZHJlbiBvciBbXSk6CiAgICAgICAgICAgIGNjID0gX3JjX2Jhc2VfY2FsbHNpZ24oYykKICAgICAgICAgICAgaWYgbm90IGNjOiBjb250aW51ZQogICAgICAgICAgICBjZSA9IGNoLmdldChjYykgb3IgeyJsYXN0IjogMH0KICAgICAgICAgICAgY2VbImxhc3QiXSA9IHRzCiAgICAgICAgICAgIGNoW2NjXSA9IGNlCiAgICAgICAgZW50WyJjaGlsZHJlbiJdID0gY2gKICAgICAgICBncFtwXSA9IGVudAogICAgICAgIHNlbGYuX2dyYXBoX3BhcmVudHMgPSBncAogICAgICAgIF9yY19saW5rX2dyYXBoX3NhdmUoc2VsZikKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKZGVmIF9yY19pc19mcmVzaChzZWxmLCB0czogaW50LCB3aW5kb3c6IGludCk6CiAgICB0cnk6CiAgICAgICAgaWYgbm90IHRzOiByZXR1cm4gRmFsc2UKICAgICAgICBpbXBvcnQgdGltZSBhcyBfdAogICAgICAgIHJldHVybiAoaW50KF90LnRpbWUoKSkgLSBpbnQodHMpKSA8PSBpbnQod2luZG93KQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gRmFsc2UKCmRlZiBfcmNfbXlfYmFzZShzZWxmKToKICAgIHRyeToKICAgICAgICByZXR1cm4gX3JjX2Jhc2VfY2FsbHNpZ24oc2VsZi5teWNhbGxfZWRpdC50ZXh0KCkuc3RyaXAoKS51cHBlcigpKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gIk1ZQ0FMTCIKCmRlZiBfcmNfaXNfcGFyZW50X2xpbmtlZChzZWxmLCBwYXJlbnQ6IHN0cikgLT4gYm9vbDoKICAgIHRyeToKICAgICAgICBncCA9IGdldGF0dHIoc2VsZiwgIl9ncmFwaF9wYXJlbnRzIiwge30pIG9yIHt9CiAgICAgICAgZW50ID0gZ3AuZ2V0KF9yY19iYXNlX2NhbGxzaWduKHBhcmVudCkpIG9yIHt9CiAgICAgICAgbXkgPSBfcmNfbXlfYmFzZShzZWxmKQogICAgICAgIGNoaWxkID0gKGVudC5nZXQoImNoaWxkcmVuIikgb3Ige30pLmdldChteSkgb3Ige30KICAgICAgICByZXR1cm4gX3JjX2lzX2ZyZXNoKHNlbGYsIGNoaWxkLmdldCgibGFzdCIpLCBMSU5LX1dJTkRPV19TRUMpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiBGYWxzZQoKZGVmIF9yY19pc19zdGF0aW9uX2xpbmtlZChzZWxmLCBjYWxsc2lnbjogc3RyKSAtPiBib29sOgogICAgcmV0dXJuIF9yY19pc19wYXJlbnRfbGlua2VkKHNlbGYsIGNhbGxzaWduIG9yICcnKQoKZGVmIF9yY19saW5rZWRfaWNvbl9jb2xvcihzZWxmKToKICAgIHRyeToKICAgICAgICBubSA9IChnZXRhdHRyKHNlbGYsICJ0aGVtZV9uYW1lIiwgIiIpIG9yICIiKS5sb3dlcigpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIG5tID0gIiIKICAgIGlmICJkYXJrIGdyZWVuIiBpbiBubTogcmV0dXJuIFFDb2xvcigxMjQsMjUyLDApCiAgICBpZiAiZGFyayByZWQiIGluIG5tOiAgIHJldHVybiBRQ29sb3IoMjU1LDc3LDc3KQogICAgcmV0dXJuIFFDb2xvcigwLDEyOCwyNTUpCgpkZWYgX3JjX2luc3RhbGxfYmVhY29uX3BhbmUoc2VsZik6CiAgICAjIGJpbmQgaGVscGVycyBpZiBub3QgYWxyZWFkeQogICAgZm9yIG5hbWUsIGZuIGluIHsKICAgICAgICAiX2xvYWRfbGlua19ncmFwaCI6IF9yY19saW5rX2dyYXBoX2xvYWQsCiAgICAgICAgIl9zYXZlX2xpbmtfZ3JhcGgiOiBfcmNfbGlua19ncmFwaF9zYXZlLAogICAgICAgICJfdXBkYXRlX2xpbmtfZ3JhcGgiOiBfcmNfbGlua19ncmFwaF91cGRhdGUsCiAgICAgICAgIl9pc19mcmVzaCI6IF9yY19pc19mcmVzaCwKICAgICAgICAiX215X2Jhc2UiOiBfcmNfbXlfYmFzZSwKICAgICAgICAiX2lzX3BhcmVudF9saW5rZWQiOiBfcmNfaXNfcGFyZW50X2xpbmtlZCwKICAgICAgICAiX2lzX3N0YXRpb25fbGlua2VkIjogX3JjX2lzX3N0YXRpb25fbGlua2VkLAogICAgICAgICJfbGlua2VkX2ljb25fY29sb3IiOiBfcmNfbGlua2VkX2ljb25fY29sb3IsCiAgICB9Lml0ZW1zKCk6CiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgbmFtZSk6CiAgICAgICAgICAgIHRyeTogc2V0YXR0cihzZWxmLCBuYW1lLCBmbi5fX2dldF9fKHNlbGYsIHNlbGYuX19jbGFzc19fKSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwoKICAgICMgQ3JlYXRlIHRoZSBwYW5lIGlmIG5vdCBwcmVzZW50CiAgICB0cnk6CiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgImJlYWNvbl9wYW5lIikgb3Igc2VsZi5iZWFjb25fcGFuZSBpcyBOb25lOgogICAgICAgICAgICBzZWxmLmJlYWNvbl9wYW5lID0gQmVhY29uUGFuZShzZWxmKQogICAgICAgICAgICAjIFRyeSB0byBlbWJlZCBpbiBhbiBleGlzdGluZyBsZWZ0IGNvbHVtbjsgaWYgd2UgY2FuJ3QgZmluZCBpdCwgZG9jayBpdC4KICAgICAgICAgICAgZG9jayA9IFFEb2NrV2lkZ2V0KCJCZWFjb25zIiwgc2VsZikKICAgICAgICAgICAgZG9jay5zZXRGZWF0dXJlcyhRRG9ja1dpZGdldC5Eb2NrV2lkZ2V0TW92YWJsZSB8IFFEb2NrV2lkZ2V0LkRvY2tXaWRnZXRGbG9hdGFibGUpCiAgICAgICAgICAgIGRvY2suc2V0QWxsb3dlZEFyZWFzKFF0LkxlZnREb2NrV2lkZ2V0QXJlYSB8IFF0LlJpZ2h0RG9ja1dpZGdldEFyZWEpCiAgICAgICAgICAgIGRvY2suc2V0V2lkZ2V0KHNlbGYuYmVhY29uX3BhbmUpCiAgICAgICAgICAgIHNlbGYuYWRkRG9ja1dpZGdldChRdC5MZWZ0RG9ja1dpZGdldEFyZWEsIGRvY2spCiAgICAgICAgICAgIHNlbGYuX2JlYWNvbl9kb2NrID0gZG9jawogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgogICAgIyBSZWZyZXNoIHRpbWVyCiAgICB0cnk6CiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgIl9iZWFjb25fcmVmcmVzaF90aW1lciIpOgogICAgICAgICAgICBzZWxmLl9iZWFjb25fcmVmcmVzaF90aW1lciA9IFFUaW1lcihzZWxmKQogICAgICAgICAgICBzZWxmLl9iZWFjb25fcmVmcmVzaF90aW1lci50aW1lb3V0LmNvbm5lY3QobGFtYmRhOiBnZXRhdHRyKHNlbGYuYmVhY29uX3BhbmUsICJyZWZyZXNoIiwgbGFtYmRhOiBOb25lKSgpKQogICAgICAgICAgICBzZWxmLl9iZWFjb25fcmVmcmVzaF90aW1lci5zdGFydCgxNTAwMCkgICMgMTVzICAjIDYwcwogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgogICAgIyBJbml0aWFsIHJlZnJlc2gKICAgIHRyeToKICAgICAgICBzZWxmLl9sb2FkX2xpbmtfZ3JhcGgoKQogICAgICAgIHNlbGYuYmVhY29uX3BhbmUucmVmcmVzaCgpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHBhc3MKCiAgICAjIFRyeSB0byBwYXRjaCB0aGUgbWFwIHdpdGggYmFkZ2VzIGFmdGVyIGl0IGhhcyBiZWVuIGNyZWF0ZWQKICAgIGRlZiBfdHJ5X3BhdGNoX2xpbmttYXAoKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGxtID0gZ2V0YXR0cihzZWxmLCAibGlua21hcCIsIE5vbmUpCiAgICAgICAgICAgIGlmIGxtIGlzIE5vbmU6CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgIyBhdHRhY2ggYW4gaXNfbGlua2VkIGNhbGxhYmxlCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGxtLmlzX2xpbmtlZCA9IGxhbWJkYSBjczogX3JjX2lzX3N0YXRpb25fbGlua2VkKHNlbGYsIGNzKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgIyBXcmFwIGRyYXdfZ3JhcGggdG8gYWRkIGJhZGdlcyBhZnRlciBkcmF3aW5nCiAgICAgICAgICAgIGlmIG5vdCBoYXNhdHRyKGxtLCAiX3JjX2JhZGdlX3dyYXBwZWQiKToKICAgICAgICAgICAgICAgIG9yaWcgPSBsbS5kcmF3X2dyYXBoCiAgICAgICAgICAgICAgICBkZWYgX3dyYXBwZWQoKToKICAgICAgICAgICAgICAgICAgICByZXMgPSBvcmlnKCkKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICMgTm90aGluZyBlbHNlIHRvIGRvIGhlcmU7IExpbmtNYXBXaWRnZXQgc2hvdWxkIHVzZSBpc19saW5rZWQgd2hlbiBjcmVhdGluZyBsYWJlbHMuCiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIHJlcwogICAgICAgICAgICAgICAgbG0uZHJhd19ncmFwaCA9IF93cmFwcGVkCiAgICAgICAgICAgICAgICBsbS5fcmNfYmFkZ2Vfd3JhcHBlZCA9IFRydWUKICAgICAgICAgICAgIyB0cmlnZ2VyIGEgcmVkcmF3IG5vdwogICAgICAgICAgICB0cnk6IGxtLmRyYXdfZ3JhcGgoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgIHRyeToKICAgICAgICAjIFRyeSBub3cgYW5kIGFnYWluIGluIGEgbW9tZW50IGluIGNhc2UgbWFwIGNvbnN0cnVjdHMgbGF0ZQogICAgICAgIF90cnlfcGF0Y2hfbGlua21hcCgpCiAgICAgICAgUVRpbWVyLnNpbmdsZVNob3QoMTUwMCwgX3RyeV9wYXRjaF9saW5rbWFwKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgojIEJpbmQgaW5zdGFsbGVyIHRvIENoYXRBcHAgb24gaW1wb3J0CnRyeToKICAgIENoYXRBcHAuX2luc3RhbGxfYmVhY29uX3BhbmUgPSBfcmNfaW5zdGFsbF9iZWFjb25fcGFuZQpleGNlcHQgRXhjZXB0aW9uOgogICAgcGFzcwojID09PT09PT09IFBhdGNoOiBCZWFjb25zIEhlYXJkIGxpc3Qgd2l0aCBMaW5rZWQgaWNvbnMgJiBwcmlvcml0eSBvcmRlcmluZyAobm8gaGVhZGVycykgPT09PT09PT0KZGVmIF9yY19yZWZyZXNoX2JlYWNvbnNfaWNvbnMoc2VsZik6CiAgICAnJycKICAgIERyYXcgdGhlICdCZWFjb25zIEhlYXJkJyBsaXN0IGFzIGEgc2luZ2xlIGxpc3Q6CiAgICAgIC0gUGFyZW50cyBvcmRlcmVkOiBMaW5rZWQgKGZyZXNoKSBmaXJzdCwgdGhlbiBVbmxpbmtlZCwgZWFjaCBuZXdlc3QtZmlyc3QKICAgICAgLSBQcmVmaXggZWFjaCBwYXJlbnQgd2l0aCDwn5SXIGlmIGxpbmtlZCAod2l0aGluIDE3IG1pbiksIGVsc2Ug4peLCiAgICAgIC0gVW5kZXIgZWFjaCBwYXJlbnQsIGxpc3QgY2hpbGRyZW4gKGV4Y2x1ZGluZyAvTVlDQUxMKTsgcHJlZml4IGNoaWxkIPCflJcgaWYgaW5kZXBlbmRlbnRseSBsaW5rZWQKICAgICcnJwogICAgdHJ5OgogICAgICAgICMgRmluZCBhIGxpa2VseSBsaXN0IHdpZGdldCBmb3IgQmVhY29ucyBIZWFyZAogICAgICAgIGxzdCA9IE5vbmUKICAgICAgICBmb3IgYXR0ciBpbiAoJ2JlYWNvbnNfbGlzdCcsICdiZWFjb25fbGlzdCcsICdiZWFjb25zSGVhcmRMaXN0JywgJ2xpc3RfYmVhY29ucycsICdiZWFjb25zX2xpc3Rfd2lkZ2V0Jyk6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgYXR0cik6CiAgICAgICAgICAgICAgICBsc3QgPSBnZXRhdHRyKHNlbGYsIGF0dHIpCiAgICAgICAgICAgICAgICBicmVhawogICAgICAgIGlmIGxzdCBpcyBOb25lOgogICAgICAgICAgICByZXR1cm4gICMgbm90aGluZyB0byBkcmF3IGludG8KCiAgICAgICAgIyBFbnN1cmUgZ3JhcGggbG9hZGVkCiAgICAgICAgdHJ5OiBzZWxmLl9sb2FkX2xpbmtfZ3JhcGgoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICBncCA9IGdldGF0dHIoc2VsZiwgJ19ncmFwaF9wYXJlbnRzJywge30pIG9yIHt9CgogICAgICAgIG15ID0gc2VsZi5fbXlfYmFzZSgpIGlmIGhhc2F0dHIoc2VsZiwgJ19teV9iYXNlJykgZWxzZSAnTVlDQUxMJwoKICAgICAgICAjIFBhcnRpdGlvbiBwYXJlbnRzIGFuZCBzb3J0CiAgICAgICAgbm93ID0gaW50KHRpbWUudGltZSgpKQogICAgICAgIGRlZiBmcmVzaCh0cywgd2luKTogCiAgICAgICAgICAgIHRyeTogcmV0dXJuIChub3cgLSBpbnQodHMgb3IgMCkpIDw9IGludCh3aW4pCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHJldHVybiBGYWxzZQoKICAgICAgICBsaW5rZWQsIHVubGlua2VkID0gW10sIFtdCiAgICAgICAgZm9yIHAsIGVudCBpbiBncC5pdGVtcygpOgogICAgICAgICAgICBsYXN0ID0gaW50KGVudC5nZXQoJ2xhc3QnKSBvciAwKQogICAgICAgICAgICBpZiBub3QgZnJlc2gobGFzdCwgTUFJTl9CRUFDT05fV0lORE9XX1NFQyk6CiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAobGlua2VkIGlmIHNlbGYuX2lzX3BhcmVudF9saW5rZWQocCkgZWxzZSB1bmxpbmtlZCkuYXBwZW5kKChwLCBlbnQpKQoKICAgICAgICBrZXlfbGFzdCA9IGxhbWJkYSBlOiBpbnQoZVsxXS5nZXQoJ2xhc3QnKSBvciAwKQogICAgICAgIGxpbmtlZC5zb3J0KGtleT1rZXlfbGFzdCwgcmV2ZXJzZT1UcnVlKQogICAgICAgIHVubGlua2VkLnNvcnQoa2V5PWtleV9sYXN0LCByZXZlcnNlPVRydWUpCgogICAgICAgICMgVGhlbWUgY29sb3VycwogICAgICAgIGZyb20gUHlRdDUuUXRHdWkgaW1wb3J0IFFCcnVzaCwgUUNvbG9yCiAgICAgICAgY29sX2xpbmsgPSBzZWxmLl9saW5rZWRfaWNvbl9jb2xvcigpIGlmIGhhc2F0dHIoc2VsZiwgJ19saW5rZWRfaWNvbl9jb2xvcicpIGVsc2UgUUNvbG9yKDAsMjAwLDI1NSkKICAgICAgICBjb2xfdW5sayA9IFFDb2xvcigxMjgsMTI4LDEyOCkKICAgICAgICBjb2xfcGFyZW50ID0gZ2V0YXR0cihzZWxmLCAnQ09MT1JfUlgnLCBRQ29sb3IoMjU1LDE2NSwwKSkgICMgZmFsbCBiYWNrIHRvIG9yYW5nZSBmb3IgdGV4dAoKICAgICAgICBkZWYgZm10X2FnZSh0cyk6CiAgICAgICAgICAgIGQgPSBtYXgoMCwgbm93IC0gaW50KHRzIG9yIDApKQogICAgICAgICAgICBtID0gZCAvLyA2MAogICAgICAgICAgICBoLCBtID0gZGl2bW9kKG0sIDYwKQogICAgICAgICAgICByZXR1cm4gZiJ7aH1oIHttfW0iIGlmIGggZWxzZSBmInttfW0iCgogICAgICAgIGxzdC5jbGVhcigpCgogICAgICAgICMgUmVuZGVyIGEgZ3JvdXAgKGZpcnN0IGxpbmtlZCwgdGhlbiB1bmxpbmtlZCkKICAgICAgICBkZWYgcmVuZGVyX2dyb3VwKGdyb3VwLCBsaW5rZWRfZmxhZyk6CiAgICAgICAgICAgIGZvciBwLCBlbnQgaW4gZ3JvdXA6CiAgICAgICAgICAgICAgICAjIHBhcmVudCBsaW5lCiAgICAgICAgICAgICAgICBpY29uID0gIvCflJciIGlmIGxpbmtlZF9mbGFnIGVsc2UgIuKXiyIKICAgICAgICAgICAgICAgIGl0ID0gUUxpc3RXaWRnZXRJdGVtKGYie2ljb259IHtwfSAgIMK3IHtmbXRfYWdlKGVudC5nZXQoJ2xhc3QnKSl9IGFnbyIpCiAgICAgICAgICAgICAgICBpdC5zZXRGb3JlZ3JvdW5kKFFCcnVzaChjb2xfbGluayBpZiBsaW5rZWRfZmxhZyBlbHNlIGNvbF9wYXJlbnQpKQogICAgICAgICAgICAgICAgbHN0LmFkZEl0ZW0oaXQpCiAgICAgICAgICAgICAgICAjIGNoaWxkcmVuCiAgICAgICAgICAgICAgICBraWRzID0gc29ydGVkKChlbnQuZ2V0KCdjaGlsZHJlbicpIG9yIHt9KS5pdGVtcygpLCBrZXk9bGFtYmRhIGt2OiBpbnQoa3ZbMV0uZ2V0KCdsYXN0Jykgb3IgMCksIHJldmVyc2U9VHJ1ZSkKICAgICAgICAgICAgICAgIGZvciBrLCBtZXRhIGluIGtpZHM6CiAgICAgICAgICAgICAgICAgICAgaWYgYmFzZV9jYWxsc2lnbihrKSA9PSBteToKICAgICAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICAgICBjaGlsZF9saW5rZWQgPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgY2hpbGRfbGlua2VkID0gc2VsZi5faXNfc3RhdGlvbl9saW5rZWQoaykKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICAgICAgcHJlZml4ID0gIiAg8J+UlyAiIGlmIGNoaWxkX2xpbmtlZCBlbHNlICIgICAgICIKICAgICAgICAgICAgICAgICAgICBraXQgPSBRTGlzdFdpZGdldEl0ZW0oZiJ7cHJlZml4fXtrfSAgIMK3IHtmbXRfYWdlKG1ldGEuZ2V0KCdsYXN0JykpfSBhZ28iKQogICAgICAgICAgICAgICAgICAgIGtpdC5zZXRGb3JlZ3JvdW5kKFFCcnVzaChjb2xfbGluayBpZiBjaGlsZF9saW5rZWQgZWxzZSBjb2xfdW5saykpCiAgICAgICAgICAgICAgICAgICAgbHN0LmFkZEl0ZW0oa2l0KQoKICAgICAgICByZW5kZXJfZ3JvdXAobGlua2VkLCBUcnVlKQogICAgICAgIHJlbmRlcl9ncm91cCh1bmxpbmtlZCwgRmFsc2UpCgogICAgICAgICMgSWYgZW1wdHksIGxlYXZlIGxpc3QgYmxhbmsgKG5vIHBsYWNlaG9sZGVyKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAjIG5ldmVyIGJyZWFrIFVJCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIG1pbmltYWwgZmFsbGJhY2s6IGNsZWFyCiAgICAgICAgICAgIGxzdCA9IGdldGF0dHIoc2VsZiwgJ2JlYWNvbnNfbGlzdCcsIE5vbmUpCiAgICAgICAgICAgIGlmIGxzdDogbHN0LmNsZWFyKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIGlmIGxzdDogbHN0LmNsZWFyKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgpkZWYgX3JjX2luc3RhbGxfYmVhY29uX2ljb25zX3JlZnJlc2goc2VsZik6CiAgICAjIEVuc3VyZSBoZWxwZXJzIHByZXNlbnQKICAgIGZvciBuYW1lLCBmbiBpbiB7CiAgICAgICAgIl9sb2FkX2xpbmtfZ3JhcGgiOiBfcmNfbGlua19ncmFwaF9sb2FkLAogICAgICAgICJfc2F2ZV9saW5rX2dyYXBoIjogX3JjX2xpbmtfZ3JhcGhfc2F2ZSwKICAgICAgICAiX3VwZGF0ZV9saW5rX2dyYXBoIjogX3JjX2xpbmtfZ3JhcGhfdXBkYXRlLAogICAgICAgICJfaXNfZnJlc2giOiBfcmNfaXNfZnJlc2gsCiAgICAgICAgIl9teV9iYXNlIjogX3JjX215X2Jhc2UsCiAgICAgICAgIl9pc19wYXJlbnRfbGlua2VkIjogX3JjX2lzX3BhcmVudF9saW5rZWQsCiAgICAgICAgIl9pc19zdGF0aW9uX2xpbmtlZCI6IF9yY19pc19zdGF0aW9uX2xpbmtlZCwKICAgICAgICAiX2xpbmtlZF9pY29uX2NvbG9yIjogX3JjX2xpbmtlZF9pY29uX2NvbG9yLAogICAgfS5pdGVtcygpOgogICAgICAgIGlmIG5vdCBoYXNhdHRyKHNlbGYsIG5hbWUpOgogICAgICAgICAgICB0cnk6IHNldGF0dHIoc2VsZiwgbmFtZSwgZm4uX19nZXRfXyhzZWxmLCBzZWxmLl9fY2xhc3NfXykpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKCiAgICAjIEluc3RhbGwgcmVmcmVzaGVyCiAgICB0cnk6CiAgICAgICAgc2VsZi5fcmVmcmVzaF9iZWFjb25zX3VpID0gX3JjX3JlZnJlc2hfYmVhY29uc19pY29ucy5fX2dldF9fKHNlbGYsIHNlbGYuX19jbGFzc19fKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgogICAgIyBUaW1lciBmb3IgYXV0by1yZWZyZXNoIGVhY2ggNjBzCiAgICB0cnk6CiAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgIl9iZWFjb25fcmVmcmVzaF90aW1lciIpOgogICAgICAgICAgICBmcm9tIFB5UXQ1LlF0Q29yZSBpbXBvcnQgUVRpbWVyCiAgICAgICAgICAgIHNlbGYuX2JlYWNvbl9yZWZyZXNoX3RpbWVyID0gUVRpbWVyKHNlbGYpCiAgICAgICAgICAgIHNlbGYuX2JlYWNvbl9yZWZyZXNoX3RpbWVyLnRpbWVvdXQuY29ubmVjdChsYW1iZGE6IGdldGF0dHIoc2VsZiwgIl9yZWZyZXNoX2JlYWNvbnNfdWkiLCBsYW1iZGE6IE5vbmUpKCkpCiAgICAgICAgICAgIHNlbGYuX2JlYWNvbl9yZWZyZXNoX3RpbWVyLnN0YXJ0KDE1MDAwKSAgIyAxNXMKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKICAgICMgSW5pdGlhbCBjYWxsCiAgICB0cnk6CiAgICAgICAgc2VsZi5fcmVmcmVzaF9iZWFjb25zX3VpKCkKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKIyBCaW5kIGluc3RhbGxlcgp0cnk6CiAgICBDaGF0QXBwLl9pbnN0YWxsX2JlYWNvbl9pY29uc19yZWZyZXNoID0gX3JjX2luc3RhbGxfYmVhY29uX2ljb25zX3JlZnJlc2gKZXhjZXB0IEV4Y2VwdGlvbjoKICAgIHBhc3MKIyA9PT09PT09PSBFbmQgUGF0Y2ggPT09PT09PT0KCiMgPT09PT09PT0gRW5kIEJlYWNvbiBQYW5lIGJsb2NrID09PT09PT09CgojID09PT09PT09IERpc2FibGUgQmVhY29uUGFuZSBkb2NrICh1c2Ugb25seSByaWdodC1zaWRlIEJlYWNvbnMgSGVhcmQgbGlzdCkgPT09PT09PT0KZGVmIF9yY19kaXNhYmxlX2JlYWNvbl9wYW5lKHNlbGYpOgogICAgdHJ5OgogICAgICAgICMgSWYgYSBwcmV2aW91cyBidWlsZCBjcmVhdGVkIGEgZG9jaywgY2xvc2UgYW5kIHJlbW92ZSBpdAogICAgICAgIGRvY2sgPSBnZXRhdHRyKHNlbGYsICJfYmVhY29uX2RvY2siLCBOb25lKQogICAgICAgIGlmIGRvY2sgaXMgbm90IE5vbmU6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRvY2suY2xvc2UoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkb2NrLnNldFBhcmVudChOb25lKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBkZWxhdHRyKHNlbGYsICJfYmVhY29uX2RvY2siKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICMgQWxzbyBkcm9wIGFueSBiZWFjb25fcGFuZSB3aWRnZXQgcmVmZXJlbmNlCiAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAiYmVhY29uX3BhbmUiKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgdyA9IGdldGF0dHIoc2VsZiwgImJlYWNvbl9wYW5lIiwgTm9uZSkKICAgICAgICAgICAgICAgIGlmIHcgaXMgbm90IE5vbmUgYW5kIGhhc2F0dHIodywgInNldFBhcmVudCIpOgogICAgICAgICAgICAgICAgICAgIHcuc2V0UGFyZW50KE5vbmUpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGRlbGF0dHIoc2VsZiwgImJlYWNvbl9wYW5lIikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKdHJ5OgogICAgQ2hhdEFwcC5faW5zdGFsbF9iZWFjb25fcGFuZSA9IF9yY19kaXNhYmxlX2JlYWNvbl9wYW5lCmV4Y2VwdCBFeGNlcHRpb246CiAgICBwYXNzCiMgPT09PT09PT0gRW5kIGRpc2FibGUgYmxvY2sgPT09PT09PT0KCmRlZiBtYWluKCk6CiAgICBpbXBvcnQgc3lzLCBvcywgdHJhY2ViYWNrCiAgICBwcmludCgnW0JPT1RdIHN0YXJ0JykKICAgIHRyeToKICAgICAgICBwcmludCgnW0JPT1RdIFFBcHBsaWNhdGlvbicpCiAgICAgICAgYXBwID0gUUFwcGxpY2F0aW9uKHN5cy5hcmd2KQogICAgICAgIHByaW50KCdbQk9PVF0gQ2hhdEFwcCgpJykKICAgICAgICB3ID0gQ2hhdEFwcCgpCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3Ll9pbnN0YWxsX2JlYWNvbl9wYW5lKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3Ll9pbnN0YWxsX2JlYWNvbl9pY29uc19yZWZyZXNoKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmcm9tIFB5UXQ1LlF0Q29yZSBpbXBvcnQgUVRpbWVyCiAgICAgICAgICAgIFFUaW1lci5zaW5nbGVTaG90KDUwMCwgbGFtYmRhOiBnZXRhdHRyKHcsICdfcmVmcmVzaF9iZWFjb25zX3VpJywgbGFtYmRhOiBOb25lKSgpKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZyb20gUHlRdDUuUXRDb3JlIGltcG9ydCBRVGltZXIKICAgICAgICAgICAgaWYgaGFzYXR0cih3LCAnX2xpbmtfZ3JhcGhfcHJ1bmUnKToKICAgICAgICAgICAgICAgIHcuX2xpbmtfZ3JhcGhfcHJ1bmUoZXhwaXJ5X3NlYz0zNjAwKQogICAgICAgICAgICAgICAgdy5fbGdfcHJ1bmVfdGltZXIgPSBRVGltZXIodykKICAgICAgICAgICAgICAgIHcuX2xnX3BydW5lX3RpbWVyLnRpbWVvdXQuY29ubmVjdChsYW1iZGE6IHcuX2xpbmtfZ3JhcGhfcHJ1bmUoZXhwaXJ5X3NlYz0zNjAwKSkKICAgICAgICAgICAgICAgIHcuX2xnX3BydW5lX3RpbWVyLnN0YXJ0KDEwICogNjAgKiAxMDAwKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgcHJpbnQoJ1tCT09UXSBzaG93IHdpbmRvdycpCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3LnNob3dNYXhpbWl6ZWQoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHcuc2hvdygpCiAgICAgICAgcHJpbnQoJ1tCT09UXSBlbnRlcmluZyBldmVudCBsb29wJykKICAgICAgICBzeXMuZXhpdChhcHAuZXhlY18oKSkKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludCgnW0JPT1RdW0VSUk9SXScsIGUpCiAgICAgICAgdGIgPSB0cmFjZWJhY2suZm9ybWF0X2V4YygpCiAgICAgICAgdHJ5OgogICAgICAgICAgICB3aXRoIG9wZW4ob3MucGF0aC5qb2luKGFwcF9iYXNlX2RpcigpLCAnc3RhcnR1cF9lcnJvci5sb2cnKSwgJ3cnLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICAgICAgZi53cml0ZSh0YikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBRTWVzc2FnZUJveC5jcml0aWNhbChOb25lLCAnU3RhcnR1cCBlcnJvcicsICdBbiBlcnJvciBvY2N1cnJlZCBkdXJpbmcgc3RhcnR1cC5cbicgKyBzdHIoZSkpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJhaXNlCgppZiBfX25hbWVfXyA9PSAiX19tYWluX18iOgogICAgbWFpbigpCgoKIyA9PT09PT09PSBNb25rZXlwYXRjaDogRjNfTE9PU0VfUlggKG5vIG1vbml0b3IvY29uc29sZSBpbiBNZXNzYWdlczsgYWNjZXB0IGFueSBSWCkgPT09PT09PT0KdHJ5OgogICAgaW1wb3J0IHRpbWUgYXMgX3QsIHJlIGFzIF9yZSwganNvbiBhcyBfanNvbgoKICAgIGRlZiBfZjNfcGVyc2lzdF9tZXNzYWdlKGtpbmQsIHRleHRfbGluZSk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBlbnRyeSA9IHsKICAgICAgICAgICAgICAgICJkaXIiOiAiVFgiIGlmIGtpbmQgPT0gInR4IiBlbHNlICgiU1lTIiBpZiBraW5kID09ICJzeXMiIGVsc2UgIlJYIiksCiAgICAgICAgICAgICAgICAidGV4dCI6IHN0cih0ZXh0X2xpbmUgb3IgIiIpLAogICAgICAgICAgICAgICAgInRzIjogX19pbXBvcnRfXygnZGF0ZXRpbWUnKS5kYXRldGltZS5ub3coX19pbXBvcnRfXygnZGF0ZXRpbWUnKS50aW1lem9uZS51dGMpLmlzb2Zvcm1hdCh0aW1lc3BlYz0nc2Vjb25kcycpLnJlcGxhY2UoJyswMDowMCcsJ1onKQogICAgICAgICAgICB9CiAgICAgICAgICAgIGRhdGEgPSBsb2FkX2pzb24oJ21lc3NhZ2VzX3YxLmpzb24nKSBvciB7fQogICAgICAgICAgICBtc2dzID0gZGF0YS5nZXQoJ21lc3NhZ2VzJykgaWYgaXNpbnN0YW5jZShkYXRhLCBkaWN0KSBlbHNlIE5vbmUKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UobXNncywgbGlzdCk6IG1zZ3MgPSBbXQogICAgICAgICAgICBtc2dzLmFwcGVuZChlbnRyeSkKICAgICAgICAgICAgc2F2ZV9qc29uKCdtZXNzYWdlc192MS5qc29uJywgeyJ2ZXJzaW9uIjoxLCAibWVzc2FnZXMiOm1zZ3N9KQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX2YzX3JlZ2lzdGVyX3NlbnQoYXBwLCB0ZXh0KToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIG5vdCBoYXNhdHRyKGFwcCwgJ3JlY2VudF9zZW50Jyk6IGFwcC5yZWNlbnRfc2VudCA9IFtdCiAgICAgICAgICAgIG5vdyA9IF90LnRpbWUoKQogICAgICAgICAgICAjIGtlZXAgM3Mgd2luZG93CiAgICAgICAgICAgIHdpbiA9IGdldGF0dHIoYXBwLCAnZWNob193aW5kb3dfcycsIDMuMCkKICAgICAgICAgICAgYXBwLnJlY2VudF9zZW50ID0gW2l0IGZvciBpdCBpbiBhcHAucmVjZW50X3NlbnQgaWYgbm93IC0gaXQuZ2V0KCd0cycsIDApIDw9IHdpbl0KICAgICAgICAgICAgYXBwLnJlY2VudF9zZW50LmFwcGVuZCh7J3RzJzogbm93LCAnZnVsbCc6ICh0ZXh0IG9yICcnKS5zdHJpcCgpfSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgZGVmIF9mM19pc19zZWxmX2VjaG8oYXBwLCBsaW5lKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIG5vdyA9IF90LnRpbWUoKQogICAgICAgICAgICBsaW4gPSAobGluZSBvciAnJykuc3RyaXAoKQogICAgICAgICAgICB3aW4gPSBnZXRhdHRyKGFwcCwgJ2VjaG9fd2luZG93X3MnLCAzLjApCiAgICAgICAgICAgIGZvciBpdCBpbiBsaXN0KGdldGF0dHIoYXBwLCAncmVjZW50X3NlbnQnLCBbXSkgb3IgW10pOgogICAgICAgICAgICAgICAgaWYgbm93IC0gaXQuZ2V0KCd0cycsIDApIDw9IHdpbjoKICAgICAgICAgICAgICAgICAgICBpZiBsaW4gPT0gKGl0LmdldCgnZnVsbCcpIG9yICcnKS5zdHJpcCgpOgogICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAjIFdyYXAgc2VuZCB0byByZWdpc3RlciBlY2hvICsgcGVyc2lzdCBUWCAobm8gY2hhbmdlIHRvIHlvdXIgYWN0dWFsIHNlbmQgbWVjaGFuaWNzKQogICAgaWYgaGFzYXR0cihDaGF0QXBwLCAnc2VuZF91c2VyX3RleHQnKToKICAgICAgICBfRjNfT1JJR19TRU5EID0gQ2hhdEFwcC5zZW5kX3VzZXJfdGV4dAogICAgICAgIGRlZiBfRjNfU0VORF9XUkFQKHNlbGYsIHRleHQpOgogICAgICAgICAgICB0cnk6IF9mM19wZXJzaXN0X21lc3NhZ2UoJ3R4JywgdGV4dCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICBvayA9IF9GM19PUklHX1NFTkQoc2VsZiwgdGV4dCkKICAgICAgICAgICAgdHJ5OiBfZjNfcmVnaXN0ZXJfc2VudChzZWxmLCB0ZXh0KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgIHJldHVybiBvawogICAgICAgIENoYXRBcHAuc2VuZF91c2VyX3RleHQgPSBfRjNfU0VORF9XUkFQCgogICAgIyBIZWxwZXIgdG8gYXBwZW5kIHRvIE1lc3NhZ2VzIChSWCkgYW5kIHBlcnNpc3QKICAgIGRlZiBfZjNfYXBwZW5kX3J4KHNlbGYsIGxpbmUpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnX2FwcGVuZF9yeCcpOiBzZWxmLl9hcHBlbmRfcngobGluZSkKICAgICAgICAgICAgZWxpZiBoYXNhdHRyKHNlbGYsICdfYXBwZW5kX3J4X3VpX29ubHknKTogc2VsZi5fYXBwZW5kX3J4X3VpX29ubHkobGluZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgdHJ5OiBfZjNfcGVyc2lzdF9tZXNzYWdlKCdyeCcsIGxpbmUpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwoKICAgICMgQ29uc29sZS9tb25pdG9yIGhldXJpc3RpY3MgKGV4Y2x1ZGUgZnJvbSBNZXNzYWdlcykKICAgIF9GM19NT05JVE9SX1BBVCA9IF9yZS5jb21waWxlKAogICAgICAgIHInXihcXFtNT05cXF18XFxbS0lTU1xcXXxcXFtBUFJTXFxdfFxcW1JYXFxdfGZtXFxzK1xcdytcXHMrdG9cXHMrXFx3K1xccytjdGxcXHMrLio/XFxzK3BpZFxccytGMCknLCBfcmUuSSkKCiAgICBkZWYgX0YzX29uX3NlcmlhbF90aHJlYWRfbGluZShzZWxmLCBsaW5lOiBzdHIpOgogICAgICAgICMgZGUtZHVwIHdpdGhpbiAzMDAgbXMKICAgICAgICB0cnk6CiAgICAgICAgICAgIG5vd20gPSBfdC5tb25vdG9uaWMoKQogICAgICAgICAgICByYXcgPSAobGluZSBvciAnJykKICAgICAgICAgICAgaWYgZ2V0YXR0cihzZWxmLCAnX2xhc3RfcmVjdl9saW5lJywgTm9uZSkgPT0gcmF3IGFuZCAobm93bSAtIGdldGF0dHIoc2VsZiwgJ19sYXN0X3JlY3ZfbW9ubycsIDAuMCkpIDw9IDAuMzoKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICBzZWxmLl9sYXN0X3JlY3ZfbGluZSA9IHJhdzsgc2VsZi5fbGFzdF9yZWN2X21vbm8gPSBub3dtCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICBzID0gKGxpbmUgb3IgJycpLnN0cmlwKCkKICAgICAgICBpZiBub3QgczogCiAgICAgICAgICAgIHJldHVybgoKICAgICAgICAjIERyb3Agc2VsZi1lY2hvCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBfZjNfaXNfc2VsZl9lY2hvKHNlbGYsIHMpOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICAgICAjIElnbm9yZSBjb25zb2xlL21vbml0b3IgZnJhbWVzIGVudGlyZWx5IGZvciBNZXNzYWdlcwogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgX0YzX01PTklUT1JfUEFULnNlYXJjaChzKToKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgIyBMb29zZSBhY2NlcHQ6IGFueSBvdGhlciBsaW5lIGlzIGEgcmVjZWl2ZWQgY2hhdCBsaW5lCiAgICAgICAgc2VsZi5fZjNfYXBwZW5kX3J4KHMpCgogICAgIyBQYXRjaCBpdCBpbgogICAgQ2hhdEFwcC5fb25fc2VyaWFsX3RocmVhZF9saW5lID0gX0YzX29uX3NlcmlhbF90aHJlYWRfbGluZQoKZXhjZXB0IEV4Y2VwdGlvbiBhcyBfZV9mMzoKICAgIHRyeToKICAgICAgICBkaWFnX2xvZyhmIkYzX0xPT1NFX1JYIHBhdGNoIGZhaWxlZDoge19lX2YzfSIpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHBhc3MKCiMgPT09PT09PT0gRW5kIE1vbmtleXBhdGNoIEYzX0xPT1NFX1JYID09PT09PT09CgoKCiMgPT09PT09PT0gTW9ua2V5cGF0Y2g6IEY0X1JFTU9WRV9NT05JVE9SX0FMTCA9PT09PT09PQp0cnk6CiAgICBkZWYgX2Y0X2Rpc2FibGVfbW9uaXRvcl9hbGwoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIEhpZGUgdGhlIGNoZWNrYm94IGlmIGl0IGV4aXN0cwogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdtb25pdG9yX2FsbF9jaGVjaycpIGFuZCBOb25lOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIE5vbmUuaGlkZSgpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgIyBSZW1vdmUgYW55IG1lbnUgYWN0aW9uIG5hbWVkICJNb25pdG9yIEFsbCIgaWYgcHJlc2VudAogICAgICAgICAgICBmb3IgYXR0ciBpbiBkaXIoc2VsZik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgb2JqID0gZ2V0YXR0cihzZWxmLCBhdHRyKQogICAgICAgICAgICAgICAgICAgIG5hbWUgPSBnZXRhdHRyKG9iaiwgJ3RleHQnLCBOb25lKQogICAgICAgICAgICAgICAgICAgIGlmIGNhbGxhYmxlKG5hbWUpIGFuZCAnbW9uaXRvcicgaW4gKG9iai50ZXh0KCkgb3IgJycpLmxvd2VyKCk6CiAgICAgICAgICAgICAgICAgICAgICAgIHRyeTogb2JqLnNldFZpc2libGUoRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAjIFJlcGxhY2UgYW55IHRvZ2dsZSBoYW5kbGVyIHdpdGggYSBuby1vcAogICAgZGVmIF9mNF9vbl9tb25pdG9yX2FsbF90b2dnbGVkKHNlbGYsIGNoZWNrZWQpOgogICAgICAgICMgSW50ZW50aW9uYWxseSBkaXNhYmxlZCB0byBwcmV2ZW50IGNvbmZ1c2lvbgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fc3RhdHVzKCJNb25pdG9yIEFsbCByZW1vdmVkIGluIHYxLjQuODEuRjQiLCAyMDAwKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4KCiAgICAjIFBhdGNoIG9udG8gQ2hhdEFwcAogICAgQ2hhdEFwcC5fb25fbW9uaXRvcl9hbGxfdG9nZ2xlZCA9IF9mNF9vbl9tb25pdG9yX2FsbF90b2dnbGVkCiAgICAjIENhbGwgdGhlIGRpc2FibGUgcm91dGluZSBvbmNlIHRoZSB3aW5kb3cgaXMgY29uc3RydWN0ZWQ7IHRyeSB0byBydW4gc29vbiBhZnRlciBjbGFzcyBsb2FkCiAgICBfb3JpZ19pbml0ID0gZ2V0YXR0cihDaGF0QXBwLCAiX19pbml0X18iLCBOb25lKQogICAgaWYgY2FsbGFibGUoX29yaWdfaW5pdCk6CiAgICAgICAgZGVmIF9pbml0X3dyYXAoc2VsZiwgKmEsICoqa3cpOgogICAgICAgICAgICBfb3JpZ19pbml0KHNlbGYsICphLCAqKmt3KQogICAgICAgICAgICB0cnk6IF9mNF9kaXNhYmxlX21vbml0b3JfYWxsKHNlbGYpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICBDaGF0QXBwLl9faW5pdF9fID0gX2luaXRfd3JhcAoKZXhjZXB0IEV4Y2VwdGlvbiBhcyBfZV9mNDoKICAgIHRyeToKICAgICAgICBkaWFnX2xvZyhmIkY0X1JFTU9WRV9NT05JVE9SX0FMTCBwYXRjaCBmYWlsZWQ6IHtfZV9mNH0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgojID09PT09PT09IEVuZCBNb25rZXlwYXRjaCBGNF9SRU1PVkVfTU9OSVRPUl9BTEwgPT09PT09PT0KCgoKIyA9PT09PT09PSBNb25rZXlwYXRjaDogRjVfTk9fTU9OSVRPUl9OT19CRUFDT04gPT09PT09PT0KIyBHb2FsczoKIyAgLSBBYnNvbHV0ZWx5IG5vIG1vbml0b3IvY29uc29sZSBmcmFtZXMgaW4gTWVzc2FnZXMuCiMgIC0gQmVhY29ucyAoVFggb3IgUlgpIG5ldmVyIGFwcGVhciBpbiBNZXNzYWdlcy4KIyAgLSBNZXNzYWdlcyBzaG93cyBvbmx5IFRYIChncmVlbikgYW5kIFJYIChvcmFuZ2UpIGNoYXQgbGluZXMuCnRyeToKICAgIGltcG9ydCB0aW1lIGFzIF90LCByZSBhcyBfcmUKCiAgICAjIFBhdHRlcm5zIHRvIGV4Y2x1ZGUgZnJvbSBNZXNzYWdlcwogICAgX0Y1X01PTl9QQVQgPSBfcmUuY29tcGlsZSgKICAgICAgICByJ14oXFxbWzAtOV17NH0tWzAtOV17Mn0tWzAtOV17Mn1bXlxcXV0qXFxdXFxzKik/XFxbTU9OXFxdfCcgICAgIyBbdGltZXN0YW1wXSBbTU9OXSAuLi4KICAgICAgICByJ14oXFxbS0lTU1xcXXxcXFtBUFJTXFxdfFxcW1JYXFxdKVxcYnwnICAgICAgICAgICAgICAgICAgICAgICAgIyBbS0lTU10gW0FQUlNdIFtSWF0KICAgICAgICByJ1xcYmZtXFxzK1tBLVowLTkvKy1dK1xccyt0b1xccytbQS1aMC05LystXStcXHMrY3RsXFxzKy4qP1xcYnBpZFxcYicsIF9yZS5JKQoKICAgIF9GNV9CRUFDT05fUEFUID0gX3JlLmNvbXBpbGUoCiAgICAgICAgcideKFxcLlxcLnwhfC98PSl8XFxbcG9zaXRpb25cXGJ8XFxiUE9TOicsIF9yZS5JKSAgIyAuLlBBUkVOVCAuLi4gLCBvciBBUFJTLWxpa2UgIS89LCBvciBbcG9zaXRpb25dL1BPUzoKICAgIAogICAgZGVmIF9mNV9pc19tb25pdG9yX2ZyYW1lKHM6IHN0cikgLT4gYm9vbDoKICAgICAgICByZXR1cm4gYm9vbChfRjVfTU9OX1BBVC5zZWFyY2gocyBvciAiIikpCgogICAgZGVmIF9mNV9pc19iZWFjb25fbGluZShzOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgcmV0dXJuIGJvb2woX0Y1X0JFQUNPTl9QQVQuc2VhcmNoKChzIG9yICIiKS5zdHJpcCgpKSkKCiAgICAjIEVuc3VyZSBVSS1vbmx5IGFwcGVuZGVyIGlzIGEgTk8tT1Agc28gbm90aGluZyBsZWFrcyBpbiBmcm9tIGNvbnNvbGUgcGF0aHMKICAgIGRlZiBfZjVfYXBwZW5kX3J4X3VpX29ubHlfbm9vcChzZWxmLCBzKToKICAgICAgICByZXR1cm4gICMgZG8gbm90IGRpc3BsYXkgY29uc29sZSB0ZXh0IGluIE1lc3NhZ2VzCgogICAgIyBSZXBsYWNlIFVJLW9ubHkgYXBwZW5kZXIgaWYgcHJlc2VudAogICAgaWYgaGFzYXR0cihDaGF0QXBwLCAnX2FwcGVuZF9yeF91aV9vbmx5Jyk6CiAgICAgICAgQ2hhdEFwcC5fYXBwZW5kX3J4X3VpX29ubHkgPSBfZjVfYXBwZW5kX3J4X3VpX29ubHlfbm9vcAoKICAgICMgV3JhcCBzZW5kIHRvIHNraXAgcGVyc2lzdGluZy9lY2hvLXJlZ2lzdGVyIGZvciBiZWFjb24gdGV4dAogICAgaWYgaGFzYXR0cihDaGF0QXBwLCAnc2VuZF91c2VyX3RleHQnKToKICAgICAgICBfRjVfT1JJR19TRU5EID0gQ2hhdEFwcC5zZW5kX3VzZXJfdGV4dAogICAgICAgIGRlZiBfRjVfU0VORF9XUkFQKHNlbGYsIHRleHQpOgogICAgICAgICAgICBzID0gKHRleHQgb3IgIiIpLnN0cmlwKCkKICAgICAgICAgICAgaXNfYmVhY29uID0gX2Y1X2lzX2JlYWNvbl9saW5lKHMpCiAgICAgICAgICAgIGlmIG5vdCBpc19iZWFjb246CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgIyByZWdpc3RlciBmb3IgZWNobyBzdXBwcmVzc2lvbiBpZiBlYXJsaWVyIHBhdGNoZXMgdXNlIGl0CiAgICAgICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAncmVjZW50X3NlbnQnKToKICAgICAgICAgICAgICAgICAgICAgICAgbm93ID0gX3QudGltZSgpCiAgICAgICAgICAgICAgICAgICAgICAgIHdpbiA9IGdldGF0dHIoc2VsZiwgJ2VjaG9fd2luZG93X3MnLCAzLjApCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYucmVjZW50X3NlbnQgPSBbaXQgZm9yIGl0IGluIHNlbGYucmVjZW50X3NlbnQgaWYgbm93IC0gaXQuZ2V0KCd0cycsIDApIDw9IHdpbl0KICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5yZWNlbnRfc2VudC5hcHBlbmQoeyd0cyc6IG5vdywgJ2Z1bGwnOiBzfSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gX0Y1X09SSUdfU0VORChzZWxmLCB0ZXh0KQogICAgICAgIENoYXRBcHAuc2VuZF91c2VyX3RleHQgPSBfRjVfU0VORF9XUkFQCgogICAgIyBPdmVycmlkZSBSWCBoYW5kbGVyIHRvIGZpbHRlciBzdHJpY3RseQogICAgX0Y1X09MRF9SWCA9IGdldGF0dHIoQ2hhdEFwcCwgIl9vbl9zZXJpYWxfdGhyZWFkX2xpbmUiLCBOb25lKQogICAgZGVmIF9GNV9SWChzZWxmLCBsaW5lOiBzdHIpOgogICAgICAgIHMgPSAobGluZSBvciAiIikuc3RyaXAoKQogICAgICAgIGlmIG5vdCBzOgogICAgICAgICAgICByZXR1cm4KICAgICAgICAjIERyb3AgZHVwbGljYXRlcyB3aXRoaW4gMzAwbXMsIGlmIGJhc2Ugc3RvcmVkIHRob3NlIGF0dHJzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBub3dtID0gX3QubW9ub3RvbmljKCkKICAgICAgICAgICAgaWYgZ2V0YXR0cihzZWxmLCAiX2xhc3RfcmVjdl9saW5lIiwgTm9uZSkgPT0gcyBhbmQgKG5vd20gLSBnZXRhdHRyKHNlbGYsICJfbGFzdF9yZWN2X21vbm8iLCAwLjApKSA8PSAwLjM6CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgc2VsZi5fbGFzdF9yZWN2X2xpbmUgPSBzOyBzZWxmLl9sYXN0X3JlY3ZfbW9ubyA9IG5vd20KICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgIyBIYXJkIGZpbHRlcnMKICAgICAgICBpZiBfZjVfaXNfbW9uaXRvcl9mcmFtZShzKToKICAgICAgICAgICAgcmV0dXJuICAjIG5ldmVyIHNob3cgbW9uaXRvci9jb25zb2xlCiAgICAgICAgaWYgX2Y1X2lzX2JlYWNvbl9saW5lKHMpOgogICAgICAgICAgICAjIHN0aWxsIGFsbG93IGludGVybmFsIGJlYWNvbiBzY2FubmVycyB0byBydW4gaWYgcHJlc2VudAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICJfc2Nhbl9mb3JfYmVhY29uX2xpbmUiKToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zY2FuX2Zvcl9iZWFjb25fbGluZShzKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gICMgZG8gbm90IHByaW50IGJlYWNvbnMgaW4gTWVzc2FnZXMKICAgICAgICAjIEVjaG8gc3VwcHJlc3Npb24gaWYgcmVjZW50X3NlbnQgZXhpc3RzCiAgICAgICAgdHJ5OgogICAgICAgICAgICBub3cgPSBfdC50aW1lKCkKICAgICAgICAgICAgZm9yIGl0IGluIGxpc3QoZ2V0YXR0cihzZWxmLCAicmVjZW50X3NlbnQiLCBbXSkgb3IgW10pOgogICAgICAgICAgICAgICAgaWYgbm93IC0gaXQuZ2V0KCJ0cyIsIDApIDw9IGdldGF0dHIoc2VsZiwgImVjaG9fd2luZG93X3MiLCAzLjApOgogICAgICAgICAgICAgICAgICAgIGlmIHMgPT0gKGl0LmdldCgiZnVsbCIpIG9yICIiKToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgICMgRmluYWxseSBhcHBlbmQgYXMgUlgKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgIl9hcHBlbmRfcngiKToKICAgICAgICAgICAgICAgIHNlbGYuX2FwcGVuZF9yeChzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICAjIE9wdGlvbmFsOiBpZiBwZXJzaXN0ZW5jZSBoZWxwZXJzIGV4aXN0IGZyb20gcHJldmlvdXMgcGF0Y2hlcywgdGhleSB3aWxsIHJ1biBpbnNpZGUgX2FwcGVuZF9yeAoKICAgIENoYXRBcHAuX29uX3NlcmlhbF90aHJlYWRfbGluZSA9IF9GNV9SWAoKZXhjZXB0IEV4Y2VwdGlvbiBhcyBfZV9mNToKICAgIHRyeToKICAgICAgICBkaWFnX2xvZyhmIkY1X05PX01PTklUT1JfTk9fQkVBQ09OIHBhdGNoIGZhaWxlZDoge19lX2Y1fSIpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHBhc3MKCiMgPT09PT09PT0gRW5kIE1vbmtleXBhdGNoIEY1X05PX01PTklUT1JfTk9fQkVBQ09OID09PT09PT09CgoKCiMgPT09PT09PT0gTW9ua2V5cGF0Y2g6IEY2X01PTl9PTl9ISURERU5fU0FOSVRJWkUgPT09PT09PT0KIyBHb2FsczoKIyAgLSBGb3JjZSAiTW9uaXRvciBBbGwgVHJhZmZpYyIgT04gYnV0IGhpZGUvZGlzYWJsZSBpdHMgVUkgc28gdXNlciBpc24ndCBjb25mdXNlZC4KIyAgLSBLZWVwIHJlY2VpdmluZyBhcyBiZWZvcmUsIGJ1dCBNZXNzYWdlcyBzaG93cyBPTkxZIFRYIChncmVlbikgYW5kIFJYIChvcmFuZ2UpIGNoYXQuCiMgIC0gU3RyaXAgYW55ICJbTU9OXSIgdG9rZW5zIGlmIHRoZXkgc2xpcCB0aHJvdWdoLgojICAtIE5ldmVyIHNob3cgY29uc29sZS9pbnN0cnVjdGlvbiBmcmFtZXMgKEtJU1MvQVBSUy9mbSAuLi4gY3RsIC4uLiBwaWQgRjAsIHRuYy9jbWQgbGluZXMpLgojICAtIE5ldmVyIHNob3cgYmVhY29ucyBpbiBNZXNzYWdlcy4KdHJ5OgogICAgaW1wb3J0IHRpbWUgYXMgX3QsIHJlIGFzIF9yZSwganNvbiBhcyBfanNvbgoKICAgIGRlZiBfZjZfZm9yY2VfbW9uaXRvcl9vbl9hbmRfaGlkZShzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUGVyc2lzdCBtb25pdG9yX2FsbCB0cnVlIGluIHNldHRpbmdzCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHMgPSBzZWxmLl9zZXR0aW5nc19nZXQoKQogICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzLCBkaWN0KToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zZXR0aW5nc19zZXQocykKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgIyBJbnN0YWxsIHdyYXBwZXIgaW4gX19pbml0X18gdG8gZm9yY2UgT04gYW5kIGhpZGUKICAgIF9GNl9PUklHX0lOSVQgPSBnZXRhdHRyKENoYXRBcHAsICJfX2luaXRfXyIsIE5vbmUpCiAgICBpZiBjYWxsYWJsZShfRjZfT1JJR19JTklUKToKICAgICAgICBkZWYgX0Y2X0lOSVRfV1JBUChzZWxmLCAqYSwgKiprdyk6CiAgICAgICAgICAgIF9GNl9PUklHX0lOSVQoc2VsZiwgKmEsICoqa3cpCiAgICAgICAgICAgIHRyeTogX2Y2X2ZvcmNlX21vbml0b3Jfb25fYW5kX2hpZGUoc2VsZikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgIENoYXRBcHAuX19pbml0X18gPSBfRjZfSU5JVF9XUkFQCgogICAgIyBNYWtlIGFueSBtb25pdG9yIHRvZ2dsZWQgaGFuZGxlciBhIG5vLW9wCiAgICBkZWYgX2Y2X29uX21vbml0b3JfYWxsX3RvZ2dsZWQoc2VsZiwgY2hlY2tlZCk6CiAgICAgICAgcmV0dXJuCiAgICBDaGF0QXBwLl9vbl9tb25pdG9yX2FsbF90b2dnbGVkID0gX2Y2X29uX21vbml0b3JfYWxsX3RvZ2dsZWQKCgogICAgIyBFeGNsdXNpb24gcGF0dGVybnMgKGNvbnNvbGUvbW9uaXRvciArIGJlYWNvbnMpCiAgICBfRjZfTU9OX1BBVCA9IF9yZS5jb21waWxlKAogICAgICAgIHInXihcXFtbMC05XXs0fS1bMC05XXsyfS1bMC05XXsyfVteXFxdXSpcXF1cXHMqKT9cXFtNT05cXF18JyAgICAjIFt0aW1lc3RhbXBdIFtNT05dCiAgICAgICAgcideKFxcW0tJU1NcXF18XFxbQVBSU1xcXXxcXFtSWFxcXSlcXGJ8JyAgICAgICAgICAgICAgICAgICAgICAgICMgW0tJU1NdL1tBUFJTXS9bUlhdCiAgICAgICAgcidcXGJmbVxccytbQS1aMC05LystXStcXHMrdG9cXHMrW0EtWjAtOS8rLV0rXFxzK2N0bFxccysuKj9cXGJwaWRcXGJ8JyAgIyBmbSAuLi4gdG8gLi4uIGN0bCAuLi4gcGlkCiAgICAgICAgcideKHRuY1s6Pl18Y21kWzo+XSknLCBfcmUuSSkKCiAgICBfRjZfQkVBQ09OX1BBVCA9IF9yZS5jb21waWxlKHInXihcXC5cXC58IXwvfD0pfFxcW3Bvc2l0aW9uXFxifFxcYlBPUzonLCBfcmUuSSkKCiAgICBkZWYgX2Y2X2lzX21vbml0b3JfZnJhbWUoczogc3RyKSAtPiBib29sOgogICAgICAgIHJldHVybiBib29sKF9GNl9NT05fUEFULnNlYXJjaChzIG9yICIiKSkKCiAgICBkZWYgX2Y2X2lzX2JlYWNvbl9saW5lKHM6IHN0cikgLT4gYm9vbDoKICAgICAgICByZXR1cm4gYm9vbChfRjZfQkVBQ09OX1BBVC5zZWFyY2goKHMgb3IgIiIpLnN0cmlwKCkpKQoKICAgICMgU2FuaXRpemUgaGVscGVyOiByZW1vdmUgbGl0ZXJhbCAiW01PTl0iIHRva2VucyBpZiBhbnkgbWFkZSBpdCBpbnRvIG1lc3NhZ2UgdGV4dAogICAgZGVmIF9mNl9zYW5pdGl6ZV90ZXh0KHM6IHN0cikgLT4gc3RyOgogICAgICAgIHRyeToKICAgICAgICAgICAgcyA9IHMucmVwbGFjZSgnW01PTl0gJywgJycpLnJlcGxhY2UoJ1tNT05dJywgJycpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgIHJldHVybiBzCgogICAgIyBPdmVycmlkZSBSWCBoYW5kbGVyIHRvIHNhbml0aXplIGFuZCBmaWx0ZXIKICAgIF9GNl9PTERfUlggPSBnZXRhdHRyKENoYXRBcHAsICJfb25fc2VyaWFsX3RocmVhZF9saW5lIiwgTm9uZSkKICAgIGRlZiBfRjZfUlgoc2VsZiwgbGluZTogc3RyKToKICAgICAgICBzID0gKGxpbmUgb3IgJycpLnN0cmlwKCkKICAgICAgICBpZiBub3QgczoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgIyBkZS1kdXAgYnJpZWYgcmVwZWF0cwogICAgICAgIHRyeToKICAgICAgICAgICAgbm93bSA9IF90Lm1vbm90b25pYygpCiAgICAgICAgICAgIGlmIGdldGF0dHIoc2VsZiwgIl9sYXN0X3JlY3ZfbGluZSIsIE5vbmUpID09IHMgYW5kIChub3dtIC0gZ2V0YXR0cihzZWxmLCAiX2xhc3RfcmVjdl9tb25vIiwgMC4wKSkgPD0gMC4zOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgIHNlbGYuX2xhc3RfcmVjdl9saW5lID0gczsgc2VsZi5fbGFzdF9yZWN2X21vbm8gPSBub3dtCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgICMgRHJvcCBjb25zb2xlL21vbml0b3IgZnJhbWVzIGZyb20gTWVzc2FnZXMgYnV0IHN0aWxsIGFsbG93IHNjYW5uZXJzIHRvIHJ1bgogICAgICAgIGlmIF9mNl9pc19tb25pdG9yX2ZyYW1lKHMpOgogICAgICAgICAgICAjIEFsbG93IGJlYWNvbiBzY2FubmVyIHRvIHVwZGF0ZSBpbnRlcm5hbHMgaWYgbmVlZGVkLCBidXQgZG8gbm90IHByaW50CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgIl9zY2FuX2Zvcl9iZWFjb25fbGluZSIpOgogICAgICAgICAgICAgICAgICAgIHNlbGYuX3NjYW5fZm9yX2JlYWNvbl9saW5lKHMpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybgogICAgICAgICMgRHJvcCBiZWFjb25zIGVudGlyZWx5IGZyb20gTWVzc2FnZXMgKHN0aWxsIHNjYW4pCiAgICAgICAgaWYgX2Y2X2lzX2JlYWNvbl9saW5lKHMpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICJfc2Nhbl9mb3JfYmVhY29uX2xpbmUiKToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9zY2FuX2Zvcl9iZWFjb25fbGluZShzKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4KICAgICAgICAjIEVjaG8gc3VwcHJlc3Npb24gKDNzIHdpbmRvdyBpZiByZWNlbnRfc2VudCBleGlzdHMpCiAgICAgICAgdHJ5OgogICAgICAgICAgICBub3cgPSBfdC50aW1lKCkKICAgICAgICAgICAgZm9yIGl0IGluIGxpc3QoZ2V0YXR0cihzZWxmLCAicmVjZW50X3NlbnQiLCBbXSkgb3IgW10pOgogICAgICAgICAgICAgICAgaWYgbm93IC0gaXQuZ2V0KCJ0cyIsIDApIDw9IGdldGF0dHIoc2VsZiwgImVjaG9fd2luZG93X3MiLCAzLjApOgogICAgICAgICAgICAgICAgICAgIGlmIHMgPT0gKGl0LmdldCgiZnVsbCIpIG9yICIiKToKICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgICMgU2FuaXRpemUgYW5kIGFwcGVuZCBhcyBSWAogICAgICAgIHMgPSBfZjZfc2FuaXRpemVfdGV4dChzKQogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAiX2FwcGVuZF9yeCIpOgogICAgICAgICAgICAgICAgc2VsZi5fYXBwZW5kX3J4KHMpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgIENoYXRBcHAuX29uX3NlcmlhbF90aHJlYWRfbGluZSA9IF9GNl9SWAoKZXhjZXB0IEV4Y2VwdGlvbiBhcyBfZV9mNjoKICAgIHRyeToKICAgICAgICBkaWFnX2xvZyhmIkY2X01PTl9PTl9ISURERU5fU0FOSVRJWkUgcGF0Y2ggZmFpbGVkOiB7X2VfZjZ9IikKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKIyA9PT09PT09PSBFbmQgTW9ua2V5cGF0Y2ggRjZfTU9OX09OX0hJRERFTl9TQU5JVElaRSA9PT09PT09PQoKCgojID09PT09PT09IE1vbmtleXBhdGNoOiBGN19BTExPV19BUFJTX01FU1NBR0VTX1JBVyA9PT09PT09PQp0cnk6CiAgICBpbXBvcnQgcmUgYXMgX3JlCgogICAgIyBEZXRlY3QgQVBSUyB0ZXh0IG1lc3NhZ2VzIChub3QgcG9zaXRpb25zKTogbG9vayBmb3IgJzo6VE9DQUxMIDp0ZXh0JyBwYXR0ZXJuCiAgICBfRjdfQVBSU19NU0dfUEFUID0gX3JlLmNvbXBpbGUocicoOjpccypbQS1aMC05XC1dezEsOX1ccyo6W15cclxuXSspJykKCiAgICBkZWYgX2Y3X2lzX2FwcnNfbWVzc2FnZShzOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgc3MgPSAocyBvciAiIikKICAgICAgICAjIE1vc3QgbG9ncyBwcmVmaXggQVBSUyBmcmFtZXMgd2l0aCBbQVBSU107IGFjY2VwdCBib3RoIHdpdGggYW5kIHdpdGhvdXQKICAgICAgICBpZiAiW0FQUlNdIiBpbiBzcyBvciBzcy51cHBlcigpLnN0YXJ0c3dpdGgoIkFQUlM6Iikgb3IgIiBBUFJTICIgaW4gc3MudXBwZXIoKToKICAgICAgICAgICAgcmV0dXJuIGJvb2woX0Y3X0FQUlNfTVNHX1BBVC5zZWFyY2goc3MpKQogICAgICAgICMgRmFsbGJhY2s6IG5ha2VkIEFQUlMgbWVzc2FnZSBwYXR0ZXJuIHdpdGhvdXQgYW55IHRhZ3MKICAgICAgICByZXR1cm4gYm9vbChfRjdfQVBSU19NU0dfUEFULnNlYXJjaChzcykpCgogICAgIyBFeHRlbmQgc2FuaXRpemVyIHRvIHN0cmlwIFtBUFJTXSB0b2tlbiBhcyB3ZWxsCiAgICBkZWYgX2Y3X3Nhbml0aXplX2FwcnNfdG9rZW5zKHM6IHN0cikgLT4gc3RyOgogICAgICAgIHRyeToKICAgICAgICAgICAgcyA9IHMucmVwbGFjZSgnW0FQUlNdICcsICcnKS5yZXBsYWNlKCdbQVBSU10nLCAnJykKICAgICAgICAgICAgcyA9IHMucmVwbGFjZSgnQVBSUzonLCAnJykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIHMKCiAgICAjIFBhdGNoIGludG8gdGhlIFJYIG92ZXJyaWRlIGluc3RhbGxlZCBpbiBGNgogICAgX0Y3X09MRF9SWCA9IGdldGF0dHIoQ2hhdEFwcCwgIl9vbl9zZXJpYWxfdGhyZWFkX2xpbmUiLCBOb25lKQogICAgZGVmIF9GN19SWChzZWxmLCBsaW5lOiBzdHIpOgogICAgICAgIHMgPSAobGluZSBvciAnJykuc3RyaXAoKQogICAgICAgIGlmIG5vdCBzOgogICAgICAgICAgICByZXR1cm4KICAgICAgICAjIElmIGl0J3MgYSBjb25zb2xlL21vbml0b3Igb3IgYmVhY29uIGZyYW1lLCB3ZSBub3JtYWxseSBkcm9wIGluIEY2LgogICAgICAgICMgQlVUOiBhbGxvdyBBUFJTICptZXNzYWdlKiBmcmFtZXMgdGhyb3VnaCBhcyByYXcgUlggKHNhbml0aXplZCkuCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpc19tb25pdG9yID0gRmFsc2UKICAgICAgICAgICAgaXNfYmVhY29uID0gRmFsc2UKICAgICAgICAgICAgIyBSZXVzZSBGNiBoZWxwZXJzIGlmIHRoZXkgZXhpc3QKICAgICAgICAgICAgaWYgJyBfZjZfaXNfbW9uaXRvcl9mcmFtZScgaW4gZ2xvYmFscygpIG9yIFRydWU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaXNfbW9uaXRvciA9IF9mNl9pc19tb25pdG9yX2ZyYW1lKHMpICAjIGZyb20gRjYgcGF0Y2gKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICBpZiAnIF9mNl9pc19iZWFjb25fbGluZScgaW4gZ2xvYmFscygpIG9yIFRydWU6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaXNfYmVhY29uID0gX2Y2X2lzX2JlYWNvbl9saW5lKHMpICAgICMgZnJvbSBGNiBwYXRjaAogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICAgICBpZiAoaXNfbW9uaXRvciBvciBpc19iZWFjb24pIGFuZCBfZjdfaXNfYXByc19tZXNzYWdlKHMpOgogICAgICAgICAgICAgICAgIyBTYW5pdGl6ZSBhbmQgYXBwZW5kIGFzIFJYCiAgICAgICAgICAgICAgICBzcyA9IF9mN19zYW5pdGl6ZV9hcHJzX3Rva2VucyhzKQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNzID0gX2Y2X3Nhbml0aXplX3RleHQoc3MpICAjIGFsc28gc3RyaXAgW01PTl0gaWYgcHJlc2VudAogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAiX2FwcGVuZF9yeCIpOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9hcHBlbmRfcngoc3MpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAgICAgIyBPdGhlcndpc2UsIGRlZmVyIHRvIGV4aXN0aW5nIEY2IFJYIGhhbmRsZXIgKHdoaWNoIGZpbHRlcnMgbW9uaXRvci9iZWFjb25zKQogICAgICAgIGlmIGNhbGxhYmxlKF9GN19PTERfUlgpOgogICAgICAgICAgICByZXR1cm4gX0Y3X09MRF9SWChzZWxmLCBsaW5lKQoKICAgIENoYXRBcHAuX29uX3NlcmlhbF90aHJlYWRfbGluZSA9IF9GN19SWAoKZXhjZXB0IEV4Y2VwdGlvbiBhcyBfZV9mNzoKICAgIHRyeToKICAgICAgICBkaWFnX2xvZyhmIkY3X0FMTE9XX0FQUlNfTUVTU0FHRVNfUkFXIHBhdGNoIGZhaWxlZDoge19lX2Y3fSIpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHBhc3MKCiMgPT09PT09PT0gRW5kIE1vbmtleXBhdGNoIEY3X0FMTE9XX0FQUlNfTUVTU0FHRVNfUkFXID09PT09PT09CgoKCiMgPT09PT09PT0gTW9ua2V5cGF0Y2g6IEY4X0hBUkRfUkVNT1ZFX01PTklUT1JfVUkgPT09PT09PT0KIyBDb21wbGV0ZWx5IHJlbW92ZSAiTW9uaXRvciBBbGwgVHJhZmZpYyIgVUkgZnJvbSB2aWV3IGFuZCBmcm9tIGxheW91dHMuCiMgQWxzbyBoaWRlIGFueSBtZW51L3Rvb2xiYXIgYWN0aW9ucyB0aGF0IHJlZmVyZW5jZSBNb25pdG9yLgp0cnk6CiAgICBmcm9tIFB5UXQ1LlF0V2lkZ2V0cyBpbXBvcnQgUVdpZGdldCwgUUNoZWNrQm94LCBRQWN0aW9uCgogICAgZGVmIF9mOF9yZW1vdmVfd2lkZ2V0X2hhcmQod2lkZ2V0KToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGlmIHdpZGdldCBpcyBOb25lOgogICAgICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgICAgICMgSGlkZSBpbW1lZGlhdGVseQogICAgICAgICAgICB0cnk6IHdpZGdldC5oaWRlKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAjIFJlbW92ZSBmcm9tIHBhcmVudCBsYXlvdXQKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgcGFyZW50ID0gd2lkZ2V0LnBhcmVudCgpCiAgICAgICAgICAgICAgICBpZiBwYXJlbnQgaXMgbm90IE5vbmUgYW5kIGhhc2F0dHIocGFyZW50LCAnbGF5b3V0Jyk6CiAgICAgICAgICAgICAgICAgICAgbGF5ID0gcGFyZW50LmxheW91dCgpCiAgICAgICAgICAgICAgICAgICAgaWYgbGF5IGlzIG5vdCBOb25lOgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6IGxheS5yZW1vdmVXaWRnZXQod2lkZ2V0KQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICMgU2NoZWR1bGUgZGVsZXRlCiAgICAgICAgICAgIHRyeTogd2lkZ2V0LmRlbGV0ZUxhdGVyKCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX2Y4X3NjcnViX21vbml0b3JfdWkoc2VsZik6CiAgICAgICAgIyAxKSBLbm93biBhdHRyaWJ1dGUKICAgICAgICB0cnk6CiAgICAgICAgICAgIHcgPSBnZXRhdHRyKHNlbGYsICdtb25pdG9yX2FsbF9jaGVjaycsIE5vbmUpCiAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UodywgUUNoZWNrQm94KSBvciBpc2luc3RhbmNlKHcsIFFXaWRnZXQpOgogICAgICAgICAgICAgICAgX2Y4X3JlbW92ZV93aWRnZXRfaGFyZCh3KQogICAgICAgICAgICAgICAgdHJ5OiBkZWxhdHRyKHNlbGYsICdtb25pdG9yX2FsbF9jaGVjaycpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgICMgMikgU2NhbiBhdHRyaWJ1dGVzIGZvciBhbnkgY2hlY2tib3ggd2l0aCAibW9uaXRvciIgaW4gdGV4dC9uYW1lCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmb3IgYXR0ciBpbiBkaXIoc2VsZik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgb2JqID0gZ2V0YXR0cihzZWxmLCBhdHRyKQogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2Uob2JqLCBRQ2hlY2tCb3gpIG9yIGlzaW5zdGFuY2Uob2JqLCBRV2lkZ2V0KToKICAgICAgICAgICAgICAgICAgICAgICAgdHh0ID0gIiIKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgaGFzYXR0cihvYmosICd0ZXh0Jyk6IHR4dCA9IChvYmoudGV4dCgpIG9yICcnKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgICAgICAgICAgICAgIG5hbWUgPSAiIgogICAgICAgICAgICAgICAgICAgICAgICB0cnk6IG5hbWUgPSAob2JqLm9iamVjdE5hbWUoKSBvciAnJykKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAgICAgICAgICAgICBoYXkgPSBmInt0eHR9IHtuYW1lfSIubG93ZXIoKQogICAgICAgICAgICAgICAgICAgICAgICBpZiAnbW9uaXRvcicgaW4gaGF5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2Y4X3JlbW92ZV93aWRnZXRfaGFyZChvYmopCiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cnk6IHNldGF0dHIoc2VsZiwgYXR0ciwgTm9uZSkKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICAjIDMpIEhpZGUgYW55IFFBY3Rpb24gbWVudGlvbmluZyBNb25pdG9yCiAgICAgICAgdHJ5OgogICAgICAgICAgICBmb3IgYXR0ciBpbiBkaXIoc2VsZik6CiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgYWN0ID0gZ2V0YXR0cihzZWxmLCBhdHRyKQogICAgICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UoYWN0LCBRQWN0aW9uKToKICAgICAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWwgPSAoYWN0LnRleHQoKSBvciAnJykubG93ZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgJ21vbml0b3InIGluIGxhYmVsOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeTogYWN0LnNldFZpc2libGUoRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyeTogYWN0LnNldEVuYWJsZWQoRmFsc2UpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICMgV3JhcCBfX2luaXRfXyB0byBzY3J1YiBhZnRlciBVSSBpcyBjb25zdHJ1Y3RlZAogICAgX0Y4X09SSUdfSU5JVCA9IGdldGF0dHIoQ2hhdEFwcCwgIl9faW5pdF9fIiwgTm9uZSkKICAgIGlmIGNhbGxhYmxlKF9GOF9PUklHX0lOSVQpOgogICAgICAgIGRlZiBfRjhfSU5JVF9XUkFQKHNlbGYsICphLCAqKmt3KToKICAgICAgICAgICAgX0Y4X09SSUdfSU5JVChzZWxmLCAqYSwgKiprdykKICAgICAgICAgICAgdHJ5OiBfZjhfc2NydWJfbW9uaXRvcl91aShzZWxmKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgQ2hhdEFwcC5fX2luaXRfXyA9IF9GOF9JTklUX1dSQVAKCiAgICAjIE1ha2UgYW55IG1vbml0b3IgdG9nZ2xlZCBoYW5kbGVycyBpbmVydAogICAgZGVmIF9mOF9vbl9tb25pdG9yX2FsbF90b2dnbGVkKHNlbGYsIGNoZWNrZWQpOgogICAgICAgICMgZnVsbHkgcmVtb3ZlZAogICAgICAgIHJldHVybgogICAgQ2hhdEFwcC5fb25fbW9uaXRvcl9hbGxfdG9nZ2xlZCA9IF9mOF9vbl9tb25pdG9yX2FsbF90b2dnbGVkCgpleGNlcHQgRXhjZXB0aW9uIGFzIF9lX2Y4OgogICAgdHJ5OgogICAgICAgIGRpYWdfbG9nKGYiRjhfSEFSRF9SRU1PVkVfTU9OSVRPUl9VSSBwYXRjaCBmYWlsZWQ6IHtfZV9mOH0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgojID09PT09PT09IEVuZCBNb25rZXlwYXRjaCBGOF9IQVJEX1JFTU9WRV9NT05JVE9SX1VJID09PT09PT09CgoKIyA9PT09PT09PSBGMTNfTk9fTU9OX1BSRUZJWDogc2FuaXRpemUgUlgvVFggZGlzcGxheSB0ZXh0ID09PT09PT09CnRyeToKICAgIGltcG9ydCByZSBhcyBfcmUKCiAgICBkZWYgX2YxM19zYW5pdGl6ZV90ZXh0KHM6IHN0cikgLT4gc3RyOgogICAgICAgIGlmIG5vdCBpc2luc3RhbmNlKHMsIHN0cik6CiAgICAgICAgICAgIHMgPSBzdHIocyBvciAnJykKICAgICAgICAjIFJlbW92ZSBsZWFkaW5nIHRpbWVzdGFtcCB0aGVuIHRhZ3MgbGlrZSBbTU9OXS9bS0lTU10vW1JYXS9bQVBSU10KICAgICAgICBzID0gX3JlLnN1YihyJ15ccyooXFtbXlxdXStcXVxzKil7MCwxfVxbKE1PTnxLSVNTfFJYfEFQUlMpXF1ccyonLCAnJywgcywgZmxhZ3M9X3JlLkkpCiAgICAgICAgIyBSZW1vdmUgYW55IHJlc2lkdWFsIHRva2VucyBpbnNpZGUgbGluZQogICAgICAgIGZvciB0YWcgaW4gKCdbTU9OXScsICdbS0lTU10nLCAnW1JYXScsICdbQVBSU10nKToKICAgICAgICAgICAgcyA9IHMucmVwbGFjZSh0YWcsICcnKQogICAgICAgICMgQ29sbGFwc2UgZXh0cmEgd2hpdGVzcGFjZQogICAgICAgIHMgPSAnICcuam9pbihzLnNwbGl0KCkpCiAgICAgICAgcmV0dXJuIHMKCiAgICAjIFdyYXAgX2FwcGVuZF9yeCB0byBzYW5pdGl6ZSB0ZXh0IGJlZm9yZSBpdCBoaXRzIHRoZSBNZXNzYWdlcyB2aWV3CiAgICBpZiBoYXNhdHRyKENoYXRBcHAsICdfYXBwZW5kX3J4Jyk6CiAgICAgICAgX0YxM19PUklHX0FQUEVORF9SWCA9IENoYXRBcHAuX2FwcGVuZF9yeAogICAgICAgIGRlZiBfRjEzX0FQUEVORF9SWChzZWxmLCBsaW5lKToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbGluZSA9IF9mMTNfc2FuaXRpemVfdGV4dChsaW5lKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gX0YxM19PUklHX0FQUEVORF9SWChzZWxmLCBsaW5lKQogICAgICAgIENoYXRBcHAuX2FwcGVuZF9yeCA9IF9GMTNfQVBQRU5EX1JYCgogICAgIyAoT3B0aW9uYWwpIGFsc28gc2FuaXRpemUgc3lzdGVtIHRleHQgaWYgaXQgZXZlciBzdXJmYWNlcwogICAgaWYgaGFzYXR0cihDaGF0QXBwLCAnX2FwcGVuZF9zeXMnKToKICAgICAgICBfRjEzX09SSUdfQVBQRU5EX1NZUyA9IENoYXRBcHAuX2FwcGVuZF9zeXMKICAgICAgICBkZWYgX0YxM19BUFBFTkRfU1lTKHNlbGYsIHRleHQpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICB0ZXh0ID0gX2YxM19zYW5pdGl6ZV90ZXh0KHRleHQpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybiBfRjEzX09SSUdfQVBQRU5EX1NZUyhzZWxmLCB0ZXh0KQogICAgICAgIENoYXRBcHAuX2FwcGVuZF9zeXMgPSBfRjEzX0FQUEVORF9TWVMKCmV4Y2VwdCBFeGNlcHRpb24gYXMgX2VfZjEzOgogICAgdHJ5OgogICAgICAgIGRpYWdfbG9nKGYiRjEzIHNhbml0aXplIHBhdGNoIGZhaWxlZDoge19lX2YxM30iKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgojID09PT09PT09IEVuZCBGMTNfTk9fTU9OX1BSRUZJWCA9PT09PT09PQoKCgojID09PT09PT09IEYxNF9SWF9BTEw6IHNob3cgZXZlcnkgcmVjZWl2ZWQgbGluZSBpbiBNZXNzYWdlcyAobm8gZmlsdGVycykgPT09PT09PT0KdHJ5OgogICAgIyBQcmVzZXJ2ZSBvcmlnaW5hbCBoYW5kbGVyIChpZiBuZWVkZWQgZm9yIHJvbGxiYWNrKQogICAgX0YxNF9PUklHX1JYID0gZ2V0YXR0cihDaGF0QXBwLCAiX29uX3NlcmlhbF90aHJlYWRfbGluZSIsIE5vbmUpCgogICAgZGVmIF9GMTRfUlhfQUxMKHNlbGYsIGxpbmU6IHN0cik6CiAgICAgICAgIyBBcHBlbmQgYW55IG5vbi1lbXB0eSBsaW5lIHRvIE1lc3NhZ2VzIGFzIFJYLCB1bmZpbHRlcmVkLgogICAgICAgIHRyeToKICAgICAgICAgICAgcyA9ICcnIGlmIGxpbmUgaXMgTm9uZSBlbHNlIHN0cihsaW5lKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHMgPSBzdHIobGluZSBvciAnJykKICAgICAgICBzID0gcy5zdHJpcCgnXHJcbicpCiAgICAgICAgaWYgcyA9PSAnJzoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICJfYXBwZW5kX3J4Iik6CiAgICAgICAgICAgICAgICBzZWxmLl9hcHBlbmRfcngocykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgQ2hhdEFwcC5fb25fc2VyaWFsX3RocmVhZF9saW5lID0gX0YxNF9SWF9BTEwKCmV4Y2VwdCBFeGNlcHRpb24gYXMgX2VfZjE0OgogICAgdHJ5OgogICAgICAgIGRpYWdfbG9nKGYiRjE0X1JYX0FMTCBwYXRjaCBmYWlsZWQ6IHtfZV9mMTR9IikKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKIyA9PT09PT09PSBFbmQgRjE0X1JYX0FMTCA9PT09PT09PQoKCgojID09PT09PT09IEYxNV9SWF9BTExfTkxfU0FGRTogdW5pdmVyc2FsIG5ld2xpbmUgKyBmbHVzaCB0aW1lciArIGhleCBkaWFnbm9zdGljcyA9PT09PT09PQp0cnk6CiAgICBpbXBvcnQgdGltZSBhcyBfdCwgYmluYXNjaWkgYXMgX2JpbmFzY2lpLCByZSBhcyBfcmUKICAgIGZyb20gUHlRdDUuUXRDb3JlIGltcG9ydCBRVGltZXIKCiAgICAjIENyZWF0ZSAvIGFwcGVuZCB0byByeF90cmFjZS5sb2cgd2l0aCBoZXhkdW1wCiAgICBkZWYgX2YxNV9kaWFnX3RyYWNlKGFwcCwgc3RhZ2UsICoqZmllbGRzKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aAogICAgICAgICAgICBpbXBvcnQganNvbiwgdGltZSBhcyBfdHgKICAgICAgICAgICAgYmFzZSA9IGFwcF9iYXNlX2RpcigpIGlmICdhcHBfYmFzZV9kaXInIGluIGdsb2JhbHMoKSBlbHNlICcuJwogICAgICAgICAgICBwID0gUGF0aChiYXNlKSAvICdzdG9yZScgLyAncnhfdHJhY2UubG9nJwogICAgICAgICAgICBwLnBhcmVudC5ta2RpcihwYXJlbnRzPVRydWUsIGV4aXN0X29rPVRydWUpCiAgICAgICAgICAgIHJlYyA9IHsndCc6IGludChfdHgudGltZSgpKSwgJ3N0YWdlJzogc3RhZ2V9CiAgICAgICAgICAgIHJlYy51cGRhdGUoZmllbGRzKQogICAgICAgICAgICB3aXRoIHAub3BlbignYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKGpzb24uZHVtcHMocmVjLCBlbnN1cmVfYXNjaWk9RmFsc2UpICsgJ1xuJykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgIyBIb2xkIGJ1ZmZlciBhY3Jvc3MgY2FsbHMgd2hlbiBubyBuZXdsaW5lIGlzIHByZXNlbnQKICAgIGRlZiBfZjE1X2luaXRfcnhfaG9sZChzZWxmKToKICAgICAgICBpZiBub3QgaGFzYXR0cihzZWxmLCAnX2YxNV9ob2xkJyk6CiAgICAgICAgICAgIHNlbGYuX2YxNV9ob2xkID0geydidWYnOiAnJywgJ3RzJzogMC4wfQoKICAgICMgQ29udmVydCBzdHJpbmcgdG8gYSBiZXN0LWVmZm9ydCBoZXggcHJldmlldyBmb3IgZGlhZ25vc3RpY3MKICAgIGRlZiBfZjE1X2hleF9wcmV2aWV3KHM6IHN0ciwgbGltaXQ9NjQpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShzLCBieXRlcyk6CiAgICAgICAgICAgICAgICBiID0gcwogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgYiA9IHMuZW5jb2RlKCd1dGYtOCcsIGVycm9ycz0nYmFja3NsYXNocmVwbGFjZScpCiAgICAgICAgICAgIGh4ID0gX2JpbmFzY2lpLmhleGxpZnkoYikuZGVjb2RlKCdhc2NpaScpCiAgICAgICAgICAgIHJldHVybiBoeFs6bGltaXQqMl0gKyAoJy4uLicgaWYgbGVuKGh4KSA+IGxpbWl0KjIgZWxzZSAnJykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gJycKCiAgICAjIFN0YXJ0IGEgdGltZXIgdGhhdCBmbHVzaGVzIHRoZSBob2xkIGJ1ZmZlciBpZiBubyBuZXdsaW5lIGV2ZXIgYXJyaXZlcwogICAgZGVmIF9mMTVfc3RhcnRfZmx1c2hfdGltZXIoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBnZXRhdHRyKHNlbGYsICdfZjE1X3RpbWVyJywgTm9uZSk6CiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgc2VsZi5fZjE1X3RpbWVyID0gUVRpbWVyKHNlbGYpCiAgICAgICAgICAgIGRlZiBfdGljaygpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIF9mMTVfaW5pdF9yeF9ob2xkKHNlbGYpCiAgICAgICAgICAgICAgICAgICAgYnVmID0gc2VsZi5fZjE1X2hvbGQuZ2V0KCdidWYnLCAnJykKICAgICAgICAgICAgICAgICAgICB0cyA9IHNlbGYuX2YxNV9ob2xkLmdldCgndHMnLCAwLjApCiAgICAgICAgICAgICAgICAgICAgaWYgYnVmIGFuZCAoX3QubW9ub3RvbmljKCkgLSB0cykgPj0gMC4yNTogICMgMjUwIG1zIGlkbGUgLT4gZmx1c2ggYXMgYSBsaW5lCiAgICAgICAgICAgICAgICAgICAgICAgIHMgPSBidWYKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fZjE1X2hvbGRbJ2J1ZiddID0gJycKICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5fZjE1X2hvbGRbJ3RzJ10gPSAwLjAKICAgICAgICAgICAgICAgICAgICAgICAgX2YxNV9kaWFnX3RyYWNlKHNlbGYsICdmbHVzaF90aW1lcicsIGZsdXNoZWQ9cywgaGV4PV9mMTVfaGV4X3ByZXZpZXcocykpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ19hcHBlbmRfcngnKToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYuX2FwcGVuZF9yeChzKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHNlbGYuX2YxNV90aW1lci50aW1lb3V0LmNvbm5lY3QoX3RpY2spCiAgICAgICAgICAgIHNlbGYuX2YxNV90aW1lci5zdGFydCg1MCkgICMgY2hlY2sgZXZlcnkgNTAgbXMKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgIyBXcmFwIF9faW5pdF9fIHRvIHN0YXJ0IHRpbWVyCiAgICBfRjE1X09SSUdfSU5JVCA9IGdldGF0dHIoQ2hhdEFwcCwgJ19faW5pdF9fJywgTm9uZSkKICAgIGlmIGNhbGxhYmxlKF9GMTVfT1JJR19JTklUKToKICAgICAgICBkZWYgX0YxNV9JTklUX1dSQVAoc2VsZiwgKmEsICoqa3cpOgogICAgICAgICAgICBfRjE1X09SSUdfSU5JVChzZWxmLCAqYSwgKiprdykKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgX2YxNV9pbml0X3J4X2hvbGQoc2VsZikKICAgICAgICAgICAgICAgIF9mMTVfc3RhcnRfZmx1c2hfdGltZXIoc2VsZikKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBDaGF0QXBwLl9faW5pdF9fID0gX0YxNV9JTklUX1dSQVAKCiAgICAjIFJlcGxhY2UgUlggaGFuZGxlcjogdW5pdmVyc2FsIG5ld2xpbmUgc3BsaXR0aW5nICsgYnVmZmVyIGhvbGQgKyBkaWFnbm9zdGljIHRyYWNpbmcKICAgIGRlZiBfRjE1X1JYKHNlbGYsIGxpbmU6IHN0cik6CiAgICAgICAgIyBGMjZhOiBkcm9wIHNlbGYtVFggbW9uaXRvciBlY2hvZXMgYmVmb3JlIHBlcnNpc3RpbmcKICAgICAgICBpZiBfcmNfZHJvcF9jb25zb2xlX2VjaG8oc2VsZiwgbGluZSk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB0cnk6CiAgICAgICAgICAgIHMgPSAnJyBpZiBsaW5lIGlzIE5vbmUgZWxzZSBzdHIobGluZSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBzID0gc3RyKGxpbmUgb3IgJycpCiAgICAgICAgIyBUcmFjZSByYXcgaW5wdXQKICAgICAgICBfZjE1X2RpYWdfdHJhY2Uoc2VsZiwgJ2VudHJ5JywgcmF3PXMsIGhleD1fZjE1X2hleF9wcmV2aWV3KHMpKQoKICAgICAgICBfZjE1X2luaXRfcnhfaG9sZChzZWxmKQoKICAgICAgICAjIE5vcm1hbGl6ZSB0byBzdHJpbmcgYW5kIHNwbGl0IG9uIEFOWSBvZiBDUiwgTEYsIENSTEYsIG9yIE5MIGluIG1pZGRsZQogICAgICAgIHMgPSBzLnJlcGxhY2UoJ1xyXG4nLCAnXG4nKS5yZXBsYWNlKCdccicsICdcbicpCiAgICAgICAgcGFydHMgPSBzLnNwbGl0KCdcbicpCgogICAgICAgICMgUHJlcGVuZCBhbnkgcHJldmlvdXMgaG9sZCB0byB0aGUgZmlyc3QgY2h1bmsKICAgICAgICBpZiBzZWxmLl9mMTVfaG9sZFsnYnVmJ106CiAgICAgICAgICAgIHBhcnRzWzBdID0gc2VsZi5fZjE1X2hvbGRbJ2J1ZiddICsgcGFydHNbMF0KICAgICAgICAgICAgc2VsZi5fZjE1X2hvbGRbJ2J1ZiddID0gJycKICAgICAgICAgICAgc2VsZi5fZjE1X2hvbGRbJ3RzJ10gPSAwLjAKCiAgICAgICAgIyBJZiB0aGUgbGFzdCBwYXJ0IGhhcyBubyB0ZXJtaW5hdGluZyBuZXdsaW5lLCBob2xkIGl0IGZvciB1cCB0byAyNTBtcwogICAgICAgIGlmIGxlbihwYXJ0cykgPj0gMToKICAgICAgICAgICAgdGFpbCA9IHBhcnRzWy0xXQogICAgICAgICAgICBjb21wbGV0ZSA9IHBhcnRzWzotMV0KICAgICAgICBlbHNlOgogICAgICAgICAgICBjb21wbGV0ZSwgdGFpbCA9IFtdLCAnJwoKICAgICAgICAjIEVtaXQgZWFjaCBjb21wbGV0ZSBsaW5lIChub24tZW1wdHkgYWZ0ZXIgc3RyaXAgb2YgQ1IvTEYpCiAgICAgICAgZm9yIGl0ZW0gaW4gY29tcGxldGU6CiAgICAgICAgICAgIGl0bSA9IGl0ZW0uc3RyaXAoJ1xyJykKICAgICAgICAgICAgaWYgaXRtICE9ICcnOgogICAgICAgICAgICAgICAgX2YxNV9kaWFnX3RyYWNlKHNlbGYsICdlbWl0JywgbGluZT1pdG0sIGhleD1fZjE1X2hleF9wcmV2aWV3KGl0bSkpCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAnX2FwcGVuZF9yeCcpOgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLl9hcHBlbmRfcngoaXRtKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCgogICAgICAgICMgVXBkYXRlIGhvbGQgYnVmZmVyIHdpdGggdGFpbCAoY291bGQgYmUgZW1wdHkpCiAgICAgICAgaWYgdGFpbDoKICAgICAgICAgICAgc2VsZi5fZjE1X2hvbGRbJ2J1ZiddID0gdGFpbAogICAgICAgICAgICBzZWxmLl9mMTVfaG9sZFsndHMnXSA9IF90Lm1vbm90b25pYygpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgc2VsZi5fZjE1X2hvbGRbJ2J1ZiddID0gJycKICAgICAgICAgICAgc2VsZi5fZjE1X2hvbGRbJ3RzJ10gPSAwLjAKCiAgICBDaGF0QXBwLl9vbl9zZXJpYWxfdGhyZWFkX2xpbmUgPSBfRjE1X1JYCgpleGNlcHQgRXhjZXB0aW9uIGFzIF9lX2YxNToKICAgIHRyeToKICAgICAgICBkaWFnX2xvZyhmIkYxNV9SWF9BTExfTkxfU0FGRSBmYWlsZWQ6IHtfZV9mMTV9IikKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKIyA9PT09PT09PSBFbmQgRjE1X1JYX0FMTF9OTF9TQUZFID09PT09PT09CgoKCiMgPT09PT09PT0gRjE2X01TR1NfUEFSSVRZX1dJVEhfMV80XzFCID09PT09PT09CiMgR29hbDogTWFrZSBNZXNzYWdlcyBiZWhhdmUgbGlrZSAxLjQuMS5CCiMgIC0gUGVyc2lzdCB0byBzdG9yZS9tZXNzYWdlc192MS5qc29uIG9uIGV2ZXJ5IG5ldyBVSSBtZXNzYWdlCiMgIC0gTG9hZCBmcm9tIGRpc2sgb24gc3RhcnR1cCBpbnRvIHNlbGYuY2hhdF9pdGVtcyBhbmQgcmVidWlsZCB2aWV3CiMgIC0gRW5zdXJlIF9hcHBlbmRfcngvX2FwcGVuZF90eCByb3V0ZSB0aHJvdWdoIF9hZGRfY2hhdF9pdGVtLWNvbXBhdGlibGUgcGF0aAoKdHJ5OgogICAgaW1wb3J0IG9zLCBqc29uCiAgICBmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSBhcyBfZHQKICAgIGZyb20gUHlRdDUuUXRDb3JlIGltcG9ydCBRVGltZXIKICAgIGZyb20gUHlRdDUuUXRXaWRnZXRzIGltcG9ydCBRTGlzdFdpZGdldEl0ZW0KICAgIGZyb20gUHlRdDUuUXRHdWkgaW1wb3J0IFFCcnVzaAogICAgZnJvbSBQeVF0NS5RdENvcmUgaW1wb3J0IFF0CgogICAgIyAtLS0tIHBhdGhzCiAgICBkZWYgX2YxNl9iYXNlX2RpcigpOgogICAgICAgIHRyeToKICAgICAgICAgICAgaW1wb3J0IHN5cywgb3MKICAgICAgICAgICAgaWYgZ2V0YXR0cihzeXMsICJmcm96ZW4iLCBGYWxzZSk6CiAgICAgICAgICAgICAgICByZXR1cm4gb3MucGF0aC5kaXJuYW1lKG9zLnBhdGguYWJzcGF0aChzeXMuZXhlY3V0YWJsZSkpCiAgICAgICAgICAgIHJldHVybiBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBpbXBvcnQgb3MKICAgICAgICAgICAgcmV0dXJuIG9zLmdldGN3ZCgpCgogICAgZGVmIF9mMTZfc3RvcmVfZGlyKCk6CiAgICAgICAgaW1wb3J0IG9zCiAgICAgICAgZCA9IG9zLnBhdGguam9pbihfZjE2X2Jhc2VfZGlyKCksICdzdG9yZScpCiAgICAgICAgdHJ5OiBvcy5tYWtlZGlycyhkLCBleGlzdF9vaz1UcnVlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICByZXR1cm4gZAoKICAgIGRlZiBfZjE2X3N0b3JlX3BhdGgoKToKICAgICAgICBpbXBvcnQgb3MKICAgICAgICByZXR1cm4gb3MucGF0aC5qb2luKF9mMTZfc3RvcmVfZGlyKCksICdtZXNzYWdlc192MS5qc29uJykKCiAgICAjIC0tLS0gYmFzaWMgSU8KICAgIGRlZiBfZjE2X3JlYWRfZGlzaygpOgogICAgICAgIHAgPSBfZjE2X3N0b3JlX3BhdGgoKQogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKHAsICdyJywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgIGRhdGEgPSBqc29uLmxvYWQoZikKICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkYXRhLCBkaWN0KToKICAgICAgICAgICAgICAgIGFyciA9IGRhdGEuZ2V0KCdtZXNzYWdlcycsIFtdKQogICAgICAgICAgICBlbGlmIGlzaW5zdGFuY2UoZGF0YSwgbGlzdCk6CiAgICAgICAgICAgICAgICBhcnIgPSBkYXRhCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBhcnIgPSBbXQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIGFyciA9IFtdCiAgICAgICAgcmV0dXJuIGFycgoKICAgIGRlZiBfZjE2X3dyaXRlX2Rpc2soYXJyKToKICAgICAgICBwID0gX2YxNl9zdG9yZV9wYXRoKCkKICAgICAgICB0cnk6CiAgICAgICAgICAgIG9zLm1ha2VkaXJzKG9zLnBhdGguZGlybmFtZShwKSwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICAgICAgcGF5bG9hZCA9IHsndmVyc2lvbic6IDEsICdtZXNzYWdlcyc6IGFycn0KICAgICAgICAgICAgd2l0aCBvcGVuKHAsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgIGpzb24uZHVtcChwYXlsb2FkLCBmLCBlbnN1cmVfYXNjaWk9RmFsc2UsIGluZGVudD0yKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAjIE5vcm1hbGl6ZSBiZXR3ZWVuIDEuNC4xLkIgaXRlbSBhbmQgY29tcGFjdCBsaXN0IGZvcm1hdAogICAgZGVmIF9mMTZfaXRlbV90b19kaXNrKGl0KToKICAgICAgICB0cyA9IGl0LmdldCgndHMnKQogICAgICAgIHRyeToKICAgICAgICAgICAgdHNfaXNvID0gdHMuaXNvZm9ybWF0KCkgaWYgaGFzYXR0cih0cywgJ2lzb2Zvcm1hdCcpIGVsc2Ugc3RyKHRzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHRzX2lzbyA9IHN0cih0cykKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAia2luZCI6IGl0LmdldCgia2luZCIpLAogICAgICAgICAgICAidGV4dCI6IGl0LmdldCgidGV4dCIpLAogICAgICAgICAgICAidHMiOiB0c19pc28sCiAgICAgICAgICAgICJhY2siOiBib29sKGl0LmdldCgiYWNrIikpLAogICAgICAgICAgICAiYWNrX2lkIjogaXQuZ2V0KCJhY2tfaWQiKSwKICAgICAgICAgICAgInRvIjogaXQuZ2V0KCJ0byIpLAogICAgICAgICAgICAiZnJtIjogaXQuZ2V0KCJmcm0iKSwKICAgICAgICAgICAgImF0dGVtcHQiOiBpdC5nZXQoImF0dGVtcHQiKSwKICAgICAgICAgICAgIm1heF9hdHRlbXB0cyI6IGl0LmdldCgibWF4X2F0dGVtcHRzIiksCiAgICAgICAgICAgICJmYWlsZWQiOiBib29sKGl0LmdldCgiZmFpbGVkIikpLAogICAgICAgICAgICAic3R5bGUiOiBpdC5nZXQoInN0eWxlIiksCiAgICAgICAgICAgICJzZXEiOiBpdC5nZXQoInNlcSIsIE5vbmUpLAogICAgICAgIH0KCiAgICBkZWYgX2YxNl9kaXNrX3RvX2l0ZW0oZCk6CiAgICAgICAgdHMgPSBkLmdldCgidHMiKQogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUgYXMgX2R0CiAgICAgICAgICAgIHRzID0gX2R0LmZyb21pc29mb3JtYXQodHMucnN0cmlwKCdaJykpIGlmIGlzaW5zdGFuY2UodHMsIHN0cikgZWxzZSB0cwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gewogICAgICAgICAgICAia2luZCI6IGQuZ2V0KCJraW5kIiksCiAgICAgICAgICAgICJ0ZXh0IjogZC5nZXQoInRleHQiKSwKICAgICAgICAgICAgInRzIjogdHMgb3IgX2R0LnV0Y25vdygpLAogICAgICAgICAgICAiYWNrIjogYm9vbChkLmdldCgiYWNrIikpLAogICAgICAgICAgICAiYWNrX2lkIjogZC5nZXQoImFja19pZCIpLAogICAgICAgICAgICAidG8iOiBkLmdldCgidG8iKSBvciAiIiwKICAgICAgICAgICAgImZybSI6IGQuZ2V0KCJmcm0iKSBvciAiIiwKICAgICAgICAgICAgImF0dGVtcHQiOiBkLmdldCgiYXR0ZW1wdCIpLAogICAgICAgICAgICAibWF4X2F0dGVtcHRzIjogZC5nZXQoIm1heF9hdHRlbXB0cyIpLAogICAgICAgICAgICAiZmFpbGVkIjogYm9vbChkLmdldCgiZmFpbGVkIikpLAogICAgICAgICAgICAic3R5bGUiOiBkLmdldCgic3R5bGUiKSwKICAgICAgICAgICAgInNlcSI6IGQuZ2V0KCJzZXEiKSwKICAgICAgICB9CgogICAgZGVmIF9mMTZfc2F2ZV9ub3coc2VsZik6CiAgICAgICAgaXRlbXMgPSBsaXN0KHJldmVyc2VkKGdldGF0dHIoc2VsZiwgImNoYXRfaXRlbXMiLCBbXSkgb3IgW10pKQogICAgICAgIGlmIG5vdCBpdGVtczoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgYXJyID0gW19mMTZfaXRlbV90b19kaXNrKGl0KSBmb3IgaXQgaW4gaXRlbXNdCiAgICAgICAgX2YxNl93cml0ZV9kaXNrKGFycikKICAgICAgICB0cnk6CiAgICAgICAgICAgIHNlbGYuc3RhdHVzX2xhYmVsLnNldFRleHQoZiJTYXZlZCAoe2xlbihhcnIpfSkiKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAjIEhvb2sgQ2hhdEFwcDogb24gaW5pdCBsb2FkLCBvbiBfYWRkX2NoYXRfaXRlbSBzYXZlCiAgICBfRjE2X09SSUdfSU5JVCA9IGdldGF0dHIoQ2hhdEFwcCwgIl9faW5pdF9fIiwgTm9uZSkKICAgIGRlZiBfRjE2X0lOSVQoc2VsZiwgKmEsICoqa3cpOgogICAgICAgIGlmIF9GMTZfT1JJR19JTklUOiBfRjE2X09SSUdfSU5JVChzZWxmLCAqYSwgKiprdykKICAgICAgICAjIGVuc3VyZSBhdHRycwogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgbm90IGhhc2F0dHIoc2VsZiwgImNoYXRfaXRlbXMiKSBvciBzZWxmLmNoYXRfaXRlbXMgaXMgTm9uZToKICAgICAgICAgICAgICAgIHNlbGYuY2hhdF9pdGVtcyA9IFtdCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgdHJ5OiBzZWxmLmNoYXRfaXRlbXMgPSBbXQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgIyBlbnN1cmUgZmlsZSBleGlzdHMKICAgICAgICB0cnk6CiAgICAgICAgICAgIHAgPSBfZjE2X3N0b3JlX3BhdGgoKQogICAgICAgICAgICBpZiBub3Qgb3MucGF0aC5leGlzdHMocCk6CiAgICAgICAgICAgICAgICBfZjE2X3dyaXRlX2Rpc2soW10pCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwogICAgICAgICMgbG9hZCBmcm9tIGRpc2sKICAgICAgICB0cnk6CiAgICAgICAgICAgIGRpc2sgPSBfZjE2X3JlYWRfZGlzaygpICAjIG9sZGVzdC1maXJzdCAoZGljdCBzY2hlbWEpCiAgICAgICAgICAgIG1lbSA9IFtfZjE2X2Rpc2tfdG9faXRlbShkKSBmb3IgZCBpbiBkaXNrXQogICAgICAgICAgICBzZWxmLmNoYXRfaXRlbXMgPSBsaXN0KHJldmVyc2VkKG1lbSkpICAjIG5ld2VzdC1maXJzdCBpbiBtZW1vcnkKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc2VsZi5fcmVidWlsZF9jaGF0X3ZpZXcoKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgIyBTaW1wbGUgbGlzdCBmYWxsYmFjayBpZiBubyBIVE1MIHZpZXcgYXZhaWxhYmxlCiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICJtZXNzYWdlc19saXN0Iik6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1lc3NhZ2VzX2xpc3QuY2xlYXIoKQogICAgICAgICAgICAgICAgICAgICAgICBmb3IgaXQgaW4gc2VsZi5jaGF0X2l0ZW1zOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgdHMgPSBpdC5nZXQoInRzIikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRzX3N0ciA9IHRzLnN0cmZ0aW1lKCIlSDolTTolUyIpIGlmIGhhc2F0dHIodHMsICJzdHJmdGltZSIpIGVsc2UgIiIKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGxpbmUgPSBpdC5nZXQoInRleHQiKSBvciAiIgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcm9sZSA9IChpdC5nZXQoImtpbmQiKSBvciAiIikubG93ZXIoKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgaXRlbSA9IFFMaXN0V2lkZ2V0SXRlbShmIlt7dHNfc3RyfV0ge2xpbmV9IikKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmIHJvbGUgPT0gInJlY2VpdmVkIjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLnNldEZvcmVncm91bmQoUUJydXNoKHNlbGYuQ09MT1JfUlgpKQogICAgICAgICAgICAgICAgICAgICAgICAgICAgZWxpZiByb2xlID09ICJzZW50IjoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBpdGVtLnNldEZvcmVncm91bmQoUUJydXNoKHNlbGYuQ09MT1JfU0VOVCkpCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1lc3NhZ2VzX2xpc3QuaW5zZXJ0SXRlbSgwLCBpdGVtKQogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1lc3NhZ2VzX2xpc3Quc2Nyb2xsVG9Ub3AoKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgIyBhdXRvc2F2ZQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VsZi5fZjE2X2F1dG9zYXZlID0gUVRpbWVyKHNlbGYpCiAgICAgICAgICAgIHNlbGYuX2YxNl9hdXRvc2F2ZS5zZXRJbnRlcnZhbCgzMDAwMDApCiAgICAgICAgICAgIHNlbGYuX2YxNl9hdXRvc2F2ZS50aW1lb3V0LmNvbm5lY3QobGFtYmRhOiBfZjE2X3NhdmVfbm93KHNlbGYpKQogICAgICAgICAgICBzZWxmLl9mMTZfYXV0b3NhdmUuc3RhcnQoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBDaGF0QXBwLl9faW5pdF9fID0gX0YxNl9JTklUCgogICAgIyBXcmFwIF9hZGRfY2hhdF9pdGVtIHRvIHNhdmUgZWFnZXJseSAocGFyaXR5IHdpdGggMS40LjEuQikKICAgIGlmIGhhc2F0dHIoQ2hhdEFwcCwgIl9hZGRfY2hhdF9pdGVtIik6CiAgICAgICAgX0YxNl9PUklHX0FERCA9IENoYXRBcHAuX2FkZF9jaGF0X2l0ZW0KICAgICAgICBkZWYgX0YxNl9BREQoc2VsZiwgKmEsICoqa3cpOgogICAgICAgICAgICByID0gTm9uZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICByID0gX0YxNl9PUklHX0FERChzZWxmLCAqYSwgKiprdykKICAgICAgICAgICAgZmluYWxseToKICAgICAgICAgICAgICAgIHRyeTogX2YxNl9zYXZlX25vdyhzZWxmKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICByZXR1cm4gcgogICAgICAgIENoYXRBcHAuX2FkZF9jaGF0X2l0ZW0gPSBfRjE2X0FERAoKICAgICMgRW5zdXJlIF9hcHBlbmRfcnggYW5kIF9hcHBlbmRfdHggcm91dGUgdGhyb3VnaCBfYWRkX2NoYXRfaXRlbSBpZiBwcmVzZW50CiAgICBkZWYgX0YxNl9SWF9BUFBFTkRfV1JBUChzZWxmLCBsaW5lOiBzdHIpOgogICAgICAgIHRyeToKICAgICAgICAgICAgdHh0ID0gc3RyKGxpbmUgb3IgJycpLnN0cmlwKCkKICAgICAgICAgICAgaWYgbm90IHR4dDoKICAgICAgICAgICAgICAgIHJldHVybgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICJfYWRkX2NoYXRfaXRlbSIpOgogICAgICAgICAgICAgICAgc2VsZi5fYWRkX2NoYXRfaXRlbShraW5kPSJyZWNlaXZlZCIsIHRleHQ9dHh0LCB0bz0iIiwgZnJtPSIiLCBhY2tfaWQ9Tm9uZSwgYWNrPUZhbHNlKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgIyBGYWxsYmFjayB0byBsaXN0IHdpZGdldAogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAibWVzc2FnZXNfbGlzdCIpOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUgYXMgX2R0CiAgICAgICAgICAgICAgICAgICAgICAgIHRzID0gX2R0Lm5vdygpLnN0cmZ0aW1lKCIlSDolTTolUyIpCiAgICAgICAgICAgICAgICAgICAgICAgIGl0ID0gUUxpc3RXaWRnZXRJdGVtKGYiW3t0c31dIHt0eHR9IikKICAgICAgICAgICAgICAgICAgICAgICAgaXQuc2V0Rm9yZWdyb3VuZChRQnJ1c2goc2VsZi5DT0xPUl9SWCkpCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfZW5jX2d1YXJkID0gKGxpbmUgaWYgImxpbmUiIGluIGxvY2FscygpIGVsc2UgdGV4dCBpZiAidGV4dCIgaW4gbG9jYWxzKCkgZWxzZSBtc2cgaWYgIm1zZyIgaW4gbG9jYWxzKCkgZWxzZSAiIikKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZiBzZWxmLl9pc19lbmNyeXB0ZWRfbGluZShfZW5jX2d1YXJkKToKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwoKICAgICAgICAgICAgICAgICAgICAgICAgICAgIGVsc2U6CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubWVzc2FnZXNfbGlzdC5pbnNlcnRJdGVtKDAsIGl0KQoKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1lc3NhZ2VzX2xpc3QuaW5zZXJ0SXRlbSgwLCBpdCkKCiAgICAgICAgICAgICAgICAgICAgICAgIHNlbGYubWVzc2FnZXNfbGlzdC5zY3JvbGxUb1RvcCgpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgIyBhbHNvIHRvdWNoIGRpc2sgdmlhIGNoYXRfaXRlbXMgaWYgcHJlc2VudAogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHNlbGYuY2hhdF9pdGVtcy5pbnNlcnQoMCwgeyJraW5kIjoicmVjZWl2ZWQiLCJ0ZXh0Ijp0eHQsInRzIjpfZHQubm93KCksImFjayI6RmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImFja19pZCI6Tm9uZSwidG8iOiIiLCJmcm0iOiIiLCJhdHRlbXB0IjpOb25lLCJtYXhfYXR0ZW1wdHMiOk5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImZhaWxlZCI6RmFsc2UsInN0eWxlIjpOb25lfSkKICAgICAgICAgICAgICAgICAgICBfZjE2X3NhdmVfbm93KHNlbGYpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgZGVmIF9GMTZfVFhfQVBQRU5EX1dSQVAoc2VsZiwgbGluZTogc3RyKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIHR4dCA9IHN0cihsaW5lIG9yICcnKS5zdHJpcCgpCiAgICAgICAgICAgIGlmIG5vdCB0eHQ6IHJldHVybgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICJfYWRkX2NoYXRfaXRlbSIpOgogICAgICAgICAgICAgICAgc2VsZi5fYWRkX2NoYXRfaXRlbShraW5kPSJzZW50IiwgdGV4dD10eHQsIHRvPSIiLCBmcm09IiIsIGFja19pZD1Ob25lLCBhY2s9RmFsc2UpCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICJtZXNzYWdlc19saXN0Iik6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSBhcyBfZHQKICAgICAgICAgICAgICAgICAgICAgICAgdHMgPSBfZHQubm93KCkuc3RyZnRpbWUoIiVIOiVNOiVTIikKICAgICAgICAgICAgICAgICAgICAgICAgaXQgPSBRTGlzdFdpZGdldEl0ZW0oZiJbe3RzfV0ge3R4dH0iKQogICAgICAgICAgICAgICAgICAgICAgICBpdC5zZXRGb3JlZ3JvdW5kKFFCcnVzaChzZWxmLkNPTE9SX1NFTlQpKQogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgX2VuY19ndWFyZCA9IChsaW5lIGlmICJsaW5lIiBpbiBsb2NhbHMoKSBlbHNlIHRleHQgaWYgInRleHQiIGluIGxvY2FscygpIGVsc2UgbXNnIGlmICJtc2ciIGluIGxvY2FscygpIGVsc2UgIiIpCgogICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgc2VsZi5faXNfZW5jcnlwdGVkX2xpbmUoX2VuY19ndWFyZCk6CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKCiAgICAgICAgICAgICAgICAgICAgICAgICAgICBlbHNlOgoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1lc3NhZ2VzX2xpc3QuaW5zZXJ0SXRlbSgwLCBpdCkKCiAgICAgICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CgogICAgICAgICAgICAgICAgICAgICAgICAgICAgc2VsZi5tZXNzYWdlc19saXN0Lmluc2VydEl0ZW0oMCwgaXQpCgogICAgICAgICAgICAgICAgICAgICAgICBzZWxmLm1lc3NhZ2VzX2xpc3Quc2Nyb2xsVG9Ub3AoKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBzZWxmLmNoYXRfaXRlbXMuaW5zZXJ0KDAsIHsia2luZCI6InNlbnQiLCJ0ZXh0Ijp0eHQsInRzIjpfZHQubm93KCksImFjayI6RmFsc2UsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImFja19pZCI6Tm9uZSwidG8iOiIiLCJmcm0iOiIiLCJhdHRlbXB0IjpOb25lLCJtYXhfYXR0ZW1wdHMiOk5vbmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgImZhaWxlZCI6RmFsc2UsInN0eWxlIjpOb25lfSkKICAgICAgICAgICAgICAgICAgICBfZjE2X3NhdmVfbm93KHNlbGYpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgaWYgaGFzYXR0cihDaGF0QXBwLCAiX2FwcGVuZF9yeCIpOgogICAgICAgIF9GMTZfT1JJR19BUlggPSBDaGF0QXBwLl9hcHBlbmRfcngKICAgICAgICBkZWYgX0YxNl9XUkFQX0FSWChzZWxmLCBsaW5lKTogCiAgICAgICAgICAgIHRyeTogX0YxNl9SWF9BUFBFTkRfV1JBUChzZWxmLCBsaW5lKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgIHJldHVybiBfRjE2X09SSUdfQVJYKHNlbGYsIGxpbmUpCiAgICAgICAgQ2hhdEFwcC5fYXBwZW5kX3J4ID0gX0YxNl9XUkFQX0FSWAogICAgZWxzZToKICAgICAgICBDaGF0QXBwLl9hcHBlbmRfcnggPSBfRjE2X1JYX0FQUEVORF9XUkFQCgogICAgaWYgaGFzYXR0cihDaGF0QXBwLCAiX2FwcGVuZF90eCIpOgogICAgICAgIF9GMTZfT1JJR19BVFggPSBDaGF0QXBwLl9hcHBlbmRfdHgKICAgICAgICBkZWYgX0YxNl9XUkFQX0FUWChzZWxmLCBsaW5lKToKICAgICAgICAgICAgdHJ5OiBfRjE2X1RYX0FQUEVORF9XUkFQKHNlbGYsIGxpbmUpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgcmV0dXJuIF9GMTZfT1JJR19BVFgoc2VsZiwgbGluZSkKICAgICAgICBDaGF0QXBwLl9hcHBlbmRfdHggPSBfRjE2X1dSQVBfQVRYCiAgICBlbHNlOgogICAgICAgIENoYXRBcHAuX2FwcGVuZF90eCA9IF9GMTZfVFhfQVBQRU5EX1dSQVAKCmV4Y2VwdCBFeGNlcHRpb24gYXMgX2VfZjE2OgogICAgdHJ5OgogICAgICAgIGRpYWdfbG9nKGYiRjE2IHBhcml0eSBwYXRjaCBmYWlsZWQ6IHtfZV9mMTZ9IikKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKIyA9PT09PT09PSBFbmQgRjE2X01TR1NfUEFSSVRZX1dJVEhfMV80XzFCID09PT09PT09CgoKCiMgPT09PT09PT0gRjE3OiBSWCB0YXAgKFFTZXJpYWxQb3J0IG9yIHB5c2VyaWFsKSArIHVuY29uZGl0aW9uYWwgcGVyc2lzdC9kaXNwbGF5ID09PT09PT09CiMgUHVycG9zZTogaWYgdGhlIG9yaWdpbmFsIFJYIHBhdGggaXNuJ3QgZmlyaW5nLCB0YXAgdGhlIHNlcmlhbCBzb3VyY2UgZGlyZWN0bHkgYW5kCiMgICAgICAgICAgcm91dGUgYnl0ZXMgaW50byBNZXNzYWdlcyArIG1lc3NhZ2VzX3YxLmpzb24gd2l0aCByb2J1c3QgbmV3bGluZSBoYW5kbGluZy4KdHJ5OgogICAgaW1wb3J0IG9zLCBqc29uLCB0aW1lIGFzIF90LCBiaW5hc2NpaSBhcyBfYmluYXNjaWkKICAgIGZyb20gZGF0ZXRpbWUgaW1wb3J0IGRhdGV0aW1lIGFzIF9kdAogICAgZnJvbSBQeVF0NS5RdENvcmUgaW1wb3J0IFFUaW1lcgogICAgdHJ5OgogICAgICAgIGZyb20gUHlRdDUuUXRTZXJpYWxQb3J0IGltcG9ydCBRU2VyaWFsUG9ydAogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBRU2VyaWFsUG9ydCA9IE5vbmUKCiAgICAjIC0tLS0tLS0tLS0gZGlzayBoZWxwZXJzIChyZXVzZWQpIC0tLS0tLS0tLS0KICAgIGRlZiBfZjE3X3N0b3JlX2RpcihzZWxmKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJhc2UgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBiYXNlID0gb3MuZ2V0Y3dkKCkKICAgICAgICBkID0gb3MucGF0aC5qb2luKGJhc2UsICdzdG9yZScpCiAgICAgICAgdHJ5OiBvcy5tYWtlZGlycyhkLCBleGlzdF9vaz1UcnVlKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICByZXR1cm4gZAoKICAgIGRlZiBfZjE3X3N0b3JlX3BhdGgoc2VsZik6CiAgICAgICAgcmV0dXJuIG9zLnBhdGguam9pbihfZjE3X3N0b3JlX2RpcihzZWxmKSwgJ21lc3NhZ2VzX3YxLmpzb24nKQoKICAgIGRlZiBfZjE3X3NhdmVfYXBwZW5kKHNlbGYsIGtpbmQsIHRleHQpOgogICAgICAgIHRyeToKICAgICAgICAgICAgcCA9IF9mMTdfc3RvcmVfcGF0aChzZWxmKQogICAgICAgICAgICBkYXRhID0ge30KICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocCk6CiAgICAgICAgICAgICAgICB3aXRoIG9wZW4ocCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIHRyeTogZGF0YSA9IGpzb24ubG9hZChmKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IGRhdGEgPSB7fQogICAgICAgICAgICBtc2dzID0gZGF0YS5nZXQoJ21lc3NhZ2VzJykKICAgICAgICAgICAgaWYgbm90IGlzaW5zdGFuY2UobXNncywgbGlzdCk6IG1zZ3MgPSBbXQogICAgICAgICAgICBtc2dzLmFwcGVuZCh7CiAgICAgICAgICAgICAgICAiZGlyIjogIlRYIiBpZiBraW5kPT0ic2VudCIgZWxzZSAiUlgiLAogICAgICAgICAgICAgICAgImtpbmQiOiAic2VudCIgaWYga2luZD09InNlbnQiIGVsc2UgInJlY2VpdmVkIiwKICAgICAgICAgICAgICAgICJ0ZXh0IjogdGV4dCwKICAgICAgICAgICAgICAgICJ0cyI6IF9kdC51dGNub3coKS5pc29mb3JtYXQodGltZXNwZWM9J3NlY29uZHMnKSArICdaJwogICAgICAgICAgICB9KQogICAgICAgICAgICBkYXRhID0geyJ2ZXJzaW9uIjogMSwgIm1lc3NhZ2VzIjogbXNnc30KICAgICAgICAgICAgd2l0aCBvcGVuKHAsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgIGpzb24uZHVtcChkYXRhLCBmLCBlbnN1cmVfYXNjaWk9RmFsc2UsIGluZGVudD0yKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAjIC0tLS0tLS0tLS0gVUkgaGVscGVyIC0tLS0tLS0tLS0KICAgIGRlZiBfZjE3X3VpX2FwcGVuZChzZWxmLCBzZWxmX2FwcCwga2luZCwgdGV4dCk6CiAgICAgICAgIyBGMjZhOiBkcm9wIHNlbGYtVFggbW9uaXRvciBlY2hvZXMKICAgICAgICBpZiBfcmNfZHJvcF9jb25zb2xlX2VjaG8oc2VsZiwgdGV4dCk6CiAgICAgICAgICAgIHJldHVybgoKICAgICAgICB0cnk6CiAgICAgICAgICAgICMgUHJlZmVyIGV4aXN0aW5nIGFwcGVuZGVycyB0byBrZWVwIGNvbG91cgogICAgICAgICAgICBpZiBraW5kID09ICdyZWNlaXZlZCcgYW5kIGhhc2F0dHIoc2VsZl9hcHAsICdfYXBwZW5kX3J4Jyk6CiAgICAgICAgICAgICAgICBzZWxmX2FwcC5fYXBwZW5kX3J4KHRleHQpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICAgICAgaWYga2luZCA9PSAnc2VudCcgYW5kIGhhc2F0dHIoc2VsZl9hcHAsICdfYXBwZW5kX3R4Jyk6CiAgICAgICAgICAgICAgICBzZWxmX2FwcC5fYXBwZW5kX3R4KHRleHQpCiAgICAgICAgICAgICAgICByZXR1cm4KICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgIyBGYWxsYmFjayB0byBtZXNzYWdlc19saXN0IGlmIGF2YWlsYWJsZQogICAgICAgIHRyeToKICAgICAgICAgICAgZnJvbSBQeVF0NS5RdFdpZGdldHMgaW1wb3J0IFFMaXN0V2lkZ2V0SXRlbQogICAgICAgICAgICBmcm9tIFB5UXQ1LlF0R3VpIGltcG9ydCBRQnJ1c2gKICAgICAgICAgICAgZnJvbSBQeVF0NS5RdENvcmUgaW1wb3J0IFF0CiAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZl9hcHAsICdtZXNzYWdlc19saXN0JykgYW5kIHNlbGZfYXBwLm1lc3NhZ2VzX2xpc3Q6CiAgICAgICAgICAgICAgICB0cyA9IF9kdC5ub3coKS5zdHJmdGltZSgiJUg6JU06JVMiKQogICAgICAgICAgICAgICAgaXRlbSA9IFFMaXN0V2lkZ2V0SXRlbShmIlt7dHN9XSB7dGV4dH0iKQogICAgICAgICAgICAgICAgaWYga2luZCA9PSAncmVjZWl2ZWQnIGFuZCBoYXNhdHRyKHNlbGZfYXBwLCAnQ09MT1JfUlgnKToKICAgICAgICAgICAgICAgICAgICBpdGVtLnNldEZvcmVncm91bmQoUUJydXNoKHNlbGZfYXBwLkNPTE9SX1JYKSkKICAgICAgICAgICAgICAgIGVsaWYga2luZCA9PSAnc2VudCcgYW5kIGhhc2F0dHIoc2VsZl9hcHAsICdDT0xPUl9TRU5UJyk6CiAgICAgICAgICAgICAgICAgICAgaXRlbS5zZXRGb3JlZ3JvdW5kKFFCcnVzaChzZWxmX2FwcC5DT0xPUl9TRU5UKSkKICAgICAgICAgICAgICAgIHNlbGZfYXBwLm1lc3NhZ2VzX2xpc3QuaW5zZXJ0SXRlbSgwLCBpdGVtKQogICAgICAgICAgICAgICAgc2VsZl9hcHAubWVzc2FnZXNfbGlzdC5zY3JvbGxUb1RvcCgpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICMgLS0tLS0tLS0tLSBsaW5lIHByb2Nlc3NpbmcgLS0tLS0tLS0tLQogICAgZGVmIF9mMTdfcHJvY2Vzc19saW5lcyhzZWxmX2FwcCwgcyk6CiAgICAgICAgIyBub3JtYWxpemUgYW5kIHNwbGl0OyBhY2NlcHQgQ1IsIExGLCBDUkxGOyBhbHNvIGZsdXNoIHBhcnRpYWwKICAgICAgICB0cnk6CiAgICAgICAgICAgIHMgPSAnJyBpZiBzIGlzIE5vbmUgZWxzZSBzdHIocykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBzID0gc3RyKHMgb3IgJycpCiAgICAgICAgcyA9IHMucmVwbGFjZSgnXHJcbicsICdcbicpLnJlcGxhY2UoJ1xyJywgJ1xuJykKICAgICAgICBwYXJ0cyA9IHMuc3BsaXQoJ1xuJykKICAgICAgICBidWYgPSBnZXRhdHRyKHNlbGZfYXBwLCAnX2YxN19idWYnLCAnJykKICAgICAgICBpZiBidWY6CiAgICAgICAgICAgIHBhcnRzWzBdID0gYnVmICsgcGFydHNbMF0KICAgICAgICAgICAgc2VsZl9hcHAuX2YxN19idWYgPSAnJwogICAgICAgICAgICBzZWxmX2FwcC5fZjE3X2J1Zl90cyA9IDAuMAogICAgICAgICMgZW1pdCBjb21wbGV0ZQogICAgICAgIGZvciBpdG0gaW4gcGFydHNbOi0xXToKICAgICAgICAgICAgbGluZSA9IGl0bS5zdHJpcCgpCiAgICAgICAgICAgIGlmIGxpbmU6CiAgICAgICAgICAgICAgICBfZjE3X3NhdmVfYXBwZW5kKHNlbGZfYXBwLCAncmVjZWl2ZWQnLCBsaW5lKQogICAgICAgICAgICAgICAgX2YxN191aV9hcHBlbmQoc2VsZl9hcHAsICdyZWNlaXZlZCcsIGxpbmUpCiAgICAgICAgIyBob2xkIHRhaWwKICAgICAgICB0YWlsID0gcGFydHNbLTFdCiAgICAgICAgaWYgdGFpbDoKICAgICAgICAgICAgc2VsZl9hcHAuX2YxN19idWYgPSB0YWlsCiAgICAgICAgICAgIHNlbGZfYXBwLl9mMTdfYnVmX3RzID0gX3QubW9ub3RvbmljKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICBzZWxmX2FwcC5fZjE3X2J1ZiA9ICcnCiAgICAgICAgICAgIHNlbGZfYXBwLl9mMTdfYnVmX3RzID0gMC4wCgogICAgZGVmIF9mMTdfdGltZXJfZmx1c2goc2VsZl9hcHApOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgZ2V0YXR0cihzZWxmX2FwcCwgJ19mMTdfYnVmJywgJycpIGFuZCAoX3QubW9ub3RvbmljKCkgLSBnZXRhdHRyKHNlbGZfYXBwLCAnX2YxN19idWZfdHMnLCAwLjApKSA+PSAwLjI1OgogICAgICAgICAgICAgICAgbGluZSA9IHNlbGZfYXBwLl9mMTdfYnVmCiAgICAgICAgICAgICAgICBzZWxmX2FwcC5fZjE3X2J1ZiA9ICcnCiAgICAgICAgICAgICAgICBzZWxmX2FwcC5fZjE3X2J1Zl90cyA9IDAuMAogICAgICAgICAgICAgICAgbGluZSA9IHN0cihsaW5lKS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBsaW5lOgogICAgICAgICAgICAgICAgICAgIF9mMTdfc2F2ZV9hcHBlbmQoc2VsZl9hcHAsICdyZWNlaXZlZCcsIGxpbmUpCiAgICAgICAgICAgICAgICAgICAgX2YxN191aV9hcHBlbmQoc2VsZl9hcHAsICdyZWNlaXZlZCcsIGxpbmUpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgICMgLS0tLS0tLS0tLSBRU2VyaWFsUG9ydCBwYXRoIC0tLS0tLS0tLS0KICAgIGRlZiBfZjE3X3FzZXJpYWxfcmVhZHkoc2VsZl9hcHApOgogICAgICAgIHRyeToKICAgICAgICAgICAgc3AgPSBnZXRhdHRyKHNlbGZfYXBwLCAnc2VyaWFsJywgTm9uZSkgb3IgZ2V0YXR0cihzZWxmX2FwcCwgJ3NlcmlhbF9wb3J0JywgTm9uZSkKICAgICAgICAgICAgaWYgc3AgaXMgbm90IE5vbmUgYW5kIFFTZXJpYWxQb3J0IGlzIG5vdCBOb25lIGFuZCBpc2luc3RhbmNlKHNwLCBRU2VyaWFsUG9ydCk6CiAgICAgICAgICAgICAgICBkYXRhID0gYnl0ZXMoc3AucmVhZEFsbCgpKQogICAgICAgICAgICAgICAgaWYgZGF0YToKICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgIHMgPSBkYXRhLmRlY29kZSgndXRmLTgnLCBlcnJvcnM9J3JlcGxhY2UnKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHMgPSByZXByKGRhdGEpCiAgICAgICAgICAgICAgICAgICAgX2YxN19wcm9jZXNzX2xpbmVzKHNlbGZfYXBwLCBzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAjIC0tLS0tLS0tLS0gcHlzZXJpYWwgcG9sbGluZyBwYXRoIC0tLS0tLS0tLS0KICAgIGRlZiBfZjE3X3B5c2VyaWFsX3BvbGwoc2VsZl9hcHApOgogICAgICAgIHRyeToKICAgICAgICAgICAgc2VyID0gZ2V0YXR0cihzZWxmX2FwcCwgJ3NlcicsIE5vbmUpIG9yIGdldGF0dHIoc2VsZl9hcHAsICdzZXJpYWwnLCBOb25lKQogICAgICAgICAgICBpZiBzZXIgaXMgbm90IE5vbmUgYW5kIGhhc2F0dHIoc2VyLCAnaW5fd2FpdGluZycpOgogICAgICAgICAgICAgICAgbiA9IDAKICAgICAgICAgICAgICAgIHRyeTogbiA9IHNlci5pbl93YWl0aW5nCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiAKICAgICAgICAgICAgICAgICAgICB0cnk6IG4gPSBzZXIuaW5XYWl0aW5nKCkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBuID0gMAogICAgICAgICAgICAgICAgaWYgbiBhbmQgbiA+IDA6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBkYXRhID0gc2VyLnJlYWQobikKICAgICAgICAgICAgICAgICAgICAgICAgaWYgaXNpbnN0YW5jZShkYXRhLCBieXRlcyk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBzID0gZGF0YS5kZWNvZGUoJ3V0Zi04JywgZXJyb3JzPSdyZXBsYWNlJykKICAgICAgICAgICAgICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIHMgPSBzdHIoZGF0YSkKICAgICAgICAgICAgICAgICAgICAgICAgX2YxN19wcm9jZXNzX2xpbmVzKHNlbGZfYXBwLCBzKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgIyAtLS0tLS0tLS0tIGluc3RhbGwgaW4gX19pbml0X18gLS0tLS0tLS0tLQogICAgX0YxN19PUklHX0lOSVQgPSBnZXRhdHRyKENoYXRBcHAsICdfX2luaXRfXycsIE5vbmUpCiAgICBpZiBjYWxsYWJsZShfRjE3X09SSUdfSU5JVCk6CiAgICAgICAgZGVmIF9GMTdfSU5JVChzZWxmLCAqYSwgKiprdyk6CiAgICAgICAgICAgIF9GMTdfT1JJR19JTklUKHNlbGYsICphLCAqKmt3KQogICAgICAgICAgICAjIGluaXQgYnVmZmVycwogICAgICAgICAgICBzZWxmLl9mMTdfYnVmID0gJycKICAgICAgICAgICAgc2VsZi5fZjE3X2J1Zl90cyA9IDAuMAogICAgICAgICAgICAjIGhvb2sgUVNlcmlhbFBvcnQgaWYgcHJlc2VudAogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzcCA9IGdldGF0dHIoc2VsZiwgJ3NlcmlhbCcsIE5vbmUpIG9yIGdldGF0dHIoc2VsZiwgJ3NlcmlhbF9wb3J0JywgTm9uZSkKICAgICAgICAgICAgICAgIGlmIHNwIGlzIG5vdCBOb25lIGFuZCBRU2VyaWFsUG9ydCBpcyBub3QgTm9uZSBhbmQgaXNpbnN0YW5jZShzcCwgUVNlcmlhbFBvcnQpOgogICAgICAgICAgICAgICAgICAgIHRyeTogc3AucmVhZHlSZWFkLmNvbm5lY3QobGFtYmRhOiBfZjE3X3FzZXJpYWxfcmVhZHkoc2VsZikpCiAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAjIHN0YXJ0IHBlcmlvZGljIGZsdXNoICsgcG9sbGluZwogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzZWxmLl9mMTdfdGltZXIgPSBRVGltZXIoc2VsZikKICAgICAgICAgICAgICAgIHNlbGYuX2YxN190aW1lci5zZXRJbnRlcnZhbCg1MCkKICAgICAgICAgICAgICAgIGRlZiBfdGljaygpOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgX2YxN190aW1lcl9mbHVzaChzZWxmKQogICAgICAgICAgICAgICAgICAgICAgICBfZjE3X3B5c2VyaWFsX3BvbGwoc2VsZikKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICAgICBzZWxmLl9mMTdfdGltZXIudGltZW91dC5jb25uZWN0KF90aWNrKQogICAgICAgICAgICAgICAgc2VsZi5fZjE3X3RpbWVyLnN0YXJ0KCkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBDaGF0QXBwLl9faW5pdF9fID0gX0YxN19JTklUCgpleGNlcHQgRXhjZXB0aW9uIGFzIF9lX2YxNzoKICAgIHRyeToKICAgICAgICBkaWFnX2xvZyhmIkYxN19SWF9UQVBfQU5EX1BFUlNJU1QgZmFpbGVkOiB7X2VfZjE3fSIpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHBhc3MKCiMgPT09PT09PT0gRW5kIEYxNyA9PT09PT09PQoKCgojID09PT09PT09IEYxODogRm9yY2Ugc2VyaWFsIGJhdWQgPSAzODQwMCArIHN0cm9uZ2VyIGRpYWdub3N0aWNzID09PT09PT09CnRyeToKICAgIGltcG9ydCBvcywganNvbiwgdGltZSBhcyBfdAogICAgZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUgYXMgX2R0CiAgICBmcm9tIFB5UXQ1LlF0Q29yZSBpbXBvcnQgUVRpbWVyCiAgICB0cnk6CiAgICAgICAgZnJvbSBQeVF0NS5RdFNlcmlhbFBvcnQgaW1wb3J0IFFTZXJpYWxQb3J0LCBRU2VyaWFsUG9ydEluZm8KICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgUVNlcmlhbFBvcnQgPSBOb25lCiAgICAgICAgUVNlcmlhbFBvcnRJbmZvID0gTm9uZQoKICAgIGRlZiBfZjE4X2RpYWdfd3JpdGUoc2VsZiwgd2hhdDogc3RyLCAqKmZpZWxkcyk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBiYXNlID0gb3MucGF0aC5kaXJuYW1lKG9zLnBhdGguYWJzcGF0aChfX2ZpbGVfXykpCiAgICAgICAgICAgIHAgPSBvcy5wYXRoLmpvaW4oYmFzZSwgJ3N0b3JlJywgJ3NlcmlhbF9kaWFnLmxvZycpCiAgICAgICAgICAgIG9zLm1ha2VkaXJzKG9zLnBhdGguZGlybmFtZShwKSwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICAgICAgcmVjID0geyJ0IjogX2R0LnV0Y25vdygpLmlzb2Zvcm1hdCh0aW1lc3BlYz0nc2Vjb25kcycpICsgJ1onLCAibXNnIjogd2hhdH0KICAgICAgICAgICAgcmVjLnVwZGF0ZShmaWVsZHMpCiAgICAgICAgICAgIHdpdGggb3BlbihwLCAnYScsIGVuY29kaW5nPSd1dGYtOCcpIGFzIGY6CiAgICAgICAgICAgICAgICBmLndyaXRlKGpzb24uZHVtcHMocmVjLCBlbnN1cmVfYXNjaWk9RmFsc2UpICsgIlxuIikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgZGVmIF9mMThfZm9yY2VfMzg0MDAoc2VsZik6CiAgICAgICAgJycnRm9yY2UgMzg0MDAgb24gYm90aCBRdFNlcmlhbFBvcnQgYW5kIHB5c2VyaWFsIGlmIHByZXNlbnQuJycnCiAgICAgICAgdHJ5OgogICAgICAgICAgICAjIFF0U2VyaWFsUG9ydCBwYXRoCiAgICAgICAgICAgIHNwID0gZ2V0YXR0cihzZWxmLCAnc2VyaWFsJywgTm9uZSkgb3IgZ2V0YXR0cihzZWxmLCAnc2VyaWFsX3BvcnQnLCBOb25lKQogICAgICAgICAgICBpZiBRU2VyaWFsUG9ydCBpcyBub3QgTm9uZSBhbmQgaXNpbnN0YW5jZShzcCwgUVNlcmlhbFBvcnQpOgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGN1cnJlbnQgPSBpbnQoc3AuYmF1ZFJhdGUoKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgY3VycmVudCA9IE5vbmUKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBpZiBjdXJyZW50ICE9IDM4NDAwOgogICAgICAgICAgICAgICAgICAgICAgICBzcC5zZXRCYXVkUmF0ZSgzODQwMCkKICAgICAgICAgICAgICAgICAgICAgICAgX2YxOF9kaWFnX3dyaXRlKHNlbGYsICJzZXQgUXRTZXJpYWxQb3J0IGJhdWQiLCBwcmV2PWN1cnJlbnQsIG5vdz0zODQwMCkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgICAgICBfZjE4X2RpYWdfd3JpdGUoc2VsZiwgImZhaWxlZCBzZXQgUXRTZXJpYWxQb3J0IGJhdWQiLCBlcnJvcj1zdHIoZSkpCiAgICAgICAgICAgICMgcHlzZXJpYWwgcGF0aAogICAgICAgICAgICBzZXIgPSBnZXRhdHRyKHNlbGYsICdzZXInLCBOb25lKSBvciBnZXRhdHRyKHNlbGYsICdzZXJpYWwnLCBOb25lKQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEF2b2lkIGRvdWJsZS11c2luZyBzYW1lIG9iamVjdAogICAgICAgICAgICAgICAgaWYgc2VyIGlzIG5vdCBOb25lIGFuZCAoUVNlcmlhbFBvcnQgaXMgTm9uZSBvciBub3QgaXNpbnN0YW5jZShzZXIsIFFTZXJpYWxQb3J0KSk6CiAgICAgICAgICAgICAgICAgICAgcHJldiA9IE5vbmUKICAgICAgICAgICAgICAgICAgICB0cnk6IHByZXYgPSBpbnQoZ2V0YXR0cihzZXIsICdiYXVkcmF0ZScsIE5vbmUpKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHByZXYgPSBOb25lCiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBzZXRhdHRyKHNlciwgJ2JhdWRyYXRlJywgMzg0MDApCiAgICAgICAgICAgICAgICAgICAgICAgIF9mMThfZGlhZ193cml0ZShzZWxmLCAic2V0IHB5c2VyaWFsIGJhdWQiLCBwcmV2PXByZXYsIG5vdz0zODQwMCkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgICAgICAgICAgICAgICAgIF9mMThfZGlhZ193cml0ZShzZWxmLCAiZmFpbGVkIHNldCBweXNlcmlhbCBiYXVkIiwgZXJyb3I9c3RyKGUpKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAjIEluc3RhbGwgaW50byBfX2luaXRfXyByaWdodCBhZnRlciBGMTcKICAgIF9GMThfT1JJR19JTklUID0gZ2V0YXR0cihDaGF0QXBwLCAnX19pbml0X18nLCBOb25lKQogICAgaWYgY2FsbGFibGUoX0YxOF9PUklHX0lOSVQpOgogICAgICAgIGRlZiBfRjE4X0lOSVQoc2VsZiwgKmEsICoqa3cpOgogICAgICAgICAgICBfRjE4X09SSUdfSU5JVChzZWxmLCAqYSwgKiprdykKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgX2YxOF9mb3JjZV8zODQwMChzZWxmKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAjIEtlZXAgZW5mb3JjaW5nIGV2ZXJ5IDIgc2Vjb25kcyAoc29tZSBkcml2ZXJzIGNhbiByZXNldCBiYXVkIGFmdGVyIG9wZW4pCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHNlbGYuX2YxOF90aW1lciA9IFFUaW1lcihzZWxmKQogICAgICAgICAgICAgICAgc2VsZi5fZjE4X3RpbWVyLnNldEludGVydmFsKDIwMDApCiAgICAgICAgICAgICAgICBzZWxmLl9mMThfdGltZXIudGltZW91dC5jb25uZWN0KGxhbWJkYTogX2YxOF9mb3JjZV8zODQwMChzZWxmKSkKICAgICAgICAgICAgICAgIHNlbGYuX2YxOF90aW1lci5zdGFydCgpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgICMgRmlyc3Qgc25hcHNob3QKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgc3AgPSBnZXRhdHRyKHNlbGYsICdzZXJpYWwnLCBOb25lKSBvciBnZXRhdHRyKHNlbGYsICdzZXJpYWxfcG9ydCcsIE5vbmUpCiAgICAgICAgICAgICAgICBzZXIgPSBnZXRhdHRyKHNlbGYsICdzZXInLCBOb25lKSBvciBnZXRhdHRyKHNlbGYsICdzZXJpYWwnLCBOb25lKQogICAgICAgICAgICAgICAgcXRfYmF1ZCA9IE5vbmUKICAgICAgICAgICAgICAgIHB5X2JhdWQgPSBOb25lCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgaWYgUVNlcmlhbFBvcnQgaXMgbm90IE5vbmUgYW5kIGlzaW5zdGFuY2Uoc3AsIFFTZXJpYWxQb3J0KToKICAgICAgICAgICAgICAgICAgICAgICAgcXRfYmF1ZCA9IGludChzcC5iYXVkUmF0ZSgpKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIGlmIHNlciBpcyBub3QgTm9uZSBhbmQgKFFTZXJpYWxQb3J0IGlzIE5vbmUgb3Igbm90IGlzaW5zdGFuY2Uoc2VyLCBRU2VyaWFsUG9ydCkpOgogICAgICAgICAgICAgICAgICAgICAgICBweV9iYXVkID0gaW50KGdldGF0dHIoc2VyLCAnYmF1ZHJhdGUnLCBOb25lKSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgICAgIF9mMThfZGlhZ193cml0ZShzZWxmLCAiYmF1ZCBzbmFwc2hvdCIsIHF0X2JhdWQ9cXRfYmF1ZCwgcHlfYmF1ZD1weV9iYXVkKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIENoYXRBcHAuX19pbml0X18gPSBfRjE4X0lOSVQKCmV4Y2VwdCBFeGNlcHRpb24gYXMgX2VfZjE4OgogICAgdHJ5OgogICAgICAgIGRpYWdfbG9nKGYiRjE4IDM4NDAwIGZvcmNlIGZhaWxlZDoge19lX2YxOH0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgojID09PT09PT09IEVuZCBGMTggPT09PT09PT0KCgoKIyA9PT09PT09PSBGMTk6IFN0cmlwIFtNT05dIGV2ZXJ5d2hlcmUgKyBUWCBsZWFkL3RhaWwgdGltaW5nICgyNTBtcy8yNTBtcykgPT09PT09PT0KdHJ5OgogICAgaW1wb3J0IHJlIGFzIF9yZSwgdGltZSBhcyBfdAoKICAgICMgLS0tIHVuaXZlcnNhbCBzYW5pdGl6ZXIgKHJlbW92ZSBbTU9OXSBhbmQgc2ltaWxhciB0YWdzKSAtLS0KICAgIGRlZiBfZjE5X3Nhbml0aXplKGxpbmU6IHN0cikgLT4gc3RyOgogICAgICAgIHMgPSAnJyBpZiBsaW5lIGlzIE5vbmUgZWxzZSBzdHIobGluZSkKICAgICAgICAjIHJlbW92ZSB0aW1lc3RhbXAgW1lZWVktbW0tZGQgSEg6TU06U1NdIGlmIHByZXNlbnQsIHRoZW4gYSB0YWcgbGlrZSBbTU9OXS9bS0lTU10vW1JYXS9bQVBSU10KICAgICAgICBzID0gX3JlLnN1YihyJ15ccypcW1xkezR9LVxkezJ9LVxkezJ9W15dXStcXVxzKicsICcnLCBzKQogICAgICAgIHMgPSBzLnJlcGxhY2UoJ1tNT05dICcsICcnKS5yZXBsYWNlKCdbTU9OXScsICcnKQogICAgICAgICMgb3B0aW9uYWw6IHN0cmlwIG90aGVyIHRhZ3MgdG9vCiAgICAgICAgZm9yIHRhZyBpbiAoJ1tLSVNTXScsICdbUlhdJywgJ1tBUFJTXScpOgogICAgICAgICAgICBzID0gcy5yZXBsYWNlKHRhZyArICcgJywgJycpLnJlcGxhY2UodGFnLCAnJykKICAgICAgICByZXR1cm4gcy5zdHJpcCgpCgogICAgIyAtLS0gV3JhcCBhcHBlbmRlcnMgc28gYW55IHBhdGggaW50byB0aGUgTWVzc2FnZXMgbGlzdCBpcyBzYW5pdGl6ZWQgLS0tCiAgICBpZiBoYXNhdHRyKENoYXRBcHAsICdfYXBwZW5kX3J4Jyk6CiAgICAgICAgX0YxOV9PUklHX0FSWCA9IENoYXRBcHAuX2FwcGVuZF9yeAogICAgICAgIGRlZiBfRjE5X0FSWChzZWxmLCBsaW5lKToKICAgICAgICAgICAgdHJ5OiBsaW5lID0gX2YxOV9zYW5pdGl6ZShsaW5lKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgIHJldHVybiBfRjE5X09SSUdfQVJYKHNlbGYsIGxpbmUpCiAgICAgICAgQ2hhdEFwcC5fYXBwZW5kX3J4ID0gX0YxOV9BUlgKCiAgICBpZiBoYXNhdHRyKENoYXRBcHAsICdfYXBwZW5kX3N5cycpOgogICAgICAgIF9GMTlfT1JJR19BU1lTID0gQ2hhdEFwcC5fYXBwZW5kX3N5cwogICAgICAgIGRlZiBfRjE5X0FTWVMoc2VsZiwgbGluZSk6CiAgICAgICAgICAgIHRyeTogbGluZSA9IF9mMTlfc2FuaXRpemUobGluZSkKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICByZXR1cm4gX0YxOV9PUklHX0FTWVMoc2VsZiwgbGluZSkKICAgICAgICBDaGF0QXBwLl9hcHBlbmRfc3lzID0gX0YxOV9BU1lTCgogICAgIyBFbnN1cmUgYW55IFVJLW9ubHkvbW9uaXRvciBwYXRoIGlzIHNhbml0aXplZCBhbmQgZm9yd2FyZGVkIGludG8gbWFpbiBSWCBhcHBlbmRlcgogICAgaWYgaGFzYXR0cihDaGF0QXBwLCAnX2FwcGVuZF9yeF91aV9vbmx5Jyk6CiAgICAgICAgX0YxOV9PUklHX1VJID0gQ2hhdEFwcC5fYXBwZW5kX3J4X3VpX29ubHkKICAgICAgICBkZWYgX0YxOV9VSShzZWxmLCBsaW5lKToKICAgICAgICAgICAgdHJ5OiBsaW5lID0gX2YxOV9zYW5pdGl6ZShsaW5lKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIGlmIGhhc2F0dHIoc2VsZiwgJ19hcHBlbmRfcngnKToKICAgICAgICAgICAgICAgICAgICByZXR1cm4gc2VsZi5fYXBwZW5kX3J4KGxpbmUpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybiBfRjE5X09SSUdfVUkoc2VsZiwgbGluZSkKICAgICAgICBDaGF0QXBwLl9hcHBlbmRfcnhfdWlfb25seSA9IF9GMTlfVUkKCiAgICAjIEFsc28gc2FuaXRpemUgdGhlIEYxNyBmYWxsYmFjayBVSSBhcHBlbmRlciBpZiBwcmVzZW50CiAgICBpZiAnX2YxN191aV9hcHBlbmQnIGluIGdsb2JhbHMoKToKICAgICAgICBfRjE5X09SSUdfVUlBUFAgPSBfZjE3X3VpX2FwcGVuZAogICAgICAgIGRlZiBfZjE3X3VpX2FwcGVuZChzZWxmX2FwcCwga2luZCwgdGV4dCk6CiAgICAgICAgICAgICMgRjI2YTogZHJvcCBzZWxmLVRYIG1vbml0b3IgZWNob2VzCiAgICAgICAgICAgIGlmIF9yY19kcm9wX2NvbnNvbGVfZWNobyhzZWxmLCB0ZXh0KToKICAgICAgICAgICAgICAgIHJldHVybgoKICAgICAgICAgICAgdHJ5OiB0ZXh0ID0gX2YxOV9zYW5pdGl6ZSh0ZXh0KQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgIHJldHVybiBfRjE5X09SSUdfVUlBUFAoc2VsZl9hcHAsIGtpbmQsIHRleHQpCgogICAgIyAtLS0gVFggdGltaW5nOiAyNTAgbXMgbGVhZCAoYmVmb3JlIHNlbmQpIGFuZCAyNTAgbXMgdGFpbCAoYWZ0ZXIgc2VuZCkgLS0tCiAgICAjIEFwcGxpZXMgdG8gc2VuZF91c2VyX3RleHQgYW5kIGxvdy1sZXZlbCBzZXJpYWwud3JpdGUgd2hlcmUgcHJlc2VudC4KICAgIGRlZiBfZjE5X3R4X2xlYWRfdGFpbChzZWxmKToKICAgICAgICAjIFRyeSB0b2dnbGluZyBSVFMvRFRSIGJyaWVmbHkgKGJlc3QtZWZmb3J0OyBtYW55IFROQ3MgaWdub3JlIGl0KQogICAgICAgIHRyeToKICAgICAgICAgICAgc2VyID0gZ2V0YXR0cihzZWxmLCAnc2VyJywgTm9uZSkgb3IgZ2V0YXR0cihzZWxmLCAnc2VyaWFsJywgTm9uZSkKICAgICAgICAgICAgIyBMZWFkCiAgICAgICAgICAgIGlmIHNlciBpcyBub3QgTm9uZToKICAgICAgICAgICAgICAgIGZvciBzaWcgaW4gKCdzZXREVFInLCAnc2V0UlRTJyk6CiAgICAgICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICAgICBmbiA9IGdldGF0dHIoc2VyLCBzaWcsIE5vbmUpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGNhbGxhYmxlKGZuKTogZm4oVHJ1ZSkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgIF90LnNsZWVwKDAuMjUpICAjIDI1MCBtcyBsZWFkCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcGFzcwoKICAgIGRlZiBfZjE5X3R4X3RhaWwoc2VsZik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBfdC5zbGVlcCgwLjI1KSAgIyAyNTAgbXMgdGFpbAogICAgICAgICAgICBzZXIgPSBnZXRhdHRyKHNlbGYsICdzZXInLCBOb25lKSBvciBnZXRhdHRyKHNlbGYsICdzZXJpYWwnLCBOb25lKQogICAgICAgICAgICBpZiBzZXIgaXMgbm90IE5vbmU6CiAgICAgICAgICAgICAgICBmb3Igc2lnIGluICgnc2V0UlRTJywgJ3NldERUUicpOgogICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgZm4gPSBnZXRhdHRyKHNlciwgc2lnLCBOb25lKQogICAgICAgICAgICAgICAgICAgICAgICBpZiBjYWxsYWJsZShmbik6IGZuKEZhbHNlKQogICAgICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCgogICAgIyBXcmFwIHNlbmRfdXNlcl90ZXh0IGlmIGF2YWlsYWJsZQogICAgaWYgaGFzYXR0cihDaGF0QXBwLCAnc2VuZF91c2VyX3RleHQnKToKICAgICAgICBfRjE5X09SSUdfU0VORCA9IENoYXRBcHAuc2VuZF91c2VyX3RleHQKICAgICAgICBkZWYgX0YxOV9TRU5EKHNlbGYsIHRleHQpOgogICAgICAgICAgICB0cnk6IF9mMTlfdHhfbGVhZF90YWlsKHNlbGYpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgciA9IF9GMTlfT1JJR19TRU5EKHNlbGYsIHRleHQpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICAgICAgICAgIHIgPSBOb25lCiAgICAgICAgICAgIHRyeTogX2YxOV90eF90YWlsKHNlbGYpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgcmV0dXJuIHIKICAgICAgICBDaGF0QXBwLnNlbmRfdXNlcl90ZXh0ID0gX0YxOV9TRU5ECgogICAgIyBXcmFwIGxvdy1sZXZlbCBzZXJpYWwgd3JpdGUgaWYgaXQncyBleHBvc2VkIGFzIGEgbWV0aG9kIG9uIHRoZSBhcHAgKHJhcmUpCiAgICBpZiBoYXNhdHRyKENoYXRBcHAsICdzZXJpYWxfd3JpdGUnKToKICAgICAgICBfRjE5X09SSUdfU1cgPSBDaGF0QXBwLnNlcmlhbF93cml0ZQogICAgICAgIGRlZiBfRjE5X1NXKHNlbGYsIGRhdGEpOgogICAgICAgICAgICB0cnk6IF9mMTlfdHhfbGVhZF90YWlsKHNlbGYpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgdHJ5OiByID0gX0YxOV9PUklHX1NXKHNlbGYsIGRhdGEpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHIgPSBOb25lCiAgICAgICAgICAgIHRyeTogX2YxOV90eF90YWlsKHNlbGYpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgcmV0dXJuIHIKICAgICAgICBDaGF0QXBwLnNlcmlhbF93cml0ZSA9IF9GMTlfU1cKCmV4Y2VwdCBFeGNlcHRpb24gYXMgX2VfZjE5OgogICAgdHJ5OgogICAgICAgIGRpYWdfbG9nKGYiRjE5IHNhbml0aXplL3R4IHRpbWluZyBmYWlsZWQ6IHtfZV9mMTl9IikKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKIyA9PT09PT09PSBFbmQgRjE5ID09PT09PT09CgoKCiMgPT09PT09PT0gRjIwOiBCbG9jayBzZWxmLUFDS3MgYW5kIHN1cHByZXNzIG15IG93biBtb25pdG9yIGVjaG9lcyA9PT09PT09PQp0cnk6CiAgICBpbXBvcnQgcmUgYXMgX3JlCgogICAgX0YyMF9BQ0tfUkUgID0gX3JlLmNvbXBpbGUocidcW0FDSzooWzAtOUEtWmEtel17MiwxMn0pXF0nKQogICAgX0YyMF9DSEFUX1JFID0gX3JlLmNvbXBpbGUocideXHMqKFtBLVowLTkvK1wtXSspXHMrREVccysoW0EtWjAtOS8rXC1dKylccysoLis/KVxzKiQnLCBfcmUuSSkKICAgIF9GMjBfTU9OX1JFICA9IF9yZS5jb21waWxlKHInXlxzKihcW1teXF1dK1xdXHMqKT9cW01PTlxdXHMqZm1ccysoW0EtWjAtOS8rXC1dKylcYicsIF9yZS5JKQoKICAgIGRlZiBfZjIwX2lzX3NlbGZfYWNrKGFwcCwgczogc3RyKSAtPiBib29sOgogICAgICAgICcnJ1JldHVybiBUcnVlIGlmIGxpbmUgY29udGFpbnMgYW4gQUNLIHRoYXQgaXMgZnJvbSBNWUNBTEwgb3Igbm90IGFkZHJlc3NlZCB0byBNWUNBTEwuJycnCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzMiA9ICcnIGlmIHMgaXMgTm9uZSBlbHNlIHN0cihzKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHMyID0gc3RyKHMgb3IgJycpCiAgICAgICAgbV9jaGF0ID0gX0YyMF9DSEFUX1JFLm1hdGNoKHMyKQogICAgICAgIGlmIG5vdCBtX2NoYXQ6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIHRvX2NzICA9IChtX2NoYXQuZ3JvdXAoMSkgb3IgJycpLnVwcGVyKCkuc3RyaXAoKQogICAgICAgIGZybV9jcyA9IChtX2NoYXQuZ3JvdXAoMikgb3IgJycpLnVwcGVyKCkuc3RyaXAoKQogICAgICAgIGJvZHkgICA9IChtX2NoYXQuZ3JvdXAoMykgb3IgJycpCiAgICAgICAgaWYgbm90IF9GMjBfQUNLX1JFLnNlYXJjaChib2R5KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgbXljID0gJycKICAgICAgICB0cnk6CiAgICAgICAgICAgIG15YyA9IGFwcC5teWNhbGxfZWRpdC50ZXh0KCkuc3RyaXAoKS51cHBlcigpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgbXljID0gJycKICAgICAgICAjIEJsb2NrIGlmIEZST00gPT0gTVlDQUxMIG9yIFRPICE9IE1ZQ0FMTCAob25seSBwZWVyLXRvLW1lIEFDS3MgYWxsb3dlZCkKICAgICAgICBpZiBteWMgYW5kIChmcm1fY3MgPT0gbXljIG9yICh0b19jcyBhbmQgdG9fY3MgIT0gbXljKSk6CiAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9mMjBfaXNfbXlfbW9uaXRvcl9lY2hvKGFwcCwgczogc3RyKSAtPiBib29sOgogICAgICAgICcnJ0RldGVjdCBbTU9OXSBmbSA8TVlDQUxMPiAuLi4gZWNobyBsaW5lcyBhbmQgc3VwcHJlc3MgdGhlbSBmcm9tIFVJL0FDSyBwYXRoLicnJwogICAgICAgIHRyeToKICAgICAgICAgICAgczIgPSAnJyBpZiBzIGlzIE5vbmUgZWxzZSBzdHIocykKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBzMiA9IHN0cihzIG9yICcnKQogICAgICAgIG0gPSBfRjIwX01PTl9SRS5tYXRjaChzMikKICAgICAgICBpZiBub3QgbToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgZnJtID0gKG0uZ3JvdXAoMikgb3IgJycpLnVwcGVyKCkKICAgICAgICBteWMgPSAnJwogICAgICAgIHRyeToKICAgICAgICAgICAgbXljID0gYXBwLm15Y2FsbF9lZGl0LnRleHQoKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBteWMgPSAnJwogICAgICAgIHJldHVybiBib29sKG15YyBhbmQgZnJtID09IG15YykKCiAgICAjIFdyYXAgdGhlIHNlcmlhbC10aHJlYWQgbGluZSBoYW5kbGVyIHRvIGZpbHRlciBiZWZvcmUgYW55IG90aGVyIGxvZ2ljIHJ1bnMKICAgIF9GMjBfT1JJR19SWCA9IGdldGF0dHIoQ2hhdEFwcCwgIl9vbl9zZXJpYWxfdGhyZWFkX2xpbmUiLCBOb25lKQogICAgZGVmIF9GMjBfRklMVEVSKHNlbGYsIGxpbmU6IHN0cik6CiAgICAgICAgdHJ5OgogICAgICAgICAgICBzID0gJycgaWYgbGluZSBpcyBOb25lIGVsc2Ugc3RyKGxpbmUpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgcyA9IHN0cihsaW5lIG9yICcnKQogICAgICAgICMgU3VwcHJlc3MgbXkgb3duIFtNT05dIGZtIDxNWUNBTEw+IC4uLiBlY2hvZXMgZW50aXJlbHkKICAgICAgICBpZiBfZjIwX2lzX215X21vbml0b3JfZWNobyhzZWxmLCBzKToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgIyBGaWx0ZXIgQUNLcyB0aGF0IGFyZSBmcm9tIG1lIG9yIG5vdCB0byBtZQogICAgICAgIGlmIF9mMjBfaXNfc2VsZl9hY2soc2VsZiwgcyk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgICMgT3RoZXJ3aXNlLCBjb250aW51ZSB3aXRoIG9yaWdpbmFsIGhhbmRsZXIKICAgICAgICBpZiBjYWxsYWJsZShfRjIwX09SSUdfUlgpOgogICAgICAgICAgICByZXR1cm4gX0YyMF9PUklHX1JYKHNlbGYsIGxpbmUpCgogICAgQ2hhdEFwcC5fb25fc2VyaWFsX3RocmVhZF9saW5lID0gX0YyMF9GSUxURVIKCmV4Y2VwdCBFeGNlcHRpb24gYXMgX2VfZjIwOgogICAgdHJ5OgogICAgICAgIGRpYWdfbG9nKGYiRjIwIHNlbGYtYWNrIGZpbHRlciBmYWlsZWQ6IHtfZV9mMjB9IikKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKIyA9PT09PT09PSBFbmQgRjIwID09PT09PT09CgoKCiMgPT09PT09PT0gRjIxOiBLaWxsIG1vbml0b3IgbGluZXMsIGtpbGwgVFggZWNobywgc3RyaWN0IEFDSyBnYXRpbmcgKFRPPT1NWUNBTEwsIEZST00hPU1ZQ0FMTCkgPT09PT09PT0KdHJ5OgogICAgaW1wb3J0IHJlIGFzIF9yZSwgdGltZSBhcyBfdAoKICAgICMgSGVscGVycwogICAgZGVmIF9mMjFfbXljKGFwcCk6CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gYXBwLm15Y2FsbF9lZGl0LnRleHQoKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gIiIKCiAgICBfRjIxX1RBR19SRSA9IF9yZS5jb21waWxlKHInXlxzKihcW1teXF1dK1xdXHMqKT9cWyhNT058S0lTU3xSWHxBUFJTKVxdXHMqJywgX3JlLkkpCiAgICBfRjIxX0NIQVRfUkUgPSBfcmUuY29tcGlsZShyJ15ccyooW0EtWjAtOS8rXC1dKylccytERVxzKyhbQS1aMC05LytcLV0rKVxzKyguKz8pXHMqJCcsIF9yZS5JKQogICAgX0YyMV9BQ0tfUkUgID0gX3JlLmNvbXBpbGUocidcW0FDSzooWzAtOUEtWmEtel17MiwxMn0pXF0nKQoKICAgIGRlZiBfZjIxX2lzX21vbml0b3JfbGluZShzOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgcmV0dXJuIGJvb2woX0YyMV9UQUdfUkUubWF0Y2gocyBvciAiIikpIG9yICIgcGlkICIgaW4gKHMgb3IgIiIpLmxvd2VyKCkKCiAgICBkZWYgX2YyMV9pc19zZWxmX2FjayhhcHAsIHM6IHN0cikgLT4gYm9vbDoKICAgICAgICAnJydBQ0tzIGFyZSB2YWxpZCBPTkxZIHdoZW4gVE8gPT0gTVlDQUxMIGFuZCBGUk9NICE9IE1ZQ0FMTC4gRXZlcnl0aGluZyBlbHNlIGlzIHJlamVjdGVkLicnJwogICAgICAgIG0gPSBfRjIxX0NIQVRfUkUubWF0Y2gocyBvciAiIikKICAgICAgICBpZiBub3QgbToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgdG9fY3MsIGZybV9jcywgYm9keSA9IChtLmdyb3VwKDEpIG9yICIiKS51cHBlcigpLCAobS5ncm91cCgyKSBvciAiIikudXBwZXIoKSwgKG0uZ3JvdXAoMykgb3IgIiIpCiAgICAgICAgaWYgbm90IF9GMjFfQUNLX1JFLnNlYXJjaChib2R5KToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgbXljID0gX2YyMV9teWMoYXBwKQogICAgICAgIGlmIG5vdCBteWM6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgICMgUmVqZWN0IGlmIEZST009PU1ZQ0FMTCBvciBUTyE9TVlDQUxMCiAgICAgICAgcmV0dXJuIChmcm1fY3MgPT0gbXljKSBvciAodG9fY3MgYW5kIHRvX2NzICE9IG15YykKCiAgICAjIFJlY29yZCBsYXN0IFRYIHRleHQgYW5kIGlnbm9yZSBleGFjdCBlY2hvIGZvciAzcwogICAgaWYgbm90IGhhc2F0dHIoQ2hhdEFwcCwgIl9mMjFfcmVjZW50X3R4Iik6CiAgICAgICAgQ2hhdEFwcC5fZjIxX3JlY2VudF90eCA9IFtdICAjIGxpc3Qgb2YgKHRzLCB0ZXh0KQoKICAgICMgV3JhcCBzZW5kX3VzZXJfdGV4dCB0byByZW1lbWJlciB3aGF0IHdlIHNlbnQKICAgIGlmIGhhc2F0dHIoQ2hhdEFwcCwgInNlbmRfdXNlcl90ZXh0Iik6CiAgICAgICAgX0YyMV9PUklHX1NFTkQgPSBDaGF0QXBwLnNlbmRfdXNlcl90ZXh0CiAgICAgICAgZGVmIF9GMjFfU0VORChzZWxmLCB0ZXh0KToKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgbm93ID0gX3QudGltZSgpCiAgICAgICAgICAgICAgICB0eHQgPSAodGV4dCBvciAiIikuc3RyaXAoKQogICAgICAgICAgICAgICAgIyBrZWVwIDNzIHdpbmRvdwogICAgICAgICAgICAgICAgQ2hhdEFwcC5fZjIxX3JlY2VudF90eCA9IFsodHMsIHQpIGZvciAodHMsIHQpIGluIENoYXRBcHAuX2YyMV9yZWNlbnRfdHggaWYgbm93IC0gdHMgPD0gMy4wXQogICAgICAgICAgICAgICAgaWYgdHh0OgogICAgICAgICAgICAgICAgICAgIENoYXRBcHAuX2YyMV9yZWNlbnRfdHguYXBwZW5kKChub3csIHR4dCkpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybiBfRjIxX09SSUdfU0VORChzZWxmLCB0ZXh0KQogICAgICAgIENoYXRBcHAuc2VuZF91c2VyX3RleHQgPSBfRjIxX1NFTkQKCiAgICBkZWYgX2YyMV9pc190eF9lY2hvKHM6IHN0cikgLT4gYm9vbDoKICAgICAgICB0cnk6CiAgICAgICAgICAgIG5vdyA9IF90LnRpbWUoKQogICAgICAgICAgICB0eHQgPSAocyBvciAiIikuc3RyaXAoKQogICAgICAgICAgICAjIHBydW5lCiAgICAgICAgICAgIENoYXRBcHAuX2YyMV9yZWNlbnRfdHggPSBbKHRzLCB0KSBmb3IgKHRzLCB0KSBpbiBDaGF0QXBwLl9mMjFfcmVjZW50X3R4IGlmIG5vdyAtIHRzIDw9IDMuMF0KICAgICAgICAgICAgZm9yIHRzLCB0IGluIENoYXRBcHAuX2YyMV9yZWNlbnRfdHg6CiAgICAgICAgICAgICAgICBpZiB0eHQgPT0gdDoKICAgICAgICAgICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAjIDEpIEtpbGwgdGhlIFVJLW9ubHkgbW9uaXRvciBwYXRoIGVudGlyZWx5CiAgICBkZWYgX0YyMV9VSV9OT09QKHNlbGYsIHMpOiAKICAgICAgICByZXR1cm4KICAgIENoYXRBcHAuX2FwcGVuZF9yeF91aV9vbmx5ID0gX0YyMV9VSV9OT09QCgogICAgIyAyKSBGaWx0ZXIgYXQgdGhlIGVhcmxpZXN0IFJYIGhvb2sKICAgIF9GMjFfT1JJR19SWCA9IGdldGF0dHIoQ2hhdEFwcCwgIl9vbl9zZXJpYWxfdGhyZWFkX2xpbmUiLCBOb25lKQogICAgZGVmIF9GMjFfUlhfRklMVEVSKHNlbGYsIGxpbmU6IHN0cik6CiAgICAgICAgcyA9ICIiIGlmIGxpbmUgaXMgTm9uZSBlbHNlIHN0cihsaW5lKQogICAgICAgICMgRHJvcCBtb25pdG9yL2NvbnNvbGUgbGluZXMgYWx0b2dldGhlcgogICAgICAgIGlmIF9mMjFfaXNfbW9uaXRvcl9saW5lKHMpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICAjIERyb3AgZXhhY3QgZWNobyBvZiBvdXIgVFgKICAgICAgICBpZiBfZjIxX2lzX3R4X2VjaG8ocyk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgICMgRHJvcCBzZWxmLUFDS3MgLyBBQ0tzIG5vdCBhZGRyZXNzZWQgdG8gbWUKICAgICAgICBpZiBfZjIxX2lzX3NlbGZfYWNrKHNlbGYsIHMpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBjYWxsYWJsZShfRjIxX09SSUdfUlgpOgogICAgICAgICAgICByZXR1cm4gX0YyMV9PUklHX1JYKHNlbGYsIGxpbmUpCiAgICBDaGF0QXBwLl9vbl9zZXJpYWxfdGhyZWFkX2xpbmUgPSBfRjIxX1JYX0ZJTFRFUgoKICAgICMgMykgSWYgdGhlIEYxNyB0YXAgaXMgaW5zdGFsbGVkLCBmaWx0ZXIgaXRzIGxpbmVzIHRvbyBiZWZvcmUgYXBwZW5kaW5nCiAgICBpZiAiX2YxN19wcm9jZXNzX2xpbmVzIiBpbiBnbG9iYWxzKCk6CiAgICAgICAgX0YyMV9PUklHX0YxNyA9IF9mMTdfcHJvY2Vzc19saW5lcwogICAgICAgIGRlZiBfZjE3X3Byb2Nlc3NfbGluZXMoc2VsZl9hcHAsIHMpOgogICAgICAgICAgICAjIFNwbGl0IGxpa2Ugb3JpZ2luYWwsIHRoZW4gZmlsdGVyIGVhY2ggbGluZQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzID0gJycgaWYgcyBpcyBOb25lIGVsc2Ugc3RyKHMpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBzID0gc3RyKHMgb3IgJycpCiAgICAgICAgICAgIHMgPSBzLnJlcGxhY2UoJ1xyXG4nLCAnXG4nKS5yZXBsYWNlKCdccicsICdcbicpCiAgICAgICAgICAgIHBhcnRzID0gcy5zcGxpdCgnXG4nKQogICAgICAgICAgICBidWYgPSBnZXRhdHRyKHNlbGZfYXBwLCAnX2YxN19idWYnLCAnJykKICAgICAgICAgICAgaWYgYnVmOgogICAgICAgICAgICAgICAgcGFydHNbMF0gPSBidWYgKyBwYXJ0c1swXQogICAgICAgICAgICAgICAgc2VsZl9hcHAuX2YxN19idWYgPSAnJwogICAgICAgICAgICAgICAgc2VsZl9hcHAuX2YxN19idWZfdHMgPSAwLjAKICAgICAgICAgICAgZm9yIGl0bSBpbiBwYXJ0c1s6LTFdOgogICAgICAgICAgICAgICAgbGluZSA9IGl0bS5zdHJpcCgpCiAgICAgICAgICAgICAgICBpZiBub3QgbGluZToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgaWYgX2YyMV9pc19tb25pdG9yX2xpbmUobGluZSk6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGlmIF9mMjFfaXNfdHhfZWNobyhsaW5lKToKICAgICAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICAgICAgaWYgX2YyMV9pc19zZWxmX2FjayhzZWxmX2FwcCwgbGluZSk6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICMgcGFzcyB0aHJvdWdoIHRvIG9yaWdpbmFsIFVJIGFwcGVuZCBwYXRoCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgX2YxN19zYXZlX2FwcGVuZChzZWxmX2FwcCwgJ3JlY2VpdmVkJywgbGluZSkKICAgICAgICAgICAgICAgICAgICBfZjE3X3VpX2FwcGVuZChzZWxmX2FwcCwgJ3JlY2VpdmVkJywgbGluZSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICB0YWlsID0gcGFydHNbLTFdCiAgICAgICAgICAgIGlmIHRhaWw6CiAgICAgICAgICAgICAgICBzZWxmX2FwcC5fZjE3X2J1ZiA9IHRhaWwKICAgICAgICAgICAgICAgIHNlbGZfYXBwLl9mMTdfYnVmX3RzID0gX3QubW9ub3RvbmljKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGZfYXBwLl9mMTdfYnVmID0gJycKICAgICAgICAgICAgICAgIHNlbGZfYXBwLl9mMTdfYnVmX3RzID0gMC4wCiAgICAgICAgZ2xvYmFscygpWydfZjE3X3Byb2Nlc3NfbGluZXMnXSA9IF9mMTdfcHJvY2Vzc19saW5lcwoKZXhjZXB0IEV4Y2VwdGlvbiBhcyBfZV9mMjE6CiAgICB0cnk6CiAgICAgICAgZGlhZ19sb2coZiJGMjEgZWNoby9hY2svbW9uaXRvciBmaWx0ZXIgZmFpbGVkOiB7X2VfZjIxfSIpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHBhc3MKCiMgPT09PT09PT0gRW5kIEYyMSA9PT09PT09PQoKCgojID09PT09PT09IEYyMjogQUNLIHJlcGx5IChoeWJyaWQgaGVhZGVyKSArIG5vIHRpY2tzIG9uIHJlY2VpdmVkID09PT09PT09CnRyeToKICAgIGltcG9ydCByZSBhcyBfcmUsIHRpbWUgYXMgX3QKCiAgICBfRjIyX0NIQVRfUkUgPSBfcmUuY29tcGlsZShyJ15ccyooW0EtWjAtOS8rXC1dKylccytERVxzKyhbQS1aMC05LytcLV0rKVxzKyguKz8pXHMqJCcsIF9yZS5JKQogICAgX0YyMl9BQ0tfUkUgID0gX3JlLmNvbXBpbGUocidcW0FDSzooWzAtOUEtWmEtel17MiwxMn0pXF0nKQoKICAgIGlmIG5vdCBoYXNhdHRyKENoYXRBcHAsICJfZjIyX3JlY2VudF9hY2tzIik6CiAgICAgICAgQ2hhdEFwcC5fZjIyX3JlY2VudF9hY2tzID0gW10gICMgbGlzdCBvZiAodHMsIGZyb21fY2FsbCwgYWNrX2lkKQoKICAgIGRlZiBfZjIyX215YyhzZWxmKToKICAgICAgICB0cnk6IHJldHVybiBzZWxmLm15Y2FsbF9lZGl0LnRleHQoKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiByZXR1cm4gIiIKCiAgICBkZWYgX2YyMl9hbHJlYWR5X3JlcGxpZWQoZnJtLCBhY2tfaWQpOgogICAgICAgIG5vdyA9IF90LnRpbWUoKQogICAgICAgIENoYXRBcHAuX2YyMl9yZWNlbnRfYWNrcyA9IFsodHMsZixhKSBmb3IgKHRzLGYsYSkgaW4gQ2hhdEFwcC5fZjIyX3JlY2VudF9hY2tzIGlmIG5vdyAtIHRzIDw9IDYwLjBdCiAgICAgICAgZm9yIHRzLGYsYSBpbiBDaGF0QXBwLl9mMjJfcmVjZW50X2Fja3M6CiAgICAgICAgICAgIGlmIGYgPT0gZnJtIGFuZCBhID09IGFja19pZDoKICAgICAgICAgICAgICAgIHJldHVybiBUcnVlCiAgICAgICAgcmV0dXJuIEZhbHNlCgogICAgZGVmIF9mMjJfbWFya19yZXBsaWVkKGZybSwgYWNrX2lkKToKICAgICAgICBDaGF0QXBwLl9mMjJfcmVjZW50X2Fja3MuYXBwZW5kKChfdC50aW1lKCksIGZybSwgYWNrX2lkKSkKCiAgICAjIEh5YnJpZCBBQ0sgcmVwbHk6ICI8VEhFSVJDQUxMPiBERSA8TVlDQUxMPiBbQUNLOklEXSIKICAgIGRlZiBfZjIyX21heWJlX3JlcGx5X2FjayhzZWxmLCBzOiBzdHIpOgogICAgICAgIG0gPSBfRjIyX0NIQVRfUkUubWF0Y2gocyBvciAiIikKICAgICAgICBpZiBub3QgbToKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgdG9fY3MsIGZybV9jcywgYm9keSA9IChtLmdyb3VwKDEpIG9yICIiKS51cHBlcigpLCAobS5ncm91cCgyKSBvciAiIikudXBwZXIoKSwgKG0uZ3JvdXAoMykgb3IgIiIpCiAgICAgICAgbV9hY2sgPSBfRjIyX0FDS19SRS5zZWFyY2goYm9keSkKICAgICAgICBpZiBub3QgbV9hY2s6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIG15YyA9IF9mMjJfbXljKHNlbGYpCiAgICAgICAgaWYgbm90IG15YzoKICAgICAgICAgICAgcmV0dXJuCiAgICAgICAgIyBPbmx5IHJlcGx5IHdoZW4gaXQncyBhZGRyZXNzZWQgdG8gbWUgYW5kIG5vdCBmcm9tIG1lCiAgICAgICAgaWYgdG9fY3MgIT0gbXljIG9yIGZybV9jcyA9PSBteWM6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIGFja19pZCA9IChtX2Fjay5ncm91cCgxKSBvciAiIikudXBwZXIoKQogICAgICAgIGlmIG5vdCBhY2tfaWQgb3IgX2YyMl9hbHJlYWR5X3JlcGxpZWQoZnJtX2NzLCBhY2tfaWQpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICByZXBseSA9IGYie2ZybV9jc30gREUge215Y30gW0FDSzp7YWNrX2lkfV0iCiAgICAgICAgdHJ5OgogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICdzZW5kX3VzZXJfdGV4dCcpOgogICAgICAgICAgICAgICAgc2VsZi5zZW5kX3VzZXJfdGV4dChyZXBseSkKICAgICAgICAgICAgICAgIF9mMjJfbWFya19yZXBsaWVkKGZybV9jcywgYWNrX2lkKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAjIEhvb2sgaW50byB0aGUgZWFybGllc3QgUlggaGFuZGxlciBhZnRlciBGMjEgZmlsdGVyaW5nCiAgICBfRjIyX09SSUdfUlggPSBnZXRhdHRyKENoYXRBcHAsICJfb25fc2VyaWFsX3RocmVhZF9saW5lIiwgTm9uZSkKICAgIGRlZiBfRjIyX1JYKHNlbGYsIGxpbmU6IHN0cik6CiAgICAgICAgcyA9ICIiIGlmIGxpbmUgaXMgTm9uZSBlbHNlIHN0cihsaW5lKQogICAgICAgICMgYXR0ZW1wdCBBQ0sgcmVwbHkgKGh5YnJpZCkgb24gYW55IGluY29taW5nIGNoYXQgd2l0aCBBQ0sgdG9rZW4KICAgICAgICB0cnk6IF9mMjJfbWF5YmVfcmVwbHlfYWNrKHNlbGYsIHMpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgIGlmIGNhbGxhYmxlKF9GMjJfT1JJR19SWCk6CiAgICAgICAgICAgIHJldHVybiBfRjIyX09SSUdfUlgoc2VsZiwgbGluZSkKICAgIENoYXRBcHAuX29uX3NlcmlhbF90aHJlYWRfbGluZSA9IF9GMjJfUlgKCiAgICAjIEVuc3VyZSByZWNlaXZlZCBpdGVtcyBuZXZlciBzaG93IHRpY2tzOiBjb2VyY2UgZmxhZ3Mgd2hlbiBhZGRlZAogICAgaWYgaGFzYXR0cihDaGF0QXBwLCAiX2FkZF9jaGF0X2l0ZW0iKToKICAgICAgICBfRjIyX09SSUdfQUREID0gQ2hhdEFwcC5fYWRkX2NoYXRfaXRlbQogICAgICAgIGRlZiBfRjIyX0FERChzZWxmLCAqYSwgKiprdyk6CiAgICAgICAgICAgICMgbm9ybWFsaXplIGFyZ3MgaWYgY2FsbGVkIHdpdGgga2V5d29yZHMKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAga2luZCA9IGt3LmdldCgia2luZCIpIGlmIGlzaW5zdGFuY2Uoa3csIGRpY3QpIGVsc2UgTm9uZQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAga2luZCA9IE5vbmUKICAgICAgICAgICAgaWYgKG5vdCBraW5kKSBhbmQgbGVuKGEpID49IDEgYW5kIGlzaW5zdGFuY2UoYVswXSwgc3RyKToKICAgICAgICAgICAgICAgIGtpbmQgPSBhWzBdCiAgICAgICAgICAgICMgRm9yY2Ugbm8tYWNrIHZpc3VhbHMgZm9yIHJlY2VpdmVkCiAgICAgICAgICAgIGlmIChraW5kIG9yICIiKS5sb3dlcigpIGluICgicmVjZWl2ZWQiLCAicngiKToKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBrdyA9IGRpY3Qoa3cgb3Ige30pCiAgICAgICAgICAgICAgICAgICAga3dbImFjayJdID0gRmFsc2UKICAgICAgICAgICAgICAgICAgICBrd1siZmFpbGVkIl0gPSBGYWxzZQogICAgICAgICAgICAgICAgICAgIGt3WyJhdHRlbXB0Il0gPSBOb25lCiAgICAgICAgICAgICAgICAgICAga3dbIm1heF9hdHRlbXB0cyJdID0gTm9uZQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybiBfRjIyX09SSUdfQUREKHNlbGYsICphLCAqKmt3KQogICAgICAgIENoYXRBcHAuX2FkZF9jaGF0X2l0ZW0gPSBfRjIyX0FERAoKZXhjZXB0IEV4Y2VwdGlvbiBhcyBfZV9mMjI6CiAgICB0cnk6CiAgICAgICAgZGlhZ19sb2coZiJGMjIgQUNLIHJlcGx5IHBhdGNoIGZhaWxlZDoge19lX2YyMn0iKQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICBwYXNzCgojID09PT09PT09IEVuZCBGMjIgPT09PT09PT0KCgoKIyA9PT09PT09PSBGMjM6IEFjY2VwdCBBQ0sgb25seSBmcm9tIHRoZSBvcmlnaW5hbCBUTy9UYXJnZXQgc3RhdGlvbiA9PT09PT09PQp0cnk6CiAgICBpbXBvcnQgcmUgYXMgX3JlLCB0aW1lIGFzIF90CgogICAgIyBDaGF0ICYgQUNLIHRva2VuIChhbGxvdyB3aXRoIG9yIHdpdGhvdXQgY29sb246IFtBQ0sxMjM0XSBvciBbQUNLOjEyMzRdKQogICAgX0YyM19DSEFUX1JFID0gX3JlLmNvbXBpbGUocideXHMqKFtBLVowLTkvK1wtXSspXHMrREVccysoW0EtWjAtOS8rXC1dKylccysoLis/KVxzKiQnLCBfcmUuSSkKICAgIF9GMjNfQUNLX1JFICA9IF9yZS5jb21waWxlKHInXFtBQ0s6P1xzKihbMC05QS1aYS16XXsyLDEyfSlcXScpCgogICAgZGVmIF9mMjNfbXljYWxsKHNlbGYpOgogICAgICAgIHRyeTogcmV0dXJuIHNlbGYubXljYWxsX2VkaXQudGV4dCgpLnN0cmlwKCkudXBwZXIoKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHJldHVybiAiIgoKICAgICMgVHJhY2sgb3V0Ym91bmQgQUNLIGV4cGVjdGF0aW9uczogYWNrX2lkIC0+IHsidGFyZ2V0IjogIkc0QUJDIiwgInRzIjogLi4ufQogICAgaWYgbm90IGhhc2F0dHIoQ2hhdEFwcCwgIl9wZW5kaW5nX291dGJveCIpOgogICAgICAgIENoYXRBcHAuX3BlbmRpbmdfb3V0Ym94ID0ge30KCiAgICAjIFdyYXAgc2VuZF91c2VyX3RleHQgdG8gcmVjb3JkIHRhcmdldCArIGFja19pZCB3aGVuZXZlciB3ZSBzZW5kIHdpdGggYW4gQUNLIHRhZwogICAgaWYgaGFzYXR0cihDaGF0QXBwLCAic2VuZF91c2VyX3RleHQiKToKICAgICAgICBfRjIzX09SSUdfU0VORCA9IENoYXRBcHAuc2VuZF91c2VyX3RleHQKICAgICAgICBkZWYgX0YyM19TRU5EKHNlbGYsIHRleHQpOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBzID0gKHRleHQgb3IgIiIpLnN0cmlwKCkKICAgICAgICAgICAgICAgIG0gPSBfRjIzX0NIQVRfUkUubWF0Y2gocykKICAgICAgICAgICAgICAgIGlmIG06CiAgICAgICAgICAgICAgICAgICAgdG9fY3MsIGZybV9jcywgYm9keSA9IChtLmdyb3VwKDEpIG9yICIiKS51cHBlcigpLCAobS5ncm91cCgyKSBvciAiIikudXBwZXIoKSwgKG0uZ3JvdXAoMykgb3IgIiIpCiAgICAgICAgICAgICAgICAgICAgbV9hY2sgPSBfRjIzX0FDS19SRS5zZWFyY2goYm9keSkKICAgICAgICAgICAgICAgICAgICBpZiBtX2FjazoKICAgICAgICAgICAgICAgICAgICAgICAgYWNrX2lkID0gKG1fYWNrLmdyb3VwKDEpIG9yICIiKS51cHBlcigpCiAgICAgICAgICAgICAgICAgICAgICAgIGlmIGFja19pZDoKICAgICAgICAgICAgICAgICAgICAgICAgICAgICMgUmVjb3JkIHRoZSBpbnRlbmRlZCBwZWVyIHRhcmdldCAoVE8pIGZvciB0aGlzIGFja19pZAogICAgICAgICAgICAgICAgICAgICAgICAgICAgdGd0ID0gdG9fY3MKICAgICAgICAgICAgICAgICAgICAgICAgICAgIENoYXRBcHAuX3BlbmRpbmdfb3V0Ym94W2Fja19pZF0gPSB7InRhcmdldCI6IHRndCwgInRzIjogX3QudGltZSgpfQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICByZXR1cm4gX0YyM19PUklHX1NFTkQoc2VsZiwgdGV4dCkKICAgICAgICBDaGF0QXBwLnNlbmRfdXNlcl90ZXh0ID0gX0YyM19TRU5ECgogICAgIyBIZWxwZXIgdG8gbWFyayBBQ0sgZGVsaXZlcmVkIG9uIHRoZSBVSSBzdGF0ZSBtYWNoaW5lcywgaWYgcHJlc2VudAogICAgZGVmIF9mMjNfbWFya19hY2tfcmVjZWl2ZWQoc2VsZiwgYWNrX2lkOiBzdHIpOgogICAgICAgIG9rID0gRmFsc2UKICAgICAgICAjIDEpIFRyeSBhbiBhY2sgc3RhdGUgbWFjaGluZSwgaWYgdXNlZCBieSB5b3VyIGJ1aWxkCiAgICAgICAgdHJ5OgogICAgICAgICAgICBzdCA9IGdldGF0dHIoc2VsZiwgIl9hY2tfc3RhdGVzIiwge30pLmdldChhY2tfaWQpCiAgICAgICAgICAgIGlmIHN0OgogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgIHN0Lm9uX2Fja19yZWNlaXZlZCgpCiAgICAgICAgICAgICAgICAgICAgb2sgPSBUcnVlCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgIyAyKSBVcGRhdGUgY2hhdF9pdGVtcyBpZiBwcmVzZW50CiAgICAgICAgaWYgbm90IG9rOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICBmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSBhcyBfZHQKICAgICAgICAgICAgICAgIGZvciBpdCBpbiAoZ2V0YXR0cihzZWxmLCAiY2hhdF9pdGVtcyIsIFtdKSBvciBbXSk6CiAgICAgICAgICAgICAgICAgICAgaWYgKGl0LmdldCgiYWNrX2lkIikgb3IgIiIpLnVwcGVyKCkgPT0gYWNrX2lkLnVwcGVyKCkgYW5kIChpdC5nZXQoImtpbmQiKSBvciAiIikubG93ZXIoKSA9PSAic2VudCI6CiAgICAgICAgICAgICAgICAgICAgICAgIGl0WyJhY2siXSA9IFRydWUKICAgICAgICAgICAgICAgICAgICAgICAgaXRbInRzX2FjayJdID0gX2R0LnV0Y25vdygpLmlzb2Zvcm1hdCgpICsgIloiCiAgICAgICAgICAgICAgICAgICAgICAgIG9rID0gVHJ1ZQogICAgICAgICAgICAgICAgIyBPcHRpb25hbDogcmVidWlsZCB2aWV3IGlmIHlvdSBoYXZlIGEgcmVuZGVyZXIKICAgICAgICAgICAgICAgIGlmIG9rIGFuZCBoYXNhdHRyKHNlbGYsICJfcmVidWlsZF9jaGF0X3ZpZXciKToKICAgICAgICAgICAgICAgICAgICB0cnk6IHNlbGYuX3JlYnVpbGRfY2hhdF92aWV3KCkKICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgIyAzKSBGYWxsYmFjazogYXBwZW5kIGEgc21hbGwgc3lzdGVtIGxpbmUKICAgICAgICBpZiBvazoKICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgaWYgaGFzYXR0cihzZWxmLCAiX2FwcGVuZF9zeXMiKToKICAgICAgICAgICAgICAgICAgICBzZWxmLl9hcHBlbmRfc3lzKGYi4pyUIEFjayB7YWNrX2lkfSByZWNlaXZlZCIpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIG9rCgogICAgIyBBY2NlcHQgQUNLIG9ubHkgd2hlbjogVE8gPT0gTVlDQUxMIEFORCBGUk9NID09IHRoZSByZWNvcmRlZCB0YXJnZXQgZm9yIHRoYXQgYWNrX2lkCiAgICBfRjIzX09SSUdfUlggPSBnZXRhdHRyKENoYXRBcHAsICJfb25fc2VyaWFsX3RocmVhZF9saW5lIiwgTm9uZSkKICAgIGRlZiBfRjIzX1JYKHNlbGYsIGxpbmU6IHN0cik6CiAgICAgICAgcyA9ICIiIGlmIGxpbmUgaXMgTm9uZSBlbHNlIHN0cihsaW5lKQogICAgICAgIHRyeToKICAgICAgICAgICAgbSA9IF9GMjNfQ0hBVF9SRS5tYXRjaChzKQogICAgICAgICAgICBpZiBtOgogICAgICAgICAgICAgICAgdG9fY3MsIGZybV9jcywgYm9keSA9IChtLmdyb3VwKDEpIG9yICIiKS51cHBlcigpLCAobS5ncm91cCgyKSBvciAiIikudXBwZXIoKSwgKG0uZ3JvdXAoMykgb3IgIiIpCiAgICAgICAgICAgICAgICBtX2FjayA9IF9GMjNfQUNLX1JFLnNlYXJjaChib2R5KQogICAgICAgICAgICAgICAgaWYgbV9hY2s6CiAgICAgICAgICAgICAgICAgICAgYWNrX2lkID0gKG1fYWNrLmdyb3VwKDEpIG9yICIiKS51cHBlcigpCiAgICAgICAgICAgICAgICAgICAgbXljID0gX2YyM19teWNhbGwoc2VsZikKICAgICAgICAgICAgICAgICAgICAjIExvb2t1cCBwZW5kaW5nIHRhcmdldAogICAgICAgICAgICAgICAgICAgIHJlYyA9IENoYXRBcHAuX3BlbmRpbmdfb3V0Ym94LmdldChhY2tfaWQsIHt9KQogICAgICAgICAgICAgICAgICAgIGV4cGVjdGVkID0gKHJlYy5nZXQoInRhcmdldCIpIG9yICIiKS51cHBlcigpCiAgICAgICAgICAgICAgICAgICAgaWYgbXljIGFuZCB0b19jcyA9PSBteWMgYW5kIGV4cGVjdGVkIGFuZCBmcm1fY3MgPT0gZXhwZWN0ZWQ6CiAgICAgICAgICAgICAgICAgICAgICAgICMgVmFsaWQgQUNLOiBtYXJrIGFuZCByZW1vdmUgZnJvbSBwZW5kaW5nCiAgICAgICAgICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICAgICAgICAgIF9mMjNfbWFya19hY2tfcmVjZWl2ZWQoc2VsZiwgYWNrX2lkKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgICAgICAgICBDaGF0QXBwLl9wZW5kaW5nX291dGJveC5wb3AoYWNrX2lkLCBOb25lKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICAgICAgICAgICAgICAjIERvIE5PVCByZXR1cm46IGFsbG93IG5vcm1hbCBSWCBkaXNwbGF5IG9mIHRoZSB0ZXh0ICh3aXRob3V0IOKckyBvbiByZWNlaXZlZCkKICAgICAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICAgICAjIE5vdCBmcm9tIHRoZSByaWdodCBzdGF0aW9uIG9yIG5vdCB0byBtZSDihpIgaWdub3JlIGZvciBhY2sgcHVycG9zZXMKICAgICAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKICAgICAgICBpZiBjYWxsYWJsZShfRjIzX09SSUdfUlgpOgogICAgICAgICAgICByZXR1cm4gX0YyM19PUklHX1JYKHNlbGYsIGxpbmUpCiAgICBDaGF0QXBwLl9vbl9zZXJpYWxfdGhyZWFkX2xpbmUgPSBfRjIzX1JYCgpleGNlcHQgRXhjZXB0aW9uIGFzIF9lX2YyMzoKICAgIHRyeToKICAgICAgICBkaWFnX2xvZyhmIkYyMyBzdHJpY3QtdGFyZ2V0IGFjayBmYWlsZWQ6IHtfZV9mMjN9IikKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKIyA9PT09PT09PSBFbmQgRjIzID09PT09PT09CgoKCgoKIyA9PT09PT09PSBGMjZlOiBEX0FMUEhBLXN0eWxlIGhhcmRlbmluZyBoZWxwZXJzID09PT09PT09CmltcG9ydCByZSBhcyBfcmNfcmUyLCB0aW1lIGFzIF9yY190Mgpmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBkZXF1ZSBhcyBfcmNfZGVxdWUyCgpkZWYgX2YyNmVfbm9ybV90ZXh0KHM6IHN0cikgLT4gc3RyOgogICAgdHJ5OgogICAgICAgIHJldHVybiBfcmNfcmUyLnN1YihyJ1tcclxuXSsnLCAnJywgKHMgb3IgJycpKS5zdHJpcCgpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHJldHVybiAocyBvciAnJykuc3RyaXAoKQoKZGVmIF9mMjZlX2lzX3JlY2VudF9lY2hvX25vcm0oc2VsZiwgczogc3RyKSAtPiBib29sOgogICAgIyBSZXR1cm4gVHJ1ZSBpZiAncycgbWF0Y2hlcyBub3JtYWxpemVkIHRleHQgb2YgYSB2ZXJ5IHJlY2VudCBUWCAoPD0gMyBzZWNvbmRzKS4KICAgIHRyeToKICAgICAgICBub3cgPSBfcmNfdDIudGltZSgpCiAgICAgICAgdHh0ID0gX2YyNmVfbm9ybV90ZXh0KHMpCiAgICAgICAgZHEgPSBnZXRhdHRyKENoYXRBcHAsICdfZjI0X3JlY2VudF90eCcsIE5vbmUpCiAgICAgICAgaWYgZHEgaXMgTm9uZToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgbmV3ZHEgPSBfcmNfZGVxdWUyKFtdLCBtYXhsZW49Z2V0YXR0cihkcSwgJ21heGxlbicsIDIwKSkKICAgICAgICBoaXQgPSBGYWxzZQogICAgICAgIGZvciB0cywgdCwgdGFyIGluIGxpc3QoZHEpOgogICAgICAgICAgICBpZiBub3cgLSB0cyA8PSAzLjA6CiAgICAgICAgICAgICAgICB0bm9ybSA9IF9mMjZlX25vcm1fdGV4dCh0KQogICAgICAgICAgICAgICAgbmV3ZHEuYXBwZW5kKCh0cywgdG5vcm0sIHRhcikpCiAgICAgICAgICAgICAgICBpZiBub3QgaGl0IGFuZCB0bm9ybSA9PSB0eHQ6CiAgICAgICAgICAgICAgICAgICAgaGl0ID0gVHJ1ZQogICAgICAgIENoYXRBcHAuX2YyNF9yZWNlbnRfdHggPSBuZXdkcQogICAgICAgIHJldHVybiBoaXQKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcmV0dXJuIEZhbHNlCgpkZWYgX2YyNmVfZHJvcF9vd25fY29udHJvbF9saW5lKHNlbGYsIHM6IHN0cikgLT4gYm9vbDoKICAgICMgRHJvcCBsaW5lcyBsaWtlICc8VE8+IERFIDxGUk9NPiA8TVNHPicgd2hlbiBGUk9NID09IE1ZQ0FMTCBhbmQgTVNHIGxvb2tzIGxpa2UgY29udHJvbCB0cmFmZmljLgogICAgdHJ5OgogICAgICAgIG5vcm0gPSBfZjI2ZV9ub3JtX3RleHQocykKICAgICAgICBtID0gX3JjX3JlMi5tYXRjaChyJ14oW0EtWjAtOS9cLV0rfENRKVxzK0RFXHMrKFtBLVowLTkvXC1dKylccyooLiopJCcsIG5vcm0sIF9yY19yZTIuSSkKICAgICAgICBpZiBub3QgbToKICAgICAgICAgICAgcmV0dXJuIEZhbHNlCiAgICAgICAgX3RvLCBfZnJtLCBfbXNnID0gKG0uZ3JvdXAoMSkgb3IgJycpLnVwcGVyKCksIChtLmdyb3VwKDIpIG9yICcnKS51cHBlcigpLCAobS5ncm91cCgzKSBvciAnJykKICAgICAgICBteWMgPSAnJwogICAgICAgIHRyeToKICAgICAgICAgICAgbXljID0gc2VsZi5teWNhbGxfZWRpdC50ZXh0KCkuc3RyaXAoKS51cHBlcigpCiAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgbXljID0gKGdldGF0dHIoc2VsZiwgJ215Y2FsbCcsICcnKSBvciBnZXRhdHRyKHNlbGYsICdNWUNBTEwnLCAnJykgb3IgJycpLnN0cmlwKCkudXBwZXIoKQogICAgICAgIGlmIG5vdCBteWM6CiAgICAgICAgICAgIHJldHVybiBGYWxzZQogICAgICAgIGlmIF9mcm0gPT0gbXljIGFuZCAoX21zZy5zdGFydHN3aXRoKCdGSUxFICcpIG9yICgnW0FDSzonIGluIF9tc2cudXBwZXIoKSkpOgogICAgICAgICAgICByZXR1cm4gVHJ1ZQogICAgICAgIHJldHVybiBGYWxzZQogICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICByZXR1cm4gRmFsc2UKIyA9PT09PT09PSBFbmQgRjI2ZSBoZWxwZXJzID09PT09PT09CiMgPT09PT09PT0gRjI0OiBIb3N0LW1vZGU6IG5vIGxvY2FsIGVjaG8sIHN0cmljdCBBQ0sgZ2F0aW5nLCByZXRyeS1mcmllbmRseSA9PT09PT09PQp0cnk6CiAgICBpbXBvcnQgdGltZSBhcyBfdCwgcmUgYXMgX3JlCiAgICBmcm9tIGNvbGxlY3Rpb25zIGltcG9ydCBkZXF1ZQoKICAgICMgUmVtZW1iZXIgcmVjZW50IFRYICh0ZXh0KSBmb3IgZWNobyBzdXBwcmVzc2lvbiB3aW5kb3cKICAgIGlmIG5vdCBoYXNhdHRyKENoYXRBcHAsICJfZjI0X3JlY2VudF90eCIpOgogICAgICAgIENoYXRBcHAuX2YyNF9yZWNlbnRfdHggPSBkZXF1ZShtYXhsZW49MjApICAjICh0cywgdGV4dCwgdGFyZ2V0KQoKICAgIGRlZiBfZjI0X215Y2FsbChzZWxmKToKICAgICAgICB0cnk6IHJldHVybiBzZWxmLm15Y2FsbF9lZGl0LnRleHQoKS5zdHJpcCgpLnVwcGVyKCkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiByZXR1cm4gIiIKCiAgICAjIERldGVjdCBtb25pdG9yL2NvbnNvbGUgc3R5bGUgbGluZXMKICAgIF9GMjRfTU9OX1RBRyA9IF9yZS5jb21waWxlKHInXlxzKihcW1teXF1dK1xdXHMqKT9cWyhNT058S0lTU3xSWHxBUFJTKVxdXGInLCBfcmUuSSkKICAgIF9GMjRfTU9OX1BJRCA9IF9yZS5jb21waWxlKHInXGJwaWRccytbQS1GMC05XStcYicsIF9yZS5JKQogICAgX0YyNF9NT05fRk0gID0gX3JlLmNvbXBpbGUocidcYmZtXHMrKFtBLVowLTkvK1wtXSspXGInLCBfcmUuSSkKCiAgICBkZWYgX2YyNF9pc19tb25pdG9yaXNoKHM6IHN0cikgLT4gYm9vbDoKICAgICAgICBzcyA9IHMgb3IgIiIKICAgICAgICByZXR1cm4gYm9vbChfRjI0X01PTl9UQUcubWF0Y2goc3MpIG9yIF9GMjRfTU9OX1BJRC5zZWFyY2goc3MpKQoKICAgICMgRXhhY3QgVFgtdGV4dCBlY2hvIGNoZWNrICh3aXRoaW4gM3MpCiAgICBkZWYgX2YyNF9pc19leGFjdF9lY2hvKHM6IHN0cikgLT4gYm9vbDoKICAgICAgICBub3cgPSBfdC50aW1lKCkKICAgICAgICB0eHQgPSAocyBvciAiIikuc3RyaXAoKQogICAgICAgICMgcHJ1bmUKICAgICAgICBDaGF0QXBwLl9mMjRfcmVjZW50X3R4ID0gZGVxdWUoWyh0cyx0LHRhcikgZm9yICh0cyx0LHRhcikgaW4gQ2hhdEFwcC5fZjI0X3JlY2VudF90eCBpZiBub3cgLSB0cyA8PSAzLjBdLCBtYXhsZW49MjApCiAgICAgICAgZm9yIHRzLCB0LCBfdGFyIGluIENoYXRBcHAuX2YyNF9yZWNlbnRfdHg6CiAgICAgICAgICAgIGlmIHQgPT0gdHh0OgogICAgICAgICAgICAgICAgcmV0dXJuIFRydWUKICAgICAgICByZXR1cm4gRmFsc2UKCiAgICAjIFNlbGYtbW9uaXRvciBlY2hvIGNoZWNrOiBbTU9OXSBmbSA8TVlDQUxMPiAuLi4KICAgIGRlZiBfZjI0X2lzX215X21vbml0b3JfZWNobyhzZWxmLCBzOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgbSA9IF9GMjRfTU9OX0ZNLnNlYXJjaChzIG9yICIiKQogICAgICAgIGlmIG5vdCBtOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKICAgICAgICBmcm0gPSAobS5ncm91cCgxKSBvciAiIikudXBwZXIoKQogICAgICAgIHJldHVybiBmcm0gPT0gX2YyNF9teWNhbGwoc2VsZikKCiAgICAjIFJlY29yZCBUWCBiZWZvcmUgc2VuZGluZyAoZm9yIGVjaG8gc3VwcHJlc3Npb24pCiAgICBpZiBoYXNhdHRyKENoYXRBcHAsICJzZW5kX3VzZXJfdGV4dCIpOgogICAgICAgIF9GMjRfT1JJR19TRU5EID0gQ2hhdEFwcC5zZW5kX3VzZXJfdGV4dAogICAgICAgIGRlZiBfRjI0X1NFTkQoc2VsZiwgdGV4dCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHRhcmdldCA9ICIiCiAgICAgICAgICAgICAgICB0cnk6IHRhcmdldCA9IChzZWxmLnRhcmdldF9lZGl0LnRleHQoKSBvciAiIikuc3RyaXAoKS51cHBlcigpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiB0YXJnZXQgPSAiIgogICAgICAgICAgICAgICAgQ2hhdEFwcC5fZjI0X3JlY2VudF90eC5hcHBlbmQoKF90LnRpbWUoKSwgKHRleHQgb3IgIiIpLnN0cmlwKCksIHRhcmdldCkpCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICBwYXNzCiAgICAgICAgICAgIHJldHVybiBfRjI0X09SSUdfU0VORChzZWxmLCB0ZXh0KQogICAgICAgIENoYXRBcHAuc2VuZF91c2VyX3RleHQgPSBfRjI0X1NFTkQKCiAgICAjIEtpbGwgVUkgbW9uaXRvci1wYXRoIGFwcGVuZGVyCiAgICBkZWYgX0YyNF9VSV9OT09QKHNlbGYsIHMpOiAKICAgICAgICByZXR1cm4KICAgIENoYXRBcHAuX2FwcGVuZF9yeF91aV9vbmx5ID0gX0YyNF9VSV9OT09QCgogICAgIyBTdHJpY3QgZmlsdGVyIGF0IHRoZSBlYXJsaWVzdCBSWCBob29rOiBkcm9wIG1vbml0b3IgKyBlY2hvZXMKICAgIF9GMjRfT1JJR19SWCA9IGdldGF0dHIoQ2hhdEFwcCwgIl9vbl9zZXJpYWxfdGhyZWFkX2xpbmUiLCBOb25lKQogICAgZGVmIF9GMjRfUlgoc2VsZiwgbGluZTogc3RyKToKICAgICAgICBzID0gIiIgaWYgbGluZSBpcyBOb25lIGVsc2Ugc3RyKGxpbmUpCiAgICAgICAgIyBEcm9wIGxvY2FsIG1vbml0b3IvY29uc29sZSBsaW5lcyBlbnRpcmVseQogICAgICAgIGlmIF9mMjRfaXNfbW9uaXRvcmlzaChzKSBhbmQgX2YyNF9pc19teV9tb25pdG9yX2VjaG8oc2VsZiwgcyk6CiAgICAgICAgICAgIHJldHVybgogICAgICAgICMgRHJvcCBleGFjdCBUWCBlY2hvCiAgICAgICAgaWYgX2YyNF9pc19leGFjdF9lY2hvKHMpOgogICAgICAgICAgICByZXR1cm4KICAgICAgICBpZiBjYWxsYWJsZShfRjI0X09SSUdfUlgpOgogICAgICAgICAgICByZXR1cm4gX0YyNF9PUklHX1JYKHNlbGYsIGxpbmUpCiAgICBDaGF0QXBwLl9vbl9zZXJpYWxfdGhyZWFkX2xpbmUgPSBfRjI0X1JYCgogICAgIyBBbHNvIGZpbHRlciB0aGUgRjE3IGJ5dGUtdGFwIHBhdGggaWYgYWN0aXZlCiAgICBpZiAiX2YxN19wcm9jZXNzX2xpbmVzIiBpbiBnbG9iYWxzKCk6CiAgICAgICAgX0YyNF9PUklHX1BST0MgPSBfZjE3X3Byb2Nlc3NfbGluZXMKICAgICAgICBkZWYgX2YxN19wcm9jZXNzX2xpbmVzKHNlbGZfYXBwLCBzKToKICAgICAgICAgICAgIyBub3JtYWxpemUgYW5kIHNwbGl0CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHMgPSAnJyBpZiBzIGlzIE5vbmUgZWxzZSBzdHIocykKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHMgPSBzdHIocyBvciAnJykKICAgICAgICAgICAgcyA9IHMucmVwbGFjZSgnXHJcbicsICdcbicpLnJlcGxhY2UoJ1xyJywgJ1xuJykKICAgICAgICAgICAgcGFydHMgPSBzLnNwbGl0KCdcbicpCiAgICAgICAgICAgIGJ1ZiA9IGdldGF0dHIoc2VsZl9hcHAsICdfZjE3X2J1ZicsICcnKQogICAgICAgICAgICBpZiBidWY6CiAgICAgICAgICAgICAgICBwYXJ0c1swXSA9IGJ1ZiArIHBhcnRzWzBdCiAgICAgICAgICAgICAgICBzZWxmX2FwcC5fZjE3X2J1ZiA9ICcnCiAgICAgICAgICAgICAgICBzZWxmX2FwcC5fZjE3X2J1Zl90cyA9IDAuMAogICAgICAgICAgICBmb3IgaXRtIGluIHBhcnRzWzotMV06CiAgICAgICAgICAgICAgICBsaW5lID0gaXRtLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIG5vdCBsaW5lOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAjIERyb3AgbW9uaXRvciBsaW5lIHRoYXQgaXMgZnJvbSBNWUNBTEwKICAgICAgICAgICAgICAgIGlmIF9mMjRfaXNfbW9uaXRvcmlzaChsaW5lKSBhbmQgX2YyNF9pc19teV9tb25pdG9yX2VjaG8oc2VsZl9hcHAsIGxpbmUpOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICAjIERyb3AgZXhhY3QgdGV4dCBlY2hvCiAgICAgICAgICAgICAgICBpZiBfZjI0X2lzX2V4YWN0X2VjaG8obGluZSk6CiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgICMgcGFzcyB0aHJvdWdoCiAgICAgICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAgICAgX2YxN19zYXZlX2FwcGVuZChzZWxmX2FwcCwgJ3JlY2VpdmVkJywgbGluZSkKICAgICAgICAgICAgICAgICAgICBfZjE3X3VpX2FwcGVuZChzZWxmX2FwcCwgJ3JlY2VpdmVkJywgbGluZSkKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAgICAgcGFzcwogICAgICAgICAgICB0YWlsID0gcGFydHNbLTFdCiAgICAgICAgICAgIGlmIHRhaWw6CiAgICAgICAgICAgICAgICBzZWxmX2FwcC5fZjE3X2J1ZiA9IHRhaWwKICAgICAgICAgICAgICAgIHNlbGZfYXBwLl9mMTdfYnVmX3RzID0gX3QubW9ub3RvbmljKCkKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIHNlbGZfYXBwLl9mMTdfYnVmID0gJycKICAgICAgICAgICAgICAgIHNlbGZfYXBwLl9mMTdfYnVmX3RzID0gMC4wCiAgICAgICAgZ2xvYmFscygpWydfZjE3X3Byb2Nlc3NfbGluZXMnXSA9IF9mMTdfcHJvY2Vzc19saW5lcwoKICAgICMgQWRkIGEgbWluaW1hbCAiY29vbGRvd24gZ2F0ZSI6IGlnbm9yZSBhbnkgQUNLIHBhcnNlZCB3aXRoaW4gMzAwIG1zIG9mIGEgc2VuZAogICAgIyAoaG9zdCBlY2hvZXMgY2FuIGJlIG5lYXItaW5zdGFudCkKICAgIGlmIG5vdCBoYXNhdHRyKENoYXRBcHAsICJfZjI0X2xhc3Rfc2VuZF90cyIpOgogICAgICAgIENoYXRBcHAuX2YyNF9sYXN0X3NlbmRfdHMgPSAwLjAKICAgIGlmIGhhc2F0dHIoQ2hhdEFwcCwgInNlbmRfdXNlcl90ZXh0Iik6CiAgICAgICAgX0YyNF9PUklHX1NFTkQyID0gQ2hhdEFwcC5zZW5kX3VzZXJfdGV4dAogICAgICAgIGRlZiBfRjI0X1NFTkQyKHNlbGYsIHRleHQpOgogICAgICAgICAgICBDaGF0QXBwLl9mMjRfbGFzdF9zZW5kX3RzID0gX3QudGltZSgpCiAgICAgICAgICAgIHJldHVybiBfRjI0X09SSUdfU0VORDIoc2VsZiwgdGV4dCkKICAgICAgICBDaGF0QXBwLnNlbmRfdXNlcl90ZXh0ID0gX0YyNF9TRU5EMgoKICAgIF9GMjRfT1JJR19SWDIgPSBnZXRhdHRyKENoYXRBcHAsICJfb25fc2VyaWFsX3RocmVhZF9saW5lIiwgTm9uZSkKICAgIGRlZiBfRjI0X1JYMihzZWxmLCBsaW5lOiBzdHIpOgogICAgICAgIHMgPSAiIiBpZiBsaW5lIGlzIE5vbmUgZWxzZSBzdHIobGluZSkKICAgICAgICAjIEFmdGVyIGluaXRpYWwgZWNoby9tb25pdG9yIGZpbHRlcnMsIGVuZm9yY2UgMzAwbXMgbm8tQUNLIHdpbmRvdwogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgKF90LnRpbWUoKSAtIGdldGF0dHIoQ2hhdEFwcCwgIl9mMjRfbGFzdF9zZW5kX3RzIiwgMC4wKSkgPD0gMC4zMDoKICAgICAgICAgICAgICAgICMgc3RyaXAgYW55IEFDSyBtYXJrcyBhZGRlZCBieSBlYXJseSBwYXRocyBieSBub3QgbGV0dGluZyBpdCB0aHJvdWdoCiAgICAgICAgICAgICAgICBwYXNzICAjIHdlIGRvbid0IGFjdGl2ZWx5IGRyb3AgaGVyZTsgdGhlIGVhcmxpZXIgZmlsdGVycyBzaG91bGQgaGF2ZSBhbHJlYWR5IGNhdWdodCBlY2hvZXMKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgaWYgY2FsbGFibGUoX0YyNF9PUklHX1JYMik6CiAgICAgICAgICAgIHJldHVybiBfRjI0X09SSUdfUlgyKHNlbGYsIGxpbmUpCiAgICBDaGF0QXBwLl9vbl9zZXJpYWxfdGhyZWFkX2xpbmUgPSBfRjI0X1JYMgoKZXhjZXB0IEV4Y2VwdGlvbiBhcyBfZV9mMjQ6CiAgICB0cnk6CiAgICAgICAgZGlhZ19sb2coZiJGMjQgbm8tbG9jYWwtZWNobyBwYXRjaCBmYWlsZWQ6IHtfZV9mMjR9IikKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKIyA9PT09PT09PSBFbmQgRjI0ID09PT09PT09CgoKCiMgPT09PT09PT0gRjI1X0JFQUNPTl9QSVBFOiBCZWFjb25zIC0+IEhlYXJ0YmVhdCArIGxpbmtfZ3JhcGguanNvbiAoK3Bvc2l0aW9ucyksIG5ldmVyIE1lc3NhZ2VzID09PT09PT09CnRyeToKICAgIGltcG9ydCByZSBhcyBfcmUsIGpzb24sIG9zCiAgICBmcm9tIGRhdGV0aW1lIGltcG9ydCBkYXRldGltZSBhcyBfZHQKICAgIGZyb20gcGF0aGxpYiBpbXBvcnQgUGF0aCBhcyBfUGF0aAoKICAgICMgUGF0dGVybiBmb3IgYmVhY29uL2hlYXJkIGxpbmVzOgogICAgIyAuLlBBUkVOVCBbTGF0IDUxLjkzNCBMb24gLTEuMjQyXSAvQ0hJTEQxIC9DSElMRDIgLi4uCiAgICBfRjI1X0JFQUNPTl9SRSA9IF9yZS5jb21waWxlKAogICAgICAgIHInXlxzKlwuXC4oP1A8cGFyZW50PltBLVowLTkvK1wtXSspJwogICAgICAgIHInKD86XHMqXFtccyooPzpMQVR8TGF0fGxhdClccyooP1A8bGF0PlstK10/XGQrKD86XC5cZCspPylccysnCiAgICAgICAgcicoPzpMT058TG9ufGxvbilccyooP1A8bG9uPlstK10/XGQrKD86XC5cZCspPylccypcXSk/JwogICAgICAgIHInKD9QPHRyYWlsPig/OlxzKi9bQS1aMC05LytcLV0rKSopXHMqJCcKICAgICkKCiAgICBkZWYgX2YyNV9pc19iZWFjb25fbGluZShzOiBzdHIpIC0+IGJvb2w6CiAgICAgICAgdHJ5OgogICAgICAgICAgICByZXR1cm4gYm9vbChfRjI1X0JFQUNPTl9SRS5tYXRjaChzIG9yICIiKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICByZXR1cm4gRmFsc2UKCiAgICBkZWYgX2YyNV9wYXJzZV9iZWFjb24oczogc3RyKToKICAgICAgICBtID0gX0YyNV9CRUFDT05fUkUubWF0Y2gocyBvciAiIikKICAgICAgICBpZiBub3QgbToKICAgICAgICAgICAgcmV0dXJuIE5vbmUKICAgICAgICBwYXJlbnQgPSAobS5ncm91cCgncGFyZW50Jykgb3IgJycpLnVwcGVyKCkKICAgICAgICBsYXQgPSBtLmdyb3VwKCdsYXQnKQogICAgICAgIGxvbiA9IG0uZ3JvdXAoJ2xvbicpCiAgICAgICAgbGF0ID0gZmxvYXQobGF0KSBpZiBsYXQgaXMgbm90IE5vbmUgZWxzZSBOb25lCiAgICAgICAgbG9uID0gZmxvYXQobG9uKSBpZiBsb24gaXMgbm90IE5vbmUgZWxzZSBOb25lCiAgICAgICAgdHJhaWwgPSBtLmdyb3VwKCd0cmFpbCcpIG9yICcnCiAgICAgICAgY2hpbGRyZW4gPSBbdFsxOl0udXBwZXIoKSBmb3IgdCBpbiBfcmUuZmluZGFsbChyJy9bQS1aMC05LytcLV0rJywgdHJhaWwpXQogICAgICAgIHJldHVybiBwYXJlbnQsIGNoaWxkcmVuLCBsYXQsIGxvbgoKICAgICMgc3RvcmFnZSBoZWxwZXJzCiAgICBkZWYgX2YyNV9zdG9yZV9kaXIoKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIGJhc2UgPSBvcy5wYXRoLmRpcm5hbWUob3MucGF0aC5hYnNwYXRoKF9fZmlsZV9fKSkKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBiYXNlID0gb3MuZ2V0Y3dkKCkKICAgICAgICBkID0gb3MucGF0aC5qb2luKGJhc2UsICdzdG9yZScpCiAgICAgICAgb3MubWFrZWRpcnMoZCwgZXhpc3Rfb2s9VHJ1ZSkKICAgICAgICByZXR1cm4gZAoKICAgIGRlZiBfZjI1X2xpbmtfZ3JhcGhfcGF0aCgpOgogICAgICAgIHJldHVybiBvcy5wYXRoLmpvaW4oX2YyNV9zdG9yZV9kaXIoKSwgJ2xpbmtfZ3JhcGguanNvbicpCgogICAgZGVmIF9mMjVfcG9zaXRpb25zX3BhdGgoKToKICAgICAgICByZXR1cm4gb3MucGF0aC5qb2luKF9mMjVfc3RvcmVfZGlyKCksICdwb3NpdGlvbnMuanNvbicpCgogICAgZGVmIF9mMjVfcmVhZF9qc29uX3NhZmUocGF0aCwgZmFsbGJhY2spOgogICAgICAgIHRyeToKICAgICAgICAgICAgaWYgb3MucGF0aC5leGlzdHMocGF0aCk6CiAgICAgICAgICAgICAgICB3aXRoIG9wZW4ocGF0aCwgJ3InLCBlbmNvZGluZz0ndXRmLTgnKSBhcyBmOgogICAgICAgICAgICAgICAgICAgIHJldHVybiBqc29uLmxvYWQoZikKICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICBwYXNzCiAgICAgICAgcmV0dXJuIGZhbGxiYWNrCgogICAgZGVmIF9mMjVfd3JpdGVfanNvbl9zYWZlKHBhdGgsIGRhdGEpOgogICAgICAgIHRyeToKICAgICAgICAgICAgd2l0aCBvcGVuKHBhdGgsICd3JywgZW5jb2Rpbmc9J3V0Zi04JykgYXMgZjoKICAgICAgICAgICAgICAgIGpzb24uZHVtcChkYXRhLCBmLCBlbnN1cmVfYXNjaWk9RmFsc2UsIGluZGVudD0yKQogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICBkZWYgX2YyNV91cGRhdGVfbGlua19ncmFwaChwYXJlbnQsIGNoaWxkcmVuKToKICAgICAgICAjIGRpc2FibGVkOiBoYW5kbGVkIGJ5IHVuaWZpZWQgZ3JhcGggdXBkYXRlcgogICAgICAgIHJldHVybgoKICAgIGRlZiBfZjI1X3VwZGF0ZV9wb3NpdGlvbnMocGFyZW50LCBsYXQsIGxvbik6CiAgICAgICAgaWYgbGF0IGlzIE5vbmUgb3IgbG9uIGlzIE5vbmU6CiAgICAgICAgICAgIHJldHVybgogICAgICAgIHAgPSBfZjI1X3Bvc2l0aW9uc19wYXRoKCkKICAgICAgICBkYXRhID0gX2YyNV9yZWFkX2pzb25fc2FmZShwLCB7InZlcnNpb24iOiAxLCAicG9zaXRpb25zIjoge319KQogICAgICAgIHBvcyA9IGRhdGEuc2V0ZGVmYXVsdCgicG9zaXRpb25zIiwge30pCiAgICAgICAgcG9zW3BhcmVudF0gPSB7CiAgICAgICAgICAgICJsYXQiOiBsYXQsICJsb24iOiBsb24sCiAgICAgICAgICAgICJ0cyI6IF9kdC51dGNub3coKS5pc29mb3JtYXQodGltZXNwZWM9J3NlY29uZHMnKSArICdaJywKICAgICAgICAgICAgInNyYyI6ICJiZWFjb24iCiAgICAgICAgfQogICAgICAgIF9mMjVfd3JpdGVfanNvbl9zYWZlKHAsIGRhdGEpCgogICAgZGVmIF9mMjVfdXBkYXRlX2hlYXJ0YmVhdChzZWxmLCBwYXJlbnQsIGNoaWxkcmVuKToKICAgICAgICB0cnk6CiAgICAgICAgICAgIG5vd19pc28gPSBfZHQudXRjbm93KCkuaXNvZm9ybWF0KHRpbWVzcGVjPSdzZWNvbmRzJykgKyAnWicKICAgICAgICAgICAgaGIgPSBnZXRhdHRyKHNlbGYsICJiZWFjb25faGVhcmQiLCBOb25lKQogICAgICAgICAgICBpZiBub3QgaXNpbnN0YW5jZShoYiwgZGljdCk6CiAgICAgICAgICAgICAgICBoYiA9IHt9CiAgICAgICAgICAgIGZvciBjYWxsIGluIFtwYXJlbnRdICsgY2hpbGRyZW46CiAgICAgICAgICAgICAgICBpZiBub3QgY2FsbDogCiAgICAgICAgICAgICAgICAgICAgY29udGludWUKICAgICAgICAgICAgICAgIGVudCA9IGhiLnNldGRlZmF1bHQoY2FsbCwge30pCiAgICAgICAgICAgICAgICBlbnRbImxhc3RfdHMiXSA9IG5vd19pc28KICAgICAgICAgICAgc2VsZi5iZWFjb25faGVhcmQgPSBoYgogICAgICAgICAgICAjIG9wdGlvbmFsIFVJIHJlZnJlc2ggaG9vawogICAgICAgICAgICBpZiBoYXNhdHRyKHNlbGYsICJfcmVmcmVzaF9oZWFydGJlYXRfdWkiKToKICAgICAgICAgICAgICAgIHRyeTogc2VsZi5fcmVmcmVzaF9oZWFydGJlYXRfdWkoKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgIHBhc3MKCiAgICAjIGdhdGUgaW4gdGhlIGVhcmxpZXN0IFJYIGhvb2s6IERPIE5PVCBzaG93IGluIG1lc3NhZ2VzCiAgICBfRjI1X09SSUdfUlggPSBnZXRhdHRyKENoYXRBcHAsICJfb25fc2VyaWFsX3RocmVhZF9saW5lIiwgTm9uZSkKICAgIGRlZiBfRjI1X1JYKHNlbGYsIGxpbmU6IHN0cik6CiAgICAgICAgcyA9ICIiIGlmIGxpbmUgaXMgTm9uZSBlbHNlIHN0cihsaW5lKQogICAgICAgIGlmIF9mMjVfaXNfYmVhY29uX2xpbmUocyk6CiAgICAgICAgICAgIHBhcnNlZCA9IF9mMjVfcGFyc2VfYmVhY29uKHMpCiAgICAgICAgICAgIGlmIHBhcnNlZDoKICAgICAgICAgICAgICAgIHBhcmVudCwgY2hpbGRyZW4sIGxhdCwgbG9uID0gcGFyc2VkCiAgICAgICAgICAgICAgICB0cnk6IF9mMjVfdXBkYXRlX2hlYXJ0YmVhdChzZWxmLCBwYXJlbnQsIGNoaWxkcmVuKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAgICAgdHJ5OiBzZWxmLl9yY19saW5rX2dyYXBoX3VwZGF0ZShwYXJlbnQsIGNoaWxkcmVuKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAgICAgdHJ5OiBfZjI1X3VwZGF0ZV9wb3NpdGlvbnMocGFyZW50LCBsYXQsIGxvbikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgICAgIHRyeTogX2YyNV91cGRhdGVfbGlua19ncmFwaChwYXJlbnQsIGNoaWxkcmVuKQogICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAgICAgdHJ5OiBfZjI1X3VwZGF0ZV9wb3NpdGlvbnMocGFyZW50LCBsYXQsIGxvbikKICAgICAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246IHBhc3MKICAgICAgICAgICAgcmV0dXJuICAjIG5ldmVyIHNlbmQgdG8gTWVzc2FnZXMKICAgICAgICBpZiBjYWxsYWJsZShfRjI1X09SSUdfUlgpOgogICAgICAgICAgICByZXR1cm4gX0YyNV9PUklHX1JYKHNlbGYsIGxpbmUpCiAgICBDaGF0QXBwLl9vbl9zZXJpYWxfdGhyZWFkX2xpbmUgPSBfRjI1X1JYCgogICAgIyBhbHNvIGdhdGUgdGhlIGJ5dGUtdGFwIHBhdGggZnJvbSBGMTcKICAgIGlmICJfZjE3X3Byb2Nlc3NfbGluZXMiIGluIGdsb2JhbHMoKToKICAgICAgICBfRjI1X09SSUdfVEFQID0gX2YxN19wcm9jZXNzX2xpbmVzCiAgICAgICAgZGVmIF9mMTdfcHJvY2Vzc19saW5lcyhzZWxmX2FwcCwgcyk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHMgPSAnJyBpZiBzIGlzIE5vbmUgZWxzZSBzdHIocykKICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjoKICAgICAgICAgICAgICAgIHMgPSBzdHIocyBvciAnJykKICAgICAgICAgICAgcyA9IHMucmVwbGFjZSgnXHJcbicsICdcbicpLnJlcGxhY2UoJ1xyJywgJ1xuJykKICAgICAgICAgICAgcGFydHMgPSBzLnNwbGl0KCdcbicpCiAgICAgICAgICAgIGJ1ZiA9IGdldGF0dHIoc2VsZl9hcHAsICdfZjE3X2J1ZicsICcnKQogICAgICAgICAgICBpZiBidWY6CiAgICAgICAgICAgICAgICBwYXJ0c1swXSA9IGJ1ZiArIHBhcnRzWzBdCiAgICAgICAgICAgICAgICBzZWxmX2FwcC5fZjE3X2J1ZiA9ICcnCiAgICAgICAgICAgICAgICBzZWxmX2FwcC5fZjE3X2J1Zl90cyA9IDAuMAogICAgICAgICAgICBmb3IgaXRtIGluIHBhcnRzWzotMV06CiAgICAgICAgICAgICAgICBsaW5lID0gaXRtLnN0cmlwKCkKICAgICAgICAgICAgICAgIGlmIG5vdCBsaW5lOgogICAgICAgICAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgICAgICBpZiBfZjI1X2lzX2JlYWNvbl9saW5lKGxpbmUpOgogICAgICAgICAgICAgICAgICAgIHBhcnNlZCA9IF9mMjVfcGFyc2VfYmVhY29uKGxpbmUpCiAgICAgICAgICAgICAgICAgICAgaWYgcGFyc2VkOgogICAgICAgICAgICAgICAgICAgICAgICBwYXJlbnQsIGNoaWxkcmVuLCBsYXQsIGxvbiA9IHBhcnNlZAogICAgICAgICAgICAgICAgICAgICAgICB0cnk6IF9mMjVfdXBkYXRlX2hlYXJ0YmVhdChzZWxmX2FwcCwgcGFyZW50LCBjaGlsZHJlbikKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAgICAgICAgICAgICB0cnk6IF9mMjVfdXBkYXRlX2xpbmtfZ3JhcGgocGFyZW50LCBjaGlsZHJlbikKICAgICAgICAgICAgICAgICAgICAgICAgZXhjZXB0IEV4Y2VwdGlvbjogcGFzcwogICAgICAgICAgICAgICAgICAgICAgICB0cnk6IF9mMjVfdXBkYXRlX3Bvc2l0aW9ucyhwYXJlbnQsIGxhdCwgbG9uKQogICAgICAgICAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOiBwYXNzCiAgICAgICAgICAgICAgICAgICAgY29udGludWUgICMgZG8gbm90IHNob3cgaW4gTWVzc2FnZXMKICAgICAgICAgICAgICAgICMgbm9uLWJlYWNvbiBsaW5lcyBmbG93IHRvIHRoZSBwcmUtZXhpc3RpbmcgRjE3IHBhdGgKICAgICAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgICAgICBfRjI1X09SSUdfVEFQKHNlbGZfYXBwLCBsaW5lICsgIlxuIikgICMgaGFuZCBiYWNrIGNodW5rCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgdGFpbCA9IHBhcnRzWy0xXQogICAgICAgICAgICBpZiB0YWlsOgogICAgICAgICAgICAgICAgc2VsZl9hcHAuX2YxN19idWYgPSB0YWlsCiAgICAgICAgICAgICAgICBzZWxmX2FwcC5fZjE3X2J1Zl90cyA9IF9faW1wb3J0X18oJ3RpbWUnKS5tb25vdG9uaWMoKQogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgc2VsZl9hcHAuX2YxN19idWYgPSAnJwogICAgICAgICAgICAgICAgc2VsZl9hcHAuX2YxN19idWZfdHMgPSAwLjAKICAgICAgICBnbG9iYWxzKClbJ19mMTdfcHJvY2Vzc19saW5lcyddID0gX2YxN19wcm9jZXNzX2xpbmVzCgpleGNlcHQgRXhjZXB0aW9uIGFzIF9lX2YyNToKICAgIHRyeToKICAgICAgICBkaWFnX2xvZyhmIkYyNV9CRUFDT05fUElQRSBmYWlsZWQ6IHtfZV9mMjV9IikKICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgcGFzcwoKIyA9PT09PT09PSBFbmQgRjI1X0JFQUNPTl9QSVBFID09PT09PT09CgoKCiMgPT09PT09PT0gRjE3X0lOU1RBTlRfUlg6IHRpZ2h0ZXIgZmx1c2ggKyBpbW1lZGlhdGUgcGFpbnQgPT09PT09PT0KdHJ5OgogICAgaW1wb3J0IHRpbWUgYXMgX3QKICAgIGZyb20gUHlRdDUuUXRDb3JlIGltcG9ydCBRVGltZXIKICAgIGZyb20gUHlRdDUuUXRXaWRnZXRzIGltcG9ydCBRQXBwbGljYXRpb24KCiAgICAjIDEpIFRpZ2h0ZW4gcGFydGlhbC1saW5lIGZsdXNoIGZyb20gMjUwbXMgLT4gNTBtcwogICAgaWYgJ19mMTdfdGltZXJfZmx1c2gnIGluIGdsb2JhbHMoKToKICAgICAgICBfRjE3X09SSUdfRkxVU0ggPSBfZjE3X3RpbWVyX2ZsdXNoCiAgICAgICAgZGVmIF9mMTdfdGltZXJfZmx1c2goc2VsZl9hcHApOgogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIEZvcmNlIGEgbXVjaCBmYXN0ZXIgZmx1c2ggaWYgYSB0YWlsIGlzIHdhaXRpbmcKICAgICAgICAgICAgICAgIGlmIGdldGF0dHIoc2VsZl9hcHAsICdfZjE3X2J1ZicsICcnKSBhbmQgKF90Lm1vbm90b25pYygpIC0gZ2V0YXR0cihzZWxmX2FwcCwgJ19mMTdfYnVmX3RzJywgMC4wKSkgPj0gMC4wNToKICAgICAgICAgICAgICAgICAgICBsaW5lID0gc2VsZl9hcHAuX2YxN19idWYKICAgICAgICAgICAgICAgICAgICBzZWxmX2FwcC5fZjE3X2J1ZiA9ICcnCiAgICAgICAgICAgICAgICAgICAgc2VsZl9hcHAuX2YxN19idWZfdHMgPSAwLjAKICAgICAgICAgICAgICAgICAgICBsaW5lID0gc3RyKGxpbmUpLnN0cmlwKCkKICAgICAgICAgICAgICAgICAgICBpZiBsaW5lIGFuZCAnX2YxN19zYXZlX2FwcGVuZCcgaW4gZ2xvYmFscygpIGFuZCAnX2YxN191aV9hcHBlbmQnIGluIGdsb2JhbHMoKToKICAgICAgICAgICAgICAgICAgICAgICAgX2YxN19zYXZlX2FwcGVuZChzZWxmX2FwcCwgJ3JlY2VpdmVkJywgbGluZSkKICAgICAgICAgICAgICAgICAgICAgICAgX2YxN191aV9hcHBlbmQoc2VsZl9hcHAsICdyZWNlaXZlZCcsIGxpbmUpCiAgICAgICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgICAgICMgZmFsbGJhY2sgdG8gdGhlIG9yaWdpbmFsIGxvZ2ljIGZvciBhbnkgb3RoZXIgY2FzZXMKICAgICAgICAgICAgICAgICAgICBfRjE3X09SSUdfRkxVU0goc2VsZl9hcHApCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAjIG5ldmVyIGNyYXNoIHRoZSBVSSBvbiBmbHVzaAogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIGdsb2JhbHMoKVsnX2YxN190aW1lcl9mbHVzaCddID0gX2YxN190aW1lcl9mbHVzaAoKICAgICMgMikgU3BlZWQgdXAgdGhlIHBvbGxpbmcvZmx1c2ggdGljayBmcm9tIDUwbXMgLT4gMjBtcwogICAgX0YxN19PUklHX0lOSVRfRk9SX1NQRUVEID0gZ2V0YXR0cihDaGF0QXBwLCAnX19pbml0X18nLCBOb25lKQogICAgaWYgY2FsbGFibGUoX0YxN19PUklHX0lOSVRfRk9SX1NQRUVEKToKICAgICAgICBkZWYgX0YxN19JTklUX1NQRUVEKHNlbGYsICphLCAqKmt3KToKICAgICAgICAgICAgX0YxN19PUklHX0lOSVRfRk9SX1NQRUVEKHNlbGYsICphLCAqKmt3KQogICAgICAgICAgICB0cnk6CiAgICAgICAgICAgICAgICAjIElmIG91ciBGMTcgdGltZXIgZXhpc3RzLCByZXR1bmUgaXQKICAgICAgICAgICAgICAgIHQgPSBnZXRhdHRyKHNlbGYsICdfZjE3X3RpbWVyJywgTm9uZSkKICAgICAgICAgICAgICAgIGlmIGlzaW5zdGFuY2UodCwgUVRpbWVyKToKICAgICAgICAgICAgICAgICAgICB0LnNldEludGVydmFsKDIwKQogICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgcGFzcwogICAgICAgIENoYXRBcHAuX19pbml0X18gPSBfRjE3X0lOSVRfU1BFRUQKCiAgICAjIDMpIEFmdGVyIGVhY2ggVUkgYXBwZW5kLCBmb3JjZSBhbiBpbW1lZGlhdGUgcGFpbnQgc28gdGhlIGxpbmUgYXBwZWFycyBub3cKICAgIGlmICdfZjE3X3VpX2FwcGVuZCcgaW4gZ2xvYmFscygpOgogICAgICAgIF9GMTdfT1JJR19VSV9BUFBFTkQgPSBfZjE3X3VpX2FwcGVuZAogICAgICAgIGRlZiBfZjE3X3VpX2FwcGVuZChzZWxmX2FwcCwga2luZCwgdGV4dCk6CiAgICAgICAgICAgIHRyeToKICAgICAgICAgICAgICAgIHIgPSBfRjE3X09SSUdfVUlfQVBQRU5EKHNlbGZfYXBwLCBraW5kLCB0ZXh0KQogICAgICAgICAgICAgICAgdHJ5OgogICAgICAgICAgICAgICAgICAgICMgVHJ5IHRvIGZvcmNlIGEgcXVpY2sgcGFpbnQ7IHNtYWxsLCBzYWZlIHB1bXAKICAgICAgICAgICAgICAgICAgICBRQXBwbGljYXRpb24ucHJvY2Vzc0V2ZW50cygpCiAgICAgICAgICAgICAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgICAgICAgICAgICAgIHBhc3MKICAgICAgICAgICAgICAgIHJldHVybiByCiAgICAgICAgICAgIGV4Y2VwdCBFeGNlcHRpb246CiAgICAgICAgICAgICAgICAjIGZhbGwgYmFjayBxdWlldGx5CiAgICAgICAgICAgICAgICByZXR1cm4gTm9uZQogICAgICAgIGdsb2JhbHMoKVsnX2YxN191aV9hcHBlbmQnXSA9IF9mMTdfdWlfYXBwZW5kCgpleGNlcHQgRXhjZXB0aW9uIGFzIF9lX2luc3Rfcng6CiAgICB0cnk6CiAgICAgICAgZGlhZ19sb2coZiJGMTdfSU5TVEFOVF9SWCBwYXRjaCBmYWlsZWQ6IHtfZV9pbnN0X3J4fSIpCiAgICBleGNlcHQgRXhjZXB0aW9uOgogICAgICAgIHBhc3MKIyA9PT09PT09PSBFbmQgRjE3X0lOU1RBTlRfUlggPT09PT09PT0='''

# ===== Single-file Robust Chat v1.6.2 (embedded base via base64) =====
import sys, os, types, base64

def _load_embedded_base():
    data = base64.b64decode(EMBEDDED_BASE_B64.encode("ascii"))
    src = data.decode("utf-8", errors="strict")
    mod = types.ModuleType("robust_base")
    # Provide a __file__ so base code that relies on it works in single-file mode
    try:
        import sys, os
        mod.__file__ = os.path.abspath(sys.argv[0])
    except Exception:
        mod.__file__ = "<embedded robust_base>"
    code = compile(src, "<embedded robust_base>", "exec")
    exec(code, mod.__dict__)
    return mod

base = _load_embedded_base()

# Writable settings dir (AppData on Windows)
import json
def _user_data_dir():
    if os.name == "nt":
        root = os.environ.get("APPDATA", os.path.expanduser("~"))
        path = os.path.join(root, "RobustChat")
    else:
        root = os.path.expanduser("~/.local/share")
        path = os.path.join(root, "RobustChat")
    os.makedirs(path, exist_ok=True)
    return path

def load_json(name):
    p = os.path.join(_user_data_dir(), name)
    try:
        if os.path.isfile(p):
            with open(p, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception:
        pass
    return None

def save_json(name, data):
    p = os.path.join(_user_data_dir(), name)
    try:
        with open(p, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=2)
    except Exception:
        pass


# Helpers to load/save small json
def load_json(name):
    try:
        import json
        base_dir = os.path.dirname(BASE_PATH)
        p = os.path.join(base_dir, name)
        if os.path.isfile(p):
            with open(p, "r", encoding="utf-8") as f:
                return json.load(f)
    except Exception:
        pass
    return None

def save_json(name, data):
    try:
        import json
        base_dir = os.path.dirname(BASE_PATH)
        p = os.path.join(base_dir, name)
        with open(p, "w", encoding="utf-8") as f:
            json.dump(data, f, indent=2)
    except Exception:
        pass


def install_gps_ui(w):
    # Find the "Serial Port" group
    serial_group = None
    for gb in w.findChildren(QGroupBox):
        try:
            if gb.title().strip() == "Serial Port":
                serial_group = gb
                break
        except Exception:
            pass
    if not serial_group:
        return

    # Build a row under the TNC COM line: GPS Port combo + Refresh + Read GPS + hint
    v = serial_group.layout()
    if v is None:
        return

    # Transparent container so it blends with theme panel background
    from PyQt5.QtWidgets import QWidget
    from PyQt5.QtCore import Qt
    cont = QWidget(serial_group)
    try:
        cont.setAutoFillBackground(False)
        cont.setAttribute(Qt.WA_TranslucentBackground, True)
        cont.setStyleSheet('background-color: transparent;')
    except Exception:
        pass

    row = QHBoxLayout(cont)
    row.setContentsMargins(0,0,0,0)
    row.setSpacing(8)

    w.gps_label = QLabel('GPS Port:')
    try:
        w.gps_label.setStyleSheet('background-color: transparent;')
    except Exception:
        pass
    row.addWidget(w.gps_label)

    w.gps_port_combo = QComboBox()
    row.addWidget(w.gps_port_combo, 1)

    btn_refresh = QPushButton('Refresh')
    row.addWidget(btn_refresh)

    btn_read = QPushButton('Read GPS')
    row.addWidget(btn_read)

    w.gps_hint_label = QLabel('Auto 15 mins')
    try:
        w.gps_hint_label.setStyleSheet('background-color: transparent;')
    except Exception:
        pass
    row.addWidget(w.gps_hint_label)

    v.addWidget(cont)

    # Methods -------------------------------------------------
    def refresh_gps_ports(self):
        ports = [f"COM{i}" for i in range(1, 17)] if os.name == "nt" else ["/dev/ttyS0","/dev/ttyUSB0"]
        try:
            self.gps_port_combo.clear()
            self.gps_port_combo.addItems(ports)
            st = load_json("settings.json") or {}
            gps = st.get("gps", {}) if isinstance(st, dict) else {}
            saved = gps.get("port", "")
            if saved:
                idx = self.gps_port_combo.findText(saved)
                if idx >= 0:
                    self.gps_port_combo.setCurrentIndex(idx)
        except Exception:
            pass

    
    def read_gps_position(self):
        """Safe GPS reader with full exception guards."""
        try:
            import time, re, math
            try:
                port = self.gps_port_combo.currentText().strip() if hasattr(self, 'gps_port_combo') else ''
            except Exception:
                port = ''
            if not port:
                try:
                    self._status('Select a GPS port first.', 3000)
                except Exception:
                    pass
                return

            # Persist chosen port
            try:
                st = load_json("settings.json") or {}
                if not isinstance(st, dict):
                    st = {}
                gps = st.get("gps", {})
                if not isinstance(gps, dict):
                    gps = {}
                gps["port"] = port
                st["gps"] = gps
                save_json("settings.json", st)
            except Exception:
                pass

            # Baud fallbacks
            bauds = [9600, 4800, getattr(self, '_serial_baud_default', 38400)]
            lat = lon = float('nan')

            def _nmea_deg(val: str, hemi: str) -> float:
                try:
                    if not val or not hemi or '.' not in val:
                        return float('nan')
                    deg_len = 2 if hemi.upper() in ('N','S') else 3
                    d = int(val[:deg_len]); m = float(val[deg_len:])
                    dec = d + m/60.0
                    if hemi.upper() in ('S','W'):
                        dec = -dec
                    return dec
                except Exception:
                    return float('nan')

            NMEA_RMC = re.compile(r'^\$(?:GP|GN|GL|GA)RMC,', re.I)
            NMEA_GGA = re.compile(r'^\$(?:GP|GN|GL|GA)GGA,', re.I)
            POS_DEC_RE = re.compile(r'(?P<lat>[-+]?\d{1,2}\.\d{3,})[,/\s]+(?P<lon>[-+]?\d{1,3}\.\d{3,})')

            try:
                import serial  # pyserial
            except Exception:
                try:
                    self._status('pyserial not available for GPS read.', 3000)
                except Exception:
                    pass
                return

            for b in bauds:
                try:
                    with serial.Serial(port, b, timeout=0.2) as s:
                        start_t = time.time(); buf = b''
                        try:
                            s.reset_input_buffer()
                        except Exception:
                            pass
                        while (time.time() - start_t) < 2.0:
                            try:
                                chunk = s.read(256)
                                if chunk:
                                    buf += chunk
                                    if len(buf) > 8192:
                                        break
                            except Exception:
                                break
                        try:
                            text = buf.decode(errors='ignore')
                        except Exception:
                            text = ''

                        if text:
                            for line in text.splitlines():
                                if NMEA_RMC.match(line):
                                    parts = line.split(',')
                                    if len(parts) >= 7:
                                        lat = _nmea_deg(parts[3], parts[4])
                                        lon = _nmea_deg(parts[5], parts[6])
                                        break
                                if NMEA_GGA.match(line):
                                    parts = line.split(',')
                                    if len(parts) >= 6:
                                        lat = _nmea_deg(parts[2], parts[3])
                                        lon = _nmea_deg(parts[4], parts[5])
                                        break
                            if (math.isnan(lat) or math.isnan(lon)) and POS_DEC_RE.search(text):
                                try:
                                    m = POS_DEC_RE.search(text)
                                    lat = float(m.group('lat')); lon = float(m.group('lon'))
                                except Exception:
                                    pass
                except Exception:
                    continue

                if not (math.isnan(lat) or math.isnan(lon) or abs(lat)>90 or abs(lon)>180):
                    break

            if math.isnan(lat) or math.isnan(lon) or abs(lat)>90 or abs(lon)>180:
                try:
                    self._status('GPS parse failed. Enter Fixed GPS or try again.', 4000)
                except Exception:
                    pass
                return

            try:
                if hasattr(self, 'fixed_lat_edit'):
                    self.fixed_lat_edit.clear()
                if hasattr(self, 'fixed_lon_edit'):
                    self.fixed_lon_edit.clear()
                if hasattr(self, 'fixed_lat_edit'):
                    self.fixed_lat_edit.setText(f"{lat:.5f}")
                if hasattr(self, 'fixed_lon_edit'):
                    self.fixed_lon_edit.setText(f"{lon:.5f}")
                self.save_fixed_gps()

                st2 = load_json("settings.json") or {}
                if not isinstance(st2, dict):
                    st2 = {}
                gps2 = st2.get("gps", {})
                if not isinstance(gps2, dict):
                    gps2 = {}
                import time as _t
                gps2["last_update"] = int(_t.time())
                gps2["lat"] = float(f"{lat:.5f}")
                gps2["lon"] = float(f"{lon:.5f}")
                st2["gps"] = gps2
                save_json("settings.json", st2)
                self._status('GPS position updated.', 3000)
            except Exception:
                pass

        except Exception as _fatal:
            # swallow any unexpected exception to avoid process exit
            try:
                self._status(f'GPS read fatal: {type(_fatal).__name__}', 4000)
            except Exception:
                pass
            return


    # Bind methods to the instance
    w.refresh_gps_ports = types.MethodType(refresh_gps_ports, w)
    w.read_gps_position = types.MethodType(read_gps_position, w)

    
    w.get_gps_via_tnc = types.MethodType(get_gps_via_tnc, w)# Wire buttons
    btn_refresh.clicked.connect(w.refresh_gps_ports)
    btn_read.clicked.connect(w.read_gps_position)

    # Populate list once
    w.refresh_gps_ports()

    # Start a 15-minute repeating timer + initial kick after 3s
    try:
        w.gps_refresh_timer = QTimer(w)
        w.gps_refresh_timer.setInterval(15 * 60 * 1000)
        w.gps_refresh_timer.timeout.connect(w.read_gps_position)
        QTimer.singleShot(500, lambda: w.gps_refresh_timer.start())
        QTimer.singleShot(3500, w.read_gps_position)
    except Exception:
        pass






def get_gps_via_tnc(self):
    """Send ESC %AZ over the existing TNC connection; fields will fill via sniffer when reply arrives."""
    try:
        self.gps_refresh_mode = 'tnc'
        # clear fields so next update is visible
        try:
            if hasattr(self, 'fixed_lat_edit'): self.fixed_lat_edit.clear()
            if hasattr(self, 'fixed_lon_edit'): self.fixed_lon_edit.clear()
        except Exception:
            pass
        # try common TX entry points on the app
        sent = False
        payload = b'\x1b%AZ\r'
        # candidates: write methods or callables attached on self
        candidates = []
        for name in ['tnc_write','send_raw','write_raw','tx_raw','write','send','send_bytes','cmd_write','writer','_writer','serial_write']:
            try:
                obj = getattr(self, name, None)
            except Exception:
                obj = None
            if callable(obj):
                candidates.append(('call', obj))
            elif hasattr(obj, 'write'):
                candidates.append(('write', getattr(obj, 'write')))
        for kind, fn in candidates:
            try:
                fn(payload)
                sent = True
                break
            except Exception:
                continue
        if not sent:
            # try to find a serial-like object on self
            try:
                for k, v in self.__dict__.items():
                    if hasattr(v, 'write'):
                        try:
                            v.write(payload); sent = True; break
                        except Exception:
                            pass
            except Exception:
                pass
        if not sent:
            if hasattr(self, '_status'): self._status('Connect to TNC first (no TX path for %AZ).', 3500)
            return
        if hasattr(self, '_status'): self._status('Requested TNC GPS (%AZ)...', 2000)
        # Do not read here; rely on normal RX path + sniffer to populate
    except Exception:
        pass

def add_get_gps_button(w):
    """Find the 'Fixed GPS' group and append a 'GET GPS' button."""
    try:
        from PyQt5.QtWidgets import QGroupBox, QPushButton
    except Exception:
        return
    if getattr(w, 'get_gps_btn', None):
        return
    fixed_group = None
    try:
        for gb in w.findChildren(QGroupBox):
            try:
                title = gb.title().strip()
            except Exception:
                title = ''
            if title.startswith('GPS') or title.startswith('Fixed GPS'):
                fixed_group = gb
                break
    except Exception:
        fixed_group = None
    if not fixed_group:
        return
    lay = fixed_group.layout()
    if not lay:
        return
    try:
        btn = QPushButton('TNC GPS')
        btn.setObjectName('get_gps_btn')
        lay.addWidget(btn)
        w.get_gps_btn = btn
        # Add STOP TNC GPS button
        try:
            stop_btn = QPushButton('STOP TNC GPS')
            stop_btn.setObjectName('stop_tnc_gps_btn')
            lay.addWidget(stop_btn)
            w.stop_tnc_gps_btn = stop_btn
            def _stop_tnc():
                try:
                    w.gps_refresh_mode = 'off'
                    if hasattr(w, '_status'): w._status('TNC GPS auto-refresh stopped.', 3000)
                except Exception:
                    pass
            try:
                stop_btn.clicked.connect(_stop_tnc)
            except Exception:
                pass
        except Exception:
            pass
    except Exception:
        return
    try:
        if hasattr(w, 'get_gps_via_tnc'):
            btn.clicked.connect(w.get_gps_via_tnc)
    except Exception:
        pass

def _gps_refresh_tick(self):
    """Dispatch GPS refresh based on selected mode: 'tnc', 'serial', or 'off'."""
    try:
        mode = getattr(self, 'gps_refresh_mode', 'serial')
        if mode == 'off':
            return
        if mode == 'tnc' and hasattr(self, 'get_gps_via_tnc'):
            return self.get_gps_via_tnc()
        # default to serial reader if available
        if hasattr(self, 'read_gps_position'):
            return self.read_gps_position()
    except Exception:
        pass

def retarget_gps_timer(w):
    """Ensure the 15-min timer calls our dispatcher instead of being hard-wired."""
    try:
        # default mode is 'serial' unless changed by user
        if not hasattr(w, 'gps_refresh_mode'):
            w.gps_refresh_mode = 'serial'
        if hasattr(w, 'gps_refresh_timer'):
            try:
                # attempt to disconnect previous slot; ignore failures
                try:
                    w.gps_refresh_timer.timeout.disconnect()
                except Exception:
                    pass
                w.gps_refresh_timer.timeout.connect(lambda: _gps_refresh_tick(w))
            except Exception:
                pass
    except Exception:
        pass

def hook_send_fix_pos_to_insert_message(w):
    """Find the 'SEND FIX POS' button and hook it to insert current lat/lon into the compose box."""
    try:
        from PyQt5.QtWidgets import QGroupBox, QPushButton
    except Exception:
        return
    fixed_group = None
    try:
        for gb in w.findChildren(QGroupBox):
            try:
                if gb.title().strip().startswith('GPS') or gb.title().strip().startswith('Fixed GPS'):
                    fixed_group = gb; break
            except Exception:
                continue
    except Exception:
        fixed_group = None
    if not fixed_group:
        return
    # scan for the SEND FIX POS button
    target_btn = None
    try:
        for btn in fixed_group.findChildren(QPushButton):
            try:
                t = btn.text().upper()
            except Exception:
                t = ''
            if ('SEND' in t) and ('POS' in t):
                target_btn = btn; break
    except Exception:
        target_btn = None
    if not target_btn:
        return
    def _inject_text():
        try:
            lat = None; lon = None
            if hasattr(w, 'fixed_lat_edit'): 
                try: lat = w.fixed_lat_edit.text().strip()
                except Exception: lat = None
            if hasattr(w, 'fixed_lon_edit'):
                try: lon = w.fixed_lon_edit.text().strip()
                except Exception: lon = None
            if lat and lon:
                msg = f"FIX POS {lat},{lon}"
                # Try common compose fields
                for name in ['message_input','send_input','send_edit','msg_input','msg_edit']:
                    try:
                        fld = getattr(w, name, None)
                        if fld is None: 
                            continue
                        # QLineEdit path
                        try:
                            fld.setText(msg)
                            if hasattr(w, '_status'): w._status('Inserted FIX POS into message.', 2000)
                            return
                        except Exception:
                            pass
                        # QText-like path
                        try:
                            fld.clear(); fld.insertPlainText(msg)
                            if hasattr(w, '_status'): w._status('Inserted FIX POS into message.', 2000)
                            return
                        except Exception:
                            pass
                    except Exception:
                        pass
                # If not found, at least echo in status
                if hasattr(w, '_status'): w._status(f'FIX POS ready: {msg}', 3000)
        except Exception:
            pass
    try:
        target_btn.clicked.connect(_inject_text)
    except Exception:
        pass

def enforce_fixed_gps_field_limits(w):
    """
    Force the Fixed GPS lat/lon QLineEdits to be visually ~10 characters wide
    and enforce a hard 10-character input limit.
    """
    try:
        from PyQt5.QtWidgets import QGroupBox, QLineEdit, QSizePolicy
        from PyQt5.QtGui import QFontMetrics

        # Find the group by either new or legacy title
        fixed_group = None
        for gb in w.findChildren(QGroupBox):
            try:
                title = gb.title().strip()
            except Exception:
                title = ""
            if title.startswith("GPS") or title.startswith("Fixed GPS"):
                fixed_group = gb
                break

        # Prefer direct attributes
        lat_edit = getattr(w, "fixed_lat_edit", None)
        lon_edit = getattr(w, "fixed_lon_edit", None)

        # If not available, try to locate first two QLineEdits in the group
        if (lat_edit is None or lon_edit is None) and fixed_group is not None:
            edits = fixed_group.findChildren(QLineEdit)
            if len(edits) >= 2:
                lat_edit, lon_edit = edits[0], edits[1]

        for ed in (lat_edit, lon_edit):
            if not ed:
                continue
            try:
                ed.setMaxLength(10)
            except Exception:
                pass
            try:
                fm = QFontMetrics(ed.font())
                px = fm.horizontalAdvance("0" * 10) + 12  # margin for decimal/sign
                ed.setFixedWidth(px)
            except Exception:
                try:
                    sp = ed.sizePolicy()
                    sp.setHorizontalPolicy(QSizePolicy.Fixed)
                    ed.setSizePolicy(sp)
                    ed.setMinimumWidth(110)
                    ed.setMaximumWidth(150)
                except Exception:
                    pass
    except Exception:
        pass

def reflow_fixed_and_upload(w):
    """
    Force GPS + File Upload onto ONE horizontal row by removing their wrapper widgets
    from the left vertical layout and inserting a single row in their place.
    Safe on repeat (guarded).
    """
    from PyQt5.QtWidgets import QGroupBox, QWidget, QHBoxLayout, QLineEdit, QSizePolicy
    from PyQt5.QtCore import Qt

    if getattr(w, "_fixed_upload_reflowed", False):
        return

    # Locate the two groups by title
    fixed_group = None
    file_group = None
    for gb in w.findChildren(QGroupBox):
        try:
            title = gb.title().strip()
        except Exception:
            title = ""
        if (title.startswith("GPS") or title.startswith("Fixed GPS")) and fixed_group is None:
            fixed_group = gb
        elif title.startswith("File Upload") and file_group is None:
            file_group = gb

    if fixed_group is None or file_group is None:
        return

    # Their direct parents are wrapper widgets ('wrap' and 'wrap2') inside the left_layout (a QVBoxLayout)
    wrap_fixed = fixed_group.parentWidget()
    wrap_file = file_group.parentWidget()
    if wrap_fixed is None or wrap_file is None:
        return

    # The parent layout that contains the wrappers
    parent_container = wrap_fixed.parentWidget()
    parent_layout = parent_container.layout() if parent_container is not None else None
    if parent_layout is None:
        return

    # Find the index of the fixed wrapper so we can reinsert a new row there
    index_of_fixed = parent_layout.indexOf(wrap_fixed)
    if index_of_fixed < 0:
        index_of_fixed = parent_layout.count()

    # Remove wrappers from the parent layout and delete them to avoid leftover vertical slots
    try:
        parent_layout.removeWidget(wrap_fixed)
    except Exception:
        pass
    try:
        parent_layout.removeWidget(wrap_file)
    except Exception:
        pass
    try:
        wrap_fixed.hide(); wrap_fixed.setParent(None); wrap_fixed.deleteLater()
    except Exception:
        pass
    try:
        wrap_file.hide(); wrap_file.setParent(None); wrap_file.deleteLater()
    except Exception:
        pass

    # Create a single row and reparent the two groups into it
    row = QWidget(parent_container)
    row.setObjectName("fixed_upload_row")
    row.setAttribute(Qt.WA_TranslucentBackground, True)
    row.setAutoFillBackground(False)
    h = QHBoxLayout(row)
    try:
        h.setSpacing(6)
        h.setContentsMargins(6, 2, 6, 2)
    except Exception:
        pass

    # Tighten the field widths to help keep everything on one line
    try:
        lat_edit = getattr(w, "fixed_lat_edit", None)
        lon_edit = getattr(w, "fixed_lon_edit", None)
        if (lat_edit is None or lon_edit is None):
            edits = fixed_group.findChildren(QLineEdit)
            if len(edits) >= 2:
                lat_edit, lon_edit = edits[0], edits[1]
        for ed in (lat_edit, lon_edit):
            if not ed:
                continue
            try:
                ed.setMaxLength(10)
            except Exception:
                pass
            try:
                from PyQt5.QtGui import QFontMetrics
                fm = QFontMetrics(ed.font())
                px = fm.horizontalAdvance("0" * 10) + 10
                ed.setFixedWidth(px)
            except Exception:
                try:
                    sp = ed.sizePolicy(); sp.setHorizontalPolicy(QSizePolicy.Fixed); ed.setSizePolicy(sp)
                    ed.setMinimumWidth(110); ed.setMaximumWidth(150)
                except Exception:
                    pass
    except Exception:
        pass

    # Set conservative size policies for the groups
    try:
        fixed_group.setSizePolicy(QSizePolicy.Preferred, QSizePolicy.Fixed)
        file_group.setSizePolicy(QSizePolicy.Expanding, QSizePolicy.Fixed)
    except Exception:
        pass

    # Reparent groups into the row (must set parent before adding to layout)
    fixed_group.setParent(row)
    file_group.setParent(row)

    h.addWidget(fixed_group, 1)
    h.addWidget(file_group, 2)
    try:
        h.setStretchFactor(fixed_group, 1)
        h.setStretchFactor(file_group, 2)
    except Exception:
        pass

    # Insert the row exactly where the fixed wrapper used to be
    try:
        parent_layout.insertWidget(index_of_fixed, row)
    except Exception:
        try:
            parent_layout.addWidget(row)
        except Exception:
            pass

    w._fixed_upload_reflowed = True


def tweak_upload_and_messages(w):
    """
    Adjust UI post-build:
      • Extend File Upload path field to end of row/column.
      • Increase stretch for File Upload group relative to Fixed GPS.
      • Restore multi-line wrap for Messages list (no horizontal scroll).
    """
    try:
        from PyQt5.QtWidgets import QGroupBox, QLineEdit, QSizePolicy, QWidget, QHBoxLayout, QListView
        from PyQt5.QtCore import Qt

        # --- File Upload group ---
        file_group = None
        for gb in w.findChildren(QGroupBox):
            try:
                if gb.title().strip().startswith("File Upload"):
                    file_group = gb
                    break
            except Exception:
                pass

        if file_group is not None:
            edits = file_group.findChildren(QLineEdit)
            if edits:
                path_edit = edits[0]
                sp = path_edit.sizePolicy()
                sp.setHorizontalPolicy(QSizePolicy.Expanding)
                path_edit.setSizePolicy(sp)
                try:
                    path_edit.setMinimumWidth(300)
                    path_edit.setMaximumWidth(16777215)
                except Exception:
                    pass

            row = w.findChild(QWidget, "fixed_upload_row")
            if row is not None:
                lay = row.layout()
                if isinstance(lay, QHBoxLayout):
                    try:
                        lay.setStretch(0, 2)
                        lay.setStretch(1, 3)
                    except Exception:
                        pass

        # --- Messages wrap ---
        msgs = getattr(w, "messages_list", None)
        if msgs is not None:
            try:
                msgs.setWordWrap(True)
            except Exception:
                pass
            try:
                msgs.setHorizontalScrollBarPolicy(Qt.ScrollBarAlwaysOff)
            except Exception:
                pass
            try:
                msgs.setUniformItemSizes(False)
                msgs.setResizeMode(QListView.Adjust)
            except Exception:
                pass
    except Exception:
        pass



def move_padlock_to_upload_row(w):
    """
    Move the Secure Pad padlock button from the bottom of the left column
    into the same row as the File Upload section (to the far right).
    """
    try:
        btn = getattr(w, "secure_btn", None)
        if btn is None:
            return
        # Find our combined row
        row = w.findChild(QWidget, "fixed_upload_row")
        if row is None or row.layout() is None:
            return
        lay = row.layout()

        # Detach from previous parent layout if any
        try:
            # remove from content_layout if that's where it sits
            parent_lay = w.content_layout
            parent_lay.removeWidget(btn)
        except Exception:
            pass

        # Tweak size to fit inline nicely
        try:
            btn.setFlat(False)
            btn.setFixedHeight(28)
            btn.setFixedWidth(36)
            btn.setToolTip("Open Secure Pad")
        except Exception:
            pass

        # Add as last widget on the row
        btn.setParent(row)
        lay.addWidget(btn, 0, Qt.AlignVCenter)
    except Exception:
        pass





def install_aprs_gps_sniffer(w):
    """Wrap messages_list.insertItem to parse APRS Current GPS position lines and update Fixed GPS."""
    try:
        from PyQt5.QtWidgets import QListWidgetItem
        import re, math, time as _t
        if not hasattr(w, "messages_list") or w.messages_list is None:
            return
        if getattr(w, "_aprs_sniffer_installed", False):
            return
        lst = w.messages_list
        orig_insert = lst.insertItem
        APRS_LINE = re.compile(r'APRS\s+Current\s+GPS\s+position:\s*(?P<lat>\d{2,3}\d{2}\.\d{2})(?P<latH>[NS])\s+(?P<lon>\d{3}\d{2}\.\d{2})(?P<lonH>[EW])', re.I)
        def dd_from_ddmm(val, hemi):
            try:
                if not val or '.' not in val: return float('nan')
                whole, frac = val.split('.', 1)
                mins = whole[-2:] + '.' + frac
                degs = whole[:-2] or '0'
                dd = float(degs) + float(mins)/60.0
                if hemi.upper() in ('S','W'): dd = -dd
                return dd
            except Exception:
                return float('nan')
        def insertItem_hook(row, item):
            # pass-through to original
            try:
                orig_insert(row, item)
            finally:
                try:
                    txt = item.text() if isinstance(item, QListWidgetItem) else str(item)
                except Exception:
                    txt = ''
                try:
                    m = APRS_LINE.search(txt)
                except Exception:
                    m = None
                if m:
                    try:
                        lat = dd_from_ddmm(m.group('lat'), m.group('latH'))
                        lon = dd_from_ddmm(m.group('lon'), m.group('lonH'))
                        if not (math.isnan(lat) or math.isnan(lon)):
                            if hasattr(w, 'fixed_lat_edit'): w.fixed_lat_edit.setText(f"{lat:.5f}")
                            if hasattr(w, 'fixed_lon_edit'): w.fixed_lon_edit.setText(f"{lon:.5f}")
                            st = load_json("settings.json") or {}
                            if not isinstance(st, dict): st = {}
                            gps = st.get("gps", {}); gps = gps if isinstance(gps, dict) else {}
                            gps["lat"] = lat; gps["lon"] = lon; 
                            try:
                                import time as _t2; gps["last_update"] = int(_t2.time())
                            except Exception: pass
                            st["gps"] = gps
                            save_json("settings.json", st)
                            if hasattr(w, '_status'): w._status('TNC GPS updated (sniffer).', 2500)
                    except Exception:
                        pass
        lst.insertItem = insertItem_hook
        w._aprs_sniffer_installed = True
    except Exception:
        pass
def hook_messages_insert_top_with_timestamp(w):
    """
    Patch QListWidget so ALL additions (addItem/insertItem) are:
      - normalized to have a unified timestamp: "Oct 14 2025 [12:06.19]  text"
      - inserted at the TOP (index 0)
      - stripped of any leading [HH:MM:SS] or old stamps
    Applies to both SENT and RECEIVED messages.
    """
    try:
        from PyQt5.QtWidgets import QListWidgetItem
        from PyQt5.QtCore import Qt
        import re, datetime

        if not hasattr(w, "messages_list") or w.messages_list is None:
            return
        if getattr(w, "_msgs_hooked", False):
            return

        lst = w.messages_list
        orig_add = lst.addItem
        orig_insert = lst.insertItem

        stamp_re = re.compile(r'^(?:\w{3}\s+\d{1,2}\s+\d{4}\s\[\d{2}:\d{2}\.\d{2}\]\s+)')
        bracket_time_re = re.compile(r'^\[\d{2}:\d{2}:\d{2}\]\s*')

        IGNORE_ESC_CMD = re.compile(r'^\s*(?:[\x00-\x1f\.]+\s*)?%AZ\s*$', re.I)

        def _fmt_prefix():
            now = datetime.datetime.now()
            return now.strftime("%b %d %Y [%H:%M.%S]")

        def _normalize_item(arg):
            # Return a QListWidgetItem with cleaned text and a timestamp prefix
            if isinstance(arg, QListWidgetItem):
                it = arg
            else:
                it = QListWidgetItem(str(arg))

            txt = it.text()
            # If already in our unified format, keep as-is
            if not stamp_re.match(txt):
                # Strip stray [HH:MM:SS] (received) or any old stamp
                txt = bracket_time_re.sub('', txt)
                # Prepend current unified timestamp
                txt = f"{_fmt_prefix()}  {txt}"
                it.setText(txt)
            return it

        def addItem_hook(arg):
            try:
                it = _normalize_item(arg)
                lst.insertItem(0, it)
                lst.scrollToTop()
            except Exception:
                try:
                    orig_add(arg)
                except Exception:
                    pass

        def insertItem_hook(row, arg):
            # Ignore 'row' and always insert at the top with normalized timestamp
            try:
                it = _normalize_item(arg)
                orig_insert(0, it)
                lst.scrollToTop()
            except Exception:
                try:
                    orig_insert(row, arg)
                except Exception:
                    pass

        # Patch both
        lst.addItem = addItem_hook
        lst.insertItem = insertItem_hook
        # Retro-normalize existing items once
        try:
            count = lst.count()
            for i in range(count):
                it = lst.item(i)
                if it:
                    txt = it.text()
                    # remove bare [HH:MM:SS] or re-stamp
                    if bracket_time_re.match(txt) or not stamp_re.match(txt):
                        core = bracket_time_re.sub('', txt)
                        it.setText(f"{_fmt_prefix()}  {core}")
        except Exception:
            pass
        w._msgs_hooked = True
    except Exception:
        pass





def compact_top_sections(w):
    """
    Reduce the vertical footprint of the top three sections by setting a fixed pixel height,
    while keeping enough padding so the section titles remain readable.
    """
    try:
        from PyQt5.QtWidgets import QGroupBox
        TARGETS = {
            "Serial Port": 250,
            "Fleet Manager": 250,
            "Incoming Files": 250,
        }
        for gb in w.findChildren(QGroupBox):
            try:
                title = gb.title().strip()
            except Exception:
                title = ""
            if title in TARGETS:
                h = TARGETS[title]
                # Tighten inner spacing but add extra top margin for the title
                try:
                    lay = gb.layout()
                    if lay:
                        lay.setContentsMargins(6, 20, 6, 6)  # top=20 for title clearance
                        lay.setSpacing(6)
                except Exception:
                    pass
                # Ensure QGroupBox reserves vertical space for title across themes
                try:
                    cur_ss = gb.styleSheet() if hasattr(gb, 'styleSheet') else ''
                    add = 'QGroupBox{padding-top:18px;}'
                    if add not in cur_ss:
                        gb.setStyleSheet((cur_ss + ' ' + add).strip())
                except Exception:
                    pass
                # Fix height
                try:
                    gb.setMinimumHeight(h)
                    gb.setMaximumHeight(h)
                except Exception:
                    pass
    except Exception:
        pass


def main():
    app = QApplication.instance() or QApplication(sys.argv)
    try:
        w = base.ChatApp()
    except Exception as e:
        print('ChatApp init error:', e)
        raise
    try:
        hook_messages_insert_top_with_timestamp(w)
    except Exception:
        pass
    try:
        w.setWindowTitle("Robust Chat v1.6.2")
    except Exception:
        pass

    # After base UI is built, install GPS row into Serial group
    install_gps_ui(w)

    from PyQt5.QtCore import QTimer as _QT
    def _safe_reflow():
        try:
            reflow_fixed_and_upload(w)
        except Exception:
            try:
                w._status('Layout reflow skipped (safe mode).', 3000)
            except Exception:
                pass
    _QT.singleShot(50, _safe_reflow)
    _QT.singleShot(55, lambda: enforce_fixed_gps_field_limits(w))

    def _tweak():
        try:
            tweak_upload_and_messages(w)
        except Exception:
            pass
    _QT.singleShot(120, _tweak)

    
    _QT.singleShot(140, lambda: add_get_gps_button(w))
    _QT.singleShot(145, lambda: enforce_fixed_gps_field_limits(w))
    _QT.singleShot(150, lambda: hook_send_fix_pos_to_insert_message(w))
    _QT.singleShot(160, lambda: retarget_gps_timer(w))# Hook messages list to insert newest at top + timestamp
    _QT.singleShot(180, lambda: hook_messages_insert_top_with_timestamp(w))
    _QT.singleShot(185, lambda: install_aprs_gps_sniffer(w))

    # Move padlock inline with File Upload row
    _QT.singleShot(200, lambda: move_padlock_to_upload_row(w))

    # Compact the three top sections by ~3 rows
    _QT.singleShot(260, lambda: compact_top_sections(w))

    # Show as the base app would
    try:
        w.show()
    except Exception:
        pass
    sys.exit(app.exec_())

if __name__ == "__main__":
    main()
